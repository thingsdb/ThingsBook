<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link href="style.css" rel="stylesheet" type="text/css" />
    <title>Data as Code - The ThingsDB Book</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body>
<div class="wrapper">

<div class="cover" id="cover">
    <img role="doc-cover" src="images/cover.jpeg" alt="Data as Code - The ThingsDB Book - Jeroen van der Heijden - First Edition" class="cover-img" />
</div>

<div class="thingsdb3" id="header-id">
    <section id="header-id-sub">
        <h1 class="title">Data as Code - The ThingsDB Book</h1>
        <div class="author">
            <p class="label">Author</p>
            <p class="author1"><span class="thingsdb2">Jeroen</span> <span class="thingsdb2">van der Heijden</span></p>
        </div>
        <div class="author">
            <p class="label">Editors</p>
            <ul class="thingsdb4">
                <li class="editor"><span class="thingsdb2">Anja</span> <span class="thingsdb2">Bruls</span></li>
                <li class="editor"><span class="thingsdb2">Sasha</span> <span class="thingsdb2">Tychkovska</span></li>
            </ul>
        </div>
        <div class="copyright">
            <p class="copyright1">Copyright Â© 2024</p>
        </div>
        <hr class="thingsdb5" />
    </section>
</div>

<div class="thingsdb3" id="header-doc-id">
		<section type="dedication" role="doc-dedication" id="header-doc-link-id">
			<p class="thingsdb6">"I extend my heartfelt gratitude to Rik, Anja, Koos, Sasha and Iris for their invaluable
				contributions to the creation of this book."</p>
		</section>
	</div>


<div class="thingsdb3" id="toc">
		<nav type="toc" id="nav" role="doc-toc">
			<h2 class="thingsdb7">Table of Contents</h2>
			<ol class="thingsdb8">
				<li class="thingsdb9"><a href="#preface" class="thingsdb10">Preface</a></li>
				<li class="thingsdb9"><a href="#installation" class="thingsdb10">Installation</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#installation-node" class="thingsdb10">Installation - Node</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#installation-docker" class="thingsdb10">Docker</a></li>
								<li class="thingsdb9"><a href="#installation-linux" class="thingsdb10">Linux</a></li>
								<li class="thingsdb9"><a href="#installation-mac" class="thingsdb10">Mac</a></li>
								<li class="thingsdb9"><a href="#installation-windows" class="thingsdb10">Windows (WSL)</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#installation-python" class="thingsdb10">Installation - Python</a></li>
						<li class="thingsdb9"><a href="#installation-thingsdb-prompt" class="thingsdb10">Installation - ThingsDB Prompt</a></li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#getting-started" class="thingsdb10">Getting Started - Initial Setup</a></li>
				<li class="thingsdb9"><a href="#chapter-1" class="thingsdb10">Chapter 1 - Introduction to ThingsDB</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-1-1" class="thingsdb10">1.1 Things and Why ThingsDB</a></li>
						<li class="thingsdb9"><a href="#chapter-1-2" class="thingsdb10">1.2 Code Blocks</a></li>
						<li class="thingsdb9"><a href="#chapter-1-3" class="thingsdb10">1.3 Variables and Properties</a></li>
						<li class="thingsdb9"><a href="#chapter-1-4" class="thingsdb10">1.4 Lazy Arguments Evaluation</a></li>
						<li class="thingsdb9"><a href="#chapter-1-5" class="thingsdb10">1.5 Query Response</a></li>
						<li class="thingsdb9"><a href="#chapter-1-6" class="thingsdb10">1.6 Scopes</a></li>
						<li class="thingsdb9"><a href="#quiz-chapter-1" class="thingsdb10">1.7 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-1" class="thingsdb10">1.7.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-2" class="thingsdb10">Chapter 2 - Integers, Floating Points, Booleans, Strings and Nil</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-2-1" class="thingsdb10">2.1 Integers</a></li>
						<li class="thingsdb9"><a href="#chapter-2-2" class="thingsdb10">2.2 Floating Points</a></li>
						<li class="thingsdb9"><a href="#chapter-2-3" class="thingsdb10">2.3 Numeric Tools</a></li>
						<li class="thingsdb9"><a href="#chapter-2-4" class="thingsdb10">2.4 Boolean</a></li>
						<li class="thingsdb9"><a href="#chapter-2-5" class="thingsdb10">2.5 Strings</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-2-5-1" class="thingsdb10">2.5.1 String Methods</a></li>
								<li class="thingsdb9"><a href="#chapter-2-5-2" class="thingsdb10">2.5.2 Escaping and Multi-line Strings</a></li>
								<li class="thingsdb9"><a href="#chapter-2-5-3" class="thingsdb10">2.5.3 Concatenation and t-strings</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-2-6" class="thingsdb10">2.6 Nil</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-2-6-1" class="thingsdb10">2.6.1 Avoiding Ambiguity with Nil as a Placeholder</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-2-7" class="thingsdb10">2.7 Errors</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-2-7-1" class="thingsdb10">2.7.1 Capture Errors</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#quiz-chapter-2" class="thingsdb10">2.8 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-2" class="thingsdb10">2.8.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-3" class="thingsdb10">Chapter 3 - Lists and Tuples</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-3-1" class="thingsdb10">3.1 Lists</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-3-1-1" class="thingsdb10">3.1.1 Bounds Checking</a></li>
								<li class="thingsdb9"><a href="#chapter-3-1-2" class="thingsdb10">3.1.2 Reference and Maintained Lists</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-3-2" class="thingsdb10">3.2 Nesting and tuples</a></li>
						<li class="thingsdb9"><a href="#chapter-3-3" class="thingsdb10">3.3 Looping Over a List or Tuple</a></li>
						<li class="thingsdb9"><a href="#chapter-3-4" class="thingsdb10">3.4 Specialized Methods</a></li>
						<li class="thingsdb9"><a href="#chapter-3-5" class="thingsdb10">3.5 Lists for Multi-Value Returns</a></li>
						<li class="thingsdb9"><a href="#quiz-chapter-3" class="thingsdb10">3.6 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-3" class="thingsdb10">3.6.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-4" class="thingsdb10">Chapter 4 - Things</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-4-1" class="thingsdb10">4.1 Things for Descriptive Multi-Value Returns</a></li>
						<li class="thingsdb9"><a href="#chapter-4-2" class="thingsdb10">4.2 Thing IDs</a></li>
						<li class="thingsdb9"><a href="#chapter-4-3" class="thingsdb10">4.3 Control Response with return Statement</a></li>
						<li class="thingsdb9"><a href="#chapter-4-4" class="thingsdb10">4.4 Looping Over a Thing</a></li>
						<li class="thingsdb9"><a href="#chapter-4-5" class="thingsdb10">4.5 Value Restriction</a></li>
						<li class="thingsdb9"><a href="#chapter-4-6" class="thingsdb10">4.6 Self-References</a></li>
						<li class="thingsdb9"><a href="#quiz-chapter-4" class="thingsdb10">4.7 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-4" class="thingsdb10">4.7.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-5" class="thingsdb10">Chapter 5 - Sets</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-5-1" class="thingsdb10">5.1 Set Operations</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-5-1-1" class="thingsdb10">5.1.1 Identifying Birds Not in the Zoo</a></li>
								<li class="thingsdb9"><a href="#chapter-5-1-2" class="thingsdb10">5.1.2 Selecting Warm-Blooded Animals in the Zoo</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-5-2" class="thingsdb10">5.2 Determining Set Membership and Supersets/Subsets</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-5-2-1" class="thingsdb10">5.2.1 Verifying Set Membership</a></li>
								<li class="thingsdb9"><a href="#chapter-5-2-2" class="thingsdb10">5.2.2 Checking Subsets and Supersets</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-5-3" class="thingsdb10">5.3 Copy or Reference</a></li>
						<li class="thingsdb9"><a href="#quiz-chapter-5" class="thingsdb10">5.4 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-5" class="thingsdb10">5.4.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-6" class="thingsdb10">Chapter 6 - Procedures</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-6-1" class="thingsdb10">6.1 Side Effects and Changes</a></li>
						<li class="thingsdb9"><a href="#chapter-6-2" class="thingsdb10">6.2 Python</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-6-2-1" class="thingsdb10">6.2.1 Run Procedure</a></li>
								<li class="thingsdb9"><a href="#chapter-6-2-2" class="thingsdb10">6.2.2 Perform a Query</a></li>
								<li class="thingsdb9"><a href="#chapter-6-2-3" class="thingsdb10">6.2.3 Prevent Code Injections</a></li>
								<li class="thingsdb9"><a href="#chapter-6-2-4" class="thingsdb10">6.2.4 Migrating from Query to Procedure</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-6-3" class="thingsdb10">6.3 Requesting Procedure Information</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-6-3-1" class="thingsdb10">6.3.1 Extracting Properties from Information Objects</a></li>
								<li class="thingsdb9"><a href="#chapter-6-3-2" class="thingsdb10">6.3.2 Additional Procedure Functions</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-6-4" class="thingsdb10">6.4 Thinking Ahead</a></li>
						<li class="thingsdb9"><a href="#quiz-chapter-6" class="thingsdb10">6.5 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-6" class="thingsdb10">6.5.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-7" class="thingsdb10">Chapter 7 - Typed Things</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-7-1" class="thingsdb10">7.1 Create Your First Type</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-7-1-1" class="thingsdb10">7.1.1 Enhancing the Todo Type using mod_type()</a></li>
								<li class="thingsdb9"><a href="#chapter-7-1-2" class="thingsdb10">7.1.2 Customizing ID Representation in Responses</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-7-2" class="thingsdb10">7.2 Collection Structure with Types</a></li>
						<li class="thingsdb9"><a href="#chapter-7-3" class="thingsdb10">7.3 Retrieving Typed Things by ID</a></li>
						<li class="thingsdb9"><a href="#chapter-7-4" class="thingsdb10">7.4 Type Methods</a></li>
						<li class="thingsdb9"><a href="#chapter-7-5" class="thingsdb10">7.5 Type Information</a></li>
						<li class="thingsdb9"><a href="#chapter-7-6" class="thingsdb10">7.6 Removing a Type</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-7-6-1" class="thingsdb10">7.6.1 Dependency Considerations</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-7-7" class="thingsdb10">7.7 More Definitions</a></li>
						<li class="thingsdb9"><a href="#quiz-chapter-7" class="thingsdb10">7.8 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-7" class="thingsdb10">7.8.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-8" class="thingsdb10">Chapter 8 - Date, Time and Tasks</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-8-1" class="thingsdb10">8.1 Timestamps vs. Datetime</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-8-1-1" class="thingsdb10">8.1.1 Bridging the Gap Between Datetime and Timestamp</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-8-2" class="thingsdb10">8.2 Enhancing Todo with Datetime Properties</a></li>
						<li class="thingsdb9"><a href="#chapter-8-3" class="thingsdb10">8.3 Scheduling Code Execution with Tasks</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-8-3-1" class="thingsdb10">8.3.1 Cancel or Delete a Task</a></li>
								<li class="thingsdb9"><a href="#chapter-8-3-2" class="thingsdb10">8.3.2 Repeating Tasks</a></li>
								<li class="thingsdb9"><a href="#chapter-8-3-3" class="thingsdb10">8.3.3 Status for Repeating Task</a></li>
								<li class="thingsdb9"><a href="#chapter-8-3-4" class="thingsdb10">8.3.4 Deleting All Tasks with a Single Statement</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-8-4" class="thingsdb10">8.4 Farewell, done Property</a></li>
						<li class="thingsdb9"><a href="#quiz-chapter-8" class="thingsdb10">8.5 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-8" class="thingsdb10">8.5.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-9" class="thingsdb10">Chapter 9 - Two-Way Links</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-9-1" class="thingsdb10">9.1 Introducing Relations</a></li>
						<li class="thingsdb9"><a href="#chapter-9-2" class="thingsdb10">9.2 Exploring More Relations</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-9-2-1" class="thingsdb10">9.2.1 One-on-One Relationship</a></li>
								<li class="thingsdb9"><a href="#chapter-9-2-2" class="thingsdb10">9.2.2 Many-to-Many Relationship</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-9-3" class="thingsdb10">9.3 Creating Relations: A Deeper Look</a></li>
						<li class="thingsdb9"><a href="#chapter-9-4" class="thingsdb10">9.4 Code Cleanup</a></li>
						<li class="thingsdb9"><a href="#quiz-chapter-9" class="thingsdb10">9.5 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-9" class="thingsdb10">9.5.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-10" class="thingsdb10">Chapter 10 - Control Responses</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-10-1" class="thingsdb10">10.1 The Power of Wrap-Only Types</a></li>
						<li class="thingsdb9"><a href="#chapter-10-2" class="thingsdb10">10.2 Update Search To-do's</a></li>
						<li class="thingsdb9"><a href="#chapter-10-3" class="thingsdb10">10.3 Wrap Every-Thing</a></li>
						<li class="thingsdb9"><a href="#chapter-10-4" class="thingsdb10">10.4 Modifying Wrap-Only and Hide-ID Flags</a></li>
						<li class="thingsdb9"><a href="#quiz-chapter-10" class="thingsdb10">10.5 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-10" class="thingsdb10">10.5.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-11" class="thingsdb10">Chapter 11 - Flags, Enumerators and Regex</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-11-1" class="thingsdb10">11.1 Crafting Your First Enumerator</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-11-1-1" class="thingsdb10">11.1.1 Setting the Default Member of an Enumerator</a></li>
								<li class="thingsdb9"><a href="#chapter-11-1-2" class="thingsdb10">11.1.2 Working with Enumerator Methods</a></li>
								<li class="thingsdb9"><a href="#chapter-11-1-3" class="thingsdb10">11.1.3 Retrieving Enumerator Members</a></li>
								<li class="thingsdb9"><a href="#chapter-11-1-4" class="thingsdb10">11.1.4 Enumerator Validation</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-11-2" class="thingsdb10">11.2 Enumerator Information</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-11-2-1" class="thingsdb10">11.2.1 Enumerator Members</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-11-3" class="thingsdb10">11.3 Modifying Enumerators</a></li>
						<li class="thingsdb9"><a href="#chapter-11-4" class="thingsdb10">11.4 Implementation and Other Enumerator Solutions</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-11-4-1" class="thingsdb10">11.4.1 Revisiting Range Definitions</a></li>
								<li class="thingsdb9"><a href="#chapter-11-4-2" class="thingsdb10">11.4.2 Regular Expressions using Regex</a></li>
								<li class="thingsdb9"><a href="#chapter-11-4-3" class="thingsdb10">11.4.3 Transitioning to the Enumerator</a></li>
								<li class="thingsdb9"><a href="#chapter-11-4-4" class="thingsdb10">11.4.4 Wrap-Only Types with Enumerators</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-11-5" class="thingsdb10">11.5 Understanding Flags</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-11-5-1" class="thingsdb10">11.5.1 Using Enumerators to Store Flags</a></li>
								<li class="thingsdb9"><a href="#chapter-11-5-2" class="thingsdb10">11.5.2 Working with Flags</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#quiz-chapter-11" class="thingsdb10">11.6 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-11" class="thingsdb10">11.6.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-12" class="thingsdb10">Chapter 12 - Real-Time Data Updates with Events and Rooms</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-12-1" class="thingsdb10">12.1 Rooms</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-12-1-1" class="thingsdb10">12.1.1 Sending Your First Message via Events</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-12-2" class="thingsdb10">12.2 Listen for Events</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-12-2-1" class="thingsdb10">12.2.1 Creating Your Dashboard Listener</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-12-3" class="thingsdb10">12.3 Retrieving Initial Dashboard State</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-12-3-1" class="thingsdb10">12.3.1 Integration of the Initial State</a></li>
								<li class="thingsdb9"><a href="#chapter-12-3-2" class="thingsdb10">12.3.2 Implement Event Handlers</a></li>
								<li class="thingsdb9"><a href="#chapter-12-3-3" class="thingsdb10">12.3.3 Test Your Dashboard in Action!</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-12-4" class="thingsdb10">12.4 Room for More</a></li>
						<li class="thingsdb9"><a href="#quiz-chapter-12" class="thingsdb10">12.5 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-12" class="thingsdb10">12.5.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-13" class="thingsdb10">Chapter 13 - Futures and Modules</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-13-1" class="thingsdb10">13.1 Demystifying Futures: Waiting with Purpose</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-13-1-1" class="thingsdb10">13.1.1 Using the Future's Task Result</a></li>
								<li class="thingsdb9"><a href="#chapter-13-1-2" class="thingsdb10">13.1.2 Empty Futures: Isolating Side Effects for Efficiency</a></li>
								<li class="thingsdb9"><a href="#chapter-13-1-3" class="thingsdb10">13.1.3 Caution! Futures Don't Always Behave Like Values</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-13-2" class="thingsdb10">13.2 Enhance Your ThingsDB with Modules</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-13-2-1" class="thingsdb10">13.2.1 Install The Demo Module</a></li>
								<li class="thingsdb9"><a href="#chapter-13-2-2" class="thingsdb10">13.2.2 Sending NTFYs with the HTTP(S) Request Module</a></li>
								<li class="thingsdb9"><a href="#chapter-13-2-3" class="thingsdb10">13.2.3 Talking to Yourself: Connecting ThingsDB Scopes</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-13-3" class="thingsdb10">13.3 Managing Your Modules: Access, Updates, and More</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-13-3-1" class="thingsdb10">13.3.1 Controlling Module Access</a></li>
								<li class="thingsdb9"><a href="#chapter-13-3-2" class="thingsdb10">13.3.2 Multiple Configurations, Multiple Installations</a></li>
								<li class="thingsdb9"><a href="#chapter-13-3-3" class="thingsdb10">13.3.3 Keeping Your Modules Up-to-Date</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#quiz-chapter-13" class="thingsdb10">13.4 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-13" class="thingsdb10">13.4.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-14" class="thingsdb10">Chapter 14 - Safeguarding Your Data</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-14-1" class="thingsdb10">14.1 Node Scopes for Backups</a></li>
						<li class="thingsdb9"><a href="#chapter-14-2" class="thingsdb10">14.2 Your First Backup</a></li>
						<li class="thingsdb9"><a href="#chapter-14-3" class="thingsdb10">14.3 Restoring Your Data</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-14-3-1" class="thingsdb10">14.3.1 Restoring Data from a Multi-Node Setup</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-14-4" class="thingsdb10">14.4 Automating Your Backups</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-14-4-1" class="thingsdb10">14.4.1 Ensuring Backup Health</a></li>
								<li class="thingsdb9"><a href="#chapter-14-4-2" class="thingsdb10">14.4.2 Google Cloud Storage</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-14-5" class="thingsdb10">14.5 Exporting and Importing Collections</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-14-5-1" class="thingsdb10">14.5.1 Exporting Collection Schemas</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-14-6" class="thingsdb10">14.6 Choosing Your Tool: Backups vs. Exports</a></li>
						<li class="thingsdb9"><a href="#quiz-chapter-14" class="thingsdb10">14.7 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-14" class="thingsdb10">14.7.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-15" class="thingsdb10">Chapter 15 - Multiple Nodes and Debugging</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-15-1" class="thingsdb10">15.1 Scaling Up: Adding Nodes</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-15-1-1" class="thingsdb10">15.1.1 ThingsDB from Source</a></li>
								<li class="thingsdb9"><a href="#chapter-15-1-2" class="thingsdb10">15.1.2 Using Docker Compose</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-15-2" class="thingsdb10">15.2 Invite the New Node</a></li>
						<li class="thingsdb9"><a href="#chapter-15-3" class="thingsdb10">15.3 Node Counters</a></li>
						<li class="thingsdb9"><a href="#chapter-15-4" class="thingsdb10">15.4 Diving Deeper with Node Information</a></li>
						<li class="thingsdb9"><a href="#chapter-15-5" class="thingsdb10">15.5 New Version, Upgrade</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-15-5-1" class="thingsdb10">15.5.1 Understanding the HTTP Status Port</a></li>
								<li class="thingsdb9"><a href="#chapter-15-5-2" class="thingsdb10">15.5.2 Using the /ready URL</a></li>
								<li class="thingsdb9"><a href="#chapter-15-5-3" class="thingsdb10">15.5.3 Liveness and Readiness</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-15-6" class="thingsdb10">15.6 Data Related Debugging</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-15-6-1" class="thingsdb10">15.6.1 Checking References</a></li>
								<li class="thingsdb9"><a href="#chapter-15-6-2" class="thingsdb10">15.6.2 Finding Things</a></li>
								<li class="thingsdb9"><a href="#chapter-15-6-3" class="thingsdb10">15.6.3 Profiling Code Performance</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#quiz-chapter-15" class="thingsdb10">15.7 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-15" class="thingsdb10">15.7.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#chapter-16" class="thingsdb10">Chapter 16: Unleashing the Power of the HTTP API</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#chapter-16-1" class="thingsdb10">16.1 Enabling the API</a></li>
						<li class="thingsdb9"><a href="#chapter-16-2" class="thingsdb10">16.2 Exploring Your First API Call</a>
							<ol class="thingsdb11">
								<li class="thingsdb9"><a href="#chapter-16-2-1" class="thingsdb10">16.2.1 Securing Admin Credentials</a></li>
								<li class="thingsdb9"><a href="#chapter-16-2-2" class="thingsdb10">16.2.2 Token Authentication</a></li>
							</ol>
						</li>
						<li class="thingsdb9"><a href="#chapter-16-3" class="thingsdb10">16.3 Running Procedures with the API</a></li>
						<li class="thingsdb9"><a href="#chapter-16-4" class="thingsdb10">16.4 MessagePack vs JSON for the API</a></li>
						<li class="thingsdb9"><a href="#quiz-chapter-16" class="thingsdb10">16.5 Quiz - Challenge Your Understanding</a>
							<ol class="thingsdb11"><li class="thingsdb9"><a href="#answers-chapter-16" class="thingsdb10">16.5.1 Quiz - Answers</a></li></ol>
						</li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#closing-note" class="thingsdb10">Closing Note</a></li>
				<li class="thingsdb9"><a href="#appendix-i" class="thingsdb10">Appendix I - Chapter Data Import</a></li>
				<li class="thingsdb9"><a href="#appendix-ii" class="thingsdb10">Appendix II - Useful Links for ThingsDB</a>
					<ol class="thingsdb11">
						<li class="thingsdb9"><a href="#general-information" class="thingsdb10">General information</a></li>
						<li class="thingsdb9"><a href="#applications" class="thingsdb10">Applications</a></li>
						<li class="thingsdb9"><a href="#connectors" class="thingsdb10">Connectors</a></li>
						<li class="thingsdb9"><a href="#modules" class="thingsdb10">Modules</a></li>
						<li class="thingsdb9"><a href="#deployment" class="thingsdb10">Deployment</a></li>
						<li class="thingsdb9"><a href="#downloads" class="thingsdb10">Downloads</a></li>
					</ol>
				</li>
				<li class="thingsdb9"><a href="#about-the-author" class="thingsdb10">About the Author</a></li>
			</ol>
		</nav>
		<nav type="landmarks" id="landmarks" hidden="">
			<h2 class="thingsdb7">Landmarks</h2>
			<ol class="thingsdb12">
				<li class="thingsdb13"><a type="cover" href="#cover" class="thingsdb14">cover</a></li>
			</ol>
		</nav>
	</div>


<div class="thingsdb3" id="preface">
        <section type="preface" role="doc-preface" aria-labelledby="preface_h" id="thingsdb_link-276">
            <h2 id="thingsdb_link-277" class="thingsdb7">Preface</h2>
            <p class="copyright1">The primary objective of this book is to equip readers with a comprehensive
                understanding of how ThingsDB functions. It is not intended to be an all-inclusive
                reference guide and therefore does not cover every aspect of the platform. ThingsDB
                can be applied in a diverse range of applications, and once its potential is fully
                grasped, it has the power to inspire novel and innovative solutions. Our aim is to
                provide a balanced overview of ThingsDB's capabilities while also fostering
                creativity and encouraging readers to explore its multifaceted applications.</p>
            <p class="copyright1">Consistent with a simplified approach, we present code blocks in this book without
                syntax highlighting. While sophisticated IDEs like vscode and dedicated tools like
                <em class="thingsdb15">things-prompt</em> and <em class="thingsdb15">ThingsGUI</em> provide syntax highlighting, coloring
                known functions,
                punctuation, etc., we've adopted a more straightforward approach for this book.</p>
            <pre class="thingsdb16"><code class="prompt">Dark blue for prompts</code>
<code class="user">Orange for code that the user needs to enter</code>
<code class="comment">Green for comments</code>
<code class="response">Light blue for responses</code></pre>
            <p class="copyright1">The first five chapters of this book can be read independently of each other and can
                be skipped if you have a strong grasp of the concepts covered. You can assess your
                understanding by completing the quizzes at the end of each chapter. However, from
                chapter 6 until chapter 13, the book will focus on developing a "to-do" application
                using the "todos" collection. The concepts introduced in these chapters build upon
                each other, making it essential to follow them in sequence to execute the code
                examples and fully comprehend the presented material. If you really want to jump
                directly into a specific chapter, you can download the necessary collection state
                from our website, which is explained in
                <a href="#appendix-i" class="thingsdb14">Appendix I - Chapter Data Import.</a></p>
        </section>
    </div>


<div class="thingsdb3" id="installation">
        <section type="installation" role="doc-installation" aria-labelledby="installation_h" id="thingsdb_link-278">
            <h2 id="thingsdb_link-279" class="thingsdb7">Installation</h2>
            <p class="copyright1">Like with learning any programming language, ThingsDB requires a setup to
                execute code examples. This setup includes at least one ThingsDB node,
                which acts as the interpreter responsible for executing the code. Throughout
                the first chapters of this book, we will primarily communicate with ThingsDB
                using the <em class="thingsdb15">"things-prompt"</em> application, a tool designed for running small
                code snippets. As we progress, we will delve into more practical examples
                and explore the realm of event-driven programming, showcasing the true power
                of ThingsDB when interacting with other programming languages. While this
                book includes some Python examples, you are free to choose a language that
                suits your preference, such as C#, Go, PHP, JavaScript/Node.js or another
                supported language. The provided examples are relatively straightforward to
                adapt to other programming languages.</p>
        </section>
    </div>


<div class="thingsdb3" id="installation-node">
        <section type="installation" role="doc-installation" aria-labelledby="installation_node_h" id="thingsdb_link-280">
            <h3 id="thingsdb_link-281" class="title1">Installation - Node</h3>
            <p class="copyright1">The process running ThingsDB is called a node. ThingsDB is built to run across
                multiple nodes for high availability and scalability but for most chapters in
                this book, running a single node will suffice.</p>
            <p class="copyright1"><strong class="thingsdb17">Exploring Multiple Nodes:</strong></p>
            <p class="copyright1">If you are interested in experimenting with distributed setups, you can run
                multiple ThingsDB nodes on your machine. However, this involves manually setting
                up each node with unique data paths and ports (covered in detail in
                <a href="#chapter-15" class="thingsdb14">Chapter 15</a>).
                Be aware that this process can be cumbersome.</p>
            <p class="copyright1"><strong class="thingsdb17">Docker to the Rescue:</strong></p>
            <p class="copyright1">Docker offers a simpler and more efficient way to manage multiple ThingsDB nodes.
                Docker is a containerization platform that packages applications and their
                dependencies into self-contained units, ensuring consistent and portable
                environments.</p>
        </section>
    </div>


<div class="thingsdb3" id="installation-docker">
        <section type="installation" role="doc-installation" aria-labelledby="docker_h" id="thingsdb_link-282">
            <h4 id="thingsdb_link-283" class="title2">Docker</h4>
            <p class="copyright1">This guide will walk you through installing and running ThingsDB using Docker Compose,
                a convenient tool for managing Docker configurations.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1"><strong class="thingsdb17">Prefer manual installation?</strong> Skip this section and proceed to the guide for
                        installing ThingsDB from source code on your specific operating system
                        <a href="#installation-linux" class="thingsdb14">Linux</a>, <a href="#installation-mac" class="thingsdb14">Mac</a>, or <a href="#installation-windows" class="thingsdb14">Windows (WSL)</a>.
                        Choose the instructions that match your system.</p>
                </div>
            </div>
            <p class="copyright1">If you do not already have Docker installed, you can download it from
                here: <a href="https://docs.docker.com/get-docker/" class="thingsdb14">https://docs.docker.com/get-docker/</a></p>
            <p class="copyright1">Check your docker version: <em class="thingsdb15">(version 23 or higher is required)</em></p>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">docker -v</code>
<code class="response">Docker version 25.0.3, build 4debf41</code></pre>
            <p class="copyright1">Create a project directory and navigate to that directory:</p>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">mkdir thingsdb_book</code>
<code class="prompt">$</code> <code class="user">cd thingsdb_book</code>
<code class="prompt">~/thingsdb_book$</code></pre>
            <p class="copyright1">Paste the following content into a new file named <code class="inline">docker-compose.yml</code>
                in your project directory: (or download the file from here:
                <a href="https://docs.thingsdb.io/v1/book/docker-compose.yml" class="thingsdb14">https://docs.thingsdb.io/v1/book/docker-compose.yml</a>)
            </p>
            <pre class="thingsdb16"><code class="prompt">x-ti-template: &amp;ti
  image: ghcr.io/thingsdb/node
  restart: unless-stopped
  environment:
    - THINGSDB_BIND_CLIENT_ADDR = '::'
    - THINGSDB_BIND_NODE_ADDR = '::'
    - THINGSDB_HTTP_API_PORT = 9210
    - THINGSDB_HTTP_STATUS_PORT = 8080
    - THINGSDB_WS_PORT=9270
    - THINGSDB_MODULES_PATH = /modules/
    - THINGSDB_STORAGE_PATH = /data/
services:
  node0:
    &lt;&lt; : *ti
    hostname: node0
    container_name: node0
    command: "--init"
    ports:
      - 9200:9200
      - 9210:9210
      - 9270:9270
      - 8080:8080
    volumes:
      - ./node0/data:/data/
      - ./node0/modules:/modules/
      - ./node0/dump:/dump/</code>
<code class="comment">
## Uncomment the following sections to add more nodes (optional)
# node1:
#   &lt;&lt; : *ti
#   hostname: node1
#   container_name: node1
#   command: "--secret pass"
#   ports:
#     - 8081:8080
#   volumes:
#     - ./node1/data:/data/
#     - ./node1/modules:/modules/
#     - ./node1/dump:/dump/</code></pre>
            <p class="copyright1">Make sure you are in the directory where your
                <code class="inline">docker-compose.yml</code> file is located
                and run the following command to pull the image:</p>
            <pre class="thingsdb16"><code class="prompt">~/thingsdb_book$</code> <code class="user">docker compose pull</code>
<code class="response">â¦</code></pre>
            <p class="copyright1">Use this command to launch ThingsDB as a persistent background service:</p>
            <pre class="thingsdb16"><code class="prompt">~/thingsdb_book$</code> <code class="user">docker compose up -d</code>
<code class="response">[+] Running 1/1</code>
<code class="response">â Container node0  Started</code></pre>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">You'll see output indicating that the container is starting.
                        Don't worry if only one node is initially active;
                        you can learn about scaling to multiple nodes in <a href="#chapter-15" class="thingsdb14">Chapter 15</a>.</p>
                </div>
            </div>
            <p class="copyright1">You've successfully set up Docker. Let's move on to <a href="#installation-python" class="thingsdb14">installing Python</a>.</p>
        </section>
    </div>


<div class="thingsdb3" id="installation-linux">
        <section type="installation" role="doc-installation" aria-labelledby="installation_linux_h" id="thingsdb_link-284">
            <h4 id="thingsdb_link-285" class="title2">Linux</h4>
            <p class="copyright1">While building ThingsDB from source is possible on various Linux distributions,
                this documentation details the process for Ubuntu due to its popularity.
                We recognize other distributions might work, but they are outside the scope
                of this guide.</p>
                <p class="copyright1"><strong class="thingsdb17">Step 1: Update and Install Packages:</strong></p>
                <p class="copyright1">Start with updating the packages list:</p>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">sudo apt update</code>
<code class="response">â¦</code></pre>
            <p class="copyright1">Then, install the required packages:</p>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">sudo apt-get install -y \
    libuv1-dev \
    libpcre2-dev \
    libyajl-dev \
    libcurl4-nss-dev \
    libssl-dev \
    build-essential \
    cmake \
    git</code>
<code class="response">â¦</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Step 3: Clone and Build ThingsDB</strong></p>
            <p class="copyright1">Clone the ThingsDB repository:</p>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">git clone https://github.com/thingsdb/ThingsDB.git</code>
<code class="response">â¦</code></pre>
            <p class="copyright1">Build ThingsDB:</p>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">./ThingsDB/release-build.sh</code>
<code class="response">â¦</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Step 4: Create a Symlink (Optional)</strong></p>
            <p class="copyright1">To easily start ThingsDB from any directory, create a symlink:</p>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">sudo ln -sr ./ThingsDB/thingsdb /usr/bin/thingsdb</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Step 5: Verify Installation</strong></p>
            <p class="copyright1">Check if ThingsDB is installed correctly:</p>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">thingsdb --version</code>
<code class="response">   _____ _   _             ____  _____
  |_   _| |_|_|___ ___ ___|    \| __  |
    | | |   | |   | . |_ -|  |  | __ -|
    |_| |_|_|_|_|_|_  |___|____/|_____|   version: 1.6.0
                  |___|
ThingsDB Node 1.6.0
Maintainer: Jeroen van der Heijden &lt;jeroen@cesbit.com&gt;
Home-page: https://thingsdb.io</code></pre>
            <p class="copyright1">You've successfully built ThingsDB from source. Let's move on to <a href="#installation-python" class="thingsdb14">installing Python</a>.</p>
        </section>
    </div>


<div class="thingsdb3" id="installation-mac">
        <section type="installation" role="doc-installation" aria-labelledby="installation_mac_h" id="thingsdb_link-286">
            <h4 id="thingsdb_link-287" class="title2">Mac</h4>
            <p class="copyright1">The section describes building ThingsDB on MacOS.</p>
            <p class="copyright1"><strong class="thingsdb17">Prerequisites:</strong></p>
            <ul class="thingsdb18">
                <li class="editor"><strong class="thingsdb17">MacOS with Homebrew installed:</strong>
                    If you do not have Homebrew installed, follow the instructions on
                    <a href="https://brew.sh" class="thingsdb14">https://brew.sh</a></li>
                <li class="editor"><strong class="thingsdb17">An active Internet connection</strong></li>
            </ul>
            <p class="copyright1"><strong class="thingsdb17">Step 1: Update and Install Packages</strong></p>
            <p class="copyright1">Update the package lists:</p>
            <pre class="thingsdb16"><code class="prompt">%</code> <code class="user">brew update</code>
<code class="response">â¦</code></pre>
            <p class="copyright1">Then, install necessary packages:</p>
            <pre class="thingsdb16"><code class="prompt">%</code> <code class="user">brew install cmake libuv pcre2 yajl curl</code>
<code class="response">â¦</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Step 2: Clone and Build ThingsDB</strong></p>
            <p class="copyright1">Clone the ThingsDB repository:</p>
            <pre class="thingsdb16"><code class="prompt">%</code> <code class="user">git clone https://github.com/thingsdb/ThingsDB.git</code>
<code class="response">â¦</code></pre>
            <p class="copyright1">Build ThingsDB:</p>
            <pre class="thingsdb16"><code class="prompt">%</code> <code class="user">./ThingsDB/release-build.sh</code>
<code class="response">â¦</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Step 3: Create a Symlink (Optional)</strong></p>
            <p class="copyright1">To easily start ThingsDB from any directory, create a symlink:</p>
            <pre class="thingsdb16"><code class="prompt">%</code> <code class="user">ln -s ~/ThingsDB/thingsdb /opt/homebrew/bin/thingsdb</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Step 4: Verify Installation</strong></p>
            <p class="copyright1">Check if ThingsDB is installed correctly:</p>
            <pre class="thingsdb16"><code class="prompt">%</code> <code class="user">thingsdb --version</code>
<code class="response">   _____ _   _             ____  _____
  |_   _| |_|_|___ ___ ___|    \| __  |
    | | |   | |   | . |_ -|  |  | __ -|
    |_| |_|_|_|_|_|_  |___|____/|_____|   version: 1.6.0
                  |___|
ThingsDB Node 1.6.0
Maintainer: Jeroen van der Heijden &lt;jeroen@cesbit.com&gt;
Home-page: https://thingsdb.io</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Next Steps:</strong></p>
            <p class="copyright1">Now you can start ThingsDB by typing <code class="inline">thingsdb</code> in your terminal.
                Let's move on to <a href="#installation-python" class="thingsdb14">installing Python</a>.</p>
        </section>
    </div>


<div class="thingsdb3" id="installation-windows">
        <section type="installation" role="doc-installation" aria-labelledby="installation_windows_h" id="thingsdb_link-288">
            <h4 id="thingsdb_link-289" class="title2">Windows (WSL)</h4>
            <p class="copyright1">While ThingsDB does not run natively on Windows, you can leverage
                WSL (Windows Subsystem for Linux) to create a Linux environment
                and enjoy all its functionalities! Here's how:</p>
            <p class="copyright1"><strong class="thingsdb17">Prerequisites:</strong></p>
            <ul class="thingsdb18">
                <li class="editor"><strong class="thingsdb17">Windows 10 version 1903 or later (with WSL 2 enabled):</strong>
                    Check your version and enable WSL if needed:
                    <a href="https://learn.microsoft.com/en-us/windows/wsl/" class="thingsdb14">https://learn.microsoft.com/en-us/windows/wsl/</a>
                </li>
                <li class="editor"><strong class="thingsdb17">An active Internet connection</strong></li>
            </ul>
            <p class="copyright1"><strong class="thingsdb17">Step 1: Install Ubuntu</strong></p>
            <p class="copyright1">Open a PowerShell window and run:</p>
            <pre class="thingsdb16"><code class="prompt">PS C:\Users\admin&gt;</code> <code class="user">wsl --install -d Ubuntu</code>
<code class="response">Installing: Ubuntu</code>
<code class="response">â¦</code></pre>
            <p class="copyright1">Follow the on-screen instructions to provide a username and password for your Ubuntu environment.</p>
            <p class="copyright1"><strong class="thingsdb17">Step 2: Update and Install Packages</strong></p>
            <p class="copyright1">Once Ubuntu is installed, open a WSL terminal
                (start menu &gt; search for "Ubuntu") and update the package lists:</p>
            <pre class="thingsdb16"><code class="prompt">ti@LAPTOP:~$</code> <code class="user">sudo apt update</code>
<code class="response">â¦</code></pre>
            <p class="copyright1">Then, install necessary packages:</p>
            <pre class="thingsdb16"><code class="prompt">ti@LAPTOP:~$</code> <code class="user">sudo apt-get install -y \
    libuv1-dev \
    libpcre2-dev \
    libyajl-dev \
    libcurl4-nss-dev \
    libssl-dev \
    build-essential \
    cmake</code>
<code class="response">â¦</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Step 3: Clone and Build ThingsDB</strong></p>
            <p class="copyright1">Clone the ThingsDB repository:</p>
            <pre class="thingsdb16"><code class="prompt">ti@LAPTOP:~$</code> <code class="user">git clone https://github.com/thingsdb/ThingsDB.git</code>
<code class="response">â¦</code></pre>
            <p class="copyright1">Build ThingsDB:</p>
            <pre class="thingsdb16"><code class="prompt">ti@LAPTOP:~$</code> <code class="user">./ThingsDB/release-build.sh</code>
<code class="response">â¦</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Step 4: Create a Symlink (Optional)</strong></p>
            <p class="copyright1">To easily start ThingsDB from any directory, create a symlink:</p>
            <pre class="thingsdb16"><code class="prompt">ti@LAPTOP:~$</code> <code class="user">sudo ln -sr ./ThingsDB/thingsdb /usr/bin/thingsdb</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Step 5: Verify Installation</strong></p>
            <p class="copyright1">Check if ThingsDB is installed correctly:</p>
<pre class="thingsdb16"><code class="prompt">ti@LAPTOP:~$</code> <code class="user">thingsdb --version</code>
<code class="response">   _____ _   _             ____  _____
  |_   _| |_|_|___ ___ ___|    \| __  |
    | | |   | |   | . |_ -|  |  | __ -|
    |_| |_|_|_|_|_|_  |___|____/|_____|   version: 1.6.0
                  |___|
ThingsDB Node 1.6.0
Maintainer: Jeroen van der Heijden &lt;jeroen@cesbit.com&gt;
Home-page: https://thingsdb.io</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Next Steps:</strong></p>
            <p class="copyright1">Now you can start ThingsDB by typing <code class="inline">thingsdb</code> in your
                WSL terminal.
                Remember to open a WSL terminal (e.g., Ubuntu)
                every time you want to use ThingsDB.</p>
        </section>
    </div>


<div class="thingsdb3" id="installation-python">
        <section type="installation" role="doc-installation" aria-labelledby="installation_python_h" id="thingsdb_link-290">
            <h3 id="thingsdb_link-291" class="title1">Installation - Python</h3>
            <p class="copyright1">While the code examples in this book are compatible with Python
                versions as old as 3.7, it is recommended to use version 3.8 or
                higher to ensure optimal performance and stability. We won't
                cover the complete Python installation process in this guide, as
                there is plenty of documentation available online. You should
                also check if Python is already installed on your system as it
                is often pre-installed.</p>
            <p class="copyright1">After installing Python, install PIP as well. PIP is the package
                manager for Python and is the simplest way to install the
                ThingsDB Python module. You can install the module using the
                following command:</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">MacOS and some Linux distributions like Debian 12 have an older version of
                        Python pre-installed. To ensure you are working with Python 3 and avoid compatibility
                        issues, use <code class="inline1">pip3</code> and <code class="inline1">python3</code> for
                        managing your packages on these systems.</p>
                </div>
            </div>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">pip install python-thingsdb</code>
<code class="response">â¦</code>
<code class="response">Successfully installed deprecation-2.1.0 msgpack-1.0.7 python-thingsdb-1.0.7</code></pre>
            <p class="copyright1">To verify that the installation was successful, open Python and try
                to import the Client from the thingsdb module.</p>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python</code>
<code class="prompt">&gt;&gt;&gt;</code> <code class="user">from thingsdb.client import Client</code>
<code class="prompt">&gt;&gt;&gt;</code></pre>
            <p class="copyright1">If this command runs without errors, the installation was successful.</p>
        </section>
    </div>


<div class="thingsdb3" id="installation-thingsdb-prompt">
        <section type="installation" role="doc-installation" aria-labelledby="installation_prompt_h" id="thingsdb_link-292">
            <h3 id="thingsdb_link-293" class="title1">Installation - ThingsDB Prompt</h3>
            <p class="copyright1">Just like installing the ThingsDB Client module, you can install ThingsDB Prompt using PIP,
                Python's package manager.</p>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">pip install thingsprompt</code>
<code class="response">â¦</code>
<code class="response">Successfully installed install-1.3.5 setproctitle-1.3.3 thingsprompt-1.0.9</code></pre>
            <p class="copyright1">Once the installation is complete, ThingsDB Prompt will be installed in your
                system's PATH. You should now be able to run it directly from your terminal.
                To verify the installation, run the following command:</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">For users encountering issues executing the <code class="inline1">things-prompt</code> command due to the
                        script directory not being included in their system's PATH environment variable,
                        an alternative invocation method exists. Users can bypass the PATH requirement
                        by directly invoking the module via <code class="inline1">python -m thingsprompt</code> (note the lack of hyphen).
                        This approach is particularly advantageous in scenarios where multiple Python
                        environments host ThingsDB Prompt installations, and precise environment selection is crucial.</p>
                </div>
            </div>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">things-prompt --version</code>
<code class="response">1.0.9</code></pre>
            <p class="copyright1">If the version is displayed, the installation was successful.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">There is also a ThingsGUI application for communicating with ThingsDB.
                        This application is more user-friendly and visually appealing than the
                        ThingsDB Prompt. However, we won't explicitly use or document the
                        ThingsGUI in this book's examples, simply because we prefer to demonstrate
                        code examples. Nonetheless, keep in mind that this tool is available if
                        you prefer a graphical and easy to use interface.</p>
                </div>
            </div>
        </section>
    </div>


<div class="thingsdb3" id="getting-started">
        <section type="installation" role="doc-installation" aria-labelledby="getting_started_h" id="thingsdb_link-294">
            <h2 id="thingsdb_link-295" class="thingsdb7">Getting Started - Initial Setup</h2>
            <p class="copyright1">If you have not launched ThingsDB before, you will need to invoke
                the <code class="inline">--init</code> argument to initiate the creation
                of necessary files within a designated data directory, serving as the
                repository for all ThingsDB entities.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">If you are using Docker Compose as described in the <a href="#installation-docker" class="thingsdb14">Docker</a>
                        installation section, navigate to your <code class="inline1">docker-compose.yml</code>
                        directory and run: <code class="inline1">docker compose up -d</code></p>
                    <p class="author1">This starts ThingsDB in the background, automatically initializing it with the
                        <code class="inline1">--init</code> argument, ensuring it's ready for use.</p>
                </div>
            </div>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">thingsdb --init</code>
<code class="response">   _____ _   _             ____  _____
  |_   _| |_|_|___ ___ ___|    \| __  |
    | | |   | |   | . |_ -|  |  | __ -|
    |_| |_|_|_|_|_|_  |___|____/|_____|   version: 1.6.0
                  |___|</code></pre>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">This book is written based on ThingsDB version 1.6.0, and some examples
                        may not work with older versions. It is always best to use the latest
                        version of ThingsDB to ensure compatibility and avoid potential issues.</p>
                </div>
            </div>
            <p class="copyright1">In a separate shell, we can establish a connection to ThingsDB using the <em class="thingsdb15">things-prompt</em>
                tool. We'll utilize this tool for some straightforward exercises in this book.
                The <em class="thingsdb15">things-prompt</em> is one of several methods for interacting with the interpreter.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">For more intricate (and real-world) examples, we'll employ Python code
                        examples due to their ease of comprehension. If you wish to follow the code
                        examples in this book, it is advisable to <a href="#installation-python" class="thingsdb14">install Python</a>
                        and the ThingsDB client (python-thingsdb) library. However, you are free to utilize any programming language you prefer, as the focus will be on the ThingsDB code itself, not the specific Python code.</p>
                </div>
            </div>
            <p class="copyright1">Okay, lets connect to the ThingsDB interpreter:</p>
            <pre class="thingsdb16"><code class="prompt">$</code> <code class="user">things-prompt -u admin -p pass -s //stuff</code>
<code class="prompt">127.0.0.1:9200 (//stuff)&gt;</code></pre>
            <p class="copyright1">To use the command we must specify a username with the <code class="inline">-u</code>
                argument. Optionally, we can also provide a password using the <code class="inline">-p</code>
                argument (if not given, the prompt will ask for the password). We can also provide a scope
                with the <code class="inline">-s</code> argument and choose the <code class="inline">//stuff</code>
                scope which represents the "stuff" collection. A <em class="thingsdb15">collection</em> acts like a container for your data,
                it is the place where things are stored. You can create as many collections as you need.
                When you start ThingsDB for the first time, a single collection "stuff" is created
                which is used in this first example.</p>
            <p class="copyright1">The prompt shows the IP address (or hostname) of the ThingsDB <em class="thingsdb15">node</em> you are connected to.
                It also includes the port number and the scope where the queries will run in.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">In many cases, it is unnecessary to display connection information in the
                        prompt. Therefore, ThingsDB Prompt provides an optional argument,
                        <code class="inline1">--hide-connection-info</code>, which suppresses the display of the connection address and port. In this book, we'll utilize this argument for cleaner code examples.</p>
                </div>
            </div>
            <p class="copyright1">If you start using ThingsDB in a production environment, you should start with more
                than one node, preferably three or more. ThingsDB is designed from the start to run
                on multiple nodes and utilizes multiple nodes to perform, for example, garbage
                collection without blocking! Garbage collection is a problem for languages like
                Python, Go and JavaScript. Although it is usually fast, it might result in shortly
                blocking applications, especially when the application requires a lot of memory due
                to the initialization of many objects. ThingsDB has solved this problem by ensuring
                garbage collection will never run on more than one node at the same time. Queries
                which are received by the node who is busy with garbage collection will forward the
                query to another node so your client will not notice anything. The same technique is
                used for creating backups as well.</p>
            <p class="copyright1">Congratulations! You're now equipped to embark on your ThingsDB journey. With this
                book as your guide, you'll gain a comprehensive understanding of this powerful data
                management solution and its capabilities. So, dive in, explore the concepts, and let
                ThingsDB unleash your creativity and innovation.</p>
        </section>
    </div>


<div class="thingsdb3" id="thingsdb_link-257">
<section type="chapter" role="doc-chapter" aria-labelledby="ch01_h" id="thingsdb_link-296">
    <h2 id="chapter-1" class="thingsdb7">Chapter 1 - Introduction to ThingsDB</h2>
    <p class="copyright1">While ThingsDB is technically a programming language, it breaks the mold by not being
        primarily designed for writing traditional programs. Instead, it is geared towards
        providing developers with an intuitive and flexible approach to storing and
        retrieving data. This might seem more akin to SQL, another language primarily
        focused on data management. However, ThingsDB's syntax and structure closely
        resemble programming languages like JavaScript and Python, making it accessible to
        developers familiar with those paradigms.</p>
    <p class="copyright1">ThingsDB shines as the connecting force within your application, integrating various
        components seamlessly. Unlike managing separate relational databases and message
        brokers, ThingsDB offers a unified solution. It provides relational data storage for
        structured information, a built-in pub/sub system for real-time event handling, and
        scheduled task automation. This simplifies your architecture and eliminates the need
        for multiple tools.</p>
    <p class="copyright1">ThingsDB excels at scaling to ensure high availability, keeping your application
        running smoothly even under load. However, for specialized data like large logs or
        time-series data, dedicated databases might be more suitable. In such cases,
        ThingsDB's strength lies in its modular connectivity. You can connect to various
        external databases using pre-built or custom modules, giving you fine-grained
        control over data storage and retrieval, ensuring the right tool for the
        right job.</p>
    <div class="note">
        <img class="note1" src="images/idea.png" alt="Note" />
        <div class="content">
            <p class="author1">As a compelling example of its versatility, ThingsDB is employed by
                InfraSonar (<a href="https://infrasonar.com" class="thingsdb14">https://infrasonar.com</a>),
                a comprehensive monitoring solution designed to handle complex and expansive
                infrastructures. In this context, ThingsDB functions as a robust back-end
                solution, where critical business logic resides alongside relational data.
                Additionally, it serves as a pivotal communication hub, orchestrating
                interactions between microservices and handling the timely dissemination of
                notifications and messages.</p>
        </div>
    </div>
    <p class="copyright1">In contrast to languages like C/C++, Go, and Rust, which require compilation before
        execution, ThingsDB utilizes an interpreter much like, for example, Python. However,
        ThingsDB distinguishes itself from other interpreted languages by maintaining state
        persistence, ensuring uninterrupted data access and manipulation even after script
        termination.</p>
    <p class="copyright1">To better grasp this concept, consider what transpires when Python is launched.</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python</code>
<code class="response">â¦</code>
<code class="prompt">&gt;&gt;&gt;</code> <code class="user">value = 'Remember me'</code></pre>
    <p class="copyright1">Upon assigning the string <code class="inline">"Remember me"</code> to the variable
        <code class="inline">value</code>, Python retains this
        value as long as the interpreter remains open. To verify this, you can execute the
        following code snippet:</p>
<pre class="thingsdb16"><code class="prompt">&gt;&gt;&gt;</code> <code class="user">print(value)</code>
<code class="response">Remember me</code></pre>
    <p class="copyright1">However, if we terminate the interpreter and relaunch Python, our
        <code class="inline">value</code> variable will be permanently lost:</p>
<pre class="thingsdb16"><code class="prompt">&gt;&gt;&gt;</code> <code class="user">exit()</code>
<code class="response"></code>
<code class="prompt">$</code> <code class="user">python</code>
<code class="response">â¦</code>
<code class="prompt">&gt;&gt;&gt;</code> <code class="user">print(value)</code>
<code class="response">Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
NameError: name value is not defined</code></pre>
    <p class="copyright1">We encounter an error message indicating that the variable <code class="inline">value</code> is undefined. To
        retain this value, a programming language like Python must resort to external
        mechanisms such as writing the value to a file and reading from a file or
        utilizing a database connection.</p>
    <p class="copyright1">This is where ThingsDB emerges as a solution. Similar to Python, ThingsDB is a
        programming language with a rich feature set encompassing task scheduling, type
        definitions, procedures, pub/sub system, and much more. Before delving into the
        technical details, let's examine how the aforementioned example would be
        implemented using ThingsDB.</p>
    <p class="copyright1">The following code shows how to assign and store a variable:</p>
    <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">.value = 'Remember me';</code>
<code class="response">"Remember me"</code></pre>
    <p class="copyright1">Notice the dot (<code class="inline">.</code>) in front of <code class="inline">.value</code>,
        this dot is important because it tells
        ThingsDB to create a property to our collection object. The property in this
        example is <code class="inline">value</code> and the actual value of the property is a
        string <code class="inline">"Remember me"</code>. It is important to understand that
        without the dot (<code class="inline">.</code>) in front of value, we
        would have created a variable, just like we did in Python.</p>
    <p class="copyright1">We also finished our statement with a semicolon (<code class="inline">;</code>).
        Although ThingsDB can be forgiving when you forget the semicolon at the end
        (in fact, the code above would yield the same result when omitting the semicolon)
        you should <em class="thingsdb15">always</em> end your statements with a semicolon to prevent unwanted behavior.</p>
    <p class="copyright1">In the example we also used a single space before and after the equal
        sign (<code class="inline">=</code>). This white space is ignored by ThingsDB and could
        be left out, or multiple spaces or even tabs and newlines would not make any difference.
        The code below, for example, doesn't look very appealing, but is just as valid as the
        example above.</p>
    <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">.  value
    =
  'Remember me'
;</code>
<code class="response">"Remember me"</code></pre>
    <div class="note">
        <img class="note1" src="images/idea.png" alt="Note" />
        <div class="content">
            <p class="author1">If you need to insert newlines within your command, you can use the CTRL+n keyboard shortcut.</p>
        </div>
    </div>
    <p class="copyright1">Now that we have assigned the property value to the root of the collection,
        exit the prompt by pressing <span class="user1">CTRL+d</span>.</p>
    <p class="copyright1">Stop ThingsDB <em class="thingsdb15">(Choose the method that matches your setup)</em>:</p>
    <ul class="thingsdb18">
        <li class="editor"><strong class="thingsdb17">Without Docker:</strong> Press <span class="user1">CTRL+c</span> in the terminal where ThingsDB is running.</li>
        <li class="editor"><strong class="thingsdb17">With Docker Compose:</strong> Navigate to the directory containing your <code class="inline">docker-compose.yml</code> file and run <code class="inline">docker compose stop</code>.</li>
    </ul>
    <p class="copyright1">Now start ThingsDB again and also start the prompt again.</p>
    <div class="note">
        <img class="note1" src="images/idea.png" alt="Note" />
        <div class="content">
            <p class="author1">You do not need the <code class="inline1">--init</code> argument anymore although this argument
                will be ignored when ThingsDB is already initialized. If you really want to re-initialize
                ThingsDB then you could also add the <code class="inline1">--force</code> argument.
                This would remove all ThingsDB data and start a clean node!</p>
        </div>
    </div>
<pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">.value;</code>
<code class="response">"Remember me"</code></pre>
    <p class="copyright1">As you can see, ThingsDB still knows about the property <code class="inline">value</code>.
        You might also notice that however this example is very simple, the syntax is more
        comparable with programming languages than it is with something like SQL.</p>
    <p class="copyright1">You might also wonder how the client is able to perform the query. The protocol for
        communication with ThingsDB is done with MessagePack. ThingsDB follows the same
        rules as MessagePack. Strings are assumed to be UTF8. This, however, is not guaranteed
        by ThingsDB but depends on if the MessagePack protocol is correctly followed. Usually,
        when working with a trusted client, this is the case. If you are not sure about this,
        ThingsDB has a function <code class="inline">is_utf8()</code> to test if a string
        really is UTF8. It also can define this on a type but we shall explore types later.
        Besides MessagePack, ThingsDB has support for JSON but this is strictly used for
        the HTTP API.</p>
    <p class="copyright1">In the code sample below we verify that <code class="inline">.value</code> contains a
        string with valid UTF-8 encoding:</p>
    <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">is_utf8(.value);</code>
<code class="response">true</code></pre>
    <p class="copyright1">If we want to know which type <code class="inline">.value</code> was, we could use
        the <code class="inline">type()</code> function.
        This function always returns a string with type information.</p>
    <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">type(.value);</code>
<code class="response">"str"</code></pre>
    <p class="copyright1">In ThingsDB it is allowed to use statements as arguments. The code below shows that
        the <code class="inline">is_utf8()</code> function returns with a boolean value:</p>
    <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">type(is_utf8(.value));</code>
<code class="response">"bool"</code></pre>
    <p class="copyright1">Where is the property "value" stored?</p>
    <section>
        <h3 id="chapter-1-1" class="title1">1.1 Things and Why ThingsDB</h3>
        <p class="copyright1">As we mentioned earlier, the <code class="inline">value</code> has been assigned to the
            root object. We refer to these objects as <em class="thingsdb15">"things"</em>, which explains the name ThingsDB.
            Every collection has a root which is a regular thing. It is not possible to remove the root,
            unless you choose to remove the complete collection. Every stored thing also receives a
            unique ID from ThingsDB. To see which ID our collection has, you can use the
            <code class="inline">id()</code> method.</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">.id();</code>
<code class="response">1</code></pre>
        <p class="copyright1">The initial <em class="thingsdb15">stuff</em> collection most likely has ID 1, but it might be different on your computer
            depending on the version of ThingsDB used when the collection was created. We also start the
            method <code class="inline">id()</code> with a dot (<code class="inline">.</code>) in front of it.
            That is because <code class="inline">id()</code> is a method of a thing object.</p>
    </section>
    <section>
        <h3 id="chapter-1-2" class="title1">1.2 Code Blocks</h3>
        <p class="copyright1">ThingsDB enables the placement of code within code blocks, which are enclosed by curly braces
            <code class="inline">{}</code> and must contain at least one statement. It is crucial to note
            that code blocks themselves are interpreted as statements, and, consequently, must be terminated
            with a semicolon.</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code>
<code class="user">{
  .value = 'Remember me';
};</code>  <code class="comment">// this semicolon ends the "block" statement</code>
<code class="response">"Remember me"</code></pre>
        <p class="copyright1">Code blocks enable the grouping of statements, which can be particularly beneficial when employed
            in conjunction with conditional statements (<code class="inline">if</code>-statements), iteration
            constructs (<code class="inline">for</code>-loops), or closures, all of which are detailed in
            subsequent chapters.</p>
    </section>
    <section>
        <h3 id="chapter-1-3" class="title1">1.3 Variables and Properties</h3>
        <p class="copyright1">Just as we did in Python, we can also assign a value to a variable.</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">value = "I'm a variable";</code>
<code class="response">"I'm a variable"</code></pre>
        <p class="copyright1">Without the dot, this is just a variable. Variables only exist within a single query.
            Therefore we cannot ask for <code class="inline">value</code> in the next query. If we did,
            ThingsDB would return with a LookupError.</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">value;</code>
<code class="response">LookupError: variable `value` is undefined</code></pre>
        <p class="copyright1">In this example we used value as the name of our variable. Note that this can be named as you wish,
            for example, <code class="inline">x</code>, <code class="inline">y</code>, <code class="inline">Foo</code>,
            <code class="inline">myValue</code> and <code class="inline">my_value</code> are all good examples of
            variable names. Variables, like almost everything in ThingsDB, are case sensitive. This means
            that <code class="inline">VALUE</code> is not the same as <code class="inline">value</code> and they
            both can exist as different variables. A variable must start with a charter of a-z (or capital A-Z) or
            an underscore (_) and may be followed by the same or a number. The variable is not allowed to start
            with a number.</p>
        <p class="copyright1">Here are some examples:</p>
        <pre class="thingsdb16"><code class="user">dog = nil;</code>        <code class="comment">// valid</code>
<code class="user">Dog = nil;</code>        <code class="comment">// valid</code>
<code class="user">_dog = nil;</code>       <code class="comment">// valid</code>
<code class="user">cat-or-dog = nil;</code> <code class="comment">// invalid &ndash; no hyphen (-) allowed in a variable name</code>
<code class="user">catOrDog = nil;</code>   <code class="comment">// valid</code>
<code class="user">cat_or_dog = nil;</code> <code class="comment">// valid</code>
<code class="user">2dogs = nil;</code>      <code class="comment">// invalid &ndash; a variable name must not start with a number</code>
</pre>
        <p class="copyright1">The code above also includes comments, which are denoted by the <code class="inline">//</code> prefix.
            Everything behind the <code class="inline">//</code> on a line will be disregarded by ThingsDB.
            An alternative comment syntax using <code class="inline">/*</code> and <code class="inline">*/</code>
            allows for comments spanning multiple lines. However, in this book, we'll primarily utilize
            the <code class="inline">//</code> syntax, as it is less prone to errors and avoids the risk of
            forgetting to close the comment section.</p>
        <p class="copyright1">Properties, on the other hand, have different naming rules. Almost anything is possible except for a
            few reserved single character names. For example, we can't use <code class="inline">#</code> as this
            is a reserved property name and is being used by ThingsDB to expose the ID. Keep in mind that it is
            possible to create a property which starts with a reserved character. For example, the
            property <code class="inline">"# 007"</code> is valid and can be used but if we wanted to assign this
            property, we can't just write it like before as this syntax is invalid.</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">.# 007 = "James Bond";</code>
<code class="response">SyntaxError: error at line 1, position 1, unexpected character `#`</code></pre>
        <p class="copyright1">Instead, we can use the method <code class="inline">set(key, value)</code> which is available on every
            object of type thing.</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">.set("# 007", "James Bond");</code>
<code class="response">"James Bond"</code></pre>
        <p class="copyright1">If we need to read the property, we require the <code class="inline">get(key)</code> method.</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">.get("# 007");</code>
<code class="response">"James Bond"</code></pre>
        <p class="copyright1">The <code class="inline">get()</code> method is also useful for when you are not sure a property exists.
            By default, the return value is <code class="inline">nil</code> for when a property is not found.</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">.get("I do not exist");</code>
<code class="response">null</code></pre>
        <p class="copyright1">Did you notice I mentioned <code class="inline">nil</code>? Well, the output shows <code class="inline">null</code>,
            so let's clarify the situation. The reason for seeing <code class="inline">null</code> is that our prompt is
            written in Python, where "nil" is called "None". However, when the output is converted to JSON format for
            display in the console, JSON uses <code class="inline">null</code> to represent the <code class="inline">None</code>
            type. Be mindful of this when translating between different programming languages.</p>
        <p class="copyright1">If we wanted an alternative value we could provide the <code class="inline">get()</code> method with an
            alternative value.</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">.get("I do not exist", "but I do");</code>
<code class="response">"but I do"</code></pre>
    </section>
    <section>
        <h3 id="chapter-1-4" class="title1">1.4 Lazy Arguments Evaluation</h3>
        <p class="copyright1">Arguments to build-in methods and functions in ThingsDB are lazy evaluated. Lazy arguments evaluation
            means that the code which is used as the argument is not executed in case the argument is not being used.
            In case of the <code class="inline">get()</code> method this means that we are allowed to raise an error
            as the second argument which will only be executed in case the property is not found.</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">.get("foo", raise(lookup_err()));</code>
<code class="response">LookupError: requested resource not found</code></pre>
        <p class="copyright1">The error is raised because the property <code class="inline">"foo"</code> does not exist. If we would use
            the same code with a property which does exist, no exception would be raised. </p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">.get("# 007", raise(lookup_err()));</code>
<code class="response">"James Bond"</code></pre>
        <p class="copyright1">We don't go into detail for the code to raise an error. For now it is enough to see lazy evaluation of method
            and function arguments at work.</p>
    </section>
    <section>
        <h3 id="chapter-1-5" class="title1">1.5 Query Response</h3>
        <p class="copyright1">Up to this point, the code snippets presented for each query involved single statements, and the response
            reflected the output of that statement. However, query code in ThingsDB can encompass as many statements
            as needed. The query response always encapsulates the outcome of the final executed statement. Typically,
            this refers to the last statement in the provided code, unless an exception is triggered or
            the <code class="inline">return</code> keyword is explicitly utilized.</p>
        <p class="copyright1">Consider these examples:</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code>  <code class="comment">// press CTRL+n for a new line</code>
<code class="user">1 / 0;</code>
<code class="user">"Hello!";</code>
<code class="response">ZeroDivisionError: division or modulo by zero</code></pre>
        <p class="copyright1">In this instance, the division by zero raises an exception, and the subsequent
            statement, <code class="inline">"Hello!"</code>, is not executed. The response, therefore, reflects the
            error message generated by the exception.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">Technically, an error response in ThingsDB is not merely a message but a distinct protocol type.
                    This distinction enables clients to discern error responses and handle them appropriately,
                    separate from valid data responses.</p>
            </div>
        </div>
        <p class="copyright1">On the other hand, if the <code class="inline">return</code> keyword is explicitly used to terminate
            the query, the response will be the value specified by the return statement:</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code>
<code class="user">return 123;</code>
<code class="user">"Hi!";</code>
<code class="response">123</code></pre>
        <p class="copyright1">Here, the <code class="inline">return</code> statement halts the execution of the query and delivers the
            value <code class="inline">123</code> as the response, effectively skipping the subsequent
            statement, <code class="inline">"Hi!"</code>.</p>
        <p class="copyright1">In summary, the response of a ThingsDB query mirrors the outcome of the final executed statement,
            unless an exception arises or the <code class="inline">return</code> keyword is explicitly employed.
            This flexibility allows for more complex and versatile query operations.</p>
    </section>
    <section>
        <h3 id="chapter-1-6" class="title1">1.6 Scopes</h3>
        <p class="copyright1">Before we dive deeper into the ThingsDB language, we must first explain more about scopes. The example
            above uses the "stuff" collection, which is automatically created on a new ThingsDB initialization.
            As mentioned before, a collection is the place where data is stored. If you like to compare with SQL
            then you can think of a collection like a database. In SQL, you may have multiple databases running
            on a single SQL instance and in ThingsDB you can have multiple collections.</p>
        <p class="copyright1">ThingsDB creates a unique scope for each collection. The full scope name for the "stuff" collection
            is <code class="inline">/collection/stuff</code>. You can shorten the prefix "collection" or even omit
            it altogether, so <code class="inline">/c/stuff</code> and <code class="inline">//stuff</code> are considered
            equivalent scopes. Additionally, you can use the "@" symbol to represent a scope. This syntax replaces
            the first "/" with "@" and the second with a semicolon, resulting in <code class="inline">@collection:stuff</code>
            or <code class="inline">@:stuff</code> for short.</p>
        <p class="copyright1">Management of collections happens within the <code class="inline">/thingsdb</code> scope. ThingsDB allows
            you to abbreviate this scope name as much as you like, so you might commonly see the shortened
            version <code class="inline">/t</code> being used. Similarly to the collection scope example, you can
            also use the "@" symbol. So, <code class="inline">/thingsdb</code>, <code class="inline">@thingsdb</code>,
            <code class="inline">/t</code>, and <code class="inline">@t</code> all refer to the same scope.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">In the early days of ThingsDB, only full scope names using the <code class="inline1">@</code> syntax
                    were permitted. The <code class="inline1">@</code> symbol was chosen because it is an unused character
                    in the ThingsDB language, leaving open the possibility of implementing it as a native scope definition
                    within the language. With the introduction of the HTTP API, however, the
                    slash (<code class="inline1">/</code>) syntax became more prevalent, as it aligns more closely with
                    standard URL conventions. Recognizing the inconvenience of typing out lengthy scope names repeatedly,
                    the developers decided to allow abbreviated scope names to enhance the user experience.</p>
            </div>
        </div>
        <p class="copyright1">For switching within the prompt, we must use the @ syntax since otherwise the prompt does not understand that
            we want to switch from scope. This is because the "@" character is not part of the ThingsDB language and thus
            can be recognized by the prompt as a different action.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">In addition to collection scopes and the <code class="inline1">/thingsdb</code> scope, ThingsDB provides
                    a third type of scope specifically designed for retrieving node information. These node scopes can also
                    be employed to execute certain node-specific tasks, such as creating backups or dynamically adjusting
                    the logging level for a node.</p>
            </div>
        </div>
        <p class="copyright1">Let's switch the prompt to the <code class="inline">@thingsdb</code> scope:</p>
        <pre class="thingsdb16"><code class="prompt">(//stuff)&gt;</code> <code class="user">@t</code>
<code class="prompt">(@t)&gt;</code></pre>
        <p class="copyright1">We see that we switched to another scope. The <code class="inline">@thingsdb</code> scope is not able to store
            regular data as it contains no root object (thing) to attach properties to.</p>
        <pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">.cat = 'Leo';</code>
<code class="response">LookupError: the `root` of the `@thingsdb` scope is inaccessible; you might want to query a `@collection` scope?</code></pre>
        <p class="copyright1">Instead, we use the <code class="inline">@thingsdb</code> scope to manage users, access rights, collections,
            modules, nodes and more.</p>
        <p class="copyright1">For now we do not go into details but we create a new empty collection using
            the <code class="inline">new_collection()</code> function which is available in
            the <code class="inline">@thingsdb</code> scope.</p>
        <pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">new_collection('chapter2');</code>
<code class="response">"chapter2"</code></pre>
        <p class="copyright1">The return value is the name for the newly created collection. While internally ThingsDB assigns a unique ID to
            the collection for communication purposes, it is the name that you will use for interactions with the collection.
            In the next chapter we shall use the collection we have just created.</p>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-250">
<section>
    <h3 id="quiz-chapter-1" class="title1">1.7 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">How is ThingsDB different from other databases and programming languages?</p></li>
        <li class="thingsdb13"><p class="copyright1">What is the purpose of the <code class="inline">--init</code> argument when starting a ThingsDB node?</p></li>
        <li class="thingsdb13">
            <p class="copyright1">The provided code contains a mistake. Can you identify and correct it?</p>
            <p class="quizcode"><code class="inline">{a = 1;} b = 2;</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Suppose we have the following code:</p>
            <p class="quizcode"><code class="inline">a = 1; .b = 2;</code></p>
            <p class="copyright1">Which sentence is correct?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Both <code class="inline">a</code> and <code class="inline">b</code> are variable</li>
                <li class="thingsdb13">Both <code class="inline">a</code> and <code class="inline">b</code> are properties of the collection root</li>
                <li class="thingsdb13"><code class="inline">a</code> is a property of the collection root and <code class="inline">b</code> is a variable</li>
                <li class="thingsdb13"><code class="inline">a</code> is a variable and <code class="inline">b</code> is a property of the collection root</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Which of the following are valid variable names?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">4you</code></li>
                <li class="thingsdb13"><code class="inline">_Color</code></li>
                <li class="thingsdb13"><code class="inline">my-hobby</code></li>
                <li class="thingsdb13"><code class="inline">P</code></li>
                <li class="thingsdb13"><code class="inline">Mode_1</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">What is the value of property <code class="inline">x</code> after executing the following code?</p>
            <p class="quizcode"><code class="inline">.x = 1; .get("x", .x = 2);</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">What comprises the response generated by a query?</p></li>
        <li class="thingsdb13"><p class="copyright1">Is it possible to create a property <code class="inline">user</code> with the value <code class="inline">"Alice"</code> while using the <code class="inline">@thingsdb</code> scope?</p></li>
        <li class="thingsdb13"><p class="copyright1">Which scope can be used to execute the following code? <em class="thingsdb15">(multiple answers are possible)</em></p>
            <p class="quizcode"><code class="inline">new_collection("book");</code></p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">/t</code></li>
                <li class="thingsdb13"><code class="inline">@:t</code></li>
                <li class="thingsdb13"><code class="inline">//thingsdb</code></li>
                <li class="thingsdb13"><code class="inline">@things</code></li>
                <li class="thingsdb13"><code class="inline">/node</code></li>
            </ol>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-1">
<section>
    <h4 id="answers-chapter-1" class="title2">1.7.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">ThingsDB is different in that it uses a distributed interpreter which preserves its state making it a programming language with database capabilities.</p></li>
        <li class="thingsdb13"><p class="copyright1">The <code class="inline">--init</code> argument is essential when initiating ThingsDB for the first time. It establishes the data path and creates a foundational collection. Subsequent invocations of ThingsDB with the <code class="inline">--init</code> argument will be disregarded unless accompanied by the <code class="inline">--force</code> argument to override existing configurations.</p></li>
        <li class="thingsdb13"><p class="copyright1">While the code block is not strictly necessary, it is missing a crucial semicolon to terminate the code block statement. As a result, running this code would generate an error message: <code class="inline">..unexpected character `b`, expecting: ; or end_of_statement</code>. To rectify the issue, either add a semicolon after the code block or remove the code block entirely.</p></li>
        <li class="thingsdb13"><p class="copyright1">Answer "d" is correct. In this code snippet, <code class="inline">a</code> is a variable, and <code class="inline">.b</code> is a property of the collection root. The equivalent code would be <code class="inline">root().b;</code>, which explicitly references the root collection and then accesses its <code class="inline">b</code> property.</p></li>
        <li class="thingsdb13"><p class="copyright1">The variable names "b", "d" and "e" are valid. A variable name cannot start with a number making <code class="inline">4you</code> invalid. A variable name may only consist of the letters a-z, A-Z, underscores (_) and digits 0-9 <em class="thingsdb15">(except for the first character which is not allowed to be a digit)</em>. Therefore, <code class="inline">my-hobby</code> is invalid as it contains the "-" character.</p></li>
        <li class="thingsdb13"><p class="copyright1">The value of property <code class="inline">x</code> is 1. The <code class="inline">get()</code> method effectively retrieves the value of property <code class="inline">x</code>, which is 1. It optionally takes a second argument to provide a fallback value in case the property does not exist. In this instance, since the property <code class="inline">x</code> is found, the second argument is never evaluated, demonstrating the concept of <em class="thingsdb15">"lazy evaluation"</em> in action.</p></li>
        <li class="thingsdb13"><p class="copyright1">The response of a query encapsulates the outcome of the final statement executed within the query. Typically, this refers to the last statement within the provided code, unless an exception arises or the return keyword is explicitly employed.</p></li>
        <li class="thingsdb13"><p class="copyright1">No. The <code class="inline">@thingsdb</code> scope is specifically designed for managing your ThingsDB cluster, not for storing data. It allows you to handle administrative tasks such as user access control, collection creation, node management, and more. While you can create procedures within the <code class="inline">@thingsdb</code> scope, it does not provide a root thing to store properties. Therefore, you must use a collection scope to store data.</p></li>
        <li class="thingsdb13"><p class="copyright1">Both "a" and "d" are correct. New collections can be created in the <code class="inline">@thingsdb</code> scope and both <code class="inline">/t</code> and <code class="inline">@thing</code> are valid abbreviations. Both "b" and "c" are collection scopes and "e" is an example of a node scope.</p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-241">
<section type="chapter" role="doc-chapter" aria-labelledby="ch02_h" id="thingsdb_link-297">
    <h2 id="chapter-2" class="thingsdb7">Chapter 2 - Integers, Floating Points, Booleans, Strings and Nil</h2>
    <p class="copyright1">For this chapter we switch to the newly created collection <em class="thingsdb15">(see the previous chapter on how to create the collection)</em>.</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">@ //chapter2</code>
<code class="prompt">(//chapter2)&gt;</code></pre>
    <div class="note">
        <img class="note1" src="images/idea.png" alt="Note" />
        <div class="content">
            <p class="author1">The @ command tells the prompt you want to switch to another scope. In this example we used the
                forward-slash notation to switch to the "chapter2" collection.</p>
        </div>
    </div>
    <section>
        <h3 id="chapter-2-1" class="title1">2.1 Integers</h3>
        <p class="copyright1">In ThingsDB integers, strings, boolean and floating point values are all immutable. That is, you cannot change an
            immutable value once it is created. An integer is a number without a fractional component. Examples
            are <code class="inline">1</code>, <code class="inline">2</code>, <code class="inline">415</code> but
            also <code class="inline">0</code> and negative integers like <code class="inline">-15</code>. As we explained,
            integer values are immutable which means that we cannot change the value once assigned.</p>
        <p class="copyright1">For example, if we assign the integer to the variable <code class="inline">x</code>, we cannot change the value.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">x = 42;</code>  <code class="comment">// x will be immutable</code>
<code class="response">42</code></pre>
        <p class="copyright1">We cannot change the value as <code class="inline">x</code> is immutable, but we can assign a <em class="thingsdb15">new</em> value to <code class="inline">x</code>.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="comment">// press CTRL+n for a new line</code>
<code class="user">x = 2;</code>
<code class="user">x = x + 1;</code>  <code class="comment">// overwrite x with a new integer value</code>
<code class="response">3</code></pre>
        <p class="copyright1">The return value is indeed the last assignment.</p>
        <p class="copyright1">Aside from the basic assignment operator (<code class="inline">=</code>), ThingsDB supports other assignment
            operations that allow you to modify values in more complex ways. For instance, you can use the addition
            assignment operator (<code class="inline">+=</code>) to add a value to another and assign the result to a variable.
            For example:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="comment">// press CTRL+n for a new line</code>
<code class="user">x = 2;</code>
<code class="user">x += 1;</code>  <code class="comment">// read as: x = x + 1</code>
<code class="response">3</code></pre>
        <div class="table">
            <h2 id="thingsdb_link-298" class="thingsdb7"></h2>
            <p class="title3">Table 2.1 - Assignment operators</p>
            <table class="thingsdb20">
                <tr class="thingsdb21"><th class="thingsdb22">Operator</th><th class="thingsdb22">Description</th></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">=</code></td><td class="thingsdb23">Assignment operator</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">*=</code></td><td class="thingsdb23">Multiplication assignment</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">/=</code></td><td class="thingsdb23">Float division assignment</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">%=</code></td><td class="thingsdb23">Modulo assignment</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">+=</code></td><td class="thingsdb23">Addition assignment</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">-=</code></td><td class="thingsdb23">Subtraction assignment</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">&amp;=</code></td><td class="thingsdb23">Bitwise AND assignment</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">^=</code></td><td class="thingsdb23">Bitwise XOR assignment</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">|=</code></td><td class="thingsdb23">Bitwise OR assignment</td></tr>
            </table>
        </div>
        <p class="copyright1">The range of integers is limited to a minimum and maximum value. You can ask this minimum and maximum value
            with the keywords <code class="inline">INT_MIN</code> and <code class="inline">INT_MAX</code>.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">INT_MIN;</code>
<code class="response">-9223372036854775808</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">INT_MAX;</code>
<code class="response">9223372036854775807</code></pre>
        <p class="copyright1">When you try to create an integer value outside this range, an Overflow error is raised as ThingsDB
            cannot store this value.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">INT_MAX + 1;</code>  <code class="comment">// this will error</code>
<code class="response">OverflowError: integer overflow</code></pre>
        <p class="copyright1">In addition to the familiar base-10 notation, integers can also be represented using hexadecimal
            (hex), octal (oct), and binary notation. Each of these notations has its own unique set of symbols
            and prefixes that distinguish it from the others.</p>
        <p class="copyright1">Hexadecimal notation (hex) uses the digits 0-9 and the letters A-F to represent values from 0 to 15.
            Hex numbers are prefixed with the identifier "0x" to indicate their hexadecimal nature. For instance,
            the number <code class="inline">0xFF</code> represents the decimal value <code class="inline">255</code>.</p>
        <p class="copyright1">Octal notation (oct) employs the digits 0-7 to represent values from 0 to 7. Octal numbers are prefixed with
            the identifier "0o" to distinguish them. For example, the
            number <code class="inline">0o77</code> stands for the decimal value <code class="inline">63</code>.</p>
        <p class="copyright1">Binary notation (bin) utilizes only the digits 0 and 1 to represent values from 0 to 1. Binary numbers are
            prefixed with the identifier "0b". For example, the
            number <code class="inline">0b1010</code> equals the decimal value <code class="inline">10</code>.</p>
        <p class="copyright1">Here are a few examples:</p>
<pre class="thingsdb16"><code class="user">0xff;</code>    <code class="comment">// hex notation (255)</code>
<code class="user">0x1F;</code>    <code class="comment">// hex notation (31) - capital letters are allowed</code>
<code class="user">0X10;</code>    <code class="comment">// !! error !! - the "x" must be lowercase</code>
<code class="user">123;</code>     <code class="comment">// decimal notation</code>
<code class="user">0o77;</code>    <code class="comment">// octal notation (63) - the "o" must be lowercase</code>
<code class="user">0b1010;</code>  <code class="comment">// binary notation (10) - the "b" must be lowercase</code></pre>
        <p class="copyright1">Assignments work from right to left. The example below first assigns <code class="inline">30</code> to
            <code class="inline">apples</code>, then <code class="inline">apples</code> is assigned to <code class="inline">grapes</code>
            and finally <code class="inline">grapes</code> is assigned to <code class="inline">lemons</code>.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">lemons = grapes = apples = 30;</code>
<code class="response">30</code></pre>
    </section>
    <section>
        <h3 id="chapter-2-2" class="title1">2.2 Floating Points</h3>
        <p class="copyright1">Floating-point numbers are used to represent numbers with decimal parts, such as <code class="inline">0.5</code>
            and <code class="inline">3.14159</code>. ThingsDB supports two notations for representing floating-point
            numbers: standard decimal point notation and scientific notation (E notation).</p>
        <p class="copyright1">Standard decimal point notation is commonly used for representing everyday numbers, such as <code class="inline">1.0</code>,
            <code class="inline">56.0</code>, and <code class="inline">0.5</code>. The E notation is more compact and is
            typically used for representing very large or very small numbers. For example, the number <code class="inline">1.5e+3</code>,
            written in E notation, represents the same value as <code class="inline">1.5 * 1000</code>. Similarly,
            <code class="inline">1.2e-4</code>, written in E notation, represents the same value as <code class="inline">1.2 * 0.0001</code>.</p>
        <p class="copyright1">ThingsDB adheres to strict rules for writing E notation. The "e" must always be lowercase, and the sign (+ or -) is
            required to indicate whether to multiply by 10 to the positive or negative power.</p>
        <p class="copyright1">Due to the limited precision of 64-bit floating-point numbers in ThingsDB, some decimal values may not be
            represented accurately. For instance, the result of dividing <code class="inline">10.0</code> by
            <code class="inline">3.0</code> is displayed as <code class="inline">3.3333333333333335</code>, even though the
            actual decimal representation extends infinitely. This is because the 64-bit format can only store a finite number
            of decimal digits.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">10.0 / 3.0;</code>  <code class="comment">// the single / means division</code>
<code class="response">3.3333333333333335</code></pre>
        <p class="copyright1">ThingsDB follows the standard floating-point behavior when performing arithmetic operations. If either operand is
            a float, the result will also be a float. However, if both operands are integers, the result will be an integer
            and will be rounded towards the nearest integer towards zero. For example, <code class="inline">10 / 3</code> will
            be <code class="inline">3</code>, and <code class="inline">10 / -3</code> will be <code class="inline">-3</code>.
            This is because integer division in ThingsDB truncates the fractional part, discarding any decimal places.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">The decision of whether to use integer or float values depends on the specific context and the desired
                    precision. Integers have a slight advantage in terms of storage size, as they can be compressed using
                    the MessagePack protocol to occupy only 1 byte up to max 9 bytes whereas floating point values always
                    are serialized using 9 bytes.</p>
            </div>
        </div>
        <p class="copyright1">Two special floating-point values exist in ThingsDB: <code class="inline">inf</code> (infinity) and <code class="inline">nan</code>
            (NaN, not a number). Infinity represents an infinitely large number, while NaN represents a value that cannot be
            represented accurately. In other programming languages, <code class="inline">nan</code> may be the result of operations
            like <code class="inline">0/0</code>, but in ThingsDB, such operations will throw a division by zero error.</p>
        <p class="copyright1">In ThingsDB, you will encounter <code class="inline">nan</code> only when a value is explicitly set to <code class="inline">nan</code>
            or when incoming arguments contain <code class="inline">nan</code>. One important distinction to remember is that
            comparing <code class="inline">nan</code> values to other values will always yield false results. Instead, use
            the <code class="inline">is_nan()</code> function to explicitly check whether a value is <code class="inline">nan</code>.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">nan == nan;</code>  <code class="comment">// this is false!!</code>
<code class="response">false</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">is_nan(nan);</code>  <code class="comment">// use is_nan() to test for NaN</code>
<code class="response">true</code></pre>
    </section>
    <section>
        <h3 id="chapter-2-3" class="title1">2.3 Numeric Tools</h3>
        <p class="copyright1">In addition to the arithmetic operators, ThingsDB provides a set of handy mathematical functions for performing
            calculations on numbers. These functions typically accept either a float or integer as input and return the
            calculated result. As an example, the <code class="inline">sqrt()</code> function calculates the square root
            of a given number. Here are a few examples:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">sqrt(9);</code>  <code class="comment">// Square root of 9</code>
<code class="response">3.0</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">pow(5, 3);</code>  <code class="comment">// 5 raised to the power of 3</code>
<code class="response">125.0</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">round(loge(5.12), 3);</code>  <code class="comment">// Combine round() and loge()</code>
<code class="response">1.633</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">ceil(6.1034);</code>  <code class="comment">// Ceil of a given number</code>
<code class="response">7</code></pre>
        <p class="copyright1">For a comprehensive list of all available mathematical functions, refer to the official
            ThingsDB documentation: <a href="https://docs.thingsdb.io/v1/collection-api/math/" class="thingsdb14">https://docs.thingsdb.io/v1/collection-api/math/</a></p>
    </section>
    <section>
        <h3 id="chapter-2-4" class="title1">2.4 Boolean</h3>
        <p class="copyright1">The bool type, named after George Boole, is used to represent truth values. ThingsDB automatically converts bool
            values to integers when needed. This conversion follows the standard convention of representing
            <code class="inline">true</code> as <code class="inline">1</code> and <code class="inline">false</code> as <code class="inline">0</code>.
            For instance, adding two <code class="inline">true</code> values would result in <code class="inline">2</code>.
            Similarly, subtracting two <code class="inline">false</code> values would result in <code class="inline">0</code>.
            Consider this example:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">true + true;</code>
<code class="response">2</code></pre>
        <p class="copyright1">In this example, the expression <code class="inline">true + true</code> is evaluated to <code class="inline">2</code>,
            even though both operands are bool values.</p>
        <p class="copyright1">In ThingsDB, you can also convert other data types to the bool type. For example, an integer value
            of <code class="inline">0</code> converts to <code class="inline">false</code>, and any other integer value
            converts to <code class="inline">true</code>. This applies to other data types as well, such as floats and
            strings. An empty string converts to <code class="inline">false</code>, while a string with any content, even
            whitespace, converts to <code class="inline">true</code>.</p>
        <p class="copyright1">Here is an example demonstrating this:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">bool(0.0);</code>  <code class="comment">// float 0.0 (false)</code>
<code class="response">false</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">bool("");</code>  <code class="comment">// empty string (false)</code>
<code class="response">false</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">bool(-4.13);</code>  <code class="comment">// non-zero float (true)</code>
<code class="response">true</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">bool("Hello");</code>  <code class="comment">// non-empty string (true)</code>
<code class="response">true</code></pre>
        <p class="copyright1">The conversion rules for other data types are described later in this book, but the important thing to remember
            is that <em class="thingsdb15">any</em> type can be converted to the bool type.</p>
        <p class="copyright1">Occasionally, you might encounter code that employs two exclamation marks (<code class="inline">!!</code>)
            instead of the <code class="inline">bool()</code> function. The single exclamation mark serves as the "not"
            operator, which first converts the value following it to a boolean and then flips that value.
             When a second exclamation mark is used, the inverted value is inverted once more.
             As you can see, this ultimately yields the same result as using the <code class="inline">bool()</code> function.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">!!"Cool";</code>  <code class="comment">// non-empty string (true)</code>
<code class="response">true</code></pre>
        <p class="copyright1">This usage serves as a concise alternative to explicitly calling the <code class="inline">bool()</code> function.</p>
    </section>
    <section>
        <h3 id="chapter-2-5" class="title1">2.5 Strings</h3>
        <p class="copyright1">Strings are used to store textual data and are typically encoded using UTF-8. Whether the encoding is indeed UTF-8
            depends on whether the MessagePack protocol is followed during communication with ThingsDB. Strings are sequences
            of characters and can be indexed, meaning they have a defined length.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">.b = "bike";</code>
<code class="response">"bike"</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">.b.len();</code>  <code class="comment">// len() is a method of type "str"</code>
<code class="response">4</code></pre>
        <p class="copyright1">As demonstrated, strings are objects with associated methods. The <code class="inline">len()</code> method is an example
            that can be used to determine the length of a string.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">.b[0];</code>  <code class="comment">// the first byte is at index 0</code>
<code class="response">"b"</code></pre>
        <p class="copyright1">Indexing for strings begins at position 0. Negative indexing is also supported.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">.b[-1];</code>  <code class="comment">// last byte, read as: .b[.b.len()-1]</code>
<code class="response">"e"</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">.b[.b.len() - 1];</code>  <code class="comment">// last byte, the hard way</code>
<code class="response">"e"</code></pre>
        <p class="copyright1">Notice that any expression can be used for indexing strings. ThingsDB supports this level of flexibility.</p>
        <p class="copyright1">Besides indexing, strings <em class="thingsdb15">(and other sequences)</em> support slicing, which allows you to extract a specific
            segment from the sequence. Slicing involves specifying a starting position <em class="thingsdb15">(inclusive)</em>, an ending
            position <em class="thingsdb15">(exclusive)</em>, and an optional step size.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">.b[1:3];</code>  <code class="comment">// slice from position 1 up to,</code>
                        <code class="comment">// but not including, position 3</code>
<code class="response">"ik"</code></pre>
        <p class="copyright1">Slicing operations create a new string, leaving the original string unchanged. This is because strings in
            ThingsDB are immutable, meaning they cannot be directly modified.</p>
        <p class="copyright1">The general format for a slice is <code class="inline">[start:end:step]</code>, where <code class="inline">start</code>
            defaults to <code class="inline">0</code>, <code class="inline">end</code> defaults to the length of the string,
            and <code class="inline">step</code> defaults to <code class="inline">1</code>.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">.b[1:];</code>  <code class="comment">// equivalent to .b[1:.b.len()]</code>
<code class="response">"ike"</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">.b[:-2];</code> <code class="comment">// equivalent to .b[0:.b.len()-2]</code>
<code class="response">"bi"</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">.b[:];</code>   <code class="comment">// equivalent to .b[0:.b.len()]</code>
<code class="response">"bike"</code></pre>
        <p class="copyright1">The step parameter enables you to select specific elements of the sequence by skipping over certain values.
            Negative step values can also be used to begin from the end of the sequence.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">.b[::2];</code>  <code class="comment">// slice with an even step size,</code>
                        <code class="comment">// extracting only even-indexed bytes</code>
<code class="response">"bk"</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">.b[::-1];</code> <code class="comment">// slice in reverse order</code>
<code class="response">"ekib"</code></pre>
        <p class="copyright1">In prior discussions, we have often used the term "bytes" instead of "characters" when referring to strings.
            This is because the length of a string in ThingsDB is measured in bytes, not characters. This can be important
            to keep in mind, especially when dealing with UTF-8 encoded strings, which can use multiple bytes to represent
            a single character.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">.u = "Hi! ð";</code>  <code class="comment">// UTF-8 string with smiley</code>
<code class="response">"Hi! \ud83d\ude01"</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">.u.len();</code>  <code class="comment">// Length of the string in bytes</code>
<code class="response">8</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">is_utf8(.u);</code>  <code class="comment">// Check if UTF-8 encoded</code>
<code class="response">true</code></pre>
        <p class="copyright1">In this example, the string <code class="inline">"Hi! ð"</code> has a length of 8 bytes, even though it contains
            only 5 characters. This is because the Unicode character for the smiley face, ð, requires 4 bytes to represent.
            When working with strings in ThingsDB, it is crucial to remember that strings are internally treated as sequences
            of bytes, not characters.</p>
        <p class="copyright1">To further illustrate the distinction between bytes and characters, consider this example:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">.u[-3:];</code>  <code class="comment">// don't try this</code>
<code class="response">(!! your client will likely crash or at least display an unpacking error)</code></pre>
        <p class="copyright1">This code attempts to index the string <code class="inline">.u</code> starting from the third-last character.
            However, since UTF-8 encoded characters can span multiple bytes, attempting to index directly by character
            position can lead to unexpected behavior, as demonstrated by the potential client error.</p>
        <p class="copyright1">On the other hand, ThingsDB internally handles strings as sequences of bytes. Therefore, while this specific
            indexing operation might cause issues on the client-side, ThingsDB itself can still process the string correctly.
            This is evident from the following command:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">is_utf8(.u[-3:]);</code>  <code class="comment">// No problem for ThingsDB</code>
<code class="response">false</code></pre>
        <p class="copyright1">This command confirms that ThingsDB can still determine that the extracted substring is not valid UTF-8 even
            though it is accessed using an invalid character index. This demonstrates that ThingsDB handles strings
            consistently as sequences of bytes, regardless of the specific indexing operations performed.</p>
        <section>
            <h4 id="chapter-2-5-1" class="title2">2.5.1 String Methods</h4>
            <p class="copyright1">We have already explored the <code class="inline">len()</code> method for determining the length of a string.
                However, ThingsDB offers a wealth of additional methods for string manipulation like, for example,
                the <code class="inline">upper()</code> method.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">.b.upper();</code>  <code class="comment">// Produces a new string in uppercase</code>
<code class="response">"BIKE"</code></pre>
            <p class="copyright1">The <code class="inline">upper()</code> method generates a new string with all characters converted to
                uppercase and exemplifies the various methods available for the string type. Other methods, such
                as <code class="inline">starts_with()</code>, accept arguments and can be used to determine if a given
                string begins with another string.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">"this is a test".starts_with("this is");</code>
<code class="response">true</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">"another test".starts_with("Ano");</code>
<code class="response">false</code></pre>
            <p class="copyright1">To explore a comprehensive list of all the methods available for the string type,
                including <code class="inline">upper()</code> and <code class="inline">starts_with()</code>,
                refer to the official ThingsDB documentation here:
                <a href="https://docs.thingsdb.io/v1/data-types/str/" class="thingsdb14">https://docs.thingsdb.io/v1/data-types/str/</a></p>
        </section>
        <section>
            <h4 id="chapter-2-5-2" class="title2">2.5.2 Escaping and Multi-line Strings</h4>
            <p class="copyright1">Until now, we have primarily employed double quotes to delimit strings. However, what if we want to include
                double quotes within the string itself? In this situation, we have two options. The simplest approach is
                to enclose the string in single quotes, which ThingsDB also supports:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">'"This is an example", she said';</code>
<code class="response">"\"This is an example\", she said"</code></pre>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">Notice that the response is rendered in JSON format. In JSON format, we observe that double quotes
                        are escaped with a backslash (<code class="inline1">\</code>).</p>
                </div>
            </div>
            <p class="copyright1">Alternatively, we can escape double quotes by placing another double quote directly before them:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">"""This is as well"", he said";</code>
<code class="response">"\"This is as well\", he said"</code></pre>
            <p class="copyright1">This escaping technique also applies to single quotes within single-quoted strings.</p>
            <p class="copyright1">In ThingsDB, all strings are inherently multiline. Simply utilize newline characters to introduce line
                breaks within a string.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">"All
strings in ThingsDB
are multiline!!";</code>
<code class="response">"All\nstrings in ThingsDB\nare multiline!!"</code></pre>
            <p class="copyright1">As before, the response is presented as JSON format, and therefore the newline characters are
                displayed as <code class="inline">\n</code>.</p>
        </section>
        <section>
            <h4 id="chapter-2-5-3" class="title2">2.5.3 Concatenation and t-strings</h4>
            <p class="copyright1">String concatenation can be accomplished using the <code class="inline">+</code> operator.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">"My " + .b + " is black";</code>
<code class="response">"My bike is black"</code></pre>
            <p class="copyright1">Take note that this does not work with other data types unless we explicitly convert them to strings:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="comment">// CTRL-n for a new line</code>
<code class="user">.n = 3;</code>  <code class="comment">// Assign integer 3 to property "n"</code>
<code class="user">"I've " + .n + " apples";</code>
<code class="response">TypeError: `+` not supported between `str` and `int`</code></pre>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">Remember that even though the code above resulted in an exception, the
                        property "n" is still preserved..</p>
                </div>
            </div>
            <p class="copyright1">To rectify the example above, we can utilize the <code class="inline">str()</code> method to convert
                the integer to a string:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">"I've " + str(.n) + " apples";</code>
<code class="response">"I've 3 apples"</code></pre>
            <p class="copyright1">In practice, it is advisable to avoid string concatenation. Instead, opting for t-strings is a
                superior choice. A t-string starts and ends with a backtick (<code class="inline">`</code>) and
                enables us to embed variables or even entire expressions within curly braces.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">`I've {.n} apples`;</code>
<code class="response">"I've 3 apples"</code></pre>
            <p class="copyright1">This approach does not only enhance readability but also eliminates the risk of forgetting to convert
                to a string, as the conversion is done automatically when using the t-string syntax.</p>
            <p class="copyright1">If you need to include curly braces or backticks within a t-string, you can follow the same escaping
                method used for single and double-quoted strings. To escape a curly brace, use two consecutive curly
                braces, and for a backtick, use another backtick.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">`Sentence with ``Backticks`` and {{Curlies}}.`;</code>
<code class="response">"Sentence with `Backticks` and {Curlies}."</code></pre>
            <p class="copyright1">This approach ensures that the braces and backticks are interpreted as part of the string and not as
                special characters.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-2-6" class="title1">2.6 Nil</h3>
        <p class="copyright1">We've encountered
            <code class="inline">nil</code> before as the return value of functions, methods or statements that do not produce
            any meaningful output. This concept extends to queries where we don't expect a substantial response.</p>
        <p class="copyright1">Consider the following:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">.quote = "'So many books, so little time.' -- Frank Zappa";</code>
<code class="response">"'So many books, so little time.' -- Frank Zappa"</code></pre>
        <p class="copyright1">This query assigns a quote but also sends the quote back to the client, consuming unnecessary network bandwidth.
            Since we have already stored the quote, we do not need it echoed back in the response. In such cases,
            it is considered a best practice to terminate the code with the <code class="inline">nil</code> type to prevent this unnecessary response:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">.quote = "'So many books, so little time.' -- Frank Zappa";</code>
<code class="user">nil;</code>
<code class="response">null</code></pre>
        <p class="copyright1">By appending <code class="inline">nil</code>, we avoid sending the quote back to the client, minimizing network
            overhead. Explicitly ending a query with <code class="inline">nil</code> also enhances the code's readability and intent. It clearly
            indicates that the query does not expect a response, making the code more self-explanatory and easier to follow.</p>
        <section>
            <h4 id="chapter-2-6-1" class="title2">2.6.1 Avoiding Ambiguity with Nil as a Placeholder</h4>
            <p class="copyright1">The <code class="inline">nil</code> data type often serves as a placeholder for empty values. While this
                can be convenient, it is crucial to avoid relying solely on the fact that <code class="inline">nil</code>
                evaluates to <code class="inline">false</code>. This is because other data types, such as an integer
                value of <code class="inline">0</code> or an empty string, also evaluate to <code class="inline">false</code>.
                To accurately identify <code class="inline">nil</code>, use the dedicated <code class="inline">is_nil()</code>
                function. This ensures that you are explicitly checking for the absence of a value rather than relying on
                potentially misleading behavior.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-2-7" class="title1">2.7 Errors</h3>
        <p class="copyright1">Before delving into the quiz for this chapter, let's explore the <em class="thingsdb15">error</em> data type. Throughout this chapter, we have encountered a few errors in our queries. While errors themselves are normal
            types in ThingsDB, raising an error interrupts the query execution and triggers the dedicated error handling
            protocol.</p>
        <p class="copyright1">Consider the <code class="inline">zero_div_err</code>, which represents the error raised when attempting to
            divide by zero. We can create an instance of this error type and access its properties:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">zero_div_err().msg();</code>
<code class="response">"division or modulo by zero"</code>
<code class="prompt">(//chapter2)&gt;</code> <code class="user">zero_div_err().code();</code>
<code class="response">-58</code></pre>
            <p class="copyright1">In this example, we only returned the error information without raising it. However, we can explicitly
                raise an error using the <code class="inline">raise()</code> function:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">raise(zero_div_err());</code>
<code class="response">ZeroDivisionError: division or modulo by zero</code></pre>
            <p class="copyright1">The client, in this case the ThingsDB Prompt, recognizes the error and returns a corresponding exception:
                <code class="inline">ZeroDivisionError</code>.</p>
            <p class="copyright1">The default message can be overwritten. Here is an example of the <code class="inline">zero_div_err</code>
                error with a customized message:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">zero_div_err("division by zero is not allowed");</code>
<code class="response">"division by zero is not allowed"</code></pre>
            <p class="copyright1">As you can see, the default message is now replaced with your custom message. Importantly, when an error
                is returned (without being raised), it is sent to the client as a string containing the message
                (equal to explicitly calling the <code class="inline">msg()</code> method).</p>
            <p class="copyright1">ThingsDB also allows you to define custom error codes. These codes must fall within a specific
                range: -127 to -50.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">To avoid conflicts with existing ThingsDB error codes (like <code class="inline1">zero_div_err</code>
                        which ranges from -99 to -50), it's recommended to keep your custom error codes within the range
                        of -127 to -100. For a comprehensive list of error codes, refer to the official
                        documentation: <a href="https://docs.thingsdb.io/v1/errors/" class="thingsdb14">https://docs.thingsdb.io/v1/errors/</a></p>
                </div>
            </div>
            <p class="copyright1">Here is an example of raising a custom error with a code:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">raise(err(-100, "My Custom Error"));</code>
<code class="response">CustomError: My Custom Error</code></pre>
            <p class="copyright1">It is worth noting that <code class="inline">-100</code> is the default code for custom errors. You can
                achieve the same result by raising the message directly:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">raise("My Custom Error");</code>
<code class="response">CustomError: My Custom Error</code></pre>
        <section>
            <h4 id="chapter-2-7-1" class="title2">2.7.1 Capture Errors</h4>
            <p class="copyright1">Unlike traditional try-catch blocks found in many languages, ThingsDB utilizes a <code class="inline">try()</code>
                function for error handling. This function requires at least one argument, which is the code you want to execute.
                If an error arises within the code, <code class="inline">try()</code> returns with the error, preventing
                disruption of the entire query execution.</p>
            <p class="copyright1">Let's see this in action:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">a = 7.0; b = 0.0;</code>
<code class="user">x = try(a / b);</code>  <code class="comment">// try dividing a with b</code>
<code class="user">`{a} / {b} = {is_err(x) ? 'NaN' : x}`;</code>
<code class="response">"7 / 0 = NaN"</code></pre>
            <p class="copyright1">Dividing by zero triggers an error, which is captured by the <code class="inline">try()</code> function.
                Use the <code class="inline">is_err()</code> function to check if the returned value from <code class="inline">try()</code>
                contains an error.</p>
            <p class="copyright1">While <code class="inline">try()</code> captures all errors by default, you can refine its behavior to
                handle only specific errors. To achieve this, provide the desired error types as additional arguments to
                the <code class="inline">try()</code> function.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter2)&gt;</code> <code class="user">try(1 / 0, zero_div_err()); "OK";</code>
<code class="response">"OK"</code></pre>
            <p class="copyright1">This code only captures the <code class="inline">zero_div_err error</code>, any other errors would
                still be raised.</p>
            <p class="copyright1">This chapter covered some fundamental types of ThingsDB, including the concept of error handling.
                Test your understanding with the quiz and join us in the next chapter where we delve into lists and tuples.</p>
        </section>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-24">
<section>
    <h3 id="quiz-chapter-2" class="title1">2.8 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">What data type will be the result of adding an integer to a float?</p></li>
        <li class="thingsdb13"><p class="copyright1">If you have a value of <code class="inline">0.0</code>, what will be the result of putting two exclamation marks in front of it?</p></li>
        <li class="thingsdb13"><p class="copyright1">Can you guess the result of evaluating the following expression?</p>
            <p class="quizcode"><code class="inline">sqrt(25);</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Is it possible to change the string <code class="inline">"alarm"</code> to <code class="inline">"ALARM"</code> by converting all characters to uppercase?</p></li>
        <li class="thingsdb13"><p class="copyright1">Choose the correct answer:</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Strings in ThingsDB are always encoded in UTF-8</li>
                <li class="thingsdb13">Strings in ThingsDB must be written on a single line</li>
                <li class="thingsdb13">Strings in ThingsDB are internally represented as sequences of bytes</li>
                <li class="thingsdb13">Strings in ThingsDB must at least contain one character</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">What string is created by the following code:</p>
            <p class="quizcode"><code class="inline">"slicing"[2:5]</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Can you guess which string is produced by the following code without executing it?</p>
            <p class="quizcode"><code class="inline">"blue blue grass, blue blue sky".replace("blue", "green", 2);</code></p>
            <p class="copyright1"><em class="thingsdb15">(Hint: consult the online documentation for the replace method)</em></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">When and why is it considered a good practice to end a query with <code class="inline">nil</code>?</p></li>
        <li class="thingsdb13"><p class="copyright1">What happens when executing the following statement in ThingsDB?</p>
            <p class="quizcode"><code class="inline">try({2 / 0; .A = true;}); .B = true;</code></p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Neither <code class="inline">.A</code> nor <code class="inline">.B</code> will be set because the division by zero raises an error</li>
                <li class="thingsdb13">Only <code class="inline">.A</code> will be set because the assignment happens within the <code class="inline">try()</code> block</li>
                <li class="thingsdb13">Only <code class="inline">.B</code> will be set because <code class="inline">try()</code> catches the error and execution continues</li>
                <li class="thingsdb13">Both <code class="inline">.A</code> and <code class="inline">.B</code> will be set to <code class="inline">true</code></li>
            </ol>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-259">
<section>
    <h4 id="answers-chapter-2" class="title2">2.8.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">The result will be a float. When one operand is a float, the other operand is internally promoted to a float and the result will also be a float.</p></li>
        <li class="thingsdb13"><p class="copyright1">The exclamation mark before the value <code class="inline">0.0</code> converts the value to a boolean (<code class="inline">false</code>) and then flips the value (<code class="inline">true</code>). The second exclamation mark inverts the result again, so the final result is <code class="inline">false</code>.</p></li>
        <li class="thingsdb13"><p class="copyright1">The result of evaluating the expression <code class="inline">sqrt(25);</code> is <code class="inline">5.0</code>. While you might initially think of the answer as simply <code class="inline">5</code>, remember that the <code class="inline">sqrt()</code> function always returns a float, even when the input is an integer.</p></li>
        <li class="thingsdb13"><p class="copyright1">No, strings in ThingsDB are immutable, meaning they cannot be changed after they are created. You can create a <em class="thingsdb15">new</em> string with uppercase characters by using the <code class="inline">upper()</code> method.</p></li>
        <li class="thingsdb13"><p class="copyright1">The correct answer is "c", strings are internally represented as sequences of bytes. A string should be encoded in UTF-8 but this is not guaranteed. Strings can be defined across multiple lines and an empty string evaluates to false when converted to bool, but is still a valid string.</p></li>
        <li class="thingsdb13"><p class="copyright1">The string <code class="inline">"ici"</code>. Indexing starts at zero, so index 2 corresponds to the third character. The slicing operation results in a substring consisting of the characters from index 2 <em class="thingsdb15">(inclusive)</em> to index 5 <em class="thingsdb15">(exclusive)</em>.</p></li>
        <li class="thingsdb13"><p class="copyright1">The resulting string is <code class="inline">"green green grass, blue blue sky"</code>. The <code class="inline">replace()</code> method can be employed to replace a specified sequence of characters within a string with another string. Optionally, you can specify the number of instances to be replaced. Had the optional argument not been set to <code class="inline">2</code>, the result would have been <code class="inline">"green green grass, green green sky"</code>.</p>
            <p class="copyright1"><em class="thingsdb15">(The replace() method offers more capabilities than described here. Consult the documentation for a comprehensive overview of its power: <a href="https://docs.thingsdb.io/v1/data-types/str/replace/" class="thingsdb14">https://docs.thingsdb.io/v1/data-types/str/replace/</a>).</em></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">When you execute a query that does not produce a meaningful response. It prevents unnecessary transmission of data back to the client and improves clarity and readability as it clearly indicates that the query does not expect a response.</p></li>
        <li class="thingsdb13"><p class="copyright1">The answer is "c". Only <code class="inline">.B</code> is set to <code class="inline">true</code>. The division by zero in <code class="inline">try()</code> halts its execution, preventing the assignment to <code class="inline">.A</code>. Execution continues outside <code class="inline">try()</code>, allowing the assignment to <code class="inline">.B</code>.</p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-13">
<section type="chapter" role="doc-chapter" aria-labelledby="ch03_h" id="thingsdb_link-300">
    <h2 id="chapter-3" class="thingsdb7">Chapter 3 - Lists and Tuples</h2>
    <p class="copyright1">Before we proceed, let's create a new collection named "chapter3" and switch to its scope.
        If you need a refresher on creating new collections, refer back to section <a href="#chapter-1-6" class="thingsdb14">1.6 Scopes</a>.</p>
    <p class="copyright1">This chapter delves into the realm of lists and tuples, exploring their nature as array-like data
        structures with a crucial distinction: lists are mutable, allowing their contents to be modified,
        while tuples are immutable, preserving their values once created. Additionally, we'll uncover the
        concept of closures, unnamed functions that capture their surrounding scope, and examine their role
        when used as arguments.</p>
    <section>
        <h3 id="chapter-3-1" class="title1">3.1 Lists</h3>
        <p class="copyright1">Lists are positionally ordered collections of arbitrarily typed objects, and they have no fixed
            size. They are also mutable. Unlike strings, lists can be modified in-place by assignment to
            offsets and by a variety of list method calls.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.L = [true, "Eggs", 0.1];</code>
<code class="response">[
    true,
    "Eggs",
    0.1
]</code></pre>
        <p class="copyright1">Similar to strings, you can get the length of a list and use indexing and slicing:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.L.len();</code>  <code class="comment">// Length of the list</code>
<code class="response">3</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.L[1];</code>     <code class="comment">// Access the second item at index 1</code>
<code class="response">"Eggs"</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.L[-2:];</code>   <code class="comment">// Get the last 2 items</code>
<code class="response">[
    "Eggs",
    0.1
]</code></pre>
        <p class="copyright1">Since lists are mutable, you can modify their contents directly:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.L[0] = false;</code>          <code class="comment">// Set the first item to false</code>
<code class="response">false</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.L[1:1] = ["Ham", "&amp;"];</code> <code class="comment">// Insert "Ham" and "&amp;" at index 1</code>
<code class="response">null</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.L;</code>
<code class="response">[
    false,
    "Ham",
    "&amp;",
    "Eggs",
    0.1
]</code></pre>
        <p class="copyright1">More common is to use one of the list methods to update the list.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.L.shift();</code> <code class="comment">// Remove the first item</code>
<code class="response">false</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.L.pop();</code> <code class="comment">// Remove the last item</code>
<code class="response">0.1</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.L.unshift("The", "best");</code> <code class="comment">// Insert "The" and "Best" at the</code>
                                         <code class="comment">// beginning</code>
<code class="response">5</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.L.push("recipes");</code> <code class="comment">// Append "recipes" to the end</code>
<code class="response">6</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.L.extend(["big", "world"]);</code> <code class="comment">// Append another list</code>
<code class="response">8</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.L.splice(6, 1, "in", "the");</code> <code class="comment">// Remove 1 item at index 6 and</code>
                                            <code class="comment">// replace it with "in" &amp; "the"</code>
<code class="response">[
    "big"
]</code></pre>
        <p class="copyright1">The return value of each method varies depending on its functionality. In general, update methods return the
            removed values or the new list length if they only add items. Among the methods discussed,
            <code class="inline">splice()</code> stands out for its versatility. It can remove multiple items, insert
            new ones, and even return the removed items in a separate list.</p>
        <p class="copyright1">If you have followed the examples above in the correct order, your list should now contain only strings.
            You can concatenate these strings into a single string using the <code class="inline">join()</code> method:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.L.join(" ");</code>  <code class="comment">// Join using a space</code>
<code class="response">"The best Ham &amp; Eggs recipes in the world"</code></pre>
        <section>
            <h4 id="chapter-3-1-1" class="title2">3.1.1 Bounds Checking</h4>
            <p class="copyright1">While lists in ThingsDB do not have a fixed size, accessing an index beyond the list's bounds will still
                trigger a LookupError.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.L[99];</code>
<code class="response">LookupError: index out of range</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.L[99] = 1;</code>
<code class="response">LookupError: index out of range</code></pre>
            <p class="copyright1">Instead of silently expanding the list, ThingsDB raises a <code class="inline">lookup_err</code>. To extend a list, utilize methods like push or slice assignments,
                which were previously demonstrated.</p>
        </section>
        <section>
            <h4 id="chapter-3-1-2" class="title2">3.1.2 Reference and Maintained Lists</h4>
            <p class="copyright1">While ThingsDB adheres to conventional list behavior in most cases, it employs a unique approach when
                lists are embedded within a thing.</p>
            <p class="copyright1">When lists are assigned to variables, ThingsDB maintains a single reference to the underlying data structure.
                This means that modifying the list through one reference will also affect any other references to the same list.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code>
<code class="user">A = ["Alice", "Bob"];</code>  <code class="comment">// Assign a list to variable "A"</code>
<code class="user">B = A;</code>                 <code class="comment">// Assign "A" to "B"</code>
<code class="user">B.push("Charlie");</code>     <code class="comment">// Append "Charlie" to the list</code>
<code class="user">A;</code>                     <code class="comment">// Return with the list using "A"</code>
<code class="response">[
    "Alice",
    "Bob",
    "Charlie"
]</code></pre>
            <p class="copyright1">As we can observe, assigning <code class="inline">A</code> to <code class="inline">B</code> establishes
                a reference to the same underlying list data structure. This is evident from the fact that
                appending <code class="inline">"Charlie"</code> to <code class="inline">B</code> also modifies the list
                accessed through <code class="inline">A</code>. Both variables <code class="inline">A</code> and
                <code class="inline">B</code> effectively point to the same list entity.</p>
            <p class="copyright1">However, when a list is assigned to a property, ThingsDB creates a distinct copy of the list. We refer
                to this type of list as a <em class="thingsdb15">maintained list</em> because it is stored and managed within a ThingsDB
                collection.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code>
<code class="user">a = ["Alice", "Bob"];</code>  <code class="comment">// Assign a list to variable "a"</code>
<code class="user">.b = a;</code>                <code class="comment">// Assign variable "a" to property ".b"</code>
<code class="user">.b.push("Charlie");</code>    <code class="comment">// Append "Charlie" to the list on "b"</code>
<code class="user">a;</code>                     <code class="comment">// Return the list assigned to variable "a"</code>
<code class="response">[
    "Alice",
    "Bob"
]</code></pre>
            <p class="copyright1">In summary, ThingsDB creates references when assigning lists to variables and copies them when lists are
                assigned to properties of a thing. We refer to the latter lists as <em class="thingsdb15">maintained lists</em> to
                differentiate them from the referenced lists used in variables.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-3-2" class="title1">3.2 Nesting and tuples</h3>
        <p class="copyright1">ThingsDB allows you to store and retrieve multidimensional data using arrays. However, when you nest arrays
            within an array, the nested arrays are converted to tuples. Tuples are immutable, meaning they cannot be
            changed after they are created. This is because ThingsDB cannot track and synchronize changes to
            nested lists.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.m = [
    [1, 2, 3],
    [4, 5, 6],
];</code>
<code class="response">[[1, 2, 3], [4, 5, 6]]</code></pre>
        <p class="copyright1">This code creates a multidimensional array <code class="inline">.m</code> with two nested arrays.
            You can verify that <code class="inline">.m</code> is a list using the <code class="inline">type()</code>
            function:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">type(.m);</code>
<code class="response">"list"</code></pre>
        <p class="copyright1">You can also extend the list by appending another array to it:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.m.push([7, 8, 9]);</code>
<code class="response">3</code></pre>
        <p class="copyright1">However, when you append a nested list to another list, the nested list is converted to a tuple.
            This means that you cannot modify the nested list after appending it to the outer list.</p>
        <p class="copyright1">For example, the following code attempts to append an element to the last nested array:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.m.last().push(10);</code>
<code class="response">LookupError: type `tuple` has no function `push`</code></pre>
        <p class="copyright1">Similarly, you cannot modify the elements of a nested tuple using index assignments:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.m.last()[0] = 10;</code>
<code class="response">TypeError: type `tuple` does not support index assignments</code></pre>
        <p class="copyright1">Tuples have a subset of the methods available to lists. Only methods that do not manipulate
            the data structure are available for both tuples and lists.</p>
        <p class="copyright1">If you assign a tuple to a variable, the variable holds a reference to the tuple. However,
            if you assign a tuple to a thing, it will be converted to a maintained list. This means that
            you can modify the elements of the new list after it has been assigned to a thing. For example,
            the following code assigns the first nested array from <code class="inline">.m</code> to a
            variable <code class="inline">a</code>:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code>
<code class="user">a = .m.first();</code>  <code class="comment">// Get the first item which is tuple [1, 2, 3]</code>
<code class="user">type(a);</code>         <code class="comment">// Verify that this is still a tuple</code>
<code class="response">"tuple"</code></pre>
        <p class="copyright1">However, if you assign the tuple to a property on a thing, for example to <code class="inline">.o</code>, it will be converted
            to a maintained list:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.o = .m.first();</code>
<code class="response">[1, 2, 3]</code></pre>
        <p class="copyright1">The variable <code class="inline">.o</code> is now a list, and you can modify its elements:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.o[0] = 10;</code>  <code class="comment">// This works!!</code>
<code class="response">10</code></pre>
        <div class="table">
            <h2 id="thingsdb_link-301" class="thingsdb7"></h2>
            <p class="title3">Table 3.2 - Summary of when ThingsDB employs copying or reference assignment for a list </p>
            <table class="thingsdb20">
                <tr class="thingsdb21"><th class="thingsdb22">Assignment</th><th class="thingsdb22">Description</th></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">a = b</code></td><td class="thingsdb23">By reference (<code class="inline">b</code> is a list)</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">a = .b</code></td><td class="thingsdb23">By reference (<code class="inline">.b</code> is a maintained list)</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">a = t</code></td><td class="thingsdb23">By reference (<code class="inline">t</code> is a tuple)</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">.a = b</code></td><td class="thingsdb23">Copy to new maintained list (<code class="inline">b</code> is a list)</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">.a = .b</code></td><td class="thingsdb23">Copy to new maintained list (<code class="inline">.b</code> is a maintained list)</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">.a = t</code></td><td class="thingsdb23">Copy to new maintained list (<code class="inline">t</code> is a tuple)</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">a.push([])</code></td><td class="thingsdb23">Copy to new tuple (<code class="inline">a</code> is a list)</td></tr>
            </table>
        </div>
    </section>
    <section>
        <h3 id="chapter-3-3" class="title1">3.3 Looping Over a List or Tuple</h3>
        <p class="copyright1">Prior lessons have covered accessing a list item using its index. However, we have yet to explore iterating
            through all list elements. To illustrate this concept, let's create a list:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.numbers = [3, 8, 9, 0, 2];</code>
<code class="response">[3, 8, 9, 0, 2]</code></pre>
        <p class="copyright1">Here is one approach to iterating through the list:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">odd = [];</code>
<code class="user">for (n in .numbers) {</code>
<code class="user">  if (n % 2) {</code>
<code class="user">    odd.push(n);</code>  <code class="comment">// If n is odd, append it to the list</code>
<code class="user">  };</code>
<code class="user">};</code>    <code class="comment">// Do not forget this semicolon!!</code>
<code class="user">odd;</code>  <code class="comment">// Return the list</code>
<code class="response">[3, 9]</code></pre>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">In this example, we utilize a trick to check the modulo 2 result, which returns
                    <code class="inline1">0</code> for even numbers and <code class="inline1">1</code> for odd numbers.
                    Since <code class="inline1">0</code> converts to <code class="inline1">false</code> and
                    <code class="inline1">1</code> to <code class="inline1">true</code>, we can employ this to
                    identify odd numbers.</p>
            </div>
        </div>
        <p class="copyright1">The <code class="inline">for</code>-loop approach offers more flexibility. In addition to the value,
            they also provide the index of the value. A <code class="inline">for</code>-loop also supports two
            keywords: <code class="inline">continue</code>, which skips all code after <code class="inline">continue</code> and commences
            the next iteration of the loop, and <code class="inline">break</code>, which halts iteration.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">even = [];</code>
<code class="user">for (n, i in .numbers) {</code>
<code class="user">  if (n % 2) {</code>
<code class="user">    continue;</code>  <code class="comment">// Skip to the next iteration for odd numbers</code>
<code class="user">  };</code>
<code class="user">  even.push(`{n} at index {i}`);</code>  <code class="comment">// Append a t-string to the list</code>
<code class="user">  if (i == 3) {</code>
<code class="user">    break;</code>    <code class="comment">// If the index is 3, terminate the loop </code>
<code class="user">  };</code>
<code class="user">};</code>
<code class="user">even;</code>  <code class="comment">// Return the list</code>
<code class="response">[
    "8 at index 1",
    "0 at index 3"
]</code></pre>
        <p class="copyright1">While <code class="inline">for</code>-loops offer the most flexibility, for many use cases, methods
            like <code class="inline">filter()</code>, <code class="inline">map()</code>, <code class="inline">each()</code>
            and <code class="inline">reduce()</code> provide a more concise and elegant approach to iterating over and
            manipulating data structures. Let's examine the <code class="inline">filter()</code> method to replace
            the first <code class="inline">for</code>-loop:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.numbers.filter(|n| n % 2);</code>
<code class="response">[3, 9]</code></pre>
        <p class="copyright1">The <code class="inline">filter()</code> method takes a closure as its first argument, which is essentially
            an unnamed function. The <code class="inline">filter()</code> method iterates over the list and executes the
            closure for each item. The arguments that the closure accepts are specified between the two pipe
            characters (<code class="inline">||</code>), and in the case of a list or tuple, the filter method provides
            both the value and index of the item to the callback function. You are not required to use both arguments,
            as demonstrated in our example.</p>
        <p class="copyright1">As you can see, the <code class="inline">filter()</code> method with a closure provides a more concise and
            readable way to filter a list compared to a <code class="inline">for</code>-loop. It is a common pattern in
            functional programming, and it can significantly improve the readability and maintainability of your code.</p>
        <p class="copyright1">The second <code class="inline">for</code>-loop, which utilized the <code class="inline">continue</code> and
            <code class="inline">break</code> keywords, seems more complex to replace by list methods. While the
            <code class="inline">map()</code> method can be helpful, it is not the ideal solution in this context.
            The <code class="inline">map()</code> method produces a new list of the same length as the original list,
            but each value in the list is generated by the callback function. In our example, we want to create a list
            of even numbers with an index smaller than 4. Combining the <code class="inline">filter()</code> and
            <code class="inline">map()</code> methods seems like a viable approach, but it introduces a new issue:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code>
<code class="user">.numbers</code>
<code class="user">  .filter(|n, i| n % 2 == 0 &amp;&amp; i &lt; 4)</code>
<code class="user">  .map(|n, i| `{n} at index {i}`);</code>
<code class="response">[
    "8 at index 0",
    "0 at index 1"
]</code></pre>
        <p class="copyright1">As you can observe, the index values are not as expected. This is because the <code class="inline">filter()</code>
            method creates a new list, and the <code class="inline">map()</code> method operates on this new list instead
            of the original list. Consequently, the index values are no longer preserved.</p>
        <p class="copyright1">To address this challenge, we can employ the <code class="inline">reduce()</code> method, which offers a
            functional approach to iterating over and manipulating data structures. The <code class="inline">reduce()</code>
            method takes a closure and an initial value as arguments. The closure is executed for each item in the list,
            and the initial value is the first argument in the callback function. For subsequent iterations, the argument
            passed to the callback function is the accumulated value from the previous iteration, and the result of the last
            iteration will be the result for the reduce method.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.numbers.reduce(|o, n, i| {
    if (n % 2 == 0 &amp;&amp; i &lt; 4) {
        o.push(`{n} at index {i}`);
    }; o;
}, []);</code>
<code class="response">[
    "8 at index 1",
    "0 at index 3"
]</code></pre>
        <p class="copyright1">Admittedly, this solution is more complex than the <code class="inline">for</code>-loop. However, it demonstrates
            the power and versatility of functional programming techniques.</p>
    </section>
    <section>
        <h3 id="chapter-3-4" class="title1">3.4 Specialized Methods</h3>
        <p class="copyright1">Most challenges related to lists can be addressed by combining looping methods with methods for modifying lists.
            However, ThingsDB provides convenient shortcuts for handling common tasks. Here are a few examples:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">.numbers.sum();</code>  <code class="comment">// Calculates the sum of all values</code>
                               <code class="comment">// in the list</code>
<code class="response">22</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.numbers.sort();</code> <code class="comment">// Sorts the list in ascending order</code>
                               <code class="comment">// and returns a new list</code>
<code class="response">[0, 2, 3, 8, 9]</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.numbers.is_unique();</code> <code class="comment">// Checks whether all values in</code>
                                    <code class="comment">// the list are unique</code>
<code class="response">true</code>
<code class="prompt">(//chapter3)&gt;</code> <code class="user">.numbers.index_of(9);</code> <code class="comment">// Finds the index of the first</code>
                                    <code class="comment">// occurrence of the value 9 in</code>
                                    <code class="comment">// the list</code>
<code class="response">2</code></pre>
        <p class="copyright1">For a complete list of available methods, refer to the official documentation:
            <a href="https://docs.thingsdb.io/v1/data-types/list/" class="thingsdb14">https://docs.thingsdb.io/v1/data-types/list/</a></p>
        <p class="copyright1">As ThingsDB evolves, new methods are added. Therefore, when encountering a problem, it is advisable to first
            consult the documentation to see if there is an existing method that can assist you. If you have a specific
            requirement, you can submit a pull request with your proposed method, and one of the ThingsDB developers may
            consider implementing it for future releases.</p>
    </section>
    <section>
        <h3 id="chapter-3-5" class="title1">3.5 Lists for Multi-Value Returns</h3>
        <p class="copyright1">Within ThingsDB, <em class="thingsdb15">"lists"</em> offer a powerful way to retrieve multiple values from a single query.</p>
        <p class="copyright1">Imagine you want to fetch both a status code and a corresponding message from your query. Using lists,
            you can achieve this elegantly by simply returning a list containing both desired values.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter3)&gt;</code> <code class="user">status = 0; message = "success";</code>
<code class="user">[status, message];</code>  <code class="comment">// List containing both status code and message</code>
<code class="response">[
    0,
    "success"
]</code></pre>
        <p class="copyright1">By embracing lists for multi-value returns, you unlock a flexible and efficient approach to retrieving data in ThingsDB.</p>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-245">
<section>
    <h3 id="quiz-chapter-3" class="title1">3.6 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">If we execute the following code:</p>
            <p class="quizcode"><code class="inline">a = [1, 2, 3];</code></p>
            <p class="quizcode"><code class="inline">.b = a;</code></p>
            <p class="copyright1">What will happen?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Property <code class="inline">.b</code> contains a copy of <code class="inline">a</code></li>
                <li class="thingsdb13">Both variable <code class="inline">a</code> and property <code class="inline">.b</code> reference the same list</li>
                <li class="thingsdb13">This code will fail because you cannot assign a list to a property</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">What will happen if we add a list <code class="inline">A</code> as a value into another list <code class="inline">B</code>?</p></li>
        <li class="thingsdb13"><p class="copyright1">Consider the following code:</p>
            <p class="quizcode"><code class="inline">a = [["foo", "bar"]];</code></p>
            <p class="quizcode"><code class="inline">b = a[0];</code></p>
            <p class="quizcode"><code class="inline">c = a;</code></p>
            <p class="copyright1">Which answer is correct?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">a</code> is a tuple, <code class="inline">b</code> is a reference to a list and <code class="inline">c</code> is a maintained list</li>
                <li class="thingsdb13"><code class="inline">a</code>, <code class="inline">b</code> and <code class="inline">c</code> are all lists</li>
                <li class="thingsdb13"><code class="inline">a</code> is a list, <code class="inline">b</code> is a reference to a tuple and <code class="inline">c</code> is a maintained list</li>
                <li class="thingsdb13"><code class="inline">a</code> and <code class="inline">c</code> are the same list and <code class="inline">b</code> is a reference to a tuple</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Can you tell which technique ThingsDB supports for looping over a list or tuple?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">each()</code> method</li>
                <li class="thingsdb13"><code class="inline">map()</code> method</li>
                <li class="thingsdb13"><code class="inline">reduce()</code> method</li>
                <li class="thingsdb13"><code class="inline">filter()</code> method</li>
                <li class="thingsdb13"><code class="inline">for</code>-loop</li>
                <li class="thingsdb13">all of the above</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">What is the final result of the following code snippet?</p>
            <p class="quizcode"><code class="inline">range(2, 5).reduce(|t, n, i| t += i * n, 10);</code></p>
            <p class="copyright1"><em class="thingsdb15">(Try to answer without executing the code. For reference, the range() documentation is available
                at: <a href="https://docs.thingsdb.io/v1/collection-api/range/" class="thingsdb14">https://docs.thingsdb.io/v1/collection-api/range/</a>)</em></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Suppose we have the following input:</p>
            <p class="quizcode"><code class="inline">input = [[1, 2], [3, 4]];</code></p>
            <p class="copyright1">Can you write code which returns with <code class="inline">[1, 2, 3, 4]</code> from that given input?</p>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-11">
<section>
    <h4 id="answers-chapter-3" class="title2">3.6.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Answer "a" is correct. When assigning a list to a property, a copy is created, resulting in a maintained list. Changes to the original list will not reflect in the maintained list.</p></li>
        <li class="thingsdb13"><p class="copyright1">A copy of list <code class="inline">A</code> will be created as a tuple. Since the nested tuple is immutable, you cannot modify its contents after creation.</p></li>
        <li class="thingsdb13"><p class="copyright1">Answer "d" is correct. The code does not contain a maintained list as only variables are used and nothing is assigned to a thing. Nested lists are always converted to tuples and are accessed by reference when assigned to a variable.</p></li>
        <li class="thingsdb13"><p class="copyright1">The correct answer is "f". ThingsDB supports all the listed techniques for iterating over lists and tuples. Each method serves a distinct purpose, and the <code class="inline">for</code>-loop proves particularly valuable when you need to utilize the <code class="inline">break</code> keyword to prematurely terminate the iteration.</p></li>
        <li class="thingsdb13"><p class="copyright1">The result is 21. The function call <code class="inline">range(2, 5)</code> produces the list <code class="inline">[2, 3, 4]</code> and the reduce method uses a closure which adds the index multiplied by the number to a total with a start value of 10. The result is <code class="inline">10 + 0*2 + 1*3 + 2*4 = 10 + 0 + 3 + 8 = 21</code>.</p></li>
        <li class="thingsdb13"><p class="copyright1">While you could use a <code class="inline">for</code>-loop or the <code class="inline">reduce()</code> method to achieve this, ThingsDB provides a dedicated method called <code class="inline">flat()</code> that simplifies this process:</p>
            <p class="quizcode"><code class="inline">input.flat();</code></p>
            <p class="copyright1"><em class="thingsdb15">(see <a href="https://docs.thingsdb.io/v1/data-types/list/flat/" class="thingsdb14">https://docs.thingsdb.io/v1/data-types/list/flat/</a>)</em></p>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-242">
<section type="chapter" role="doc-chapter" aria-labelledby="ch04_h" id="thingsdb_link-302">
    <h2 id="chapter-4" class="thingsdb7">Chapter 4 - Things</h2>
    <p class="copyright1">Let's start this chapter with a new collection named "chapter4" and switch to its scope.
        If you are unsure of the process, revisit the end of <a href="#chapter-1-6" class="thingsdb14">Chapter 1.6</a> for a refresher.</p>
    <p class="copyright1">Why is this programming language named ThingsDB?</p>
    <p class="copyright1">In ThingsDB, data is organized and stored within things, which are essentially objects with properties.
        Every collection starts with an empty root "thing". New "things" can be created
        by using the <code class="inline">thing()</code> function
        without arguments, or, more commonly, you can use curly braces <code class="inline">{}</code>:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">t = {};</code>  <code class="comment">// Create an empty thing</code>
<code class="user">t.x = 4;</code>  <code class="comment">// Assign property "x" with value 4 to "t"</code>
<code class="user">t.y = 2;</code>  <code class="comment">// Assign property "y" with value 2 to "t"</code>
<code class="user">t;</code>        <code class="comment">// Return "t"</code>
<code class="response">{
    "x": 4,
    "y": 2
}</code></pre>
    <p class="copyright1">This can be simplified by initializing the thing with the properties in curly braces:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">t = {x: 4, y: 2,};</code>
<code class="response">{
    "x": 4,
    "y": 2
}</code></pre>
    <p class="copyright1">This initialization syntax only works for properties that adhere to the ThingsDB naming convention, which is the
        same as the convention for variable names <em class="thingsdb15">(see <a href="#chapter-1-3" class="thingsdb14">1.3 Variables and Properties</a>)</em>.
        The properties are defined as key-value pairs separated by commas. You can omit the comma after the last property,
        since ThingsDB will ignore it if no other key-value pairs follow.</p>
    <div class="note">
        <img class="note1" src="images/idea.png" alt="Note" />
        <div class="content">
            <p class="author1">The same principle applies when initializing lists. The last comma in a list initialization is optional if no
                further items follow. For instance, both <code class="inline1">[nil]</code> and <code class="inline1">[nil,]</code>
                are valid representations of the same list.</p>
        </div>
    </div>
    <p class="copyright1">ThingsDB supports a shorthand notation to initialize a thing when using a variable and using the same variable
        name as the property name:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code>
<code class="user">foo = 6;</code>
<code class="user">bar = 7;</code>
<code class="user">t = {foo:, bar:,};</code>
<code class="response">{
    "bar": 7,
    "foo": 6
}</code></pre>
    <p class="copyright1">This syntax is equivalent to writing <code class="inline">t = {foo: foo, bar: bar};</code> but it eliminates
        the need to repeat variable names.</p>
    <section>
        <h3 id="chapter-4-1" class="title1">4.1 Things for Descriptive Multi-Value Returns</h3>
        <p class="copyright1">While lists, as shown in <a href="#chapter-3-5" class="thingsdb14">Chapter 3.5</a>, provide a simple way to return
            multiple values, things provide a more descriptive alternative. They allow assigning meaningful names to
            each value, enhancing clarity and reducing reliance on positional interpretation. This structure improves
            readability and understanding, but comes at a slight network bandwidth cost compared to lists.</p>
        <p class="copyright1">Example:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">status = 0; message = "success";</code>
<code class="user">{
    status:,
    message:,
};</code>  <code class="comment">// Thing containing both status code and message</code>
<code class="response">{
    "message": "success",
    "status": 0
}</code></pre>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">For optimal efficiency of read only queries, construct the thing containing multiple values either
                    at the end of your query or after a <code class="inline1">return</code> statement. Setting individual
                    properties one by one might trigger unnecessary updates. While this has no effect on queries modifying
                    the collection, it can lead to less efficient execution for queries which are intended to be read only.</p>
            </div>
        </div>
    </section>
    <section>
        <h3 id="chapter-4-2" class="title1">4.2 Thing IDs</h3>
        <p class="copyright1">Once a thing is stored, meaning it is connected to the collection root, it is assigned a unique identifier or ID.
            Back in <a href="#chapter-1-1" class="thingsdb14">Chapter 1.1</a> we already saw that our root thing had an ID and that we
            could ask for this ID using the <code class="inline">id()</code> method.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">.id();</code>  <code class="comment">// ID for the collection root</code>
<code class="response">1</code>
<code class="prompt">(//chapter4)&gt;</code> <code class="user">{}.id();</code>  <code class="comment">// Unattached thing lacks an ID</code>
<code class="response">null</code>
<code class="prompt">(//chapter4)&gt;</code> <code class="user">(.t = {}).id();</code>  <code class="comment">// Assign a new thing to property "t",</code>
                               <code class="comment">// guaranteeing a unique ID.</code>
<code class="response">2</code></pre>
        <p class="copyright1">A thing possesses no ID as long as it remains unattached to the collection. In the last example, we attached a
            new thing to property <code class="inline">t</code> within the root and immediately queried its ID. The
            response displayed a unique identifier.</p>
        <p class="copyright1">Instead of explicitly requesting the ID, it is also accessible as a reserved property
            named "<code class="inline">#</code>" within the thing's response.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">.t;</code>
<code class="response">{
    "#": 2
}</code></pre>
        <p class="copyright1">However, it is important to note that "<code class="inline">#</code>" is not a genuine property of the thing,
            as evidenced by the following code snippets:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">.t["#"];</code>  <code class="comment">// Key â#' does not exist</code>
<code class="response">LookupError: thing `#2` has no property `#`</code>
<code class="prompt">(//chapter4)&gt;</code> <code class="user">.t.len();</code>  <code class="comment">// The length is 0</code>
<code class="response">0</code>
<code class="prompt">(//chapter4)&gt;</code> <code class="user">bool(.t);</code>  <code class="comment">// Empty thing evaluates as false and .t is empty</code>
<code class="response">false</code></pre>
        <p class="copyright1">As ThingDB implicitly assigns IDs to things, it is crucial to grasp when this occurs.
            While the earlier example might seem straightforward, it is essential to recognize its nuances.</p>
        <p class="copyright1">The code below employs the <code class="inline">assert()</code> function, which triggers an exception
            if the provided expression evaluates to <code class="inline">false</code>. This, along with the
            <code class="inline">is_nil()</code> and <code class="inline">is_int()</code> functions,
            facilitates straightforward testing for ID existence.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code>
<code class="user">arr = [];</code>               <code class="comment">// Create an empty list</code>
<code class="user">a = {name: "Alice"};</code>    <code class="comment">// Create a thing with a name property</code>
<code class="user">assert(is_nil(a.id()));</code> <code class="comment">// Confirm that the thing has no ID</code>
<code class="user">arr.push(a);</code>            <code class="comment">// Add the thing to the list</code>
<code class="user">assert(is_nil(a.id()));</code> <code class="comment">// Verify that the thing still lacks an ID</code>
<code class="user">.arr = arr;</code>             <code class="comment">// Assign the list to a collection root property</code>
<code class="user">assert(is_int(a.id()));</code> <code class="comment">// Verify that the thing now has an ID</code>
<code class="user">a;</code>
<code class="response">{
    "#": 3,
    "name": "Alice"
}</code></pre>
        <p class="copyright1">In this example, we observe that the ID is generated when the thing is linked to the collection. Initially,
            we assigned the thing to a variable, followed by adding the variable to the list. Since the list remained
            unattached to the collection, the thing retained its lack of an ID. It is only when we incorporated the
            list as a property of the collection root that it became associated with the collection, triggering ID
            assignment.</p>
        <p class="copyright1">Another noteworthy aspect is that ThingsDB always interprets things by reference. This observation is evident
            in the fact that we kept checking the original variable "<code class="inline">a</code>".</p>
        <p class="copyright1">Once an ID is assigned to a thing, it remains permanently associated with that thing and cannot be altered
            or removed.</p>
        <p class="copyright1">ThingsDB supports multiple references to the same ID, allowing you to link distinct properties or collections
            to the same underlying thing. This is demonstrated in the code snippet:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">.t.p = .arr.first();</code>
<code class="response">{
    "#": 3,
    "name": "Alice"
}</code></pre>
        <p class="copyright1">As evident, property <code class="inline">p</code> of thing <code class="inline">t</code> points to the same
            thing as the first element in the list.</p>
        <p class="copyright1">If you know the ID of a specific thing, you can directly retrieve it using the <code class="inline">thing()</code>
            function. When provided with an integer as the first argument, ThingsDB searches the collection for the
            thing with that ID. This becomes particularly useful in practical scenarios.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">thing(3).name = "Bob";</code>
<code class="response">"Bob"</code>
<code class="prompt">(//chapter4)&gt;</code> <code class="user">thing(99).name = "Charlie";</code>
<code class="response">LookupError: collection `chapter4` has no `thing` with ID 99</code></pre>
        <p class="copyright1">The first example successfully modifies the <code class="inline">name</code> property of the thing with ID 3 to <code class="inline">"Bob"</code>.
            The second query fails because the collection does not contain a thing with ID 99.</p>
        <p class="copyright1">Let's review the current state of the collection by querying the <code class="inline">root()</code> thing:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">root();</code>
<code class="response">{
    "#": 1,
    "arr": [{"#": 3}],
    "t": {"#": 2}
}</code></pre>
        <p class="copyright1">This output might raise an eyebrow. While the <code class="inline">root()</code> with properties
            <code class="inline">arr</code> and <code class="inline">t</code> is fully displayed, the
            <code class="inline">p</code> property of the thing with ID 2 and the <code class="inline">name</code>
            property of the thing with ID 3 are missing.</p>
        <p class="copyright1">This is because ThingsDB, by default, returns things only <em class="thingsdb15">one level</em> deep. In this instance,
            the <code class="inline">root()</code> represents the first level, and the things within list
            <code class="inline">arr</code> and the thing within <code class="inline">t</code> are considered
            the second level. This safety measure prevents accidentally returning the entire collection.
            While this might be acceptable in our example due to its small size, it could pose issues with
            larger collections.</p>
    </section>
    <section>
        <h3 id="chapter-4-3" class="title1">4.3 Control Response with return Statement</h3>
        <p class="copyright1">To address the issue of returning only <em class="thingsdb15">one level</em> deep, we can utilize the <code class="inline">return</code>
            keyword, which was introduced in <a href="#chapter-1-5" class="thingsdb14">Chapter 1.5</a>. This statement accepts a
            second argument that specifies the deep level:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">return root(), 3;</code>
<code class="response">{
    "#": 1,
    "arr": [{"#": 3, "name": "Bob"}],
    "t": {"#": 2, "p": {"#": 3, "name": "Bob"}}
}</code></pre>
        <p class="copyright1">With this modified query, we now see the <code class="inline">root()</code> and its properties at <em class="thingsdb15">level 1</em>,
            the thing with ID 3 within <code class="inline">arr</code> at <em class="thingsdb15">level 2</em>, the thing with ID 2 at <em class="thingsdb15">level 2</em>,
            and the thing with ID 3 again, this time residing on property <code class="inline">p</code> at <em class="thingsdb15">level 3</em>.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">While it is generally recommended to keep the default deep level unchanged, it is possible to modify
                    it using the <code class="inline1">set_default_deep()</code> function. The current deep setting can
                    be checked using the <code class="inline1">deep()</code> function within a collection or through
                    the <code class="inline1">collections_info()</code> function in the <code class="inline1">@thingsdb</code>
                    scope.</p>
            </div>
        </div>
        <p class="copyright1">The <code class="inline">return</code> statement accepts an optional third argument, which allows you to specify flags that modify the
            returned data. Currently, only one flag is supported: <code class="inline">NO_IDS</code>.
            When enabled, this flag prevents ThingsDB from including ID values in the response.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">return root(), 3, NO_IDS;</code>
<code class="response">{
    "arr": [{"name": "Bob"}],
    "t": {"p": {"name": "Bob"}}
}</code></pre>
        <p class="copyright1">While you might initially consider using the <code class="inline">return</code> statement frequently to control the deep level or
            incorporate the <code class="inline">NO_IDS</code> flag, ThingsDB offers a more elegant and streamlined
            approach to retrieving the desired data. This will be introduced in <a href="#chapter-10" class="thingsdb14">Chapter 10</a>, where we delve into typed things and wrapping.</p>
    </section>
    <section>
        <h3 id="chapter-4-4" class="title1">4.4 Looping Over a Thing</h3>
        <p class="copyright1">We can use a <code class="inline">for</code>-loop to iterate through the key value pairs of a thing.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">.gps = {lat: 51.36, long: 5.23};
for (key, value in .gps) {
    log(`{key}: {value}`);
};</code>
<code class="response">WARNING:root:ThingsDB: lat: 51.36 (2)
WARNING:root:ThingsDB: long: 5.23 (2)
null</code></pre>
        <p class="copyright1">The <code class="inline">for</code>-loop is similar when used on a thing compared to when iterating a list.
            Only the arguments are different. While iterating over a list accepts a value and index, a thing accepts a
            key and value.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">In this code snippet, we introduced a new <code class="inline1">log()</code> function <em class="thingsdb15">(distinct
                    from the <strong class="thingsdb17">loge()</strong> function that calculates the natural logarithm (base e) of a number)</em>.
                    This <code class="inline1">log()</code> function serves debugging purposes and operates as follows:
                    Upon execution, it generates a warning log message to the console where the ThingsDB Node is running and emits a warning event to the client initiating the query. This warning event precedes the transmission of query results. The ThingsDB Prompt conveniently handles this event by displaying the warning message within the prompt. While real-world implementations may vary, warnings are typically logged for future reference.</p>
            </div>
        </div>
        <p class="copyright1">Similar to lists, a thing also offers methods for iterating over its contents. The provided example
            demonstrates how to achieve the same result as the <code class="inline">for</code>-loop using the
            <code class="inline">each()</code> method:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">.gps.each(|key, value| log(`{key}: {value}`));</code>
<code class="response">WARNING:root:ThingsDB: lat: 51.36 (2)
WARNING:root:ThingsDB: long: 5.23 (2)
null</code></pre>
        <p class="copyright1">Additional looping methods include <code class="inline">filter()</code>, <code class="inline">map()</code>,
            and <code class="inline">vmap()</code>.</p>
    </section>
    <section>
        <h3 id="chapter-4-5" class="title1">4.5 Value Restriction</h3>
        <p class="copyright1">While keys in ThingsDB are always restricted to strings, values can have any type. However, if a specific
            type is required for all values, a value restriction can be applied to enforce this constraint.</p>
        <p class="copyright1">Consider our existing "gps" example:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">.gps.restriction();</code>
<code class="response">null</code></pre>
        <p class="copyright1">The <code class="inline">restriction()</code> method returns <code class="inline">nil</code>,
            indicating that no value restriction is currently applied to the "gps" thing.</p>
        <p class="copyright1">Attempting to apply an invalid restriction to a non-empty thing will result in an error. For instance,
            trying to restrict "gps" to integer values will fail because it already contains float values:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">.gps.restrict("int");</code>
<code class="response">ValueError: at least one of the existing values does not match the desired restriction</code></pre>
        <p class="copyright1">To successfully apply a value restriction, all existing values must adhere to the specified type. In this case,
            we can successfully apply a float restriction:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">.gps.restrict("float");</code>
<code class="response">{
    "#": 5,
    "lat": 51.36,
    "long": 5.23
}</code></pre>
        <p class="copyright1">Once a value restriction is applied, attempting to assign a value of an incompatible type will trigger a type error:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">.gps.lat = nil;</code>
<code class="response">TypeError: restriction mismatch</code></pre>
        <p class="copyright1">This error prevents invalid value assignments and ensures data integrity.</p>
    </section>
    <section>
        <h3 id="chapter-4-6" class="title1">4.6 Self-References</h3>
        <p class="copyright1">Lists and other data types in ThingsDB do not allow for self-references due to the creation of
            copies (tuple conversion) when lists are nested. However, self-references are common within the
            structure of things.</p>
        <p class="copyright1">Consider a simple example of creating a book and its author:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="comment">// Create a book and author</code>
<code class="user">author = {name: "Katja Hoyer"};
.book = {
    title: "Beyond the wall",
    author:,
};</code>
<code class="response">{
    "#": 6,
    "author": {"#": 7},
    "title": "Beyond the wall"
}</code></pre>
        <p class="copyright1">Since we only retrieve the first deep level of detail, we do not see the entire author thing,
            but we can see that both the book and author have unique IDs (6 and 7, respectively).</p>
        <p class="copyright1">To retrieve the author of the book, we can simply access the author property of the book thing:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">thing(6).author.name;</code>  <code class="comment">// ID 6 is the book</code>
<code class="response">"Katja Hoyer"</code></pre>
        <p class="copyright1">To retrieve the books written by the author, we can add a <code class="inline">books</code> property
            to the author thing and populate it with the book:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">thing(7).books = [.book];</code>  <code class="comment">// ID 7 is the author</code>
<code class="user">nil;</code>  <code class="comment">// Return nil as we do not need the assignment as response</code>
<code class="response">null</code></pre>
        <p class="copyright1">Now, we can retrieve data in both directions, but we have created a nested self-reference for both the book
            and the author.</p>
        <p class="copyright1">You might wonder what will happen if we use a large deep value and ask for either the book or the author?
            ThingsDB intelligently handles the situation by only returning the IDs of self-referential objects.
            This prevents infinite loops and ensures data integrity:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter4)&gt;</code> <code class="user">return .book, 99;</code>
<code class="response">{
    "#": 6,
    "author": {
        "#": 7,
        "books": [{"#": 6}],
        "name": "Katja Hoyer"
    },
    "title": "Beyond the wall"
}</code></pre>
        <p class="copyright1">Establishing two-way relationships between things is a common practice in ThingsDB, but managing these
            connections manually can be cumbersome and error-prone. To address this challenge, ThingsDB introduces
            a sophisticated solution that simplifies and streamlines relationship management.</p>
        <p class="copyright1">In <a href="#chapter-9" class="thingsdb14">Chapter 9</a>, we'll delve into the details of this solution and explore
            its capabilities in detail. But before we embark on this journey, we encourage you to assess your
            comprehension by taking the quiz provided. This will help solidify your understanding of things and prepare
            you for the next chapter, where we'll explore the powerful concept of <em class="thingsdb15">sets</em> in depth.</p>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-12">
<section>
    <h3 id="quiz-chapter-4" class="title1">4.7 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Looking at the following code, will the thing "<code class="inline">t</code>" receive an unique ID and if so, at which line? <em class="thingsdb15">(a-e)</em></p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">t = {};</code></li>
                <li class="thingsdb13"><code class="inline">p = [t];</code></li>
                <li class="thingsdb13"><code class="inline">.p = p;</code></li>
                <li class="thingsdb13"><code class="inline">.t = t;</code></li>
                <li class="thingsdb13"><code class="inline">// "t" still lacks an ID</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">What will be the response for a query using the following code?</p>
            <p class="quizcode"><code class="inline">return {x: 1, y: 2}, 0;</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">What function is available to verify the <em class="thingsdb15">deep</em> value for a collection using a collection scope?</p></li>
        <li class="thingsdb13"><p class="copyright1">How can you see the ID of a thing in a query response? For example, in the response for this code?</p>
            <p class="quizcode"><code class="inline">.x = {};</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Which of the following code examples will work without returning an error?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">{4: 2}.restrict("int");</code></li>
                <li class="thingsdb13"><code class="inline">{}.restrict("int").x = 123;</code></li>
                <li class="thingsdb13"><code class="inline">{m: 'Hello!'}.restrict("str");</code></li>
                <li class="thingsdb13"><code class="inline">{}.restrict("int").x = 1.0;</code></li>
                <li class="thingsdb13"><code class="inline">{pi: 3}.restrict("float").pi = MATH_PI;</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Can a <em class="thingsdb15">list</em> in ThingsDB be a part of itself?</p></li>
        <li class="thingsdb13"><p class="copyright1">Can a <em class="thingsdb15">thing</em> in ThingsDB be a part of itself?</p></li>
        <li class="thingsdb13"><p class="copyright1">Given the existing thing:</p>
            <p class="quizcode"><code class="inline">.point = {x: 5, y: 7};</code></p>
            <p class="copyright1">Can you create a query to return the following desired response:</p>
            <p class="quizcode"><code class="inline">{"x": 5.0, "y": 7.0}</code></p>
            <p class="copyright1">The returned object should contain float values instead of integer values for the <code class="inline">x</code> and <code class="inline">y</code> properties.</p>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-254">
<section>
    <h4 id="answers-chapter-4" class="title2">4.7.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">At line "c". The thing is a member of the list <code class="inline">p</code> which on this line is assigned to the collection root via property <code class="inline">p</code>.</p></li>
        <li class="thingsdb13"><p class="copyright1">The <em class="thingsdb15">deep</em> value has been set to 0, so the query will return an empty object: <code class="inline">{}</code></p></li>
        <li class="thingsdb13"><p class="copyright1">The <code class="inline">deep()</code> method can be used to retrieve the current deep value for a collection in the collection scope. </p></li>
        <li class="thingsdb13"><p class="copyright1">The ID of a thing is returned as the <code class="inline">#</code> property in the thing object unless explicitly the <code class="inline">NO_IDS</code> flag is used.</p></li>
        <li class="thingsdb13"><p class="copyright1">The code samples "b" and "c" will execute without errors. Code snippet "a" will fail because keys must be of type string, and snippet "d" will fail because the thing is restricted to integers and the value <code class="inline">1.0</code> is a float. Snipped "e" fails because the initial value of <code class="inline">pi</code> is an integer, and attempting to apply the restriction to type float will result in an error.</p></li>
        <li class="thingsdb13"><p class="copyright1">No, a <em class="thingsdb15">list</em> cannot be a part of itself. Lists are copied when nested, so they cannot be referenced by themselves.</p></li>
        <li class="thingsdb13"><p class="copyright1">Yes, a <em class="thingsdb15">thing</em> can be a part of itself. Things are always accessed by reference, so they can be self-referential.</p></li>
        <li class="thingsdb13"><p class="copyright1">The easiest way to accomplish this is by using the <code class="inline">vmap()</code> method which returns a new thing with equal keys but values computed as a result of a given closure callback.</p>
            <p class="quizcode"><code class="inline">.point.vmap(|v| float(v));</code></p>
            <p class="copyright1"><em class="thingsdb15">(see <a href="https://docs.thingsdb.io/v1/data-types/thing/vmap" class="thingsdb14">https://docs.thingsdb.io/v1/data-types/thing/vmap</a>)</em></p>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-7">
<section type="chapter" role="doc-chapter" aria-labelledby="ch05_h" id="thingsdb_link-303">
    <h2 id="chapter-5" class="thingsdb7">Chapter 5 - Sets</h2>
    <p class="copyright1">Just like in previous chapters, we shall begin by creating a new collection and
        switching the prompt to that collection.</p>
    <p class="copyright1">In this chapter, we'll explore the concept of sets in ThingsDB. Let's start by
        creating an empty set.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">.mammals = set();</code>
<code class="response">[]</code></pre>
    <p class="copyright1">Notice that despite creating a set, the response displays an empty list. This is
        because MessagePack, the underlying data serialization format for ThingsDB, does not
        have explicit support for sets. As a result, sets are always converted to lists in responses.</p>
    <p class="copyright1">To add elements to a set, we can utilize the <code class="inline">add()</code> method. Sets can only
        accommodate things. Attempting to add other data types will trigger a type error.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">.mammals.add("dog");</code>
<code class="response">TypeError: cannot add type `str` to a set</code></pre>
    <p class="copyright1">Let's add some mammals to the set. We can add multiple things simultaneously by separating them with commas.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">.mammals.add(
    {animal: "dog"},
    {animal: "cat"},
    {animal: "elephant"},
    {animal: "lion"},
);</code>
<code class="response">4</code></pre>
    <p class="copyright1">The number of things successfully added to the set is returned. In this instance, we added four new elements.</p>
    <p class="copyright1">Let's examine the set we've created:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">.mammals;</code>
<code class="response">[
    {"#": 2, "animal": "dog"},
    {"#": 5, "animal": "lion"},
    {"#": 4, "animal": "elephant"},
    {"#": 3, "animal": "cat"}
]</code></pre>
    <p class="copyright1">As you can see, all things have been assigned unique IDs, but the order of elements does not match our expectation.
        This is because sets are inherently unordered.</p>
    <p class="copyright1">Due to this lack of order, retrieving an element by index is not possible.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">.mammals[0];</code>
<code class="response">TypeError: type `set` is not indexable</code></pre>
    <p class="copyright1">Each thing can only exist once within a set. Remember that ThingsDB compares things by reference, so even if two things
        have identical properties, they are considered distinct entities.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">.mammals.add({animal: "dog"});</code>  <code class="comment">// Add another dog</code>
<code class="response">1</code></pre>
    <p class="copyright1">Despite having the same properties (<code class="inline">animal: "dog"</code>), this dog is
        considered a different entity due to reference comparison. It is not the same "dog" previously added,
        so it gets included in the set.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">animal = .mammals.one();</code>  <code class="comment">// Take one element from the set</code>
<code class="user">.mammals.add(animal);</code>  <code class="comment">// Try to add that animal</code>
<code class="response">0</code></pre>
    <p class="copyright1">The final query yielded <code class="inline">0</code>. This is because the animal already exists within
        the set, and calling the <code class="inline">add()</code> method did not introduce any new elements.</p>
    <section>
        <h3 id="chapter-5-1" class="title1">5.1 Set Operations</h3>
        <p class="copyright1">Before moving forward, let's create two more sets, one for birds and another for reptiles.
            <em class="thingsdb15">(We apologize to any fish or other animal species that weren't included; we'll focus on these three classes for now ;-)</em></p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">.birds = set(
    {animal: "parrot"},
    {animal: "flamingo"},
);
.reptiles = set(
    {animal: "turtle"},
    {animal: "snake"},
);</code>
<code class="user">nil;</code>  <code class="comment">// Return nil as we do not need a response</code>
<code class="response">null</code></pre>
        <p class="copyright1">Now that we have our sets ready, let's create a zoo and populate it with some animals.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code>
<code class="user">animals = ["lion", "elephant", "flamingo", "turtle", "snake"];
all = .mammals | .birds | .reptiles;
.zoo = all.filter(|x| animals.has(x.animal));
.zoo.len();</code>
<code class="response">5</code></pre>
        <p class="copyright1">Let's break down what happened here:</p>
        <ol class="thingsdb12">
            <li class="thingsdb13">We defined a list (<code class="inline">animals</code>) containing the animals we want in the zoo.</li>
            <li class="thingsdb13">Using the union operator (<code class="inline">|</code>), we created a new set (<code class="inline">all</code>) that combines the <code class="inline">mammals</code>, <code class="inline">birds</code>, and <code class="inline">reptiles</code> sets.</li>
            <li class="thingsdb13">We employed the <code class="inline">filter()</code> method to iterate over the <code class="inline">all</code> set and select only those animals that are also present in the <code class="inline">animals</code> list.</li>
            <li class="thingsdb13">Finally, we used the <code class="inline">len()</code> method to count the number of animals in the <code class="inline">zoo</code> set.</li>
        </ol>
        <p class="copyright1">Sets in ThingsDB provide a range of useful operations that enable efficient manipulation of data.
            These operations, summarized in <a href="#thingsdb_link-8" class="thingsdb14">Table 5.1</a>, facilitate tasks such as combining,
            filtering, and finding specific subsets of things within sets.</p>
        <div class="table">
            <h2 id="thingsdb_link-8" class="thingsdb7"></h2>
            <p class="title3">Table 5.1 - Set operations</p>
            <table class="thingsdb20">
                <tr class="thingsdb21"><th class="thingsdb22">Operator</th><th class="thingsdb22">Operation</th><th class="thingsdb22">Description</th></tr>
                <tr class="thingsdb21">
                    <td class="thingsdb23"><code class="inline">|</code> (union)</td>
                    <td class="thingsdb23"><code class="inline">A | B</code></td>
                    <td class="thingsdb23">The set of things that are in either <code class="inline">A</code> or <code class="inline">B</code>.</td>
                </tr>
                <tr class="thingsdb21">
                    <td class="thingsdb23"><code class="inline">&amp;</code> (intersection)</td>
                    <td class="thingsdb23"><code class="inline">A &amp; B</code></td>
                    <td class="thingsdb23">The set of things that are in both <code class="inline">A</code> and <code class="inline">B</code>.</td>
                </tr>
                <tr class="thingsdb21">
                    <td class="thingsdb23"><code class="inline">-</code> (difference)</td>
                    <td class="thingsdb23"><code class="inline">A - B</code></td>
                    <td class="thingsdb23">The set of things that are in <code class="inline">A</code> but not <code class="inline">B</code>.</td>
                </tr>
                <tr class="thingsdb21">
                    <td class="thingsdb23"><code class="inline">^</code> (symmetric difference)</td>
                    <td class="thingsdb23"><code class="inline">A ^ B</code></td>
                    <td class="thingsdb23">The set of things that are in either <code class="inline">A</code> or <code class="inline">B</code>, but not in both.</td>
                </tr>
            </table>
        </div>
        <p class="copyright1">We have already employed the union operation to populate our zoo with a diverse set of animals.
            Now, let's delve into additional examples showcasing how set operations can be utilized within
            the context of our zoo.</p>
        <section>
            <h4 id="chapter-5-1-1" class="title2">5.1.1 Identifying Birds Not in the Zoo</h4>
            <p class="copyright1">The <code class="inline">-</code> operator allows us to find birds that are not part of the zoo:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">.birds - .zoo;</code>
<code class="response">[
    {"#": 8, "animal": "parrot"}
]</code></pre>
            <p class="copyright1">This command retrieves the <code class="inline">birds</code> set and subtracts the
                <code class="inline">zoo</code> set, resulting in a new set containing only the birds that
                do not reside in the zoo.</p>
        </section>
        <section>
            <h4 id="chapter-5-1-2" class="title2">5.1.2 Selecting Warm-Blooded Animals in the Zoo</h4>
            <p class="copyright1">We can combine the <code class="inline">|</code> and <code class="inline">&amp;</code>
                operators to find warm-blooded animals that are also in the zoo:</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">(.mammals | .birds) &amp; .zoo;</code>
<code class="response">[
    {"#": 7, "animal": "flamingo"},
    {"#": 5, "animal": "lion"},
    {"#": 4, "animal": "elephant"}
]</code></pre>
            <p class="copyright1">This expression combines the <code class="inline">mammals</code> and
                <code class="inline">birds</code> sets using <code class="inline">|</code>,
                then intersects the resulting set with the <code class="inline">zoo</code> set,
                effectively selecting only the warm-blooded animals that are in the zoo.</p>
            <p class="copyright1">These examples demonstrate how set operations can effectively manage and analyze data
                within sets, providing a powerful tool for building efficient and data-driven applications.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-5-2" class="title1">5.2 Determining Set Membership and Supersets/Subsets</h3>
        <p class="copyright1">In addition to the set operations we've covered, ThingsDB sets provide several additional
            useful operators and methods. These enable us to determine whether a set contains all things
            of another set, verify whether a set is a subset or superset of another, and check
            whether a particular thing belongs to a set.</p>
        <section>
            <h4 id="chapter-5-2-1" class="title2">5.2.1 Verifying Set Membership</h4>
            <p class="copyright1">The <code class="inline">has()</code> method can be employed to determine whether a specific
                thing exists within a set. This method is particularly efficient for sets compared to lists,
                as it does not require iterating through the entire collection to perform the check.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">flamingo = .birds.find(|b| b.animal == "flamingo");
.zoo.has(flamingo);</code>
<code class="response">true</code></pre>
        </section>
        <section>
            <h4 id="chapter-5-2-2" class="title2">5.2.2 Checking Subsets and Supersets</h4>
            <p class="copyright1">To determine whether one set is a subset of another, we can use the
                <code class="inline">&lt;=</code> operator. This operator checks if all elements of the first set
                are also present in the second set.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">.reptiles &lt;= .zoo;</code>  <code class="comment">// Determines if "reptiles" is a</code>
                                  <code class="comment">// subset of "zoo"</code>
<code class="response">true</code></pre>
            <p class="copyright1">Conversely, to verify whether a set is a superset of another, we employ the
                <code class="inline">&gt;=</code> operator. This operator checks if the second set contains all
                the elements of the first set.</p>
<pre class="thingsdb16"><code class="prompt">(//chapter5)&gt;</code> <code class="user">.zoo &gt;= .reptiles;</code>  <code class="comment">// Determines if "zoo" is a</code>
                                  <code class="comment">// superset of "reptiles"</code>
<code class="response">true</code></pre>
            <p class="copyright1">To distinguish between proper subsets and supersets, which explicitly exclude the possibility of equality,
                the <code class="inline">&lt;</code> and <code class="inline">&gt;</code> operators are employed.
                These operators function similarly to their respective <code class="inline">&lt;=</code> and
                <code class="inline">&gt;=</code> counterparts, but they return <code class="inline">false</code> when
                the sets are equal.</p>
            <div class="table">
                <h2 id="thingsdb_link-304" class="thingsdb7"></h2>
                <p class="title3">Table 5.2 - Subset and Superset operations</p>
                <table class="thingsdb20">
                    <tr class="thingsdb21"><th class="thingsdb22">Operator</th><th class="thingsdb22">Operation</th><th class="thingsdb22">Description</th></tr>
                    <tr class="thingsdb21">
                        <td class="thingsdb23"><code class="inline">&lt;=</code></td>
                        <td class="thingsdb23">is subset</td>
                        <td class="thingsdb23">Determines if all things of the first set are contained within the second set, ignoring equality.</td>
                    </tr>
                    <tr class="thingsdb21">
                        <td class="thingsdb23"><code class="inline">&lt;</code></td>
                        <td class="thingsdb23">is proper subset</td>
                        <td class="thingsdb23">Determines if all things of the first set are contained within the second set, and the two sets are not equal.</td>
                    </tr>
                    <tr class="thingsdb21">
                        <td class="thingsdb23"><code class="inline">&gt;=</code></td>
                        <td class="thingsdb23">is superset</td>
                        <td class="thingsdb23">Determines if all things of the second set are contained within the first set, ignoring equality.</td>
                    </tr>
                    <tr class="thingsdb21">
                        <td class="thingsdb23"><code class="inline">&gt;</code></td>
                        <td class="thingsdb23">is proper superset</td>
                        <td class="thingsdb23">Determines if all things of the second set are contained within the first set, and the two sets are not equal.</td>
                    </tr>
                </table>
            </div>
        </section>
    </section>
    <section>
        <h3 id="chapter-5-3" class="title1">5.3 Copy or Reference</h3>
        <p class="copyright1">Assignments with sets follow a similar pattern to lists. When assigning a set to a variable,
            it is treated as a reference. However, if you assign a set to a property of a thing,
            a copy of the set will be created.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">Nested sets are not supported in ThingsDB. Sets can only contain things. However, you can add a set to a list.
                    In this case, a copy of the set will be made, and it will be converted into an immutable tuple.</p>
            </div>
        </div>
        <div class="table">
            <h2 id="thingsdb_link-305" class="thingsdb7"></h2>
            <p class="title3">Table 5.3 - Summary of when ThingsDB employs copying or reference assignment for a set</p>
            <table class="thingsdb20">
                <tr class="thingsdb21"><th class="thingsdb22">Assignment</th><th class="thingsdb22">Description</th></tr>
                <tr class="thingsdb21">
                    <td class="thingsdb23"><code class="inline">a = b</code></td>
                    <td class="thingsdb23">By reference (<code class="inline">b</code> is a set)</td>
                </tr>
                <tr class="thingsdb21">
                    <td class="thingsdb23"><code class="inline">a = .b</code></td>
                    <td class="thingsdb23">By reference (<code class="inline">.b</code> is a maintained set)</td>
                </tr>
                <tr class="thingsdb21">
                    <td class="thingsdb23"><code class="inline">.a = b</code></td>
                    <td class="thingsdb23">Copy to new maintained set (<code class="inline">b</code> is a set)</td>
                </tr>
                <tr class="thingsdb21">
                    <td class="thingsdb23"><code class="inline">.a = .b</code></td>
                    <td class="thingsdb23">Copy to new maintained set (<code class="inline">.b</code> is a maintained set)</td>
                </tr>
                <tr class="thingsdb21">
                    <td class="thingsdb23"><code class="inline">a.push(set())</code></td>
                    <td class="thingsdb23">Copy to new tuple (<code class="inline">a</code> is a list)</td>
                </tr>
            </table>
        </div>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-251">
<section>
    <h3 id="quiz-chapter-5" class="title1">5.4 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">What data types can be stored in a ThingsDB set?</p></li>
        <li class="thingsdb13"><p class="copyright1">Determine the resulting <em class="thingsdb15">set</em> after performing the following operation:</p>
            <p class="quizcode"><code class="inline">set(a, b) - set(b, c)</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Which of the following expressions evaluates to <code class="inline">true</code>?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">set(a, c) &lt;= set(a, b, d)</code></li>
                <li class="thingsdb13"><code class="inline">set(a, c) &gt;= set(a, b, d)</code></li>
                <li class="thingsdb13"><code class="inline">set(a, c) &gt; set(a, c)</code></li>
                <li class="thingsdb13"><code class="inline">set(a, c) &lt; set(a, b, c)</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">How does a client receive a <em class="thingsdb15">set</em> when it is returned in a response from ThingsDB?</p></li>
        <li class="thingsdb13"><p class="copyright1">Can you explain what will happen when you append a <em class="thingsdb15">set</em> as an element to a <em class="thingsdb15">list</em>?</p></li>
    </ol>
</section>

</div>

<div class="thingsdb3" id="thingsdb_link-32">
<section>
    <h4 id="answers-chapter-5" class="title2">5.4.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Only unique "things" are allowed in a set.</p></li>
        <li class="thingsdb13"><p class="copyright1">The resulting set after performing the operation is <code class="inline">set(a)</code>.
            The <code class="inline">-</code> operator in ThingsDB is used to perform set difference,
            which removes elements from the first set that are also present in the second set.</p>
        </li>
        <li class="thingsdb13"><p class="copyright1">The only expression which evaluates to <code class="inline">true</code> is the expression "d".
            The set with things <code class="inline">a</code> and <code class="inline">c</code> is a
            subset of the set with things <code class="inline">a</code>, <code class="inline">b</code> and
            <code class="inline">c</code>.</p></li>
        <li class="thingsdb13"><p class="copyright1">Because sets are not directly supported by the ThingsDB communication protocol, they must be
            converted to a more fundamental data type when sent to a client. Therefore, the <em class="thingsdb15">set</em> is
            converted into a <em class="thingsdb15">list</em>, which is a sequence of ordered elements. While this conversion
            enables clients to receive and process sets, it is essential to remember that sets are inherently
            unordered collections. As a result, you cannot rely on the order of things in the returned list
            as they may not reflect the order in which the things were added to the set.</p></li>
        <li class="thingsdb13"><p class="copyright1">When a <em class="thingsdb15">set</em> is appended to a <em class="thingsdb15">list</em>, ThingsDB will create a copy and convert
            the set into a <em class="thingsdb15">tuple</em>, which is an immutable collection of elements.</p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-260">
<section type="chapter" role="doc-chapter" aria-labelledby="ch06_h" id="thingsdb_link-306">
    <h2 id="chapter-6" class="thingsdb7">Chapter 6 - Procedures</h2>
    <p class="copyright1">In ThingsDB, we've encountered built-in functions like <code class="inline">is_nil()</code> and
        methods like <code class="inline">.len()</code>, which are functions called on instances of a type.
        We've also explored closures, which are unnamed functions commonly used as callback arguments to
        iterate over lists, sets or things.</p>
    <p class="copyright1">ThingsDB introduces another variation of these concepts called <em class="thingsdb15">procedures</em>.
        Procedures bind a name to a closure and expose the procedure for direct execution. This means we
        can call procedures directly, eliminating the need for queries. Procedures are typically created
        within a collection, but ThingsDB also offers the <code class="inline">/thingsdb</code> scope for
        procedures that simplify management tasks like user creation which we will explore later in this chapter.</p>
     <p class="copyright1">In this chapter, we'll begin crafting a to-do application, empowering you to manage Alice's tasks
        and keep her organized.</p>
    <p class="copyright1">First, let's create a new collection named "todos" using the <code class="inline">/thingsdb</code> scope
        and switch to the <code class="inline">//todos</code> scope.</p>
<pre class="thingsdb16"><code class="prompt">(/thingsdb)&gt;</code> <code class="user">new_collection("todos");</code>
<code class="response">"todos"</code>
<code class="prompt">(/thingsdb)&gt;</code> <code class="user">@ //todos</code>
<code class="prompt">(//todos)&gt;</code></pre>
    <p class="copyright1">To manage Alice's to-do items, we'll create a list to store them. This list will hold strings representing the to-do items. To control what gets added to the list, we'll use a procedure.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">.todos = [];</code>  <code class="comment">// Create an empty list for to-do items</code>
<code class="response">[]</code></pre>
    <p class="copyright1">Instead of directly adding to-do's to the list, we'll create a procedure to manage this process.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">new_procedure("add_todo", |body| {</code>
    <code class="user">"Adds a to-do to the list.";</code>   <code class="comment">// Docstring</code>
    <code class="user">assert(is_str(body) &amp;&amp; body);</code>  <code class="comment">// Check if the input is a</code>
                                   <code class="comment">// non-empty string</code>
    <code class="user">.todos.push(body);</code>  <code class="comment">// Add the to-do to the list</code>
    <code class="user">nil;
});</code>
<code class="response">"add_todo"</code></pre>
    <p class="copyright1">This creates a procedure named <code class="inline">add_todo</code> that takes a
        single <code class="inline">todo</code> argument. The docstring specifies the procedure's purpose
        and is optional. The <code class="inline">assert()</code> function ensures that the input is a valid,
        non-empty string.</p>
    <p class="copyright1">To utilize the <code class="inline">add_todo</code> procedure, we can simply call it directly in a query,
        similar to a regular function.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">add_todo("Read a book");</code>
<code class="response">OperationError: closures with side effects require a change but none is created; use `wse(...)` to enforce a change; see https://docs.thingsdb.io/v1/collection-api/wse</code></pre>
    <p class="copyright1">ThingsDB throws an error indicating that the procedure contains a closure which may introduce
        changes to the collection and requires a change to synchronize the state. This is because ThingsDB
        must ensure data consistency across all nodes when changes occur.</p>
    <section>
        <h3 id="chapter-6-1" class="title1">6.1 Side Effects and Changes</h3>
        <p class="copyright1">To explicitly signal to ThingsDB that the query involves side effects and requires a change,
            we can use the <code class="inline">wse()</code> function. This function informs ThingsDB that
            the query will modify the collection and necessitates a change to maintain data integrity.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">In most cases, ThingsDB automatically detects and handles the need for changes when queries
                    modify data. However, there may be situations where this automatic detection is not
                    possible or desired.</p>
                <p class="author1">To explicitly instruct ThingsDB to initiate a change, the <code class="inline1">wse()</code>
                    <em class="thingsdb15">(with-side-effects)</em> function can be used. This function explicitly informs ThingsDB
                    that the query involves modifications to the collection and requires a change operation to
                    ensure data consistency across nodes.</p>
                <p class="author1">Conversely, there may be scenarios where ThingsDB incorrectly identifies a change as necessary,
                    even though it is not the case. To prevent unnecessary changes, the <code class="inline1">nse()</code>
                    <em class="thingsdb15">(no-side-effects)</em> function can be employed. This function tells ThingsDB that the
                    query does not involve any data modifications and therefore does not require a change operation.</p>
                <p class="author1">By utilizing these functions, developers can effectively manage change propagation in ThingsDB,
                    ensuring data consistency and avoiding unnecessary change operations.</p>
            </div>
        </div>
        <p class="copyright1">Here is the corrected code snippet with the wse() function:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">wse();</code>  <code class="comment">// Tell ThingsDB to initiate a change</code>
<code class="user">add_todo("Read a book");</code>
<code class="response">null</code></pre>
        <p class="copyright1">By including the <code class="inline">wse()</code> function, ThingsDB recognizes the potential data
            modification and initiates the necessary change operations to maintain consistency across nodes.
            This approach ensures that any changes made by the procedure are applied in a coordinated manner,
            preserving the integrity of the data managed by ThingsDB.</p>
        <p class="copyright1">In addition to calling procedures within queries, ThingsDB also allows direct procedure calls without
            the need for queries. While the ThingsDB Prompt does not support direct procedure calls,
            this opens up the opportunity to utilize Python code to interact with ThingsDB. As mentioned earlier,
            Python is not the only programming language supported by ThingsDB; there are also clients available
            for C#, Go, PHP, JavaScript/Node.js and maybe more by the time you read this book. Furthermore, procedures can be invoked through the ThingsDB HTTP API, a topic we'll
            explore in <a href="#chapter-16" class="thingsdb14">Chapter 16</a>.</p>
    </section>
    <section>
        <h3 id="chapter-6-2" class="title1">6.2 Python</h3>
        <p class="copyright1">To streamline the development process, we'll create a reusable template that serves as a foundation
            for our code examples. This template will encapsulate the common connection and authentication steps,
            allowing us to focus on the specific procedure call logic.</p>
        <p class="copyright1">Create a file named <code class="inline">template.py</code> and save the following code:</p>
<pre class="thingsdb16"><code class="prompt">import asyncio
from thingsdb.client import Client

async def work(client: Client):
    pass

async def main():
    client = Client()
    client.set_default_scope('//todos')
    await client.connect('localhost')</code>  <code class="comment"># Replace with the actual ThingsDB</code>
                                       <code class="comment"># server address</code>
<code class="prompt">    try:
        await client.authenticate('admin', 'pass')</code>  <code class="comment"># Replace with your</code>
                                                    <code class="comment"># ThingsDB credentials</code>
<code class="prompt">        await work(client)
    finally:
        client.close()
        await client.wait_closed()

asyncio.run(main())</code></pre>
        <p class="copyright1">This template assumes ThingsDB is running on localhost. If this is not the case, modify the
            <code class="inline">connect()</code> function call to specify the correct address and,
            optionally, a port number. Similarly, update the <code class="inline">authenticate()</code>
            function call with your actual ThingsDB credentials.</p>
        <p class="copyright1">To test the template, run the following command:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python template.py</code>
<code class="prompt">$</code></pre>
        <p class="copyright1">The code should execute without errors, demonstrating the successful connection and authentication
            with ThingsDB.</p>
        <section>
            <h4 id="chapter-6-2-1" class="title2">6.2.1 Run Procedure</h4>
            <p class="copyright1">To execute the <code class="inline">add_todo</code> procedure directly, we'll create a copy of the template Python script
                and name it <code class="inline">add_todo.py</code>.</p>
            <p class="copyright1">Within the work function, we'll modify the code to handle user input and invoke the procedure:</p>
<pre class="thingsdb16"><code class="prompt">async def work(client: Client):</code>
<code class="user">    todo_body = input("To-do body: ")</code>  <code class="comment"># Prompt user for to-do item</code>
<code class="user">    await client.run('add_todo', body=todo_body)</code>  <code class="comment"># Call the add_todo</code>
                                                  <code class="comment"># procedure</code></pre>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">Since we previously called <code class="inline1">client.set_default_scope('//todos')</code> in
                        the template, we do not need to explicitly specify the scope in this instance.</p>
                </div>
            </div>
            <p class="copyright1">Save the file and run the following command to execute the code:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python add_todo.py</code>
<code class="prompt">To-do body:</code> <code class="user">Brush your teeth</code>
<code class="prompt">$</code></pre>
            <p class="copyright1">If successful, no errors should be shown.</p>
        </section>
        <section>
            <h4 id="chapter-6-2-2" class="title2">6.2.2 Perform a Query</h4>
            <p class="copyright1">Next, create another file based on the template and name it <code class="inline">search_todos.py</code>:</p>
<pre class="thingsdb16"><code class="prompt">async def work(client: Client):</code>
<code class="user">    needle = input("Search for: ")</code>  <code class="comment"># Prompt user for search input</code>
<code class="user">    res = await client.query("""//ti
        .todos.filter(|todo| todo.contains('""" + needle + """'));
    """)
    print(res)</code></pre>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">This code utilizes a multi-line string to define the query and prefixes it with <code class="inline1">//ti</code>
                        to improve syntax highlighting in some IDEs. However, this is not mandatory and does not affect
                        the query execution.</p>
                </div>
            </div>
            <p class="copyright1">Execute the following command to run the <code class="inline">search_todos.py</code> file:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python search_todos.py</code>
<code class="prompt">Search for:</code> <code class="user">book</code>
<code class="response">['Read a book']</code></pre>
            <p class="copyright1">The output confirms that the to-do item <code class="inline">"Read a book"</code> has been
                added and retrieved successfully.</p>
        </section>
        <section>
            <h4 id="chapter-6-2-3" class="title2">6.2.3 Prevent Code Injections</h4>
            <p class="copyright1">While the code works, it also contains a potential security flaw. The direct embedding of user
                input into the query structure makes it vulnerable to code injections, allowing malicious code
                to manipulate the collection's properties.</p>
            <p class="copyright1">Consider the scenario where a malicious user inputs the following:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python search_todos.py</code>
<code class="prompt">Search for:</code> <code class="user">' + {.hacked = true; "book";} + '</code>
<code class="response">['Read a book']</code></pre>
            <p class="copyright1">This input, when passed directly into the query, would effectively create an unauthorized
                property <code class="inline">.hacked</code> on the <code class="inline">//todos</code>
                collection root. This highlights the potential for code injections to compromise the integrity
                of ThingsDB data.</p>
            <p class="copyright1">To address this vulnerability, it is essential to separate user input from the query structure by
                using variables. This technique allows for a more secure and controlled handling of user-provided
                data.</p>
            <p class="copyright1">To enhance security and prevent code injections, we'll modify the <code class="inline">search_todos.py</code>
                code to use variables for user input:</p>
<pre class="thingsdb16"><code class="prompt">async def work(client: Client):</code>
<code class="user">    needle = input("Search for: ")</code>  <code class="comment"># Prompt user for search input</code>
<code class="user">    res = await client.query(
        """//ti
            .todos.filter(|todo| todo.contains(needle));
        """,
        needle=needle)
    print(res)</code></pre>
            <p class="copyright1">The original code, which directly embedded the user input into the query, was vulnerable to
                code injections. By using variables, we can isolate the user input and prevent it from affecting
                the query structure. This safeguard protects the integrity of the ThingsDB database and ensures
                that only authorized operations are executed.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">Another benefit of separating input from the query structure is that it enables ThingsDB to
                        cache the query, independent of the user input. This caching mechanism can significantly
                        improve the performance of frequently executed queries, especially those that involve
                        user-provided data.</p>
                    <p class="author1">By isolating user input, ThingsDB can store the compiled query separately from the input values.
                        This allows the database to pre-compile and optimize the query for later execution, regardless
                        of the specific input received. As a result, subsequent executions of the same query can be
                        performed more efficiently, reducing response times and improving overall
                        application performance.</p>
                    <p class="author1">In contrast, if the user input were directly embedded within the query, ThingsDB would need to
                        recompile the query each time it was executed with different input. This would lead to
                        increased processing overhead and potentially slower query performance.</p>
                </div>
            </div>
        </section>
        <section>
            <h4 id="chapter-6-2-4" class="title2">6.2.4 Migrating from Query to Procedure</h4>
            <p class="copyright1">To enhance code organization, we'll migrate the <em class="thingsdb15">"search_todos"</em> query to a reusable procedure.
                This approach encapsulates the search logic and makes it easily accessible from multiple parts of the
                application.</p>
            <p class="copyright1">Create the procedure in a tool like <em class="thingsdb15">things-prompt</em> or <em class="thingsdb15">ThingsGUI</em>. Having explored code-based query execution, you might even prefer to use Python or some other language for code execution. In this book we'll stick with the <em class="thingsdb15">things-prompt</em> for simple code snippets:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">new_procedure("search_todos", |needle| {i
    "Search for todo's";
    .todos.filter(|todo| todo.contains(needle));
});</code>
<code class="response">"search_todos"</code></pre>
            <p class="copyright1">Update the <code class="inline">work</code> method in <code class="inline">search_todos.py</code>
                to call the procedure:</p>
<pre class="thingsdb16"><code class="prompt">async def work(client: Client):</code>
<code class="user">    needle = input("Search for: ")</code>  <code class="comment"># Prompt user for search input</code>
<code class="user">    res = await client.run("search_todos", needle=needle)
    print(res)</code></pre>
            <p class="copyright1">By using a procedure, we've encapsulated the search logic and made it reusable. This approach promotes
                code modularity, improves maintainability, and reduces development complexity.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-6-3" class="title1">6.3 Requesting Procedure Information</h3>
        <p class="copyright1">Procedures are stored within a scope, but they are not directly attached to the root of the collection.
            To retrieve information about procedures within a specific scope, the <code class="inline">procedures_info()</code>
            function is employed. This function returns a list of procedure information objects, each containing
            detailed metadata about the procedure.</p>
        <p class="copyright1">Calling <code class="inline">procedures_info()</code> within the <code class="inline">//todos</code> scope
            produces the following output:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">procedures_info();</code>
<code class="response">[
    {
        "arguments": ["todo"],
        "created_at": 1706363614,
        "doc": "Adds a to-do to the list.",
        "name": "add_todo",
        "with_side_effects": true
    },
    {
        "arguments": ["needle"],
        "created_at": 1706540544,
        "doc": "Search for todo's",
        "name": "search_todos",
        "with_side_effects": false
    }
]</code> <code class="comment">//-- some information is left out to keep the sample comprehensible</code></pre>
        <p class="copyright1">The properties of each procedure in this list provide valuable insights. The
            <code class="inline">with_side_effects</code> property indicates whether invoking the procedure
            modifies the dataset or not. Additionally, each procedure's arguments are listed, and a brief
            description of its functionality is provided in the <code class="inline">doc</code> property
            <em class="thingsdb15">(this is the docstring we provided earlier in the closure body)</em>.</p>
        <section>
            <h4 id="chapter-6-3-1" class="title2">6.3.1 Extracting Properties from Information Objects</h4>
            <p class="copyright1">Now that we have a basic understanding of procedure information objects, let's focus on
                extracting just the procedure names.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">type(procedures_info());</code>
<code class="response">"list"</code>
<code class="prompt">(//todos)&gt;</code> <code class="user">type(procedures_info().first());</code>
<code class="response">"mpdata"</code></pre>
            <p class="copyright1">Observing the data types involved, we can see that the <code class="inline">procedures_info()</code>
                function returns a list of <em class="thingsdb15">mpdata</em> objects, not <em class="thingsdb15">things</em>. MPdata stands
                for "MessagePack-Data" and represents serialized MessagePack data. Information objects
                in ThingsDB are pre-serialized to minimize work and enhance performance.</p>
            <p class="copyright1">To extract the procedure names, we can utilize the <code class="inline">load()</code> method
                provided by the mpdata type. This method allows us to deserialize mpdata objects into
                ThingsDB objects, enabling us to access their properties.</p>
            <p class="copyright1">Applying <code class="inline">load()</code> to a procedure information object results in a
                thing object. This enables us to access the <code class="inline">name</code> property of
                the procedure, which provides the procedure's identifier.</p>
            <p class="copyright1">With this approach, we can efficiently retrieve a list of procedure names using the
                following code:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">procedures_info().map(|mpdata| mpdata.load().name);</code>
<code class="response">[
    "add_todo",
    "search_todos"
]</code></pre>
            <p class="copyright1">This concise code demonstrates the ability to extract relevant information from
                pre-serialized MessagePack data.</p>
        </section>
        <section>
            <h4 id="chapter-6-3-2" class="title2">6.3.2 Additional Procedure Functions</h4>
            <p class="copyright1">We've covered the <code class="inline">new_procedure()</code> and <code class="inline">procedures_info()</code>
                functions, but ThingsDB offers a few more functions that you can find in a dedicated
                documentation section.</p>
            <p class="copyright1">For detailed information on these additional procedure functions, please refer to the
                ThingsDB documentation: <a href="https://docs.thingsdb.io/v1/procedures-api/" class="thingsdb14">https://docs.thingsdb.io/v1/procedures-api/</a></p>
        </section>
    </section>
    <section>
        <h3 id="chapter-6-4" class="title1">6.4 Thinking Ahead</h3>
        <p class="copyright1">While the current setup of the to-do application works well for Alice, it is important to consider
            scalability and maintainability from the start. While full admin access might be sufficient for now,
            granting such extensive permissions to the Python code might not be the best approach in the long run.</p>
        <p class="copyright1">To address this, we can create a dedicated user for the Python code and grant them only the necessary
            permissions. This will provide a more secure and controlled environment for managing user access.</p>
        <p class="copyright1">Using the <code class="inline">grant()</code> function, we can assign the appropriate permissions to
            the newly created user. The table below summarizes the various permission flags available in ThingsDB:</p>
        <div class="table">
            <h2 id="thingsdb_link-307" class="thingsdb7"></h2>
            <p class="title3">Table 6.4 - Summary of permission flags</p>
            <table class="thingsdb20">
                <tr class="thingsdb21"><th class="thingsdb22">Mask</th><th class="thingsdb22">Description</th></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">QUERY</code> (<code class="inline">1</code>)</td><td class="thingsdb23">Grants access to execute queries</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">CHANGE</code> (<code class="inline">2</code>)</td><td class="thingsdb23">Grants access to make changes</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">GRANT</code> (<code class="inline">4</code>)</td><td class="thingsdb23">Grants administrative privileges, allowing users to grant and revoke permissions to other users</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">JOIN</code> (<code class="inline">8</code>)</td><td class="thingsdb23">Grants join (and leave) privileges to a room</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">RUN</code> (<code class="inline">16</code>)</td><td class="thingsdb23">Grants access to run procedures directly</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">USER</code> (<code class="inline">27</code>)</td><td class="thingsdb23">Combination of <code class="inline">QUERY</code>, <code class="inline">CHANGE</code>, <code class="inline">JOIN</code> and RUN</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">FULL</code> (<code class="inline">31</code>)</td><td class="thingsdb23">Combination of all privileges</td></tr>
            </table>
        </div>
        <p class="copyright1">Since we've migrated all the queries from the Python code to procedures, we no longer
            require <code class="inline">QUERY</code> access. Therefore, we can safely grant the user
            <code class="inline">CHANGE</code> and <code class="inline">RUN</code> permissions, which will allow them to
            modify data and execute procedures within the "todos" scope.</p>
        <p class="copyright1">By adopting this approach, we can effectively differentiate between the administrative user (Alice) and the
            Python code, ensuring that the code has the appropriate level of access to perform its tasks while
            maintaining security and control over the system.</p>
        <p class="copyright1">Instead of creating users manually, we can create a procedure to automate the process. This will make
            it easier to manage users and create new ones as needed.</p>
        <p class="copyright1">Let's create a procedure called <code class="inline">new_todo_user</code> in the
            <code class="inline">/thingsdb</code> scope that takes a user name and access flags as input and generates a unique
            token for authentication.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">@ /t;</code>  <code class="comment">// Switch to the /thingsdb scope</code>
<code class="prompt">(/t)&gt;</code> <code class="user">new_procedure("new_todo_user", |name, access| {
    "Creates a new user with access to the todos scope.";
    new_user(name);
    grant('//todos', name, access);
    new_token(name);
});</code>
<code class="response">"new_todo_user"</code></pre>
        <p class="copyright1">This procedure first creates a new user with the specified name using the <code class="inline">new_user()</code>
            function. Then, it grants the desired user permission for the <code class="inline">//todos</code> scope
            using the <code class="inline">grant()</code> function. Finally, it generates a unique token for the user
            using the <code class="inline">new_token()</code> function.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">Instead of using a token, we could have opted for username and password authentication through the
                    <code class="inline1">set_password()</code> function. However, tokens offer several advantages:
                    they are strong, easily revoked (using: <code class="inline1">del_token()</code>), and allow for
                    issuing multiple tokens per account for different purposes.</p>
            </div>
        </div>
        <p class="copyright1">To create a user named <code class="inline">py</code> and obtain their token, run the following command:</p>
<pre class="thingsdb16"><code class="prompt">(/t)&gt;</code> <code class="user">wse(); new_todo_user('py', RUN | CHANGE);</code>
<code class="response">"9U0unWQglFlxl1DUBX5JsR"</code></pre>
        <p class="copyright1">This will create a user named <code class="inline">py</code> and provide you with their token,
            which you should copy and paste into the corresponding Python script.</p>
        <p class="copyright1">Now, modify the authentication call in the <code class="inline">template.py</code> and
            <code class="inline">search_todos.py</code> scripts to replace the default token with
            the generated one:</p>
<pre class="thingsdb16"><code class="prompt">    â¦
    try:
        await client.authenticate(</code><code class="user">'9U0unWQglFlxl1DUBX5JsR'</code><code class="prompt">)
        await work(client)
    â¦
</code></pre>
        <p class="copyright1">Replace <code class="inline">"9U0unWQglFlxl1DUBX5JsR"</code> with the actual token you obtained
            from the previous command.</p>
        <p class="copyright1">With this change, the Python scripts should now use the <code class="inline">py</code> user's token
            to authenticate with ThingsDB and access the <code class="inline">//todos</code> scope.
            This provides a more secure and maintainable approach to managing user access.</p>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-34">
<section>
    <h3 id="quiz-chapter-6" class="title1">6.5 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Under what circumstances is the <code class="inline">wse()</code> function necessary?</p></li>
        <li class="thingsdb13"><p class="copyright1">Will the following query succeed in executing the <code class="inline">set_x()</code> procedure
            and modifying the corresponding property in the collection?</p>
            <p class="quizcode"><code class="inline">set_x(123);</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">How can you invoke a procedure in ThingsDB?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Call the procedure directly from a query</li>
                <li class="thingsdb13">Use the ThingsDB protocol to run the procedure directly</li>
                <li class="thingsdb13">Use the HTTP API to run the procedure</li>
                <li class="thingsdb13">All of the above</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">In the following query, what is the data type of the variable <code class="inline">info</code>?</p>
            <p class="quizcode"><code class="inline">info = procedure_info("set_x");</code></p>
            <p class="quizcode"><code class="inline">type(info);  // ???</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Which authentication methods does ThingsDB support?</p></li>
        <li class="thingsdb13"><p class="copyright1">If you want to restrict your application to executing only predefined procedures that do not modify the state, which authentication flag(s) should you use?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">QUERY</code></li>
                <li class="thingsdb13"><code class="inline">READ</code></li>
                <li class="thingsdb13"><code class="inline">CHANGE</code></li>
                <li class="thingsdb13"><code class="inline">RUN</code></li>
                <li class="thingsdb13"><code class="inline">USER</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Verify if the <code class="inline">.hacked</code> property is present in the todos collection. If so, can you remove the property to ensure the integrity of the data?</p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-239">
<section>
    <h4 id="answers-chapter-6" class="title2">6.5.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">ThingsDB employs intelligent algorithms to identify queries with side effects that modify system state. However, in certain scenarios, these algorithms may fail to detect side effects, necessitating the explicit use of the <code class="inline">wse()</code> function. One such instance arises when invoking procedures that themselves encompass side effects.</p></li>
        <li class="thingsdb13"><p class="copyright1">No, the provided query will not work without explicitly invoking the <code class="inline">wse()</code> function.</p></li>
        <li class="thingsdb13"><p class="copyright1">Answer "d". All methods can be used to execute procedures in ThingsDB.</p>
            <ul class="thingsdb18">
                <li class="thingsdb13">You can simply include the procedure's name in your query, and ThingsDB will execute the procedure and return the result.</li>
                <li class="thingsdb13">The ThingsDB protocol allows you to make a direct call to a procedure without invoking a query. Native clients for popular programming languages, including Python, C#, Go, PHP, JavaScript/Node.js and more, provide built-in support for this direct procedure invocation.</li>
                <li class="thingsdb13">If you have enabled the HTTP API, you can also use it to call procedures. This can be a good option if you want to call procedures from a web application or other client that does not support the ThingsDB protocol. We'll explore the HTTP API in more detail in <a href="#chapter-16" class="thingsdb14">Chapter 16</a>.</li>
            </ul>
        </li>
        <li class="thingsdb13"><p class="copyright1">While the client response for <code class="inline">procedure_info()</code> might initially seem to imply that the return value is a <em class="thingsdb15">thing</em>, it is actually an instance of <em class="thingsdb15">mpdata</em>, a specialized data type that represents serialized MessagePack data. To convert mpdata, you can call the <code class="inline">load()</code> method on the mpdata object. This will effectively de-serialize the MessagePack data and return the corresponding thing instance.</p></li>
        <li class="thingsdb13"><p class="copyright1">ThingsDB offers two primary authentication methods: token-based and username/password. ThingsDB provides the <code class="inline">new_token()</code> function for generating secure tokens and the <code class="inline">set_password()</code> function for managing user credentials.</p></li>
        <li class="thingsdb13"><p class="copyright1">The correct answer is <code class="inline">RUN</code>.</p>
            <ul class="thingsdb18">
                <li class="thingsdb13">The <code class="inline">QUERY</code> flag enables users to execute queries that retrieve and process data from ThingsDB. However, the goal is to restrict the application to executing only pre-defined procedures without modifying the system state.</li>
                <li class="thingsdb13">The <code class="inline">READ</code> flag is not a valid authentication flag in ThingsDB.</li>
                <li class="thingsdb13">The <code class="inline">CHANGE</code> flag allows users to modify data. Since the goal is to prevent the application from modifying the state, the <code class="inline">CHANGE</code> flag is not suitable.</li>
                <li class="thingsdb13">The <code class="inline">USER</code> constant serves as a convenient shorthand for combining the commonly used <code class="inline">QUERY</code>, <code class="inline">CHANGE</code>, <code class="inline">JOIN</code>, and <code class="inline">RUN</code> permissions into a single name.</li>
            </ul>
        </li>
        <li class="thingsdb13"><p class="copyright1">In <a href="#chapter-6-2-3" class="thingsdb14">Section 6.2.3</a>, we explored code injection vulnerabilities. If you executed the code snippet provided in that section, a new property named <code class="inline">.hacked</code> may have been added to the collection. To remove this unintended property, you can use the following code:</p>
            <p class="quizcode"><code class="inline">.del("hacked");</code></p>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-267">
<section type="chapter" role="doc-chapter" aria-labelledby="ch07_h" id="thingsdb_link-308">
    <h2 id="chapter-7" class="thingsdb7">Chapter 7 - Typed Things</h2>
    <p class="copyright1">Currently, Alice can add and search for to-do items, but she lacks a straightforward method to mark them as completed. While we could implement a procedure to remove completed to-do items, Alice prefers to retain them for future reference.</p>
    <p class="copyright1">To achieve this, we'll transform the current <em class="thingsdb15">"todo"</em>, which is simply a string, into a thing with
        both a <code class="inline">body</code> property and a boolean property which we call <code class="inline">done</code>.
        We initially set <code class="inline">done</code> to <code class="inline">false</code> and update
        the property to <code class="inline">true</code> when the to-do is marked as completed.</p>
    <p class="copyright1">However, using things without proper type constraints can lead to errors due to incorrect property
        names or unexpected values. To enhance control and prevent such issues, we'll explore the concept
        of types in this chapter. In practical applications, it is rare to store plain things; instead,
        we mainly choose to employ typed things.</p>
    <div class="note">
        <img class="note1" src="images/idea.png" alt="Note" />
        <div class="content">
            <p class="author1">Typed things offer significant memory advantages over regular things with identical properties.
                This is because typed things in memory only store the data associated with that particular instance,
                while the property names are stored only once, centrally within the type definition. This
                centralized storage significantly reduces memory consumption, particularly for large collections of
                typed things.</p>
        </div>
    </div>
    <section>
        <h3 id="chapter-7-1" class="title1">7.1 Create Your First Type</h3>
        <p class="copyright1">To create a type, you'll need to use the <code class="inline">new_type()</code> function to define
            the type and the <code class="inline">set_type()</code> function to initialize it with property
            definitions. While it is technically possible to skip <code class="inline">new_type()</code> and
            call <code class="inline">set_type()</code> directly, this approach may lead to issues with
            self-referential type definitions. To avoid potential problems, it is recommended to follow the
            conventional practice of using <code class="inline">new_type()</code> first, followed by
            <code class="inline">set_type()</code>. Unlike procedures, types can only be created within a
            collection's scope.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">new_type("Todo");
set_type("Todo", {
    body: "str",
    done: "bool",
});</code>
<code class="response">null</code></pre>
        <p class="copyright1">Both <code class="inline">new_type()</code> and <code class="inline">set_type()</code> require a type
            name as their first argument. It is considered best practice to use CamelCase naming convention for types,
            starting with a capital letter. The <code class="inline">set_type()</code> function takes a second
            argument, which is a <em class="thingsdb15">thing</em> object that defines the properties and their respective definitions.
            Property definitions are always expressed as strings.</p>
        <p class="copyright1">Once the <code class="inline">Todo</code> type is created, you can initialize an instance of it by simply
            writing <code class="inline">Todo{}</code>. Every type can be initialized without explicitly specifying
            the properties. This implies that every property must have a default value at initialization.</p>
        <p class="copyright1">For instance, here's how to initialize a <code class="inline">Todo</code> instance using its default values:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Todo{};</code>  <code class="comment">// Initialize a Todo using the default values</code>
<code class="response">{
    "body": "",
    "done": false
}</code></pre>
        <p class="copyright1">This creates a new <code class="inline">Todo</code> instance with an empty <code class="inline">body</code>
            property and a <code class="inline">done</code> property set to <code class="inline">false</code>. As you
            can see, the default values for <code class="inline">body</code> and <code class="inline">done</code> are
            automatically assigned when the instance is created.</p>
        <section>
            <h4 id="chapter-7-1-1" class="title2">7.1.1 Enhancing the Todo Type using mod_type()</h4>
            <p class="copyright1">We defined the <code class="inline">Todo</code> type to accept empty strings for the
                <code class="inline">body</code> property. However, this is not ideal, as we want to ensure that
                to-do's always have a meaningful description. To address this, we can utilize property definitions
                to impose stricter constraints on the <code class="inline">body</code> property.</p>
            <p class="copyright1">Instead of simply <code class="inline">"str"</code>, we can specify a range condition
                using <code class="inline">"str&lt;1:&gt;"</code>. This indicates that the body must be at least
                one character long. We could also define maximum length restrictions or additional default values
                if needed.</p>
            <p class="copyright1">To modify the <code class="inline">Todo</code> type, we'll employ the
                <code class="inline">mod_type()</code> function. This function is specifically designed for type
                modification and is commonly used in migration scripts to streamline data migration processes.
                It is somewhat analogous to the <code class="inline">ALTER TABLE</code> syntax in SQL, often
                employed when introducing new features or enhancing existing applications.</p>
            <p class="copyright1">The <code class="inline">mod_type()</code> function takes the type name as its first argument,
                followed by an <em class="thingsdb15">action</em> string specifying the desired operation. In this case, we'll use
                the <code class="inline">"mod"</code> action, which indicates a property definition modification.</p>
            <p class="copyright1">Here's a table summarizing the available <code class="inline">mod_type()</code> actions:</p>
            <div class="table">
                <h2 id="thingsdb_link-309" class="thingsdb7"></h2>
                <p class="title3">Table 7.1.1 - Summary of mod_type() actions</p>
                <table class="thingsdb20">
                    <tr class="thingsdb21"><th class="thingsdb22">Action</th><th class="thingsdb22">Description</th></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"add"</code></td><td class="thingsdb23">Adds a new property or method to the type</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"all"</code></td><td class="thingsdb23">Iterates over all instances of a given type</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"del"</code></td><td class="thingsdb23">Deletes a property or method from the type</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"hid"</code></td><td class="thingsdb23">Enables or disable <em class="thingsdb15">hide-id</em> for the type</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"mod"</code></td><td class="thingsdb23">Modifies a property or method definition</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"rel"</code></td><td class="thingsdb23">Creates a relation between types</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"ren"</code></td><td class="thingsdb23">Renames a property or method</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"wpo"</code></td><td class="thingsdb23">Enables or disable <em class="thingsdb15">wrap-only</em> mode for the type</td></tr>
                </table>
            </div>
            <p class="copyright1">The specific arguments required depend on the chosen action. For <code class="inline">"mod"</code>, we
                need to provide the property name, the new definition, and a migration callback if the new definition
                is incompatible with the old one. This is the case here, as the old definition allowed empty strings,
                while the new one does not. The migration callback will be invoked for each instance of the type and
                should return either <code class="inline">nil</code> to retain the original property value or a new
                value that complies with the updated definition.</p>
            <p class="copyright1">Now, let's migrate the "todos" collection to utilize the updated <code class="inline">Todo</code> type:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code>
<code class="comment">// Migrate existing string values to the Todo type</code>
<code class="user">.todos = .todos.map(|body| Todo{body:});</code>

<code class="comment">// Modify the Todo type to disallow empty bodies</code>
<code class="user">mod_type("Todo", "mod", "body", "str&lt;1:&gt;", |todo| !todo.body ? "-" : nil);</code>

<code class="comment">// Migrate procedures to ensure compatibility with the updated type</code>
<code class="user">mod_procedure("add_todo", |body| {
    "Adds a to-do to the list.";
    .todos.push(Todo{body:});
    nil;
});
mod_procedure("search_todos", |needle| {
    "Search for to-do's";
    .todos.filter(|todo| todo.body.contains(needle));
});</code>
<code class="response">null</code></pre>
            <p class="copyright1">By applying the migration in a single query, we eliminate the risk of using deprecated procedures or
                performing operations on incompatible data structures.</p>
            <p class="copyright1">To verify that the migration to the <code class="inline">Todo</code> type has been successful,
                let's execute the <code class="inline">search_todos.py</code> script again:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python search_todos.py</code>
<code class="prompt">Search for:</code> <code class="user">book</code>
<code class="response">[{'#': 2, 'body': 'Read a book', 'done': False}]</code></pre>
        </section>
        <section>
            <h4 id="chapter-7-1-2" class="title2">7.1.2 Customizing ID Representation in Responses</h4>
            <p class="copyright1">The previous example demonstrated how to retrieve a list of <code class="inline">Todo</code> objects
                using the <code class="inline">search_todos.py</code> script. The response included the properties
                of the <code class="inline">Todo</code> type along with the unique identifier for each object, represented by the
                <code class="inline">#</code> key.</p>
            <p class="copyright1">While this approach works, it is possible to gain more control over how IDs are returned in
                responses by leveraging type definitions. Specifically, we can utilize
                the <code class="inline">"#"</code> definition to specify the desired key for the ID.</p>
            <p class="copyright1">To achieve this, we'll employ the <code class="inline">mod_type()</code> function again. This time,
                we'll modify the <code class="inline">Todo</code> type to return the ID as <code class="inline">"id"</code>
                instead of <code class="inline">"#"</code>.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_type("Todo", "add", "id", "#");</code>
<code class="response">null</code></pre>
            <p class="copyright1">This modification tells ThingsDB to return the unique identifier for each <code class="inline">Todo</code>
                object as the <code class="inline">"id"</code> key in responses.</p>
            <p class="copyright1">Now, let's re-execute the <code class="inline">search_todos.py</code> script to observe the change:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python search_todos.py</code>
<code class="prompt">Search for:</code> <code class="user">book</code>
<code class="response">[{'id': 2, 'body': 'Read a book', 'done': False}]</code></pre>
            <p class="copyright1">As expected, the response now includes the <code class="inline">"id"</code> key instead of
                <code class="inline">"#"</code>, providing a more consistent and user-friendly representation
                of the object identifier.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-7-2" class="title1">7.2 Collection Structure with Types</h3>
        <p class="copyright1">While we've established a well-defined structure for <code class="inline">Todo</code> objects,
            the <code class="inline">.todos</code> list still accepts items of other types, potentially
            introducing inconsistencies. Additionally, the collection root lacks strict structure, allowing
            for arbitrary property assignments.</p>
        <p class="copyright1">To address these concerns, we'll create a new type which we call <code class="inline">Root</code> to
            represent the collection root. The name <code class="inline">Root</code> is just a choice, another
            good name would be <code class="inline">Collection</code> or a more descriptive name like
            <code class="inline">TodoCollection</code>. This type will solely contain a property named
            <code class="inline">todos</code> with type definition <code class="inline">"[Todo]"</code>, ensuring
            that only <code class="inline">Todo</code> objects can be added to the list.</p>
        <p class="copyright1">Let's create the <code class="inline">Root</code> type:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">new_type("Root");
set_type("Root", {
    todos: "[Todo]",
});</code>
<code class="response">null</code></pre>
        <p class="copyright1">To convert the collection root to the <code class="inline">Root</code> type, we'll use the
            <code class="inline">to_type()</code> method.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">.to_type("Root");</code>
<code class="response">null</code></pre>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">If you encounter an error indicating that the <code class="inline1">Root</code> type is missing a property called hacked,
                    it is likely due to the hacked property introduced in <a href="#chapter-6-2-3" class="thingsdb14">Chapter 6.2.3</a>.
                    To resolve this, remove the hacked property using <code class="inline1">.del("hacked");</code></p>
            </div>
        </div>
        <p class="copyright1">With the <code class="inline">Root</code> type applied to the collection root, we have achieved stronger
            type enforcement. Attempts to assign arbitrary properties or add non-<code class="inline">Todo</code> objects
            to the <code class="inline">.todos</code> list will trigger errors.</p>
        <p class="copyright1">Here are some examples illustrating this enhanced type safety:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">.x = 1;</code>
<code class="response">LookupError: type `Root` has no property `x`</code>
<code class="prompt">(//todos)&gt;</code> <code class="user">.todos.push(123);</code>
<code class="response">TypeError: type `int` is not allowed in restricted array</code>
<code class="prompt">(//todos)&gt;</code> <code class="user">type(root());</code>
<code class="response">"Root"</code>
<code class="prompt">(//todos)&gt;</code> <code class="user">.todos.restriction();</code>
<code class="response">"Todo"</code></pre>
        <p class="copyright1">By leveraging typed roots, we've significantly enhanced the structure and type safety of our collection,
            promoting data integrity and consistency.</p>
        <p class="copyright1">As your application grows and evolves, you may need to adapt your data structures to accommodate new
            requirements or enhance existing features. To address such changes, the earlier
            discussed <code class="inline">mod_type()</code> function is available, enabling you to modify existing
            types by adding new properties, changing data types, or introducing restrictions.</p>
        <p class="copyright1">If, for any reason, you need to revert a type back to its original <em class="thingsdb15">"thing"</em> form,
            the <code class="inline">to_thing()</code> method is your go-to solution. This method effectively
            de-structures the typed thing, removing any imposed constraints and allowing for arbitrary property
            assignments.</p>
    </section>
    <section>
        <h3 id="chapter-7-3" class="title1">7.3 Retrieving Typed Things by ID</h3>
        <p class="copyright1">In <a href="#chapter-4-2" class="thingsdb14">Chapter 4.2</a>, we learned how to retrieve a specific thing using
            the <code class="inline">thing()</code> function by providing its ID. This method also applies to
            typed things, but for greater control, we can directly invoke the type name and pass the ID as an
            argument. This approach ensures that only instances of the specified type are returned.</p>
        <p class="copyright1">Consider the following examples:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Todo(2);</code>  <code class="comment">// ID 2 is a Todo item</code>
<code class="response">{
    "body": "Read a book",
    "done": false,
    "id": 2
}</code>
<code class="prompt">(//todos)&gt;</code> <code class="user">Todo(1);</code>  <code class="comment">// ID 1 is the collection root</code>
<code class="response">TypeError: `#1` is of type `Root`, not `Todo`</code></pre>
        <p class="copyright1">In the first example, the <code class="inline">Todo(2)</code> call successfully retrieves
            the <code class="inline">Todo</code> object with ID 2. However, when attempting to access the
            collection root using <code class="inline">Todo(1)</code>, an error is raised because the collection
            root is a <code class="inline">Root</code> object, not a <code class="inline">Todo</code> object.</p>
    </section>
    <section>
        <h3 id="chapter-7-4" class="title1">7.4 Type Methods</h3>
        <p class="copyright1">Up to this point, the <code class="inline">Todo</code> type has a property named <code class="inline">done</code>
            to indicate whether a to-do item is completed. However, if Alice finishes reading a book, she needs a way to
            mark the corresponding to-do item as completed. While we could simply set the <code class="inline">done</code>
            property to <code class="inline">true</code>, it is better to adopt a more flexible approach that allows
            for potential future changes in data representation.</p>
        <p class="copyright1">Type "methods" are self-contained functions within a type definition, allowing us to encapsulate specific
            behavior for that type. Instead of directly modifying the <code class="inline">done</code> property,
            we'll create a method named <code class="inline">mark_as_done</code> that handles the task completion logic.</p>
        <p class="copyright1">In contrast to properties, which are defined using strings, methods are defined using closures. These closures
            encapsulate the method's logic and receive the <code class="inline">this</code> object as their first argument,
            which represents the instance of the type where the method is being called on.</p>
        <p class="copyright1">We'll use the <code class="inline">mod_type()</code> function to add the <code class="inline">mark_as_done</code>
            method to the <code class="inline">Todo</code> type:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_type("Todo", "add", "mark_as_done", |this| this.done = true);</code>
<code class="response">null</code></pre>
        <p class="copyright1">Next, we'll create a procedure to interact with the <code class="inline">mark_as_done</code> method.
            This procedure will receive a <code class="inline">todo_id</code> as input and call the
            <code class="inline">mark_as_done</code> method on the corresponding <code class="inline">Todo</code> instance:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">new_procedure("mark_as_done", |todo_id| {
    wse();
    Todo(todo_id).mark_as_done();
    nil;
});</code>
<code class="response">"mark_as_done"</code></pre>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">Here, we again need to use the <code class="inline1">wse()</code> function to inform ThingsDB that
                    this procedure may modify the "todos" collection and potentially trigger side effects.</p>
            </div>
        </div>
        <p class="copyright1">To test the new <code class="inline">mark_as_done</code> procedure, we'll create a Python file
            named <code class="inline">mark_as_done.py</code> based on the template and modify the work method to
            capture user input for the <code class="inline">todo_id</code> and call the procedure:</p>
<pre class="thingsdb16"><code class="prompt">async def work(client: Client):</code>
<code class="user">    todo_id = int(input("To-do ID: "))
    await client.run('mark_as_done', todo_id=todo_id)</code></pre>
        <p class="copyright1">Running this Python file will prompt you to enter a <code class="inline">todo_id</code>, which will
            then be used to invoke the <code class="inline">mark_as_done</code> procedure.</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python mark_as_done.py</code>
<code class="prompt">To-do ID:</code> <code class="user">2</code></pre>
        <p class="copyright1">If no errors occur, it indicates that the operation was successful.</p>
        <p class="copyright1">To verify that the to-do item has been marked as completed, you can run the
            <code class="inline">search_todos.py</code> script again and observe the
            updated <code class="inline">done</code> property:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python search_todos.py</code>
<code class="prompt">Search for:</code> <code class="user">book</code>
<code class="response">[{'id': 2, 'body': 'Read a book', 'done': True}]</code></pre>
    </section>
    <section>
        <h3 id="chapter-7-5" class="title1">7.5 Type Information</h3>
        <p class="copyright1">With the <code class="inline">types_info()</code> function, you can explore all the types defined
            within a collection. The function returns a list of information objects.</p>
        <p class="copyright1">For detailed information about a single type, use the <code class="inline">type_info()</code> method.
            The <code class="inline">Todo</code> type information, for example, would look like this:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">type_info("Todo");</code>
<code class="response">{
    "created_at": 1706696007,
    "fields": [
        ["id", "#"],
        ["body", "str&lt;1:&gt;"],
        ["done", "bool"]
    ],
    "hide_id": false,
    "methods": {
        "mark_as_done": {
            "arguments": ["this"],
            "definition": "|this| this.done = true",
            "doc": "",
            "with_side_effects": true
        }
    },
    "modified_at": 1707128380,
    "name": "Todo",
    "relations": {},
    "type_id": 0,
    "wrap_only": false
}</code></pre>
    </section>
    <section>
        <h3 id="chapter-7-6" class="title1">7.6 Removing a Type</h3>
        <p class="copyright1">ThingsDB empowers you to remove existing types using the <code class="inline">del_type()</code> function.
            However, exercise caution, as this function operates even when instances of the
            targeted type still exist.</p>
        <p class="copyright1">Consider the following example:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">new_type("T");</code>      <code class="comment">// Create type T</code>
<code class="user">set_type("T", {name: "str"});</code>  <code class="comment">// Define type T</code>
<code class="user">t = T{name: "test"};</code>           <code class="comment">// Create an instance of T</code>
<code class="user">assert(type(t) == "T");</code>        <code class="comment">// Verify the type</code>
<code class="user">del_type("T");</code>                 <code class="comment">// Delete type T</code>
<code class="user">assert(type(t) == "thing");</code>    <code class="comment">// Verify type is now "thing"</code>
<code class="user">t;</code>
<code class="response">{
    "name": "test"
}</code></pre>
        <p class="copyright1">As observed, deleting the type converts all existing instances to plain "things", discarding the
            specific type information. This transformation is not easily reversible unless you possess precise
            knowledge of the original type belonging to each instance.</p>
        <section>
            <h4 id="chapter-7-6-1" class="title2">7.6.1 Dependency Considerations</h4>
            <p class="copyright1">Furthermore, attempting to remove a type referenced by another type or enumerator will fail.
                To successfully delete such a type, you must first address the dependencies. Refer
                to <a href="#chapter-9" class="thingsdb14">Chapter 9</a> for in-depth exploration of type connections
                and <a href="#chapter-11" class="thingsdb14">Chapter 11</a> for detailed discussions on enumerators.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-7-7" class="title1">7.7 More Definitions</h3>
        <p class="copyright1">In this book we'll explore more definitions than discussed so far. We already used a definition
            to specify a string with a range, a boolean and a list restricted to a specific data type.</p>
        <p class="copyright1">As always, use the documentation page for a full description of all the type property definitions
            which can be found here: <a href="https://docs.thingsdb.io/v1/overview/type/" class="thingsdb14">https://docs.thingsdb.io/v1/overview/type/</a>
        </p>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-268">
<section>
    <h3 id="quiz-chapter-7" class="title1">7.8 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Choose which statement declares a new type?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">del_type("A");</code></li>
                <li class="thingsdb13"><code class="inline">new_type("A");</code></li>
                <li class="thingsdb13"><code class="inline">mod_type("A");</code></li>
                <li class="thingsdb13"><code class="inline">set_type("A");</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Can you identify which strings fit the property definition <code class="inline">"str&lt;4:8&gt;"</code>?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">"ThingsDB"</code></li>
                <li class="thingsdb13"><code class="inline">"Hi"</code></li>
                <li class="thingsdb13"><code class="inline">nil</code></li>
                <li class="thingsdb13"><code class="inline">"Hello"</code></li>
                <li class="thingsdb13"><code class="inline">"Bicycle Race"</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">How can you seamlessly integrate the ID of type <code class="inline">T</code> instances as a property
            named <code class="inline">"identifier"</code> in responses, given that the ID is currently exposed
            as <code class="inline">"#"</code>?</p></li>
        <li class="thingsdb13"><p class="copyright1">Suppose a type <code class="inline">T</code> exposes the ID for each instance as key <code class="inline">"identifier"</code> <em class="thingsdb15">(see previous question)</em>.
            How can you change the name for this key to <code class="inline">"id"</code>?</p></li>
        <li class="thingsdb13"><p class="copyright1">Complete the <code class="inline">set_type("P", ???);</code> statement to create type <code class="inline">P</code>, enabling the following code to function flawlessly:</p>
            <p class="quizcode"><code class="inline">a = P{x: 3.0, y: 2.0};</code></p>
            <p class="quizcode"><code class="inline">b = P{x: 7.0, y: 8.0};</code></p>
            <p class="quizcode"><code class="inline">d = a.distance(b);  // Should produce 7.211102550927978</code></p>
            <p class="copyright1"><em class="thingsdb15">Hint: recall the distance formula: â((xâ - xâ)Â² + (yâ - yâ)Â²)</em></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Can you produce a query that returns a list containing <em class="thingsdb15">only the type names</em> present in the collection?</p></li>
        <li class="thingsdb13"><p class="copyright1">When a type is removed using <code class="inline">del_type()</code>, what happens to existing instances of that type?</p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-33">
<section>
    <h4 id="answers-chapter-7" class="title2">7.8.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">The correct answer is "b". While <code class="inline">set_type()</code> can technically be
            used to create a new type, it is primarily used to set the properties and/or methods for a type.
            It requires an additional argument, even when not setting any properties or methods.
            <code class="inline">del_type()</code> is the opposite, it removes a type instead of creating one.
            <code class="inline">mod_type()</code> is used to modify a type and at least requires an "action"
            as second argument.</p></li>
        <li class="thingsdb13"><p class="copyright1">Both "a", <code class="inline">"ThingsDB"</code> and "d", <code class="inline">"Hello"</code> are valid.
            The defined range accepts strings from 4 up till 8 characters, both inclusive.
            The string <code class="inline">"ThingsDB"</code> contains exactly 8 characters so it is a valid string.
            Type <code class="inline">nil</code> is not allowed for this definition since only type string is allowed. </p></li>
        <li class="thingsdb13"><p class="copyright1">By executing the following statement:</p>
            <p class="quizcode"><code class="inline">mod_type("T", "add", "identifier", "#");</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">A type can only have a single <code class="inline">"#"</code> definition. By executing the
            following statement the key will be renamed from <code class="inline">"identifier"</code> to <code class="inline">"id"</code>.</p>
            <p class="quizcode"><code class="inline">mod_type("T", "ren", "identifier", "id");</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">To enable distance calculations between points, create type <code class="inline">P</code> with the following masterful definition:</p>
            <p class="quizcode"><code class="inline">set_type("P", {</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;// Properties for point coordinates</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;x: "float",</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;y: "float",</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;// Method for calculating distance:</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;distance: |this, other| {</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;&nbsp;&nbsp;// Distance formula</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;&nbsp;&nbsp;sqrt(pow(other.x - this.x, 2.0) + pow(other.y - this.y, 2.0));</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;},</code></p>
            <p class="quizcode"><code class="inline">});</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Use <code class="inline">types_info().map(|info| info.load().name);</code> to get a list of type names.
            This iterates through type info objects, extracting and returning only the <code class="inline">name</code> property.</p></li>
        <li class="thingsdb13"><p class="copyright1">Instances of the removed type are downcast to regular things. This means that while their existing properties and values remain intact, the original type information becomes unavailable.</p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-261">
<section type="chapter" role="doc-chapter" aria-labelledby="ch08_h" id="thingsdb_link-310">
    <h2 id="chapter-8" class="thingsdb7">Chapter 8 - Date, Time and Tasks</h2>
    <p class="copyright1">Effectively managing to-do lists involves not only tracking tasks themselves, but also the
        timing of their creation and completion. In this chapter, we delve into two core methods for
        capturing time in ThingsDB: <em class="thingsdb15">timestamps</em>, the <em class="thingsdb15">datetime</em> type and the <em class="thingsdb15">task</em> type
        used for scheduling code execution.</p>
    <section>
        <h3 id="chapter-8-1" class="title1">8.1 Timestamps vs. Datetime</h3>
        <p class="copyright1">Timestamps represent time as a single numerical value, specifically the number of seconds elapsed
            since January 1, 1970, 00:00:00 UTC. This representation offers compact storage and is suitable
            for calculations involving relative time differences.</p>
        <p class="copyright1">The <code class="inline">now()</code> function retrieves the current timestamp:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">now();</code>
<code class="response">1707145945.4736154</code></pre>
        <p class="copyright1">While timestamps offer efficient storage and ease of calculating time differences between events,
            their single numerical representation can pose challenges when dealing with absolute dates or
            time zones. These scenarios often require intricate calculations to extract the desired information.</p>
        <p class="copyright1">ThingsDB simplifies time-related tasks with the datetime type, offering a human-readable and
            efficient approach to date and time manipulation.</p>
        <p class="copyright1">Unless explicitly overridden with the <code class="inline">set_time_zone()</code> function,
            datetime objects in ThingsDB default to Coordinated Universal Time (UTC), the global standard
            for timekeeping.</p>
        <p class="copyright1">Generate a datetime object reflecting the current date and time by simply calling
            the <code class="inline">datetime()</code> function without arguments:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">datetime();</code>
<code class="response">"2024-02-05T15:22:05Z"</code></pre>
        <p class="copyright1">The datetime object is returned in a response as a string using the ISO 8601 format.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">While powerful, datetime objects have limited precision, offering only up to the <em class="thingsdb15">second</em> level.
                    If your needs require millisecond-level accuracy or finer granularity, alternative approaches
                    like timestamps might be more suitable.</p>
            </div>
        </div>
        <p class="copyright1">The <code class="inline">datetime()</code> function offers a variety of methods to create datetime objects,
            ensuring adaptability to diverse data sources and formatting preferences.</p>
        <p class="copyright1">Construct datetime objects with year, month, and day:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">datetime(2024, 2, 6);</code>
<code class="response">"2024-02-06T00:00:00Z"</code></pre>
        <p class="copyright1">Add optional hour, minute, and seconds:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">datetime(2024, 2, 6, 9, 57, 30);</code>
<code class="response">"2024-02-06T09:57:30Z"</code></pre>
        <p class="copyright1">When the final argument passed to <code class="inline">datetime()</code> is a string, ThingsDB
            interprets it as a time zone identifier. This allows you to "ground" your datetime object in a
            specific geographical location, ensuring accurate representation across regions:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">datetime(2024, 2, 6, 9, 58, "Europe/Kyiv");</code>
<code class="response">"2024-02-06T09:58:00+0200"</code></pre>
        <p class="copyright1">In this example, the time zone <code class="inline">"Europe/Kyiv"</code> is specified, resulting in a
            datetime object reflecting the time in Kyiv, Ukraine. For a comprehensive overview of all available
            time zones supported by ThingsDB, use the <code class="inline">time_zones_info()</code> function.</p>
        <p class="copyright1">Create datetime objects from ISO 8601 formatted strings:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">datetime("2024-02-06T10:05:00Z");</code>
<code class="response">"2024-02-06T10:05:00Z"</code></pre>
        <p class="copyright1">Accommodate diverse date and time representations using format specifiers:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">datetime("2024-2-6", "%Y-%m-%d");</code>
<code class="response">"2024-02-06T00:00:00Z"</code></pre>
        <p class="copyright1">Convert a timestamp to a datetime object and return using a custom format:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">datetime(1707211569).format("%a, %d %b %Y %H:%M:%S %Z");</code>
<code class="response">"Tue, 06 Feb 2024 09:26:09 UTC"</code></pre>
        <p class="copyright1">As illustrated in the provided examples, datetime object initialization in ThingsDB boasts
            remarkable flexibility. For a comprehensive overview of possible initialization options,
            delve into the detailed online documentation: <a href="https://docs.thingsdb.io/v1/collection-api/datetime/" class="thingsdb14">https://docs.thingsdb.io/v1/collection-api/datetime/</a></p>
        <p class="copyright1">Once initialized, datetime objects uphold immutability, safeguarding the integrity of their
            original data. Consequently, methods like <code class="inline">move()</code>, <code class="inline">to()</code>,
            and <code class="inline">replace()</code> always create new datetime objects,
            leaving the original unaltered.</p>
        <p class="copyright1">Need to tweak specific components within a datetime object? The <code class="inline">replace()</code> method
            is your friend. It allows you to craft new instances with adjusted values, ensuring pinpoint accuracy:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">datetime("2024-02-06T09:26:09Z").replace({
    minute: 0,
    second: 0,
});</code>
<code class="response">"2024-02-06T09:00:00Z"</code></pre>
        <p class="copyright1">Accurate time representation across different regions is crucial. With the <code class="inline">to()</code> method,
            you can seamlessly apply different time zones to your datetime objects:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">datetime("2024-02-06T09:26:09Z").to("Europe/Kyiv");</code>
<code class="response">"2024-02-06T11:26:09+0200"</code></pre>
        <p class="copyright1">Move through time with ease using the <code class="inline">move()</code> method. It allows you to
            generate new datetime objects adjusted by specified intervals, empowering you to navigate temporal
            data efficiently:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">datetime("2024-02-06T09:26:09Z").move("years", -1);</code>
<code class="response">"2023-02-06T09:26:09Z"</code></pre>
        <p class="copyright1">By mastering these and other methods, you'll unlock a powerful toolkit for manipulating datetime objects
            within ThingsDB projects. This ensures precision and flexibility in managing your time-related data.</p>
        <section>
            <h4 id="chapter-8-1-1" class="title2">8.1.1 Bridging the Gap Between Datetime and Timestamp</h4>
            <p class="copyright1">Converting a datetime object to a timestamp can be achieved effortlessly by casting it as an integer.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">int(datetime("2024-02-06T09:26:09Z"));</code>
<code class="response">1707211569</code></pre>
            <p class="copyright1">ThingsDB also offers a data type called <em class="thingsdb15">timeval</em>. While functionally equivalent to <em class="thingsdb15">datetime</em>,
                it has a key difference: instead of returning an ISO 8601 formatted string, timeval returns a raw UTC
                timestamp integer in its responses. Think of it as a more compact and optimized version of datetime for
                timestamp-related tasks.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">timeval("2024-02-06T09:26:09Z");</code>
<code class="response">1707211569</code></pre>
        </section>
    </section>
    <section>
        <h3 id="chapter-8-2" class="title1">8.2 Enhancing Todo with Datetime Properties</h3>
        <p class="copyright1">Now that you've grasped the power of datetime for representing and manipulating temporal data,
            let's apply this knowledge to enhance our understanding of the <code class="inline">Todo</code> type
            in ThingsDB. We'll focus on adding two useful properties: <code class="inline">creation</code>
            and <code class="inline">completion</code>.</p>
        <p class="copyright1">We want to keep track of when each <code class="inline">Todo</code> item was created. To achieve this,
            we'll add a new property named <code class="inline">creation</code> with the datetime type:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_type("Todo", "add", "creation", "datetime");</code>
<code class="response">null</code></pre>
        <p class="copyright1">This command seamlessly integrates the <code class="inline">creation</code> property into the <code class="inline">Todo</code> type.
            However, since we do not possess historical data about the exact creation dates of existing to-do's,
            the system automatically assigns the current date and time to them. This ensures consistency while
            acknowledging the limitations of our historical data.</p>
        <p class="copyright1">Next, we want to record the moment when a <code class="inline">Todo</code> item is marked as completed.
            But here's a twist: not all to-do's might be completed yet. For this, we'll introduce a property
            named completion, but with the <code class="inline">"datetime?"</code> definition. The question
            mark (<code class="inline">?</code>) signifies that this property is optional, allowing it to hold
            either a datetime value (representing the completion time) or <code class="inline">nil</code> (indicating
            no completion yet).</p>
        <p class="copyright1">Here's the command to add the <code class="inline">completion</code> property:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code>
<code class="comment">// Adds the completion property</code>
<code class="user">mod_type("Todo", "add", "completion", "datetime?", |this| {
    this.done ? datetime() : nil;
});</code>
<code class="comment">// Fix the mark_as_done method</code>
<code class="user">mod_type("Todo", "mod", "mark_as_done", |this| {
    this.done = true;
    this.completion = datetime();
});</code>
<code class="response">null</code></pre>
        <p class="copyright1">This code snippet does more than simply adding the property. It also defines a closure to initialize
            the <code class="inline">completion</code> value appropriately for existing to-do's and it also fixes
            the <code class="inline">mark_as_done</code> method to set the <code class="inline">completion</code> value
            after the to-do will be marked as done.</p>
    </section>
    <section>
        <h3 id="chapter-8-3" class="title1">8.3 Scheduling Code Execution with Tasks</h3>
        <p class="copyright1">Tasks allow you to schedule code execution at specific dates and times.</p>
        <p class="copyright1">Key features of the task type:</p>
        <ul class="thingsdb18">
            <li class="editor"><strong class="thingsdb17">Guaranteed consistency: </strong>ThingsDB ensures that each task runs on exactly one node, preventing data conflicts and maintaining data integrity across the system.</li>
            <li class="editor"><strong class="thingsdb17">User context execution: </strong>Tasks execute within the context of the user who created them, inheriting their permissions and ensuring appropriate access control. However, you can change the task owner using the <code class="inline">set_owner()</code> method, granting ownership and associated permissions to a different user.</li>
            <li class="editor"><strong class="thingsdb17">Automatic node distribution: </strong>No need to worry about task allocation! ThingsDB takes care of distributing tasks across available nodes.</li>
        </ul>
        <p class="copyright1">Let's explore what happens when we create tasks in ThingsDB:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">task(datetime(), || nil);</code>
<code class="response">"&lt;task:4 owner:admin run_at:2024-02-07T14:49:36Z status:nil&gt;"</code></pre>
        <p class="copyright1">This task is scheduled for immediate execution as <code class="inline">datetime()</code> specifies the
            current date and time. It doesn't perform any actions (<code class="inline">|| nil</code>) but serves
            as an example of task creation.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">task(datetime(), || 1/0);</code>
<code class="response">"&lt;task:5 owner:admin run_at:2024-02-07T14:49:50Z status:nil&gt;"</code></pre>
        <p class="copyright1">This task attempts to perform a division by zero, which will result in an error when executed.
            It is useful for demonstrating how ThingsDB handles task errors.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">task(datetime().move("days", 1), || nil);</code>
<code class="response">"&lt;task:6 owner:admin run_at:2024-02-08T14:50:01Z status:nil&gt;"</code></pre>
        <p class="copyright1">This task is scheduled to run a day later using <code class="inline">datetime().move("days", 1)</code>, showcasing how to schedule actions for specific future moments.</p>
        <p class="copyright1">Use the <code class="inline">tasks()</code> function to view all tasks within the current scope:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">tasks();</code>
<code class="response">[
    "&lt;task:5 owner:admin run_at:nil status:err&gt;",
    "&lt;task:6 owner:admin run_at:2024-02-08T14:50:01Z status:nil&gt;"
]</code></pre>
        <p class="copyright1">Note that successfully completed tasks are removed from the list, while those with errors and pending tasks remain.</p>
        <p class="copyright1">Task with ID 5 has encountered an error, preventing its successful completion. To uncover the cause
            of the problem, we'll utilize the <code class="inline">err()</code> method:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">task(5).err();</code>
<code class="response">"division or modulo by zero"</code></pre>
        <section>
            <h4 id="chapter-8-3-1" class="title2">8.3.1 Cancel or Delete a Task</h4>
            <p class="copyright1">There are two ways to stop tasks from running. Using the <code class="inline">cancel()</code> method
                preserves the task information for later use and marks it with
                a <code class="inline">cancelled_err</code> while the <code class="inline">del()</code> method
                permanently removes it.</p>
            <p class="copyright1">The code below illustrates the use of both methods:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">task(6).cancel();</code>  <code class="comment">// Cancel task with ID 6</code>
<code class="response">null</code>

<code class="prompt">(//todos)&gt;</code> <code class="user">task(6).err();</code>  <code class="comment">// Observe cancelled error</code>
<code class="response">"operation is cancelled before completion"</code>

<code class="prompt">(//todos)&gt;</code> <code class="user">task(6).del();</code>  <code class="comment">// Delete task</code>
<code class="response">null</code>

<code class="prompt">(//todos)&gt;</code> <code class="user">task(6);</code>  <code class="comment">// Attempt to access task with ID 6 (now deleted)</code>
<code class="response">LookupError: task with id 6 not found</code></pre>
        </section>
        <section>
            <h4 id="chapter-8-3-2" class="title2">8.3.2 Repeating Tasks</h4>
            <p class="copyright1">Incorporating <code class="inline">again_in()</code> within your task's code allows you to
                reschedule its execution based on desired time units and values. It acts like a built-in calendar
                reminder, prompting the task to reactivate itself after a defined period.</p>
            <p class="copyright1">Let's illustrate this with an example: Alice needs a daily reminder to send reports to Bob.
                She can achieve this with a single task coded as follows:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">task(datetime(), |task, body| {</code>
    <code class="user">task.again_in("days", 1);</code>  <code class="comment">// Reschedule the task in 1 day</code>
    <code class="user">add_todo(body);</code>  <code class="comment">// Add the "Send report to Bob" to-do</code>
<code class="user">}, ["Send report to Bob"]);</code>
<code class="response">"&lt;task:7 owner:admin run_at:2024-02-07T14:52:25Z status:nil&gt;"</code></pre>
            <p class="copyright1">In this code, the task immediately executes using <code class="inline">datetime()</code>. Within
                the closure, <code class="inline">task.again_in("days", 1)</code> reschedules it to run again in
                one day. The task then adds a to-do with the message <code class="inline">"Send report to Bob"</code>.</p>
            <p class="copyright1">But what if you need to modify the report content later? No worries! The task type offers
                the <code class="inline">set_args()</code> method, enabling you to dynamically change
                task arguments without recreating the entire task.</p>
            <p class="copyright1">While <code class="inline">again_in()</code> offers convenient rescheduling relative to the
                original task time, the task type also provides <code class="inline">again_at()</code> for
                pinpoint accuracy in setting future execution.</p>
            <p class="copyright1">Choosing the right method:</p>
            <ul class="thingsdb18">
                <li class="editor"><p class="copyright1"><code class="inline">again_in()</code>:</p>
                    <ul class="nested">
                        <li class="editor">Reschedules a task relative to its original execution time.</li>
                        <li class="editor">Is ideal for creating repeating tasks at specific intervals (e.g., daily, hourly).</li>
                        <li class="editor">Example: <code class="inline">task.again_in("days", 1)</code> reschedules the task to run in 1 day.</li>
                    </ul>
                </li>
                <li class="editor"><p class="copyright1"><code class="inline">again_at()</code>:</p>
                    <ul class="nested">
                        <li class="editor">Reschedules a task to a specific new date and time.</li>
                        <li class="editor">Is useful for one-time adjustments or scheduling tasks for future deadlines.</li>
                        <li class="editor">Example: <code class="inline">task.again_at(datetime(2024, 02, 09, 10, 00))</code> reschedules the task for February 9th, 2024, at 10:00 AM.</li>
                    </ul>
                </li>
            </ul>
        </section>
        <section>
            <h4 id="chapter-8-3-3" class="title2">8.3.3 Status for Repeating Task</h4>
            <p class="copyright1">As we explored, completed tasks vanished from the ThingsDB list, leaving no trace of their successful
                execution. But what about repeating tasks? How do we track their progress and ensure they are
                functioning smoothly?</p>
            <p class="copyright1">A successfully completed run of a repeating task changes its status from <code class="inline">"nil"</code>
                to <code class="inline">"ok"</code> indicating a successful execution. You can check this status using
                the <code class="inline">task()</code> function, providing the task ID of your repeating task:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">task(7);</code>
<code class="response">"&lt;task:7 owner:admin run_at:2024-02-08T14:52:25Z status:ok&gt;"</code></pre>
            <p class="copyright1">This example shows that the task with ID 9, scheduled to repeat on February 8th, 2024, at 2:52 PM UTC,
                has successfully completed its previous run.</p>
            <p class="copyright1">If you need to check the task status in code, use the <code class="inline">err()</code> method.
                This reveals any errors encountered during the last execution.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">task(7).err();</code>
<code class="response">null</code></pre>
            <p class="copyright1">If everything went well, the output will be <code class="inline">nil</code>, indicating no errors.</p>
        </section>
        <section>
            <h4 id="chapter-8-3-4" class="title2">8.3.4 Deleting All Tasks with a Single Statement</h4>
            <p class="copyright1">Before starting the quiz, let's clean up the tasks we created during this chapter.
                Can you guess how to delete all of them at once?</p>
            <p class="copyright1">Indeed! The following code snippet achieves this efficiently:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">tasks().each(|task| task.del());</code>
<code class="response">null</code></pre>
            <p class="copyright1">This expression iterates through every task using <code class="inline">tasks()</code>, and for
                each <code class="inline">task</code>, it calls the <code class="inline">del()</code> method
                to permanently remove it.</p>
            <p class="copyright1">To verify, you can check the list again:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">tasks();</code>
<code class="response">[]</code></pre>
            <p class="copyright1">As you can see, the list is now empty, indicating all tasks have been successfully deleted.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-8-4" class="title1">8.4 Farewell, done Property</h3>
        <p class="copyright1">Remember the <code class="inline">done</code> property for marking completed to-do's?
            We can actually remove it! The <code class="inline">completion</code> property serves this purpose perfectly.</p>
        <p class="copyright1">Here's how we clean up the data model:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code>
<code class="comment">// Remove the done property</code>
<code class="user">mod_type("Todo", "del", "done");</code>

<code class="comment">// Update the mark_as_done method</code>
<code class="user">mod_type("Todo", "mod", "mark_as_done", |this| {
    this.completion = datetime();
});</code>
<code class="response">null</code></pre>
        <p class="copyright1">This updated method only sets the <code class="inline">completion</code> property to the current date
            and time, indicating the to-do is complete.</p>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-35">
<section>
    <h3 id="quiz-chapter-8" class="title1">8.5 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">What data type is returned by the <code class="inline">now()</code> function, and what does it represent?</p></li>
        <li class="thingsdb13"><p class="copyright1">How would you calculate the timestamp for January 25, 2025, at 13:05 Kyiv time, considering time zone differences and potential daylight saving time adjustments?</p></li>
        <li class="thingsdb13"><p class="copyright1">Remember the range definition from the previous chapter? Consider the property definition <code class="inline">"int&lt;-1:1&gt;?"</code>. What range of values would be allowed for this property?</p></li>
        <li class="thingsdb13"><p class="copyright1">You have a task that you no longer want to execute, but you still want to keep it for reference. How can you achieve this without permanently removing the task from the task list?</p></li>
        <li class="thingsdb13"><p class="copyright1">Which of the following will create a daily repeating task?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">task(datetime(), |task| nil).repeat("daily");</code></li>
                <li class="thingsdb13"><code class="inline">task(datetime(), |task| task.again_in("days", 1));</code></li>
                <li class="thingsdb13"><code class="inline">task(datetime(), |task| task.again_at(datetime(2025, 1, 1)));</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Write a single line of code that evaluates all tasks and returns <code class="inline">true</code> only if all tasks are in a non-error state. If at least one task is in an error state, the code should return <code class="inline">false</code>.</p></li>
        <li class="thingsdb13"><p class="copyright1">Which of the following statements is true?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">The <em class="thingsdb15">datetime</em> type has millisecond precision.</li>
                <li class="thingsdb13">The <em class="thingsdb15">datetime</em> type is mutable, allowing changes like time zone adjustment.</li>
                <li class="thingsdb13">The <em class="thingsdb15">datetime</em> and <em class="thingsdb15">timeval</em> types represent the same information but differ in response format.</li>
                <li class="thingsdb13">The <em class="thingsdb15">timeval</em> type represents a timestamp, while the <em class="thingsdb15">datetime</em> type can be zone-aware.</li>
            </ol>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-236">
<section>
    <h4 id="answers-chapter-8" class="title2">8.5.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">The <code class="inline">now()</code> function returns a floating-point number representing the current time as the number of seconds since the Unix epoch (January 1, 1970, 00:00:00 UTC). </p></li>
        <li class="thingsdb13"><p class="copyright1">The code <code class="inline">timeval(2025, 1, 25, 13, 5, "Europe/Kyiv");</code> constructs a datetime object representing the specified date and time in the Europe/Kyiv time zone and directly returns a UNIX timestamp in the response. This differs from the <code class="inline">datetime()</code> function, which returns an ISO 8601 formatted string representation of the datetime object. To obtain a UNIX timestamp from a datetime object you can convert the datetime object to an integer using the <code class="inline">int()</code> function.</p></li>
        <li class="thingsdb13"><p class="copyright1">The property definition <code class="inline">"int&lt;-1:1&gt;?"</code> allows integer values from -1 to 1, inclusive. The question mark (<code class="inline">?</code>) denotes that the property can also be left <code class="inline">nil</code>. So, valid options are <code class="inline">-1</code>, <code class="inline">0</code>, <code class="inline">1</code> and <code class="inline">nil</code>.</p></li>
        <li class="thingsdb13"><p class="copyright1">The <code class="inline">cancel()</code> method prevents a task from executing while keeping it in the list. The task's error state will be set to <code class="inline">cancelled_err</code>. This is different from using the <code class="inline">del()</code> method, which completely removes the task from the list, including its data.</p></li>
        <li class="thingsdb13"><p class="copyright1">Option "b" is the correct approach for creating a daily repeating task. The <code class="inline">again_in()</code> method with a <code class="inline">"days"</code> argument allows you to define a relative delay from the current time. In this case, a recurring delay of 1 day, effectively scheduling the task to run every day until it is explicitly canceled. While <code class="inline">again_at()</code> can be used, it schedules the task for a specific time on that date only. Using <code class="inline">again_at(datetime(2025, 1, 1))</code> would run the task once on January 1, 2025, not daily. In fact, if the current date is past January 1, 2025, it would indeed result in a <code class="inline">value_err</code> <em class="thingsdb15">("start time out-of-range")</em> error.</p></li>
        <li class="thingsdb13"><p class="copyright1">The following line of code would accomplish this task:</p>
            <p class="quizcode"><code class="inline">tasks().every(|task| is_nil(task.err()));</code></p>
            <p class="copyright1">The function <code class="inline">tasks()</code> returns a list with all tasks and
                the <code class="inline">every()</code> method on the list iterates through each task and only
                returns <code class="inline">true</code> if the provided closure evaluates to <code class="inline">true</code> for
                every task. Within the closure, <code class="inline">is_nil(task.err())</code> checks if
                the <code class="inline">err()</code> method of each task returns with <code class="inline">nil</code>.</p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Statement "c" is correct: <em class="thingsdb15">datetime</em> and <em class="thingsdb15">timeval</em> represent the same information, but differ in response format. The <em class="thingsdb15">datetime</em> and <em class="thingsdb15">timeval</em> types offer only second precision. Both types are immutable, so attempting to change their time zone creates a new object reflecting the change. </p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-262">
<section type="chapter" role="doc-chapter" aria-labelledby="ch09_h" id="thingsdb_link-311">
    <h2 id="chapter-9" class="thingsdb7">Chapter 9 - Two-Way Links</h2>
    <p class="copyright1">Alice's trusty to-do app has caught Bob's eye, and now it's time to take it multi-user!
        Let's dive into how we can transform the app to accommodate different users and their to-do's.</p>
    <p class="copyright1">Let's start with creating a new type called <code class="inline">User</code> with properties
        for their <code class="inline">name</code> and <code class="inline">todos</code>:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">new_type("User");
set_type("User", {
    name: "str",
    todos: "{Todo}",
});</code>
<code class="response">null</code></pre>
    <div class="note">
        <img class="note1" src="images/idea.png" alt="Note" />
        <div class="content">
            <p class="author1">We're switching from a <em class="thingsdb15">list</em> to a <em class="thingsdb15">set</em> for <code class="inline1">todos</code>.
                This prepares us for introducing relations later in the chapter,
                as relations only work between sets and plain properties, not lists.</p>
        </div>
    </div>
    <p class="copyright1">Now comes the migration magic! Though slightly longer than previous code, keep in mind this
        single query transforms the entire collection from single-user to multi-user.
        It seamlessly adds users for Alice and Bob, migrates Alice's existing to-do's,
        and updates all procedures to function with the new setup.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code>
<code class="comment">// Add user lookup</code>
<code class="user">mod_type("Root", "add", "users", "thing&lt;User&gt;");</code>

<code class="comment">// Add procedure for adding a user</code>
<code class="user">new_procedure("add_user", |name| {
    "Add a new todo user.";
    uid = name.lower();
    assert(!.users.has(uid));
    user = .users[uid] = User{name:,};
    user.id();
});</code>

<code class="comment">// Add users and migrate Alice's to-do's</code>
<code class="user">user_id = add_user("Alice");
User(user_id).todos |= set(.todos);
add_user("Bob");</code>

<code class="comment">// Remove todos from Root</code>
<code class="user">mod_type("Root", "del", "todos");</code>

<code class="comment">// Update search_todos</code>
<code class="user">mod_procedure("search_todos", |needle| {
    "Search for to-do's";
    .users.values().reduce(|total, user| {
        total |= user.todos.filter(|todo| todo.body.contains(needle));
        total;
    }, set());
});</code>

<code class="comment">// Update add_todo</code>
<code class="user">mod_procedure("add_todo", |name, body| {
    "Adds a to-do to a user's todo list.";
    todo = Todo{body:,};
    .users[name.lower()].todos.add(todo);
    todo.id();
});</code>
<code class="response">null</code></pre>
    <p class="copyright1">So far, everything seems familiar. We can easily find a user's to-do's because
        they are directly stored under the <code class="inline">todos</code> property.
        But what if we have a specific to-do? How do we know which user it belongs to
        without searching through all users?</p>
    <p class="copyright1">This becomes evident when using our existing <code class="inline">search_todos.py</code> script:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python search_todos.py</code>
<code class="prompt">Search for:</code> <code class="user">report</code>
<code class="response">[{'id': 8, 'body': 'Send report to Bob', 'creation': '2024-02-07T14:52:26Z', 'completion': None}]</code></pre>
    <p class="copyright1">As you can see, the search does not reveal which user this to-do belongs to.</p>
    <section>
        <h3 id="chapter-9-1" class="title1">9.1 Introducing Relations</h3>
        <p class="copyright1">To address the issue described in the previous paragraph, we can add
            a <code class="inline">user</code> property to the <code class="inline">Todo</code> type.
            However, manually maintaining its accuracy could be cumbersome. ThingsDB offers a more
            elegant solution: <em class="thingsdb15">relations</em>.</p>
        <p class="copyright1">Let's add a relation between the <code class="inline">Todo</code> and <code class="inline">User</code>
            types using the following code:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code>
<code class="comment">// 1. Add the optional user property to Todo</code>
<code class="user">mod_type("Todo", "add", "user", "User?");</code>

<code class="comment">// 2. Create the bidirectional relation</code>
<code class="user">mod_type("Todo", "rel", "user", "todos");</code>
<code class="response">null</code></pre>
        <p class="copyright1">Let's break down the key steps:</p>
        <ol class="thingsdb12">
            <li class="thingsdb13">
                We add a new property named user to the <code class="inline">Todo</code> type.
                This property holds a reference to a <code class="inline">User</code> object, but here is the crucial part:
                it is nillable (indicated by the question mark <code class="inline">?</code>). Why is this important?
                Imagine we remove a <code class="inline">Todo</code> from a user's set.
                With a nillable property, ThingsDB can effortlessly set the <code class="inline">user</code> property
                to <code class="inline">nil</code>, reflecting the broken relationship. Without
                nillable properties, such changes would lead to errors or inconsistencies.
            </li>
            <li class="thingsdb13">
                Now comes the magic: creating a bidirectional relationship
                between <code class="inline">Todo</code> and <code class="inline">User</code>. We do
                this by specifying the <code class="inline">user</code> property on
                the <code class="inline">Todo</code> side and the <code class="inline">todos</code> property on
                the <code class="inline">User</code> side. This tells ThingsDB how they're connected. As a result,
                you can easily access a user's to-do's through their <code class="inline">todos</code> property
                and identify the owner of a specific <code class="inline">Todo</code> using
                its <code class="inline">user</code> property.
            </li>
        </ol>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">This relationship can be initiated from either the <code class="inline1">Todo</code>
                    or <code class="inline1">User</code> type, both would yield the same result.</p>
            </div>
        </div>
        <p class="copyright1">Now that we've built the bridge between <code class="inline">Todo</code>
            and <code class="inline">User</code>, let's see if it holds. Let's use our
            trusty <code class="inline">search_todos.py</code> script:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python search_todos.py</code>
<code class="prompt">Search for:</code> <code class="user">book</code>
<code class="response">[{
    'id': 2,
    'body': 'Read a book',
    'creation': '2024-02-07T14:47:49Z',
    'completion': '2024-02-07T14:48:06Z',
    'user': {'#': 10}
}]</code></pre>
        <p class="copyright1">Look! ThingsDB automatically populated the <code class="inline">user</code> property for us.
            But the real magic happens when we modify this relationship. Imagine changing
            the <code class="inline">"Read a book"</code> to-do's owner from Alice to Bob.
            Thanks to the <em class="thingsdb15">relation</em>, this change would seamlessly ripple through the system.
            The to-do automatically gets removed from Alice's <code class="inline">todos</code> set
            and added to Bob's! This dynamic behavior ensures your data stays consistent and
            reflects real-world ownership of to-do's.</p>
    </section>
    <section>
        <h3 id="chapter-9-2" class="title1">9.2 Exploring More Relations</h3>
        <p class="copyright1">Our to-do example showcased a <em class="thingsdb15">one-to-many</em> relationship between a single
            property <code class="inline">user</code> and a set todos. But ThingsDB's relational
            power doesn't stop there! Let's dive into the other types which are briefly
            described in <a href="#thingsdb_link-263" class="thingsdb14">Table 9.2</a> below.</p>
        <div class="table">
            <h2 id="thingsdb_link-263" class="thingsdb7"></h2>
            <p class="title3">Table 9.2 - Relationship Types</p>
            <table class="thingsdb20">
                <tr class="thingsdb21"><th class="thingsdb22">Relation</th><th class="thingsdb22">Definition</th><th class="thingsdb22">Description</th><th class="thingsdb22">Example</th></tr>
                <tr class="thingsdb21"><td class="thingsdb23">One-on-One</td><td class="thingsdb23"><code class="inline">T?</code> &lt;-&gt; <code class="inline">T?</code></td><td class="thingsdb23">Type to Type</td><td class="thingsdb23">Passport and owner</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23">One-to-Many</td><td class="thingsdb23"><code class="inline">T?</code> &lt;-&gt; <code class="inline">{T}</code></td><td class="thingsdb23">Type to Set</td><td class="thingsdb23">User and their to-do's</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23">Many-to-Many</td><td class="thingsdb23"><code class="inline">{T}</code> &lt;-&gt; <code class="inline">{T}</code></td><td class="thingsdb23">Set to Set</td><td class="thingsdb23">Users and their friends</td></tr>
            </table>
        </div>
        <p class="copyright1">Let's take a quick break from our current topic and set up a dedicated space for
            exploring the different types of relationships in ThingsDB. Using
            the <code class="inline">/thingsdb</code> scope, we'll create a new collection
            called <code class="inline">"relations"</code> to use for upcoming examples.</p>
        <p class="copyright1">Here's how we'll do it:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">@t</code>
<code class="prompt">(/t)&gt;</code> <code class="user">new_collection("relations");</code>
<code class="response">"relations"</code>
<code class="prompt">(/t)&gt;</code> <code class="user">@ //relations</code>
<code class="prompt">(//relations)&gt;</code></pre>
        <p class="copyright1">Now, with the <code class="inline">"relations"</code> collection ready and waiting, we can
            now examine the different types of relationships available in ThingsDB.</p>
        <section>
            <h4 id="chapter-9-2-1" class="title2">9.2.1 One-on-One Relationship</h4>
            <p class="copyright1">Imagine a <code class="inline">Passport</code> type linked to its owner through
                a <code class="inline">user</code> property. Each owner can have only one passport,
                and each passport belongs to exactly one owner. This scenario represents
                a <em class="thingsdb15">one-on-one</em> relationship, denoted
                as <code class="inline">T?</code> &lt;-&gt; <code class="inline">T?</code>
                in <a href="#thingsdb_link-263" class="thingsdb14">Table 9.2</a>.</p>
            <p class="copyright1">One-on-One relationships in ThingsDB offer flexibility beyond just connecting different
                types. You can create a relationship where one instance connects to exactly one other
                instance of the same type. This even allows for reflexive relationships, where an
                instance connects to itself!</p>
            <p class="copyright1">Defining the type <code class="inline">Pair</code> to demonstrate this type of relationship:</p>
<pre class="thingsdb16"><code class="prompt">(//relations)&gt;</code> <code class="user">new_type("Pair");</code>
<code class="user">set_type("Pair", {other: "Pair?"});</code>

<code class="comment">// Create a relationship to the same property</code>
<code class="user">mod_type("Pair", "rel", "other", "other");</code>
<code class="response">null</code></pre>
            <p class="copyright1">Creating a <code class="inline">Pair</code> in action:</p>
<pre class="thingsdb16"><code class="prompt">(//relations)&gt;</code> <code class="user">.p = Pair{};
.p.other= Pair{};
.p.other.other == .p;</code>  <code class="comment">// Returns true, confirming the link</code>
<code class="response">true</code></pre>
            <p class="copyright1">Building on the idea of self-referencing relationships, let's dive into chain relationships.
                These are perfect for modeling parent-child scenarios where each parent has only one child,
                and vice versa. Imagine a chain of connected elements, where each element points to the
                next one in line.</p>
            <p class="copyright1">Creating the <code class="inline">Chain</code> Type:</p>
<pre class="thingsdb16"><code class="prompt">(//relations)&gt;</code> <code class="user">new_type("Chain");
set_type("Chain", {prev: "Chain?", next: "Chain?"});</code>

<code class="comment">// Create a relationship between "prev" and "next"</code>
<code class="user">mod_type("Chain", "rel", "prev", "next");</code>
<code class="response">null</code></pre>
            <p class="copyright1">Now, let's create some <code class="inline">Chain</code> instances and connect them:</p>
<pre class="thingsdb16"><code class="prompt">(//relations)&gt;</code> <code class="user">.chain = Chain{};
.chain.next = Chain{};
.chain.next.next = Chain{};
.chain.next.next.prev == .chain.next;</code>  <code class="comment">// Returns true, confirming the link</code>
<code class="response">true</code></pre>
            <p class="copyright1">See how each element's <code class="inline">next</code> property points to the next one in
                the chain, and the last element's <code class="inline">prev</code> points back to the second element!</p>
        </section>
        <section>
            <h4 id="chapter-9-2-2" class="title2">9.2.2 Many-to-Many Relationship</h4>
            <p class="copyright1">Now, consider a social network scenario where users have friends. Adding Bob as a friend for
                Alice should automatically make Alice a friend of Bob.
                This <em class="thingsdb15">many-to-many</em> relationship connects two sets.</p>
            <p class="copyright1">Let's create a <code class="inline">Person</code> type in the <code class="inline">//relations</code>
                scope to model this scenario:</p>
<pre class="thingsdb16"><code class="prompt">(//relations)&gt;</code> <code class="user">new_type("Person");
set_type("Person", {friends: "{Person}"});</code>

<code class="comment">// Define the many-to-many relationship</code>
<code class="user">mod_type("Person", "rel", "friends", "friends");</code>
<code class="response">null</code></pre>
            <p class="copyright1">Now, let's see how Thelma and Louise become friends:</p>
<pre class="thingsdb16"><code class="prompt">(//relations)&gt;</code> <code class="user">.Thelma = Person{}; .Louise = Person{};</code>
<code class="user">.Thelma.friends.add(.Louise);</code>  <code class="comment">// Thelma adds Louise as a friend</code>
<code class="user">.Louise.friends.has(.Thelma);</code>  <code class="comment">// Returns true, confirming their friendship</code>
<code class="response">true</code></pre>
            <p class="copyright1">By adding Louise to Thelma's <code class="inline">friends</code> set, the relationship automatically
                applies to Louise's <code class="inline">friends</code> set as well, thanks to the defined relationship.</p>
            <p class="copyright1">Like other relationship types, <em class="thingsdb15">many-to-many</em> relationships aren't limited to connecting instances
                of the same type. As long as both participating entities have sets defined with each other's type,
                you can create a bidirectional connection. In <a href="#thingsdb_link-263" class="thingsdb14">Table 9.2</a>, we used the
                notation <code class="inline">{T}</code> &lt;-&gt; <code class="inline">{T}</code> to represent this
                flexibility.</p>
            <p class="copyright1">We've explored different relationships in ThingsDB. Now, let's head back to
                the <code class="inline">//todos</code> collection to continue building our to-do app!</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-9-3" class="title1">9.3 Creating Relations: A Deeper Look</h3>
        <p class="copyright1">Adding a relation in ThingsDB might seem like a simple task, but there's more to it than meets the eye.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">In ThingsDB, sets are deliberately chosen for the <em class="thingsdb15">"many"</em> side of relationships due to their unique
                    strengths: they naturally avoid order-related issues when removing things (unlike lists),
                    guarantee uniqueness (aligned with expected behavior) and offer optimized performance for managing
                    relations.</p>
            </div>
        </div>
        <p class="copyright1">Before officially establishing a relation, ThingsDB performs a thorough check to ensure everything is in
            order. Think of it like a safety net to prevent potential data conflicts.</p>
        <p class="copyright1">These checks are crucial for maintaining data integrity and consistency. Imagine accidentally creating a
            relation that would lead to duplicate data or inconsistent information. By proactively identifying such
            issues, ThingsDB safeguards your data and prevents headaches down the line.</p>
        <p class="copyright1">Now that we understand the importance of pre-checks, let's remember a key requirement for relations:
            <em class="thingsdb15">they only work with stored data</em>. This means that at least one of the entities involved in
            creating a relation (e.g. a <code class="inline">Todo</code> and its <code class="inline">User</code>) needs to have an ID assigned by ThingsDB.</p>
        <p class="copyright1">Consider this code snippet that tries to create a relation without this requirement:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code>
<code class="user">t = Todo{};</code>  <code class="comment">// Todo without ID</code>
<code class="user">u = User{};</code>  <code class="comment">// User without ID</code>
<code class="user">u.todos.add(t);</code>
<code class="response">TypeError: relations must be created using a property on a stored thing (a thing with an Id)</code></pre>
        <p class="copyright1">In this example, we attempt to link a <code class="inline">Todo</code> and a <code class="inline">User</code>
            by adding the <code class="inline">Todo</code> object to the user's <code class="inline">todos</code> property.
            However, the <code class="inline">User</code> object lacks an ID, which is essential for establishing the
            relation. Remember from <a href="#chapter-4-2" class="thingsdb14">Chapter 4.2</a> that things only get IDs when they are
            assigned to a collection.</p>
        <p class="copyright1">To correctly create the relation, first assign the <code class="inline">User</code> to the collection before
            adding the <code class="inline">Todo</code>. This will grant them IDs, enabling ThingsDB to establish the
            desired connection.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">Storing a thing before creating a relation is a fundamental principle in ThingsDB. While it might
                    seem like an extra step, it often aligns with the natural flow of data creation. Take
                    the <code class="inline1">add_todo</code> procedure, for example. While we did not explicitly
                    mention the rule there, adding the <code class="inline1">Todo</code> object to
                    the <code class="inline1">todos</code> set on the stored user is the correct way to establish
                    the relation with a <code class="inline1">User</code>.</p>
            </div>
        </div>
    </section>
    <section>
        <h3 id="chapter-9-4" class="title1">9.4 Code Cleanup</h3>
        <p class="copyright1">Previously, adding to-do's was limited to a specific user. Now, we'll prompt the user for a name during
            the process. This information will be passed to the <code class="inline">add_todo</code> procedure,
            ensuring the to-do gets linked to the correct user.</p>
        <p class="copyright1">Here's the updated <code class="inline">add_todo.py</code> script:</p>
<pre class="thingsdb16"><code class="prompt">async def work(client: Client):</code>
<code class="user">    name = input("Name: ")
    todo_body = input("To-do body: ")
    todo_id = await client.run('add_todo', name=name, body=todo_body)
    print(todo_id);</code></pre>
        <p class="copyright1">With the <code class="inline">add_todo.py</code> back on track, it's time to test your knowledge with
            the quiz! Then, in the next chapter, we'll master controlling ThingsDB responses.</p>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-37">
<section>
    <h3 id="quiz-chapter-9" class="title1">9.5 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Which of the following are valid relation types which can be handled by ThingsDB?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">T?</code> &lt;-&gt; <code class="inline">T?</code></li>
                <li class="thingsdb13"><code class="inline">T?</code> &lt;-&gt; <code class="inline">[T]</code></li>
                <li class="thingsdb13"><code class="inline">{T}</code> &lt;-&gt; <code class="inline">{T}</code></li>
                <li class="thingsdb13"><code class="inline">T?</code> &lt;-&gt; <code class="inline">{T}</code></li>
                <li class="thingsdb13"><code class="inline">T</code> &lt;-&gt; <code class="inline">{T}</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Can you identify which statement(s) establish a relation between type <code class="inline">X</code> on
            property <code class="inline">one</code> with definition <code class="inline">"Y?"</code> and
            type <code class="inline">Y</code> on a property called <code class="inline">many</code> using definition <code class="inline">"{X}"</code>?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">mod_type("X", "rel", "one", "many");</code></li>
                <li class="thingsdb13"><code class="inline">mod_type("X", "rel", "many", "one");</code></li>
                <li class="thingsdb13"><code class="inline">mod_type("Y", "rel", "one", "many");</code></li>
                <li class="thingsdb13"><code class="inline">mod_type("Y", "rel", "many", "one");</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Imagine we're building a to-do app with users and their tasks. We have a <code class="inline">Todo</code> type and a <code class="inline">User</code> type connected by a <em class="thingsdb15">one-to-many</em> relation on the <code class="inline">user</code> and <code class="inline">todos</code> properties. Now, consider the following code:</p>
            <p class="quizcode"><code class="inline">Todo{user: User(10)};</code></p>
            <p class="copyright1">This code tries to create a new <code class="inline">Todo</code> object and assign
                a <code class="inline">User</code> object with ID 10 to its <code class="inline">user</code> property.
                The <code class="inline">User</code> with ID 10 exists, so why would this code fail?
                Can you identify the issue and explain why it would not work in ThingsDB?</p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Remember our to-do app with the <code class="inline">Todo</code> and <code class="inline">User</code> types
            linked by a <em class="thingsdb15">one-to-many</em> relation? Now, consider the following code snippet:</p>
            <p class="quizcode"><code class="inline">todo = Todo(2);</code></p>
            <p class="quizcode"><code class="inline">user = User(10);</code></p>
            <p class="quizcode"><code class="inline">assert(todo.user == user);</code></p>
            <p class="quizcode"><code class="inline">user.todos -= set(todo);</code></p>
            <p class="quizcode"><code class="inline">todo.user;  // ??? what will it be?</code></p>
            <p class="copyright1">Given that this code runs without errors, can you predict what value will be assigned to <code class="inline">todo.user</code> after the final line?</p>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-10">
<section>
    <h4 id="answers-chapter-9" class="title2">9.5.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Valid relation types are "a", "c" and "d".</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">T?</code> &lt;-&gt; <code class="inline">T?</code> <em class="thingsdb15">(One-on-One relation)</em></li>
                <li class="thingsdb13"><code class="inline">T?</code> &lt;-&gt; <code class="inline">[T]</code> <em class="thingsdb15">(!!! Invalid - A relation with a "list" is not possible)</em></li>
                <li class="thingsdb13"><code class="inline">{T}</code> &lt;-&gt; <code class="inline">{T}</code> <em class="thingsdb15">(Many-to-Many relation)</em></li>
                <li class="thingsdb13"><code class="inline">T?</code> &lt;-&gt; <code class="inline">{T}</code> <em class="thingsdb15">(One-to-Many relation)</em></li>
                <li class="thingsdb13"><code class="inline">T</code> &lt;-&gt; <code class="inline">{T}</code> <em class="thingsdb15">(!!! Invalid - The property must be marked nillable)</em></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">The correct statements are "a" and "d". When establishing a relationship, ThingsDB relies on the third argument to locate the other type based on the provided property. Subsequently, the fourth argument serves as a pointer, directing ThingsDB to the target property on that type where the relationship will be formed.</p></li>
        <li class="thingsdb13"><p class="copyright1">In ThingsDB, establishing a relation between two types relies on stored data and their associated IDs. In your code, the <code class="inline">User</code> object with ID 10 exists, but you are trying to assign it to a new <code class="inline">Todo</code> without an ID. The solution is to use the stored user:</p>
            <p class="quizcode"><code class="inline">User(10).todos.add(Todo{});</code></p>
            <p class="copyright1">When working with relations in ThingsDB, always keep in mind the importance of stored data and IDs. Utilize existing objects with IDs to establish connections.</p>
        </li>
        <li class="thingsdb13"><p class="copyright1">The final value of <code class="inline">todo.user</code> in the given code snippet will
            be <code class="inline">nil</code>. The key lies in the line <code class="inline">user.todos -= set(todo)</code>.
            Here, we're using set subtraction to remove the <code class="inline">Todo</code> object from
            the <code class="inline">user.todos</code> set. ThingsDB then automatically updates the <code class="inline">user</code> property
            of the <code class="inline">Todo</code> object to <code class="inline">nil</code>, reflecting the "broken" relationship. This behavior ensures consistency and eliminates the possibility of orphaned references.</p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-243">
<section type="chapter" role="doc-chapter" aria-labelledby="ch10_h" id="thingsdb_link-312">
    <h2 id="chapter-10" class="thingsdb7">Chapter 10 - Control Responses</h2>
    <p class="copyright1">Remember how <code class="inline">search_todos.py</code> returned a <code class="inline">Todo</code> instance?
        While it is functional, imagine customizing the response to something like this:</p>
<pre class="thingsdb16"><code class="response">{
    "id": 2,
    "body": "Read a book",
    "done": true,
    "user": {
       "name": "Alice",
    }
}</code></pre>
    <p class="copyright1">This example showcases the desired structure:</p>
    <ul class="thingsdb18">
        <li class="editor">Essential keys like <code class="inline">"id"</code> and <code class="inline">"body"</code> remain unchanged.</li>
        <li class="editor">The <code class="inline">completion</code> property is replaced with a <code class="inline">"done"</code> flag.</li>
        <li class="editor">User information is simplified, including only the <code class="inline">"name"</code>.</li>
    </ul>
    <section>
        <h3 id="chapter-10-1" class="title1">10.1 The Power of Wrap-Only Types</h3>
        <p class="copyright1">While code manipulation can achieve this, ThingsDB offers a more efficient approach: Wrap-Only types.
            These types act as templates defining how to present existing data. They can't be directly created,
            but they can "wrap" other types, transforming their output.</p>
        <p class="copyright1">Let's dive into defining our wrap-only type for to-do's.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">new_type("_Todo", true);</code>
<code class="response">"_Todo"</code></pre>
        <p class="copyright1">The name we choose for our wrap-only type plays a role. While not strictly required, many developers
            adopt the convention of starting it with an underscore (<code class="inline">_Todo</code> in our case).
            This helps visually distinguish wrap-only types from regular ones at a glance.</p>
        <p class="copyright1">The second boolean argument (<code class="inline">true</code>) passed to <code class="inline">new_type()</code>
            serves as a flag, enabling the "wrap-only" mode for the defined type (<code class="inline">_Todo</code>).
            This signifies that direct instantiation of instances is prohibited. Instead, its functionality lies in
            dynamically transforming existing data structures based on the properties and computed values specified
            within its definition.</p>
        <p class="copyright1">Having declared our <code class="inline">_Todo</code> wrap-only type, we proceed to define its structure and behavior
            using <code class="inline">set_type()</code>:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">set_type("_Todo", {
    id: "#",
    body: "any",
    done: |this| is_datetime(this.completion),
});</code>
<code class="response">null</code></pre>
        <p class="copyright1">Let's dissect the key aspects of our wrap-only type configuration:</p>
        <ul class="thingsdb18">
            <li class="editor"><p class="copyright1"><code class="inline">id: "#"</code></p>
                <p class="quizcode">This familiar selection directly includes the unique identifier (id) of the wrapped <code class="inline">Todo</code> object in the response.</p>
            </li>
            <li class="editor"><p class="copyright1"><code class="inline">body: "any"</code></p>
                <p class="quizcode">This indicates we want to incorporate the entire text content of the <code class="inline">body</code> property, regardless of its original data type. To include a property in the wrapped data, its definition in the wrap-only type must be <em class="thingsdb15">equal or less restrictive</em> compared to the original. In this case, <code class="inline">"any"</code> covers any possible data type for the <code class="inline">body</code>.</p>
            </li>
            <li class="editor"><p class="copyright1"><code class="inline">done: |this| is_datetime(this.completion)</code></p>
                <p class="quizcode">This is where things get interesting! We're utilizing a <em class="thingsdb15">computed property</em>. This method dynamically examines the <code class="inline">completion</code> property of the wrapped <code class="inline">Todo</code>. If it finds a datetime value present, it sets the <code class="inline">done</code> flag to <code class="inline">true</code>, otherwise it remains <code class="inline">false</code>. This demonstrates the power of computed properties to not only select specific data but also transform it based on defined logic, adding new insights to the wrapped representation.</p>
            </li>
        </ul>
        <p class="copyright1">Fundamental to the design of wrap-only types is the restriction on direct instance creation. Let's confirm this behavior:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">_Todo{};</code>
<code class="response">TypeError: type `_Todo` has wrap-only mode enabled</code></pre>
        <p class="copyright1">As expected, attempting to directly create an instance of the <code class="inline">_Todo</code> type throws an error.</p>
        <p class="copyright1">To leverage the power of <code class="inline">_Todo</code>, we employ the <code class="inline">wrap()</code> method, available on thing objects. Let's see how it works:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Todo(2).wrap("_Todo");</code>
<code class="response">{
    "body": "Read a book",
    "done": true,
    "id": 2
}</code></pre>
        <p class="copyright1">We've achieved a significant transformation. The wrapped <code class="inline">Todo</code> now exhibits the
            desired structure, including the calculated <code class="inline">done</code> property. However, one
            crucial element remains missing - the <code class="inline">user</code> information.</p>
        <p class="copyright1">To incorporate <code class="inline">user</code> information, let's create another wrap-only type specifically for this purpose:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">new_type("_TodoUser", true, true);</code>
<code class="response">"_TodoUser"</code></pre>
        <p class="copyright1">The first <code class="inline">true</code> argument activates the familiar wrap-only mode functionality.
            However, the inclusion of the second <code class="inline">true</code> argument introduces a privacy feature.
            By specifying this additional flag, we instruct ThingsDB to exclude the ID property within the response.</p>
        <p class="copyright1">We'll keep the <code class="inline">_TodoUser</code> type simple, focusing on the essential <code class="inline">name</code> property:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">set_type("_TodoUser", {name: "str"});</code>
<code class="response">null</code></pre>
        <p class="copyright1">Now, let's merge <code class="inline">_TodoUser</code> into our <code class="inline">_Todo</code> type:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_type("_Todo", "add", "user", "&amp;_TodoUser?");</code>
<code class="response">null</code></pre>
        <p class="copyright1">Let's delve into the meaning of the <code class="inline">"&amp;_TodoUser?"</code> definition assigned to the <code class="inline">user</code> property.</p>
        <p class="copyright1">The <code class="inline">?</code> symbol is crucial as it preserves the original nillability <code class="inline">"User?"</code>
            of the <code class="inline">user</code> property. If we omitted the <code class="inline">?</code>,
            it would remove the nillability flag, making the definition stricter and preventing the <code class="inline">user</code> property
            to be included in a response.</p>
        <p class="copyright1">The <code class="inline">&amp;</code> symbol at the beginning of the <code class="inline">"&amp;_TodoUser?"</code>
            definition is a prefix flag in ThingsDB. Several such flags exist, each influencing how properties are returned
            in a query response. Remember the optional <code class="inline">deep</code> value in the <code class="inline">return</code>
            statement? It is actually rarely needed to define this <code class="inline">deep</code> value. The <code class="inline">&amp;</code>
            flag acts similarly, instructing ThingsDB to directly include the specified property in the response without
            manual deep level specification. It effectively maintains the same deep level as the parent property.</p>
        <div class="table">
            <h2 id="thingsdb_link-313" class="thingsdb7"></h2>
            <p class="title3">Table 10.1 - Summarizing prefix flags</p>
            <table class="thingsdb20">
                <tr class="thingsdb21"><th class="thingsdb22">Flag</th><th class="thingsdb22">Description</th></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"&amp;"</code></td><td class="thingsdb23">Use parent's deep level</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"+"</code></td><td class="thingsdb23">Force the maximum deep level of 126 (127 in parent)</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"-"</code></td><td class="thingsdb23">Force deep level of 0 (1 in parent)</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"^"</code></td><td class="thingsdb23">Apply <code class="inline">NO_IDS</code> return flag</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"*"</code></td><td class="thingsdb23">Return enumerator names instead of values</td></tr>
            </table>
        </div>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">While the <code class="inline1">^</code> flag effectively hides IDs, you might wonder if it is equivalent to setting
                    the hide-ID flag for the <code class="inline1">_TodoUser</code> type like we did. Both achieve
                    the same result here, but with a key difference. The <code class="inline1">^</code> flag
                    applies the <code class="inline1">NO_IDS</code> restriction
                    recursively, anonymizing IDs throughout nested user data. In contrast, hide-ID only
                    affects the <code class="inline1">_TodoUser</code> type itself, potentially exposing IDs in
                    nested objects.</p>
            </div>
        </div>
        <p class="copyright1">Now that we've incorporated the <code class="inline">user</code> property, let's witness the magic!</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Todo(2).wrap("_Todo");</code>
<code class="response">{
    "id": 2,
    "body": "Read a book",
    "done": true,
    "user": {
        "name": "Alice"
    }
}</code></pre>
        <p class="copyright1">This output aligns perfectly with our desired format!</p>
        <p class="copyright1">No need for a <code class="inline">return</code> statement or manual deep level specification! Our wrap-only types seamlessly weave together to-do information and the user's name, presenting a cohesive response in the desired format.</p>
    </section>
    <section>
        <h3 id="chapter-10-2" class="title1">10.2 Update Search Todos</h3>
        <p class="copyright1">Now that we have a robust wrap-only type for to-do's, let's adapt the <code class="inline">search_todos</code>
            procedure to leverage its functionality.</p>
        <p class="copyright1">Initially, we could employ the familiar <code class="inline">map()</code> method to wrap each filtered <code class="inline">Todo</code> instance:</p>
<pre class="thingsdb16"><code class="user">.users.values().reduce(|total, user| {
    total |= user.todos.filter(|todo| todo.body.contains(needle));
    total;
}, set()).map(|todo| todo.wrap("_Todo"));</code></pre>
        <p class="copyright1">However, ThingsDB offers a dedicated and more efficient option specifically designed for this common wrapping scenario:
            the <code class="inline">map_wrap()</code> method.</p>
        <p class="copyright1">Update the the <code class="inline">search_todos</code> procedure by incorporating the <code class="inline">map_wrap()</code> method:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_procedure("search_todos", |needle| {
    "Search for to-do's";
    .users.values().reduce(|total, user| {
        total |= user.todos.filter(|todo| todo.body.contains(needle));
        total;
    }, set()).map_wrap("_Todo");</code>  <code class="comment">// map_wrap() for efficient conversion</code>
<code class="user">});</code>
<code class="response">null</code></pre>
        <p class="copyright1">To confirm the successful integration of the <code class="inline">Todo</code> type, let's re-run
            the <code class="inline">search_todos.py</code> script:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python search_todos.py</code>
<code class="prompt">Search for:</code> <code class="user">book</code>
<code class="response">[{'id': 2, 'body': 'Read a book', 'user': {'name': 'Alice'}, 'done': True}]</code></pre>
        <p class="copyright1">As expected, the output now reflects the desired structure, incorporating the to-do details and user information within the expected format.</p>
    </section>
    <section>
        <h3 id="chapter-10-3" class="title1">10.3 Wrap Every-Thing</h3>
        <p class="copyright1">In this chapter, we crafted the <code class="inline">_Todo</code> wrap-only type, but did you
            notice a key detail? We never explicitly specified the target type for wrapping.
            That's because wrap-only types possess remarkable versatility! Any thing, any instance, can be
            wrapped using <code class="inline">_Todo</code>, regardless of its original definition.</p>
        <p class="copyright1">Let's observe what happens when we wrap an empty thing:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">{}.wrap("_Todo");</code>
<code class="response">{
    "done": "thing `#0` has no property `completion`"
}</code></pre>
        <p class="copyright1">While not ideal, the result is understandable. The computed <code class="inline">done</code> property
            returns an error message as the wrapped thing lacks the required <code class="inline">completion</code> property.</p>
        <p class="copyright1">Now, let's try wrapping an object with some properties:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">{completion: nil, body: 123, smile: true}.wrap("_Todo");</code>
<code class="response">{
    "body": 123,
    "done": false
}</code></pre>
        <p class="copyright1">As expected, the <code class="inline">done</code> property is calculated correctly based on the
            provided <code class="inline">completion</code> property. Remember, the <code class="inline">body</code>
            property in <code class="inline">_Todo</code> is defined as <code class="inline">"any"</code>,
            allowing it to accept various data types like integers here. Since <code class="inline">smile</code> is not defined
            in <code class="inline">_Todo</code>, it is simply ignored.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">While ThingsDB can wrap even plain things, it is worth noting that wrapping typed things
                    offers a significant performance advantage. This is due to an internal optimization
                    mechanism: The first time a typed thing is wrapped, ThingsDB creates a mapping table.
                    This table efficiently stores how each property in the typed object maps to the corresponding
                    property in the wrap-only type. For subsequent wraps of the same type, ThingsDB can leverage
                    this pre-calculated table, drastically reducing computation overhead. This optimization
                    excludes computed properties, which inherently require dynamic evaluation.</p>
            </div>
        </div>
    </section>
    <section>
        <h3 id="chapter-10-4" class="title1">10.4 Modifying Wrap-Only and Hide-ID Flags</h3>
        <p class="copyright1">In this chapter, we've explored creating wrap-only types and defining hide-ID behavior. While we
            covered the standard approach, you might be wondering what happens if you forget to set these
            flags initially?</p>
        <p class="copyright1">The <code class="inline">mod_type()</code> function provides two key actions for modifying these
            configurations after creation: <code class="inline">"wpo"</code> for managing wrap-only mode
            and <code class="inline">"hid"</code> for controlling hide-ID behavior.</p>
        <p class="copyright1">The following code demonstrates how to apply these actions in practice:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_type("_Todo", "wpo", true);</code>
<code class="response">null</code>
<code class="prompt">(//todos)&gt;</code> <code class="user">mod_type("_TodoUser", "hid", true);</code>
<code class="response">null</code></pre>
        <p class="copyright1">Enabling wrap-only mode for an existing type is restricted to when no instances of that type currently exist.
            Attempting to activate it with existing instances will result in an error.</p>
        <p class="copyright1">We trust you've gained a solid grasp of the transformative potential of wrap-only types. By
            leveraging them effectively, you can streamline your code, eliminating custom deep levels
            within <code class="inline">return</code> statements and achieving your desired data structures
            effortlessly.</p>
        <p class="copyright1">We wish you the best of luck with the quiz! In the next chapter, we'll delve into the exciting world of
            implementing flags and enumerators, further expanding your data manipulation capabilities within ThingsDB.</p>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-269">
<section>
    <h3 id="quiz-chapter-10" class="title1">10.5 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Both type <code class="inline">A</code> and <code class="inline">B</code> have an <code class="inline">email</code> property.
            On type <code class="inline">A</code> the property is defined as <code class="inline">"email?"</code>. In which
            scenario will the <code class="inline">email</code> property appear in the response when an instance of
            type <code class="inline">A</code> is wrapped with type <code class="inline">B</code>?</p>
            <p class="copyright1">Choose the correct definition(s) for the <code class="inline">email</code> property in type <code class="inline">B</code>:</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">"any"</code></li>
                <li class="thingsdb13"><code class="inline">"str"</code></li>
                <li class="thingsdb13"><code class="inline">"str?</code></li>
                <li class="thingsdb13"><code class="inline">"email"</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Consider the following code snippet:</p>
            <p class="quizcode"><code class="inline">new_type("T", true, true);</code></p>
            <p class="copyright1">What do the two boolean arguments in the provided <code class="inline">new_type()</code> function call signify?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">The first <code class="inline">true</code> activates wrap-only mode, the second activates the hide-ID flag.</li>
                <li class="thingsdb13">The first <code class="inline">true</code> activates wrap-only mode, the second activates the show-ID flag.</li>
                <li class="thingsdb13">The first <code class="inline">true</code> activates the hide-ID flag, the second activates wrap-only mode.</li>
                <li class="thingsdb13">The first <code class="inline">true</code> activates the show-ID flag, the second activates wrap-only mode.</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Wrap-only types empower you to define properties or methods. What purpose do methods serve in this context?</p></li>
        <li class="thingsdb13"><p class="copyright1">Imagine you have a variable <code class="inline">people</code> holding a list of things of
            type <code class="inline">Person</code>. Your task is to return this list with each <code class="inline">Person</code>
            instance transformed and represented using the <code class="inline">_Person</code> wrap-only type. Write the most concise and efficient statement possible to achieve this transformation.</p></li>
        <li class="thingsdb13"><p class="copyright1">Imagine you're creating a wrap-only type to transform existing instances of the <code class="inline">Person</code> type. Which of the following names are valid for your new wrap-only type?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">Beer</code></li>
                <li class="thingsdb13"><code class="inline">_Person</code></li>
                <li class="thingsdb13"><code class="inline">person</code></li>
                <li class="thingsdb13"><code class="inline">_PersonCompact</code></li>
                <li class="thingsdb13"><em class="thingsdb15">all of the above</em></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">What happens when a <em class="thingsdb15">computed property</em> encounters an error during its calculation? Choose the correct answer:</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">It throws an exception that needs to be handled elsewhere.</li>
                <li class="thingsdb13">It silently returns a default value like <code class="inline">nil</code>.</li>
                <li class="thingsdb13">It adds the property with a string value containing the error message.</li>
                <li class="thingsdb13">It continues with the calculation, potentially leading to unexpected results.</li>
            </ol>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-15">
<section>
    <h4 id="answers-chapter-10" class="title2">10.5.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Both <code class="inline">"str?"</code> and <code class="inline">"any"</code> can inherit
            the <code class="inline">email</code> property due to their less restrictive nature compared to the
            original <code class="inline">"email?"</code> definition. This follows the principle of compatibility
            where definitions should be either the same or less restrictive for properties to appear.
            While <code class="inline">"str"</code> enforces string type, it loses the nillability aspect from
            the original. On the other hand, <code class="inline">"any"</code> allows any type,
            including <code class="inline">nil</code>, effectively inheriting the nillability due to its broadness.</p></li>
        <li class="thingsdb13"><p class="copyright1">Answer "a". The first <code class="inline">true</code> enables wrap-only mode, and the second <code class="inline">true</code> activates the hide-ID flag. Both arguments default to <code class="inline">false</code> if omitted.</p></li>
        <li class="thingsdb13"><p class="copyright1">Methods in wrap-only types define <em class="thingsdb15">computed properties</em>: properties whose values are dynamically calculated on response creation.</p></li>
        <li class="thingsdb13"><p class="copyright1">The most efficient way to achieve this transformation is using the built-in <code class="inline">map_wrap()</code>
            method. Simply calling <code class="inline">people.map_wrap("_Person");</code> will wrap each <code class="inline">Person</code> object in the
            list with the <code class="inline">_Person</code> type. While other methods like <code class="inline">map()</code> can
            also be used, <code class="inline">map_wrap()</code> offers the most concise and efficient solution in this case.</p></li>
        <li class="thingsdb13"><p class="copyright1">All the proposed names technically work. However, best practices favor naming conventions for clarity
            and consistency. Options like <code class="inline">_Person</code> or the more descriptive
            name <code class="inline">_PersonCompact</code> using the underscore prefix instantly reveal the
            wrap-only purpose, enhancing code understanding and avoiding confusion.</p></li>
        <li class="thingsdb13"><p class="copyright1">The correct answer is "c". ThingsDB handles errors in computed properties gracefully by incorporating
            the error message itself as the property's string value within the result. This approach ensures visibility
            of any issues that may arise during calculation, promoting transparency and facilitating troubleshooting.</p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-247">
<section type="chapter" role="doc-chapter" aria-labelledby="ch11_h" id="thingsdb_link-314">
    <h2 id="chapter-11" class="thingsdb7">Chapter 11 - Flags, Enumerators and Regex</h2>
    <p class="copyright1">This chapter equips you with more powerful tools to manage data efficiently in ThingsDB: bitwise flags,
        regular expressions and enumerators. Let's jump right in with enumerators!</p>
    <p class="copyright1">Consider a <code class="inline">severity</code> property for your to-do items. An enumerator allows you
        to establish a finite list of valid options, such as "Low", "Medium", and "High". This enforces data
        integrity by ensuring only permitted values are assigned, preventing inconsistencies or invalid entries</p>
    <section>
        <h3 id="chapter-11-1" class="title1">11.1 Crafting Your First Enumerator</h3>
        <p class="copyright1">Unlike conventional data types, enumerators in ThingsDB are created directly using
            the <code class="inline">set_enum()</code> function. Here's the code to define the <code class="inline">Severity</code> enumerator
            for our to-do application:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">set_enum("Severity", {
    Low: 0,
    Medium: 1,
    High: 2,
</code>
<code class="comment">    // Optional method for customized string representation</code>
<code class="user">    str: |this| `{this.name()} ({this.value()})`,
});</code>
<code class="response">null</code></pre>
        <p class="copyright1">Key Technical Properties:</p>
        <ul class="thingsdb18">
            <li class="editor"><strong class="thingsdb17">Supported Data Types: </strong>Enumerators can accommodate integers, floats, strings, bytes, and things. Other types like sets, lists, and tasks are not supported.</li>
            <li class="editor"><strong class="thingsdb17">Unique Value Requirement: </strong>Each value within an enumerator must be distinct.</li>
            <li class="editor"><strong class="thingsdb17">Mutable Object Handling: </strong>Things, being mutable, can have identical content within an enumerator as long as they reference different objects.</li>
            <li class="editor"><strong class="thingsdb17">Method Inclusion: </strong>Enumerators can also house methods, like the <code class="inline">str()</code> method in our example, used for custom string formatting.</li>
            <li class="editor"><strong class="thingsdb17">Member Rules: </strong>At least one member is mandatory, and all members must share the same data type (e.g., all integers). Mixing types like integers and floats is not allowed.</li>
        </ul>
        <section>
            <h4 id="chapter-11-1-1" class="title2">11.1.1 Setting the Default Member of an Enumerator</h4>
            <p class="copyright1">Like other ThingsDB elements, enumerators possess default members. To avoid unexpected behavior,
                it is highly recommended to explicitly define these defaults using the <code class="inline">mod_enum()</code>
                function. Here's how to set <code class="inline">Medium</code> as the default member for
                the <code class="inline">Severity</code> enumerator:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_enum("Severity", "def", "Medium");</code>
<code class="response">null</code></pre>
            <p class="copyright1">To verify that the default member is correctly configured, simply call the <code class="inline">Severity</code> enumerator without providing a specific value to get the default member:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Severity();</code>
<code class="response">1</code></pre>
            <p class="copyright1">As demonstrated, when a member is returned in a response, its underlying value is displayed by default.
                In this case, <code class="inline">1</code> (representing <code class="inline">Medium</code>) is returned.</p>
        </section>
        <section>
            <h4 id="chapter-11-1-2" class="title2">11.1.2 Working with Enumerator Methods</h4>
            <p class="copyright1">Each enumerator member in ThingsDB offers two built-in methods: <code class="inline">name()</code>
                and <code class="inline">value()</code>. These methods provide programmatic access to the
                enumerator's name and value, respectively. Additionally, any custom methods defined within
                the enumerator become available to its members.</p>
            <p class="copyright1">Let's delve into practical examples using the <code class="inline">Severity</code> enumerator we defined earlier:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Severity().name();</code>
<code class="response">"Medium"</code>
<code class="prompt">(//todos)&gt;</code> <code class="user">Severity().value();</code>
<code class="response">1</code></pre>
            <p class="copyright1">As expected, <code class="inline">name()</code> returns the string <code class="inline">"Medium"</code>,
                while <code class="inline">value()</code> retrieves the corresponding value, <code class="inline">1</code>.</p>
            <p class="copyright1">Remember the optional <code class="inline">str()</code> method we defined for formatting? We can access it through a member:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Severity().str();</code>
<code class="response">"Medium (1)"</code></pre>
            <p class="copyright1">This demonstrates how custom methods enhance the functionality of enumerator members.</p>
        </section>
        <section>
            <h4 id="chapter-11-1-3" class="title2">11.1.3 Retrieving Enumerator Members</h4>
            <p class="copyright1">Need a member with a specific value? Simply pass the value directly to the enumerator constructor:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Severity(2).name();</code>  <code class="comment">// Value 2 for High</code>
<code class="response">"High"</code></pre>
            <p class="copyright1">This straightforward approach is ideal when the value is readily available.</p>
            <p class="copyright1">Know the enumerator name beforehand? Use static access with curly braces:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Severity{High}.str();</code>
<code class="response">"High (2)"</code></pre>
            <p class="copyright1">This method is useful when the name is known and fixed.</p>
            <p class="copyright1">Working with dynamic names stored in variables? Employ a closure within curly braces:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">name = "High"; Severity{||name};</code>
<code class="response">2</code></pre>
            <p class="copyright1">While the example might seem unusual, the name variable is simply for demonstration.
                In practice, you might receive it as an input argument or retrieve it dynamically.
                This method ensures security against code injection vulnerabilities, as described
                in <a href="#chapter-6-2-3" class="thingsdb14">Chapter 6.2.3</a>.
            </p>
        </section>
        <section>
            <h4 id="chapter-11-1-4" class="title2">11.1.4 Enumerator Validation</h4>
            <p class="copyright1">When you attempt to access an enumerator using an invalid value or name, it raises an error
                instead of silently continuing. This prevents unexpected behavior and ensures data accuracy.</p>
            <p class="copyright1">Here's what happens when you try to use non-existent values or names:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Severity(9);</code>
<code class="response">LookupError: enum `Severity` has no member with value 9</code>
<code class="prompt">(//todos)&gt;</code> <code class="user">Severity{Insane};</code>
<code class="response">LookupError: enum `Severity` has no member `Insane`</code>
<code class="prompt">(//todos)&gt;</code> <code class="user">Severity{||"NotAtAll"};</code>
<code class="response">LookupError: enum `Severity` has no member `NotAtAll`</code></pre>
            <p class="copyright1">As you can see, ThingsDB throws a <code class="inline">lookup_err</code> in all cases,
                clearly indicating the invalid input.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-11-2" class="title1">11.2 Enumerator Information</h3>
        <p class="copyright1">ThingsDB offers <code class="inline">enums_info()</code> to explore all defined enumerators within a collection, returning a list
            of information objects. Each object encapsulates details like its name, members, and methods.</p>
        <p class="copyright1">For a specific enumerator, use <code class="inline">enum_info()</code>, which retrieves a single
            information object. Remember that information methods like <code class="inline">enum_info()</code>
            return "mpdata" requiring further processing. Utilize the <code class="inline">load()</code> method to
            convert it into a usable structure where you can extract individual properties.</p>
        <p class="copyright1">For instance, verifying the default member of the <code class="inline">Severity</code> enumerator involves:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">enum_info("Severity").load().default;</code>
<code class="response">"Medium"</code></pre>
        <p class="copyright1">This code retrieves the <code class="inline">Severity</code> information object, loads it,
            and extracts the <code class="inline">default</code> property,
            revealing the default member: <code class="inline">"Medium"</code>.</p>
        <section>
            <h4 id="chapter-11-2-1" class="title2">11.2.1 Enumerator Members</h4>
            <p class="copyright1">Accessing an enumerator's member can be valuable for integrating with other platforms or systems.
                Ideally, we want these members readily available as a single "thing" for simpler handling.</p>
            <p class="copyright1">While <code class="inline">enum_info()</code> exposes members, processing them requires code to
                convert the returned list of tuples into a desired format. Here's an example
                using <code class="inline">reduce()</code>:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">enum_info("Severity").load().members.reduce(
    |t, m| {t.set(m[0], m[1]); t;},
    {}
);</code>
<code class="response">{"Low": 0, "Medium": 1, "High": 2}</code></pre>
            <p class="copyright1">As you can see, this approach involves several steps and can be cumbersome.</p>
            <p class="copyright1">Fortunately, ThingsDB provides a built-in solution: <code class="inline">enum_map()</code>.
                This function directly returns the enumerator members as a convenient "thing":</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">enum_map("Severity");</code>
<code class="response">{"Low": 0, "Medium": 1, "High": 2}</code></pre>
        </section>
    </section>
    <section>
        <h3 id="chapter-11-3" class="title1">11.3 Modifying Enumerators</h3>
        <p class="copyright1">Need to modify an existing enumerator after its creation? Don't worry, the <code class="inline">mod_enum()</code>
            function comes to the rescue! We previously saw it in action for setting the default member.
            But its power extends beyond that. It offers a versatile suite of actions to tailor your
            enumerators to your evolving needs.</p>
        <p class="copyright1">Here's a quick reference table summarizing the available actions:</p>
        <div class="table">
            <h2 id="thingsdb_link-315" class="thingsdb7"></h2>
            <p class="title3">Table 11.3 - Summary of mod_enum() actions</p>
            <table class="thingsdb20">
                <tr class="thingsdb21"><th class="thingsdb22">Action</th><th class="thingsdb22">Description</th></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"add"</code></td><td class="thingsdb23">Adds a new member or method to the enumerator</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"def"</code></td><td class="thingsdb23">Sets the default member for the enumerator</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"del"</code></td><td class="thingsdb23">Deletes a member or method from the enumerator</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"mod"</code></td><td class="thingsdb23">Modifies a member value or method closure</td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">"ren"</code></td><td class="thingsdb23">Renames a member or method</td></tr>
            </table>
        </div>
    </section>
    <section>
        <h3 id="chapter-11-4" class="title1">11.4 Implementation and Other Enumerator Solutions</h3>
        <p class="copyright1">While we've created a custom <code class="inline">Severity</code> enumerator, ThingsDB offers other
            built-in solutions for common purposes. Let's briefly compare these options before proceeding.</p>
        <section>
            <h4 id="chapter-11-4-1" class="title2">11.4.1 Revisiting Range Definitions</h4>
            <p class="copyright1">Recall that ThingsDB empowers you with precise control over integer values using range definitions.
                Let's revisit how to implement this for the <code class="inline">severity</code> property within
                the <code class="inline">Todo</code> type:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_type("Todo", "add", "severity", "int&lt;0:2:1&gt;");</code>
<code class="response">null</code></pre>
            <p class="copyright1">This code snippet concisely bolsters data integrity within the <code class="inline">Todo</code> type
                by introducing the <code class="inline">severity</code> property. This new property restricts
                values to integers within the strict <code class="inline">0-2</code> range, effectively preventing
                invalid input. Furthermore, a default value of <code class="inline">1</code> is established,
                ensuring a meaningful starting point for both existing and new instances. Notably, this constraint
                is retroactively applied to all existing <code class="inline">Todo</code> instances, guaranteeing
                data integrity throughout the entire dataset.</p>
            <p class="copyright1">Let's demonstrate the default value and error handling of the <code class="inline">severity</code> property:</p>
            <p class="copyright1">Creating a <code class="inline">Todo</code> instance without specifying <code class="inline">severity</code> assigns the default value:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Todo{}.severity;</code>
<code class="response">1</code></pre>
            <p class="copyright1">Attempting to create a <code class="inline">Todo</code> with an invalid severity triggers an error:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Todo{severity: 99};</code>
<code class="response">ValueError: mismatch in type `Todo`; property `severity` requires an integer value between 0 and 2 (both inclusive)</code></pre>
        </section>
        <section>
            <h4 id="chapter-11-4-2" class="title2">11.4.2 Regular Expressions using Regex</h4>
            <p class="copyright1">While enumerators offer a structured and type-safe approach to defining value sets, you can also
                achieve similar results using regular expressions. ThingsDB supports regular expressions through
                the "regex" data type.</p>
            <p class="copyright1">Here's how to write a regular expression in ThingsDB:</p>
<pre class="thingsdb16"><code class="prompt">/pattern/flags</code></pre>
            <p class="copyright1">Regular expressions in ThingsDB go beyond just validating strings. They act as powerful tools for
                various string manipulation tasks. By using string methods like <code class="inline">replace()</code>
                and <code class="inline">split()</code>, you can transform and extract portions of strings
                based on defined patterns.</p>
            <p class="copyright1">A key method for pattern matching is the regex method <code class="inline">test()</code>, which
                returns <code class="inline">true</code> if a given string matches the pattern,
                and <code class="inline">false</code> otherwise.</p>
            <p class="copyright1">Let's see the <code class="inline">test()</code> method in action:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">/^(Low|Medium|High)$/.test("Low");</code>
<code class="response">true</code>
<code class="prompt">(//todos)&gt;</code> <code class="user">/^(Low|Medium|High)$/.test("MEDIUM");</code>
<code class="response">false</code>
<code class="prompt">(//todos)&gt;</code> <code class="user">/^(Low|Medium|High)$/i.test("LOW");</code> <code class="comment">// Case-insensitive matching</code>
<code class="response">true</code></pre>
            <p class="copyright1">While crafting regular expressions is beyond this book's scope, let's briefly break down the pattern used in the example:</p>
            <ul class="thingsdb18">
                <li class="editor"><code class="inline">^</code>: Matches the beginning of the string.</li>
                <li class="editor"><code class="inline">(Low|Medium|High)</code>: Matches one of the listed options (<code class="inline">"Low"</code>, <code class="inline">"Medium"</code>, or <code class="inline">"High"</code>).</li>
                <li class="editor"><code class="inline">$</code>: Matches the end of the string.</li>
                <li class="editor"><code class="inline">i</code> flag: Enables case-insensitive matching.</li>
            </ul>
            <p class="copyright1">Leveraging the understanding of regular expressions, let's define the <code class="inline">severity</code>
                property using a pattern-based approach. Remember, definitions in ThingsDB are always strings. We
                encapsulate the regular expression within quotes and specify a default value. Crucially, this
                default value must strictly adhere to the defined pattern for successful definition acceptance.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_type(
    "Todo",
    "mod",
    "severity",
    "/^(Low|Medium|High)$/&lt;Medium&gt;",
    |this| ["Low", "Medium", "High"][this.severity],
);</code>
<code class="response">null</code></pre>
            <p class="copyright1">Key Points:</p>
            <ol class="thingsdb12">
                <li class="thingsdb13"><strong class="thingsdb17">Regex Definition:</strong> The code snippet utilizes a regex string (<code class="inline">/^(Low|Medium|High)$/</code>) to constrain valid severity values to <code class="inline">"Low"</code>, <code class="inline">"Medium"</code>, or <code class="inline">"High"</code>.</li>
                <li class="thingsdb13"><strong class="thingsdb17">Default Value:</strong> The <code class="inline">&lt;Medium&gt;</code> suffix sets the default value to <code class="inline">"Medium"</code>. Remember, default values must adhere to the defined pattern for acceptance.</li>
                <li class="thingsdb13"><strong class="thingsdb17">Migration Closure:</strong> This scenario necessitates a migration closure due to the incompatibility of the new regex with the previous integer range.</li>
                <li class="thingsdb13"><strong class="thingsdb17">Closure Functionality:</strong> The provided closure maps existing integer severity values (<code class="inline">0</code>, <code class="inline">1</code>, <code class="inline">2</code>) to their corresponding string equivalents (<code class="inline">"Low"</code>, <code class="inline">"Medium"</code>, <code class="inline">"High"</code>).</li>
            </ol>
            <p class="copyright1">Let's validate the default value and constraint for the string-based <code class="inline">severity</code> property:</p>
            <p class="copyright1">Creating a new <code class="inline">Todo</code> without specifying <code class="inline">severity</code> assigns the default value:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Todo{}.severity;</code>
<code class="response">"Medium"</code></pre>
            <p class="copyright1">Attempting to create a <code class="inline">Todo</code> with an invalid <code class="inline">severity</code> triggers an error:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Todo{severity: "Unknown"};</code>
<code class="response">ValueError: mismatch in type `Todo`; property `severity` has a requirement to match pattern /^(Low|Medium|High)$/</code></pre>
        </section>
        <section>
            <h4 id="chapter-11-4-3" class="title2">11.4.3 Transitioning to the Enumerator</h4>
            <p class="copyright1">Having explored both integer range and string-based solutions, let's migrate
                the <code class="inline">severity</code> property to leverage our custom <code class="inline">Severity</code> enumerator:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_type(
    "Todo",
    "mod",
    "severity",
    "Severity",
    |this| Severity{||this.severity},
);</code>
<code class="response">"Medium"</code></pre>
            <p class="copyright1">As before, a migration closure is necessary due to the change in data representation. This closure
                translates existing string values (<code class="inline">"Low"</code>, <code class="inline">"Medium"</code>, <code class="inline">"High"</code>) to
                their corresponding enumerator members (<code class="inline">Severity{Low}</code>, <code class="inline">Severity{Medium}</code>, <code class="inline">Severity{High}</code>).</p>
            <p class="copyright1">To confirm successful migration, let's create a new <code class="inline">Todo</code> with default severity:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Todo{}.severity.str();</code>
<code class="response">"Medium (1)"</code></pre>
            <p class="copyright1">Excellent! We can now leverage the <code class="inline">str()</code> method we defined, indicating that
                the <code class="inline">severity</code> property is now strictly bound to the enumerator's members.</p>
        </section>
        <section>
            <h4 id="chapter-11-4-4" class="title2">11.4.4 Wrap-Only Types with Enumerators</h4>
            <p class="copyright1">We can further elevate the <code class="inline">_Todo</code> wrap-only type by incorporating
                the <code class="inline">severity</code> property. Additionally, ThingsDB offers the
                optional <code class="inline">*</code> prefix flag to specify returning the enumerator
                member's <em class="thingsdb15">name</em> instead of its <em class="thingsdb15">value</em>. Let's demonstrate this in action:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_type("_Todo", "add", "severity", "*Severity");</code>
<code class="response">null</code></pre>
            <p class="copyright1">Now, let's test this modification on an empty <code class="inline">Todo</code>:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">Todo{}.wrap("_Todo");</code>
<code class="response">{
    "body": "-",
    "done": false,
    "severity": "Medium",
    "user": null
}</code></pre>
            <p class="copyright1">As you can see, the <code class="inline">severity</code> property now displays the member
                name <code class="inline">"Medium"</code> instead of its numerical
                value (<code class="inline">1</code>).</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-11-5" class="title1">11.5 Understanding Flags</h3>
        <p class="copyright1">Before we proceed with the quiz, let's explore a use case for flags in ThingsDB.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">Flags are a data structure used internally by ThingsDB and many other software to efficiently
                    store access rights and other bitwise information. Recall how we granted
                    the <code class="inline1">RUN</code> and <code class="inline1">CHANGE</code> access flags to
                    our <code class="inline1">"py"</code> user. These flags represent individual bits,
                    specifically <code class="inline1">16</code> (<code class="inline1">10000</code>)
                    for <code class="inline1">RUN</code> and <code class="inline1">2</code> (<code class="inline1">00010</code>)
                    for <code class="inline1">CHANGE</code>. By granting both, we effectively stored the
                    value <code class="inline1">18</code> (<code class="inline1">10010</code>) within a single
                    integer property. Leveraging 64-bit integers, ThingsDB empowers you to store up to 64 flags
                    within a single property, promoting data density and efficiency.</p>
            </div>
        </div>
        <section>
            <h4 id="chapter-11-5-1" class="title2">11.5.1 Using Enumerators to Store Flags</h4>
            <p class="copyright1">Before utilizing flags, we need to establish them within your ThingsDB project. Enumerators
                provide a convenient and safe approach for this task.</p>
            <p class="copyright1">While it may seem unrelated to our to-do app, let's imagine Alice and Bob, with no more tasks
                remaining, decide to play cards. We'll create a <code class="inline">Suits</code> enumerator
                to represent the four card suits:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">set_enum("Suits", {</code>
    <code class="user">Spades:   1&lt;&lt;0,</code>  <code class="comment">// 0b0001 (1)</code>
    <code class="user">Clubs:    1&lt;&lt;1,</code>  <code class="comment">// 0b0010 (2)</code>
    <code class="user">Diamonds: 1&lt;&lt;2,</code>  <code class="comment">// 0b0100 (4)</code>
    <code class="user">Hearts:   1&lt;&lt;3,</code>  <code class="comment">// 0b1000 (8)</code>
<code class="user">});</code>
<code class="response">null</code></pre>
            <p class="copyright1">We've used the bitwise left shift operator (<code class="inline">&lt;&lt;</code>) to assign
                values to each suit. While not mandatory, this approach helps prevent errors during
                flag definition, as it leverages the inherent binary representation of integers. Using
                simple numbers (<code class="inline">1</code>, <code class="inline">2</code>,
                <code class="inline">4</code>, <code class="inline">8</code>) would also work, but
                bit shifting offers additional safety and clarity.</p>
        </section>
        <section>
            <h4 id="chapter-11-5-2" class="title2">11.5.2 Working with Flags</h4>
            <p class="copyright1">Now that our <code class="inline">Suits</code> enumerator is defined, let's delve into how
                to use these flags effectively in your code.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">While this section delves into using flags in ThingsDB, the underlying bitwise
                        operations are similar to those found in most programming languages. If you are
                        comfortable with bitwise operators
                        like <code class="inline1">&lt;&lt;</code> and <code class="inline1">&amp;</code>,
                        you may find this section reinforces general concepts rather than ThingsDB-specific details.</p>
                </div>
            </div>
            <p class="copyright1"><strong class="thingsdb17">Bitwise OR (<code class="inline">|</code>) Operator:</strong> Combines multiple flags into a single variable:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="comment">// Sets both Spades and Hearts flags</code>
<code class="user">my_suits = Suits{Spades}.value() | Suits{Hearts}.value();</code>
<code class="response">9</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Bitwise OR-Equals (<code class="inline">|=</code>) Operator:</strong> Adds a flag to an existing value:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code>
<code class="user">my_suits = Suits{Spades}.value();</code>  <code class="comment">// Initially set Spades flag</code>
<code class="user">my_suits |= Suits{Hearts}.value();</code> <code class="comment">// Adds Hearts flag</code>
<code class="response">9</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Bitwise AND (<code class="inline">&amp;</code>) Operator:</strong> Checks if a specific flag is present:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">my_suits = Suits{Spades}.value() | Suits{Hearts}.value();</code>
<code class="comment">// Test for Hearts flag</code>
<code class="user">assert(bool(my_suits &amp; Suits{Hearts}.value()) == true);</code>

<code class="comment">// Test for Diamonds flag</code>
<code class="user">assert(bool(my_suits &amp; Suits{Diamonds}.value()) == false);</code>
<code class="response">null</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Bitwise NOT (<code class="inline">~</code>) Operator:</strong> Inverts all bits in a value, effectively removing a specific flag when combined with bitwise AND:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">my_suits = Suits{Spades}.value() | Suits{Hearts}.value();
my_suits &amp;= ~Suits{Hearts}.value();</code>  <code class="comment">// Unsets the Hearts flag</code>
<code class="response">1</code></pre>
            <p class="copyright1"><strong class="thingsdb17">Bitwise XOR (<code class="inline">^</code>) Operator:</strong> Flips the bits of a specified flag, switching its state on or off:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">my_suits = Suits{Spades}.value() | Suits{Hearts}.value();</code>
<code class="user">my_suits ^= Suits{Hearts}.value();</code>   <code class="comment">// Toggles the Hearts flag</code>
<code class="user">my_suits ^= Suits{Diamonds}.value();</code> <code class="comment">// Toggles the Diamonds flag</code>
<code class="response">5</code></pre>
            <p class="copyright1">Flags offer a powerful and compact way to store multiple boolean values within a single integer,
                enhancing data efficiency and representation. This can be particularly advantageous for managing
                access control, permissions, and various configuration settings.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">When integrating ThingsDB with other languages, remember the <code class="inline1">enum_map()</code> function.
                        This function helps effortlessly translate between ThingsDB enumerators and their corresponding
                        values in different languages, streamlining data exchange and interoperability.</p>
                </div>
            </div>
            <p class="copyright1">Best of luck with the quiz! In the next chapter, we embark on the exciting journey of events and rooms
                in ThingsDB, where you'll explore powerful mechanisms for real-time communication and data interactions
                within your applications.</p>
        </section>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-23">
<section>
    <h3 id="quiz-chapter-11" class="title1">11.6 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Select all statements that are true about enumerators:</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Members of an enumerator must be of the same type.</li>
                <li class="thingsdb13">An enumerator is created using the <code class="inline">new_enum()</code> function.</li>
                <li class="thingsdb13">Members must have unique names, and their values must also be unique.</li>
                <li class="thingsdb13">Enumerators are immutable, meaning you cannot modify members or methods after creation.</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">While creating an enumerator, why is it recommended to use <code class="inline">mod_enum()</code> at least once?</p></li>
        <li class="thingsdb13"><p class="copyright1">Imagine you have a variable <code class="inline">x</code> containing the name of a member within the <code class="inline">Colors</code> enumerator. How would you retrieve the corresponding member using that variable?</p></li>
        <li class="thingsdb13"><p class="copyright1">What built-in methods are available on every member of an enumerator?</p></li>
        <li class="thingsdb13"><p class="copyright1">What does the <code class="inline">*</code> prefix flag signify when used in a type property definition for an enumerator? Explain its purpose and impact on data representation.</p></li>
        <li class="thingsdb13"><p class="copyright1">Write a statement using a regular expression that checks if the string stored in the variable <code class="inline">animal</code> matches either <code class="inline">"Dog"</code> or <code class="inline">"Cat"</code>, regardless of case sensitivity.</p></li>
        <li class="thingsdb13"><p class="copyright1">Which code snippet accurately initializes the <code class="inline">Colors</code> enumerator with <code class="inline">R</code>, <code class="inline">G</code>, and <code class="inline">B</code> members so they can be independently used as distinct flags for bitwise operations?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">set_enum("Colors", {R: 0, G: 1, : 2});</code></li>
                <li class="thingsdb13"><code class="inline">set_enum("Colors", {R: "#FF0000", G: "#00FF00", B: "#0000FF"});</code></li>
                <li class="thingsdb13"><code class="inline">set_enum("Colors", {R: 1, G: 2, : 3});</code></li>
                <li class="thingsdb13"><code class="inline">set_enum("Colors", {R: 1&lt;&lt;0, G: 1&lt;&lt;1, : 1&lt;&lt;2});</code></li>
            </ol>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-253">
<section>
    <h4 id="answers-chapter-11" class="title2">11.6.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">The correct choices are "a" and "c". Enumerators enforce strict data type consistency for their members and require unique names and values. While <code class="inline">new_enum()</code> might seem fitting, remember that ThingsDB uses <code class="inline">set_enum()</code> to create enumerators. Enumerators are mutable, allowing you to add, rename, delete, and change members and methods using the <code class="inline">mod_enum()</code> function.</p></li>
        <li class="thingsdb13"><p class="copyright1">Setting a default value using <code class="inline">mod_enum()</code> is generally recommended for enumerators, particularly those used within a type to influence its behavior. While less crucial for enumerators solely used for storing values like flags, defining a default value through <code class="inline">mod_enum()</code> provides additional control and clarity in various use cases.</p></li>
        <li class="thingsdb13"><p class="copyright1">To dynamically retrieve the Colors member based on the name stored in x, you can use a closure expression enclosed in curly braces:</p>
            <p class="quizcode"><code class="inline">Colors{||x};</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">The two basic methods accessible to every enumerator member are:</p>
            <ul class="thingsdb18">
                <li class="thingsdb13"><code class="inline">name()</code>: This method returns the string name of the member as defined in the enumerator declaration.</li>
                <li class="thingsdb13"><code class="inline">value()</code>: This method returns the value associated with the member.</li>
            </ul>
            <p class="copyright1">Remember that enumerators themselves can have additional methods defined beyond these two, depending on how they were created using <code class="inline">set_enum()</code> or <code class="inline">mod_enum()</code>.</p>
        </li>
        <li class="thingsdb13"><p class="copyright1">The <code class="inline">*</code> prefix flag, when used in a type property definition for an enumerator, influences the value returned when the instance is wrapped for the response. It instructs the system to return the <em class="thingsdb15">name</em> of the corresponding enumerator member instead of its <em class="thingsdb15">value</em>.</p></li>
        <li class="thingsdb13"><p class="copyright1">The following regular expression, combined with the <code class="inline">test()</code> method, can be used to check if the variable <code class="inline">animal</code> matches either <code class="inline">"Dog"</code> or <code class="inline">"Cat"</code> (case-insensitive):</p>
            <p class="quizcode"><code class="inline">/^(dog|cat)$/i.test(animal);</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">The correct answer is "d":</p>
            <p class="quizcode"><code class="inline">set_enum("Colors", {R: 1&lt;&lt;0, G: 1&lt;&lt;1, : 1&lt;&lt;2});</code></p>
            <p class="copyright1">This option uses the bitwise left shift operator (<code class="inline">&lt;&lt;</code>) to assign distinct binary values to each member. Answer "a" and "c" are using consecutive integer values (0, 1, 2) and (1, 2, 3) which do not provide distinct binary representations for bitwise operations. Answer "b" is using string values for their members, which cannot be used for bitwise operations.</p>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-25">
<section type="chapter" role="doc-chapter" aria-labelledby="ch12_h" id="thingsdb_link-316">
    <h2 id="chapter-12" class="thingsdb7">Chapter 12 - Real-Time Data Updates with Events and Rooms</h2>
    <p class="copyright1">Imagine Alice and Bob want to build a live dashboard displaying the number of pending to-do's for all users
        in their to-do application. However, simply polling the collection every few seconds is inefficient and
        creates unnecessary network traffic.</p>
    <p class="copyright1">Enter the world of <em class="thingsdb15">Events</em> and <em class="thingsdb15">Rooms</em> in ThingsDB!</p>
    <div class="note">
        <img class="note1" src="images/idea.png" alt="Note" />
        <div class="content">
            <p class="author1">Remember from <a href="#chapter-4-4" class="thingsdb14">Chapter 4.4</a> how we used <code class="inline1">log()</code> to emit warning events to the client? Well, events are a much broader concept in ThingsDB, acting as messengers carrying information triggered by various actions. Besides warnings, ThingsDB, for example, also generates events for node status changes.</p>
        </div>
    </div>
    <section>
        <h3 id="chapter-12-1" class="title1">12.1 Rooms</h3>
        <p class="copyright1">This chapter focuses on a specific type of event: those emitted to <em class="thingsdb15">rooms</em>.</p>
        <p class="copyright1">Think of a room as a lightweight, dedicated communication channel within your collection.
            Each room receives a unique ID when it is associated with the collection, similar to
            individual things.</p>
        <p class="copyright1">Creating a room is simple:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">room();</code>
<code class="response">"room:nil"</code></pre>
        <p class="copyright1">You'll see <code class="inline">"room:nil"</code> because no ID has been assigned yet. Assigning the
            room to the collection grants it an ID, just like how it works with things.</p>
        <p class="copyright1">Since we converted the root of the collection to type <code class="inline">Root</code> back
            in <a href="#chapter-7-2" class="thingsdb14">Chapter 7.2</a>, modifying its structure requires
            the <code class="inline">mod_type()</code> function. We'll add a property named <code class="inline">dashboard</code> of type
            room to the <code class="inline">Root</code> type.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_type("Root", "add", "dashboard", "room");</code>
<code class="response">null</code></pre>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">While assigning a separate room to each <code class="inline1">Todo</code> might seem intuitive,
                    it would not be efficient for a comprehensive dashboard that requires an overall view.</p>
            </div>
        </div>
        <p class="copyright1">Let's verify if the room was created by accessing the <code class="inline">dashboard</code> property:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">.dashboard;</code>
<code class="response">"room:12"</code></pre>
        <p class="copyright1">You should see a unique room ID like <code class="inline">"room:12"</code>, indicating a successfully
            created room associated with the collection.</p>
        <p class="copyright1">We can retrieve the plain ID of the dashboard room using the <code class="inline">id()</code> method.
            This method comes in handy when we later want to join the room for event listening.</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">.dashboard.id();</code>
<code class="response">12</code></pre>
        <section>
            <h4 id="chapter-12-1-1" class="title2">12.1.1 Sending Your First Message via Events</h4>
            <p class="copyright1">With the "dashboard" room in place, we're ready to emit our first event!</p>
            <p class="copyright1">The process is simple: use the <code class="inline">emit()</code> method on your room object.
                The first argument is the <em class="thingsdb15">event name</em>, a string between 1 and 255 characters.
                You can optionally include additional arguments that will be sent along with the event.</p>
            <p class="copyright1">Here's an example of sending a "chat-message" event:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">.dashboard.emit("chat-message", "Who's listening???");</code>
<code class="response">null</code></pre>
            <p class="copyright1">Remember, no one has joined the room yet. So, while the event was successfully emitted,
                no one received the "chat-message".</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">While we emphasized the event name as the first argument for <code class="inline1">emit()</code>,
                        it can also accept an alternative <em class="thingsdb15">deep</em> value. Optionally, a second argument allows
                        setting flags like <code class="inline1">NO_IDS</code>. The actual event name and accompanying
                        data always follow, regardless of these advanced options which are hardly ever required.</p>
                    <p class="author1">For example: <code class="inline1">room.emit(2, NO_IDS, "&lt;EVENT_NAME&gt;", â¦)</code></p>
                </div>
            </div>
        </section>
    </section>
    <section>
        <h3 id="chapter-12-2" class="title1">12.2 Listen for Events</h3>
        <p class="copyright1">Just like before, we'll demonstrate using Python to create a listener for the "dashboard" room.
            Remember, the concepts are transferable to other languages like C#, Go, PHP or JavaScript/Node.js with minor adjustments.</p>
        <p class="copyright1">Before proceeding, let's create a dedicated user for the dashboard. We can leverage the
            same <code class="inline">new_todo_user()</code> procedure we established in <a href="#chapter-6-4" class="thingsdb14">Chapter 6.4</a>:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">@t</code>
<code class="prompt">(@t)&gt;</code> <code class="user">wse(); new_todo_user("dashboard", JOIN | RUN | QUERY);</code>
<code class="response">"14VdoACr4WydUi/PEi1MV6"</code></pre>
        <p class="copyright1">This grants the "dashboard" user:</p>
        <ul class="thingsdb18">
            <li class="editor"><code class="inline">JOIN</code>: To subscribe to the room and receive events.</li>
            <li class="editor"><code class="inline">QUERY</code>: To retrieve the room ID (needed for joining).</li>
            <li class="editor"><code class="inline">RUN</code>: To execute a future procedure for grabbing the initial state.</li>
        </ul>
        <section>
            <h4 id="chapter-12-2-1" class="title2">12.2.1 Creating Your Dashboard Listener</h4>
            <p class="copyright1">Save the following code as <code class="inline">dashboard.py</code>:</p>
<pre class="thingsdb16"><code class="prompt">import asyncio
from thingsdb.client import Client
from thingsdb.room import Room, event

class Dashboard(Room):

    @event("chat-message")
    def on_chat_message(self, message):
        print(message)

async def main():
    client = Client()
    client.set_default_scope('//todos')

    room = Dashboard("""//ti
        .dashboard.id();  </code><code class="comment">// This must return the room ID</code><code class="prompt">
    """)  </code><code class="comment"># Fetch the dashboard room ID dynamically</code><code class="prompt">

    await client.connect('localhost')  </code><code class="comment"># Replace with your address/port</code><code class="prompt">
    try:
        </code><code class="comment"># Authenticate with the dashboards user's token</code><code class="prompt">
        await client.authenticate('14VdoACr4WydUi/PEi1MV6')
        await room.join(client)  </code><code class="comment"># Join the dashboard room</code><code class="prompt">
        await asyncio.Future()  </code><code class="comment"># Run forever</code><code class="prompt">
    finally:
        client.close()
        await client.wait_closed()

asyncio.run(main())</code></pre>
            <p class="copyright1">Open a terminal and run the script:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python dashboard.py</code>
<code class="response">â¦</code></pre>
            <p class="copyright1">If successful, you'll see no immediate output. The listener is now actively waiting for
                events in the background.</p>
            <p class="copyright1">With the listener running, let's send a test message from the <code class="inline">//todos</code> scope:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">.dashboard.emit("chat-message", "Hello dear listeners");</code>
<code class="response">null</code></pre>
            <p class="copyright1">If everything is set up correctly, you should see the following output in the terminal
                running your <code class="inline">dashboard.py</code> script:</p>
<pre class="thingsdb16"><code class="prompt">$ python dashboard.py</code>
<code class="response">Hello dear listeners</code>
<code class="response">â¦</code></pre>
            <p class="copyright1">This confirms that your listener successfully received and printed the message!</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-12-3" class="title1">12.3 Retrieving Initial Dashboard State</h3>
        <p class="copyright1">While sending chat messages is fun, our ultimate goal is to create a functional dashboard.
            Like many real-world applications, the dashboard needs to fetch an initial state, in this case,
            the current number of uncompleted tasks for each user.</p>
        <p class="copyright1">First, we need a way to represent this information. Let's create a new wrap-only type named <code class="inline">_DashboardUser</code>:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">new_type("_DashboardUser", true);</code>
<code class="response">"_DashboardUser"</code></pre>
        <p class="copyright1">Next, we define the structure of <code class="inline">_DashboardUser</code>:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">set_type("_DashboardUser", {
    id: "#",
    name: "str",
    count: |this| list(this.todos).count(|todo| is_nil(todo.completion)),
});</code>
<code class="response">null</code></pre>
        <p class="copyright1">The <code class="inline">_DashboardUser</code> type defines three properties: <code class="inline">id</code> to
            identify a user, <code class="inline">name</code> for retrieving user names and <code class="inline">count</code> for
            calculating uncompleted to-do's using a computed property.</p>
        <p class="copyright1">Finally, we create a procedure named <code class="inline">get_dashboard_state</code> that retrieves and formats the initial data:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">new_procedure("get_dashboard_state", || {
    .users.values().map_wrap("_DashboardUser");
});</code>
<code class="response">"get_dashboard_state"</code></pre>
        <p class="copyright1">Let's check if it works:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">get_dashboard_state();</code>
<code class="response">[
    {"id": 10, "count": 2, "name": "Alice"},
    {"id": 11, "count": 0, "name": "Bob"}
]</code></pre>
        <p class="copyright1">This confirms that the procedure successfully retrieves the desired initial state.</p>
        <section>
            <h4 id="chapter-12-3-1" class="title2">12.3.1 Integration of the Initial State</h4>
            <p class="copyright1">Now that we have the <code class="inline">get_dashboard_state</code> procedure, let's integrate
                it into the dashboard application:</p>
<pre class="thingsdb16"><code class="prompt">class Dashboard(Room):</code>
<code class="user">    def on_init(self):
        # Called only once
        self.state = []

    async def on_join(self):
        # Called when joining the room
        self.state = await self.client.run("get_dashboard_state")
        self.print_state()

    def print_state(self):
        print('-' * 20)
        for user in self.state:
            name, count = user["name"], user["count"]
            print(f"{name:&lt;15}{count:&gt;5}")</code></pre>
        <ul class="thingsdb18">
            <li class="editor"><p class="copyright1"><strong class="thingsdb17">Initial state in <code class="inline">on_init()</code>:</strong></p>
                <p class="copyright1">The <code class="inline">on_init()</code> method, inherited from <code class="inline">Room</code>, is
                    called once during room initialization. We use it to initialize an empty state.</p>
            </li>
            <li class="editor"><p class="copyright1"><strong class="thingsdb17">Updating state on join in <code class="inline">on_join()</code>:</strong></p>
                <p class="copyright1">The asynchronous <code class="inline">on_join()</code> method, called when joining the room,
                    retrieves the current state using <code class="inline">get_dashboard_state</code> and updates the state.
                    It then calls <code class="inline">print_state</code> to display the information.</p>
                <div class="note">
                    <img class="note1" src="images/idea.png" alt="Note" />
                    <div class="content">
                        <p class="author1"><strong class="thingsdb17">Important Note:</strong> Unlike <code class="inline1">on_init()</code>,
                            <code class="inline1">on_join()</code> can be called multiple times due to reconnections.
                            This ensures the dashboard retrieves the latest state after any disruptions.</p>
                    </div>
                </div>
            </li>
            <li class="editor"><p class="copyright1"><strong class="thingsdb17">Custom <code class="inline">print_state()</code> method:</strong></p>
                <p class="copyright1">This custom method formats and prints the user names and uncompleted to-do counts from the state.</p>
            </li>
        </ul>
        <p class="copyright1">Running <code class="inline">dashboard.py</code> again will now print the state:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python dashboard.py</code>
<code class="response">--------------------
Alice              2
Bob                0</code></pre>
        </section>
        <section>
            <h4 id="chapter-12-3-2" class="title2">12.3.2 Implement Event Handlers</h4>
            <p class="copyright1">Now we need to handle events that indicate changes to the data, ensuring our dashboard reflects
                the latest information.</p>
            <p class="copyright1">Identifying state-changing procedures and methods:</p>
            <ul class="thingsdb18">
                <li class="editor"><code class="inline">add_todo</code>: Adds a new task to a user's list.</li>
                <li class="editor"><code class="inline">add_user</code>: Creates a new user.</li>
                <li class="editor"><code class="inline">mark_as_done</code>: Marks a task as completed.</li>
            </ul>
            <p class="copyright1">Here's the code to update the procedures and methods:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code>
<code class="user">mod_procedure("add_todo", |name, body| {
    "Adds a to-do to the list.";
    todo = Todo{body:,};
    .users[name.lower()].todos.add(todo);
    .dashboard.emit("add-todo", todo.user.id());  </code><code class="comment">// New line</code><code class="user">
    todo.id();
});
mod_procedure("add_user", |name| {
    "Add a new to-do user.";
    uid = name.lower();
    assert(!.users.has(uid));
    user = .users[uid] = User{name:,};
    .dashboard.emit("add-user", user.wrap("_DashboardUser"));  </code><code class="comment">// New line</code><code class="user">
    user.id();
});
mod_type("Todo", "mod", "mark_as_done", |this| {
    .dashboard.emit("mark-as-done", this.user.id());  </code><code class="comment">// New line</code><code class="user">
    this.completion = datetime();
});</code>
<code class="response">null</code></pre>
            <p class="copyright1">Implementing the event handlers in <code class="inline">dashboard.py</code>:</p>
<pre class="thingsdb16"><code class="prompt">class Dashboard(Room):</code>
<code class="user">    @event("add-todo")
    def on_add_todo(self, user_id):
        </code><code class="comment"># Update user's to-do count and display updated state</code><code class="user">
        self.get_user(user_id)["count"] += 1
        self.print_state()

    @event("add-user")
    def on_add_user(self, user):
        </code><code class="comment"># Add user to state and display updated state</code><code class="user">
        self.state.append(user)
        self.print_state()

    @event("mark-as-done")
    def on_mark_as_done(self, user_id):
        </code><code class="comment"># Update user's to-do count and display updated state</code><code class="user">
        self.get_user(user_id)["count"] -= 1
        self.print_state()

    def get_user(self, user_id):
        </code><code class="comment"># Find user object based on ID</code><code class="user">
        for user in self.state:
            if user["id"] == user_id:
                return user

    </code><code class="comment"># ... other methods</code></pre>
        </section>
        <section>
            <h4 id="chapter-12-3-3" class="title2">12.3.3 Test Your Dashboard in Action!</h4>
            <p class="copyright1">Restart your <code class="inline">dashboard.py</code> script and have some fun:</p>
            <ol class="thingsdb12">
                <li class="thingsdb13"><strong class="thingsdb17">Add new tasks:</strong> Create tasks for various users ("Alice", "Bob", or even a new user like "Charlie"). Observe how the dashboard automatically updates their to-do counts.</li>
                <li class="thingsdb13"><strong class="thingsdb17">Mark tasks done:</strong> Mark some tasks as completed and witness the immediate reflection in the dashboard's user counts.</li>
                <li class="thingsdb13"><strong class="thingsdb17">Add new users:</strong> Create additional users and see how they're automatically added to the dashboard.</li>
            </ol>
            <p class="copyright1"><em class="thingsdb15">Example output:</em></p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">python dashboard.py</code>
<code class="response">--------------------
Alice              2
Bob                0
--------------------
Alice              2
Bob                1
--------------------
Alice              1
Bob                1
--------------------
Alice              1
Bob                1
Charlie            0
â¦</code></pre>
            <p class="copyright1">As you interact, the dashboard dynamically updates the list, displaying the latest
                to-do counts for each user in real-time. This demonstrates the power of event-driven
                communication between your application and ThingsDB!</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-12-4" class="title1">12.4 Room for More</h3>
        <p class="copyright1">We hope this chapter provided a solid foundation for using events and rooms in ThingsDB.
            While it does not cover everything, it equips you to start building interactive applications.</p>
        <p class="copyright1"><strong class="thingsdb17">Expand your knowledge!</strong> For deeper insights into rooms and events,
            explore the client website specific to your chosen language. This website likely contains
            detailed information and examples beyond what is covered here. Do not miss
            the <a href="#connectors" class="thingsdb14">Connectors section</a> of this book for quick access to these
            valuable resources.</p>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-255">
<section>
    <h3 id="quiz-chapter-12" class="title1">12.5 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Who will receive the message <code class="inline">"Hello World"</code> in the following statement?</p>
            <p class="quizcode"><code class="inline">room().emit("new-message", "Hello World");</code></p>
            <p class="copyright1"><em class="thingsdb15">Remember: Rooms must have an ID before they can be joined.</em></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">What access flag is required for a program to join a room in ThingsDB?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">QUERY</code></li>
                <li class="thingsdb13"><code class="inline">CHANGE</code></li>
                <li class="thingsdb13"><code class="inline">RUN</code></li>
                <li class="thingsdb13"><code class="inline">JOIN</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">What method is available to get a room ID?</p></li>
        <li class="thingsdb13"><p class="copyright1">What is the most appropriate point to synchronize the state of a <em class="thingsdb15">Room</em> with the current state of the collection?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">on_init(..)</code> <em class="thingsdb15">(During room initialization)</em></li>
                <li class="thingsdb13"><code class="inline">on_join(..)</code> <em class="thingsdb15">(When joining the room)</em></li>
                <li class="thingsdb13"><code class="inline">on_emit(..)</code> <em class="thingsdb15">(When emitting an event)</em></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Which of the following are valid event names?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">"123"</code></li>
                <li class="thingsdb13"><code class="inline">"new-building"</code></li>
                <li class="thingsdb13"><code class="inline">"stop the program!"</code></li>
                <li class="thingsdb13"><code class="inline">""</code></li>
                <li class="thingsdb13"><code class="inline">"ADD_USER"</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Consider the following Python code snippet belonging to a <code class="inline">Room</code> class that listens to the <code class="inline">.math</code> room:</p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;&nbsp;&nbsp;@event("add-two-numbers")</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;&nbsp;&nbsp;def on_add_two_numbers(self, a, b):</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f"{a} + {b} = {a + b}")</code></p>
            <p class="copyright1">The observed output is:</p>
            <p class="quizcode"><code class="inline">8 + 5 = 13</code></p>
            <p class="copyright1">Can you write the ThingsDB code that could have triggered this event, resulting in the displayed response?</p>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-266">
<section>
    <h4 id="answers-chapter-12" class="title2">12.5.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">No one will receive the message <code class="inline">"Hello World"</code> because the statement lacks a room ID. Rooms require an ID for joining, and without one, a program cannot join the intended room.</p></li>
        <li class="thingsdb13"><p class="copyright1">The absolute requirement for joining a room in ThingsDB is the <code class="inline">JOIN</code> access flag. While the <code class="inline">QUERY</code> flag is not strictly mandatory, it offers valuable utility. It allows you to retrieve the room ID dynamically using a query.</p></li>
        <li class="thingsdb13"><p class="copyright1">The <code class="inline">id()</code> method is directly available on the room object and returns the ID as integer. While technically possible, extracting the ID from the string representation of the room object is less efficient and generally discouraged. The room object itself returns a string in the format <code class="inline">room:ID</code>.</p></li>
        <li class="thingsdb13"><p class="copyright1">Answer "b". The most appropriate point to synchronize the state with the current collection in a <code class="inline">Room</code> implementation is <code class="inline">on_join(..)</code>. While the <code class="inline">on_init(..)</code> could be used for initial state retrieval, it would not account for potential changes after a connection loss. The <code class="inline">on_join(..)</code> handler is called every time a room is joined, making it ideal for ensuring the latest state is retrieved from the collection.</p></li>
        <li class="thingsdb13"><p class="copyright1">All event names are valid <em class="thingsdb15">except for empty strings</em> (answer "d"). Remember, event names need at least one character and cannot exceed 255 characters.</p></li>
        <li class="thingsdb13"><p class="copyright1">The following ThingsDB code could have triggered the <code class="inline">"add-two-numbers"</code> event, leading to the observed output:</p>
            <p class="quizcode"><code class="inline">.math.emit("add-two-numbers", 8, 5);</code></p>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-237">
<section type="chapter" role="doc-chapter" aria-labelledby="ch13_h" id="thingsdb_link-317">
    <h2 id="chapter-13" class="thingsdb7">Chapter 13 - Futures and Modules</h2>
    <p class="copyright1">Ready to push your ThingsDB projects further? This chapter dives into the world of <em class="thingsdb15">modules</em>,
        unlocking a vast array of functionalities to extend your applications beyond the core features.</p>
    <p class="copyright1">Imagine sending automated emails, interacting with external APIs, storing files in the cloud, or even
        connecting to other databases &ndash; modules make these and more possible!</p>
    <p class="copyright1">But before we explore the exciting world of modules, let's take a quick detour and understand a key
        concept: <em class="thingsdb15">futures</em> in ThingsDB.</p>
    <p class="copyright1">By understanding futures, you'll be well-equipped to harness the true power of modules and unlock the
        full potential of your ThingsDB projects.</p>
    <section>
        <h3 id="chapter-13-1" class="title1">13.1 Demystifying Futures: Waiting with Purpose</h3>
        <p class="copyright1">Think of futures as placeholders for tasks running in the background, allowing your code to continue
            without getting stuck waiting.</p>
        <p class="copyright1">We'll start by creating an "empty future", which doesn't have a specific task but still waits for a query to complete before executing asynchronously:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">future(nil);</code>
<code class="response">[
    null
]</code></pre>
        <p class="copyright1">This code creates a future without any specific task. It simply waits for the query to finish and
            then executes asynchronously. The response you see (<code class="inline">[null]</code>) is the
            result of the future task (which, in this case, is nothing).</p>
        <section>
            <h4 id="chapter-13-1-1" class="title2">13.1.1 Using the Future's Task Result</h4>
            <p class="copyright1">We have seen how futures hold the place for background tasks. But what if we want to do something
                with the result of that task once it is finished? That is where the <code class="inline">then()</code>
                method comes to the rescue!</p>
            <p class="copyright1">Imagine you delegate a task to a friend. When they finish, they share the result.
                The <code class="inline">then()</code> method acts like your friend, waiting for the future to finish and
                then running a closure you provide with the result.</p>
            <p class="copyright1">Here is an example:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">future(nil).then(|result| is_nil(result));</code>
<code class="response">true</code></pre>
            <p class="copyright1">As you can see, the query response now shows the outcome of the
                closure (<code class="inline">true</code> in this case).</p>
            <p class="copyright1">The closure provided to the <code class="inline">then()</code> method operates in a separate context
                than your main code. It cannot directly access variables defined outside, like in this example:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code>
<code class="user">x = 10;
future(nil).then(|| x + 10);</code>
<code class="response">LookupError: variable `x` is undefined</code></pre>
            <p class="copyright1">So, how do we use existing variables within a future's closure? We simply pass them along! Wrap them
                up and send them together with the future using the <code class="inline">future()</code> function:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code>
<code class="user">x = 10;
future(nil, x).then(|_, x| x + 10);</code>
<code class="response">20</code></pre>
            <p class="copyright1">Specifying <code class="inline">nil</code> as an argument and then ignoring it could get a bit tedious. Well, ThingsDB offers a handy shortcut!</p>
            <p class="copyright1">Instead of <code class="inline">then()</code>, simply provide the closure as the first argument
                to <code class="inline">future()</code>. This magical closure inherits variables from your main context,
                eliminating the need to pass them explicitly:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code>
<code class="user">x = 5;
future(|x| x + 10);</code>  <code class="comment">// No more `nil`s!</code>
<code class="response">15</code></pre>
            <p class="copyright1">As you noticed, the task result is not explicitly mentioned, but since it is an empty future,
                we know it is <code class="inline">nil</code> anyway.</p>
            <p class="copyright1">Do you want to pass the arguments explicitly to the closure? No problem! Wrap them in a list as
                the second argument to <code class="inline">future()</code>:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code>
<code class="user">future(|x| x + 10, [8]);</code>  <code class="comment">// `x` is provided by the first item in the list</code>
<code class="response">18</code></pre>
            <p class="copyright1">By leveraging this simplified syntax, you can create and work with empty futures in a more concise and efficient way, making your asynchronous operations in ThingsDB cleaner and easier to manage.</p>
        </section>
        <section>
            <h4 id="chapter-13-1-2" class="title2">13.1.2 Empty Futures: Isolating Side Effects for Efficiency</h4>
            <p class="copyright1">You might wonder, "Why bother with empty futures?" The key lies in their ability to create separate contexts for closures, unlocking hidden potential.</p>
            <p class="copyright1">Imagine this scenario in our to-do application: we need a procedure to retrieve or create a user and then grab their ID (or other information, but let's focus on ID for now).</p>
            <p class="copyright1">One way to tackle this challenge is the following implementation:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">new_procedure("get_or_create_user_id", |name| {
    user = .users.get(name.lower());
    if (is_nil(user)) {
        wse();  </code><code class="comment">// Enforced Side effect for the add_user() call</code><code class="user">
        return add_user(name);
    };
    user.id();
});</code>
<code class="response">"get_or_create_user_id"</code></pre>
            <p class="copyright1">While this works for both existing and new users, it has a flaw: it triggers side effects even when a user already exists. This can be inefficient, especially if the procedure is called frequently.</p>
            <p class="copyright1">Here's how we can use an empty future to isolate side effects and improve efficiency:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">mod_procedure("get_or_create_user_id", |name| {
    user = .users.get(name.lower());
    if (is_nil(user)) {
        return future(|name| {
            wse();</code>  <code class="comment">// Side effect now contained within the future</code><code class="user">
            add_user(name);
        });
    };
    user.id();
});</code>
<code class="response">null</code></pre>
            <p class="copyright1">Now, the main branch retrieves the existing user ID without causing a change. If a new user needs to be created, the future's closure handles it asynchronously, ensuring updates only happen when necessary.</p>
            <p class="copyright1">Remember from <a href="#chapter-6-3" class="thingsdb14">Chapter 6.3</a> that we can verify if a procedure triggers
                side effects by checking the <code class="inline">with_side_effects</code> property. Let's confirm
                that our modified <code class="inline">get_or_create_user_id</code> procedure is truly free of them:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">procedure_info("get_or_create_user_id").load().with_side_effects;</code>
<code class="response">false</code></pre>
            <p class="copyright1">The value <code class="inline">false</code> indicates no side effects are detected within the main logic of the procedure.</p>
        </section>
        <section>
            <h4 id="chapter-13-1-3" class="title2">13.1.3 Caution! Futures Don't Always Behave Like Values</h4>
            <p class="copyright1">Before you store a future in your ThingsDB project, it is crucial to understand a key
                quirk: <strong class="thingsdb17">futures store their current state, not the eventual result</strong>. Just assigning a future
                to a variable works as expected, but attempting to store it in collections or object properties can
                lead to unexpected results.</p>
            <p class="copyright1">Let's explore the scenario:</p>
            <p class="copyright1">Imagine you create a future that calculates <code class="inline">2 + 2</code> and store it in a list:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">[future(|| 2 + 2)];</code>
<code class="response">[
    null
]</code></pre>
            <p class="copyright1">You might expect the list to contain <code class="inline">[4]</code>. However, the actual result
                is <code class="inline">[null]</code>. Why? Because you are not storing the future itself,
                but rather its <em class="thingsdb15">initial</em> state, which is <code class="inline">nil</code> before the calculation finishes.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-13-2" class="title1">13.2 Enhance Your ThingsDB with Modules</h3>
        <p class="copyright1">Now that you are familiar with futures, let's explore modules, which can significantly expand ThingsDB's capabilities. Modules can unlock various features like sending emails, connecting to diverse databases, or making HTTP(S) requests.</p>
        <p class="copyright1">Module Types:</p>
        <ul class="thingsdb18">
            <li class="editor"><strong class="thingsdb17">Python Modules:</strong> Python modules offer a familiar language option for future potential customization.</li>
            <li class="editor"><strong class="thingsdb17">Binary Modules:</strong> ThingsDB utilizes pre-written binary modules, providing various functionalities. Writing your own modules in a language like Go is possible but beyond this book's scope.</li>
        </ul>
        <p class="copyright1">For this book, we'll focus on pre-built binary modules, readily available and requiring no additional coding on your part.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">To install official modules, you'll need Internet access as they are downloaded
                    directly from GitHub repositories.</p>
            </div>
        </div>
        <section>
            <h4 id="chapter-13-2-1" class="title2">13.2.1 Install The Demo Module</h4>
            <p class="copyright1">Module installation in ThingsDB happens smoothly within the <code class="inline">/thingsdb</code> scope
                using the <code class="inline">new_module()</code> function. Just give your module a friendly alias
                (like <code class="inline">"demo"</code>), then provide the corresponding GitHub repository URL where
                it resides.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">Want a specific version? Simply add <code class="inline1">@v0.1.0</code> (or similar) alongside
                        the URL, and you're good to go!</p>
                </div>
            </div>
            <p class="copyright1">Switch to the <code class="inline">/thingsdb</code> scope and install the <code class="inline">demo</code> module:</p>
<pre class="thingsdb16"><code class="prompt">(//todos)&gt;</code> <code class="user">@t</code>
<code class="prompt">(@t)&gt;</code> <code class="user">new_module('demo', 'github.com/thingsdb/module-go-demo');</code>
<code class="response">null</code></pre>
            <p class="copyright1">Once you have installed the module, use the <code class="inline">module_info()</code> function to
                confirm its success.</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">module_info("demo");</code>
<code class="response">{
    "conf": null,
    "created_at": 1707931759,
    "doc": "https://github.com/thingsdb/module-go-demo#readme",
    "exposes": {
        "echo": {
            "argmap": ["message"],
            "defaults": {"load": true},
            "doc": "Echo message"
        }
    },
    "file": "/usr/lib/thingsdb-modules/demo/bin/demo_linux_amd64.bin",
    "github_owner": "thingsdb",
    "github_ref": "default",
    "github_repo": "module-go-demo",
    "github_with_token": false,
    "name": "demo",
    "scope": null,
    "status": "running",
    "version": "0.1.0"
}</code></pre>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">If the status is still <code class="inline1">"installing module..."</code>, wait a few seconds
                        longer for the installation to complete.</p>
                </div>
            </div>
            <p class="copyright1">Now that the <code class="inline">demo</code> module is installed, let's explore how to use its capabilities
                by understanding the methods it is exposing.</p>
<pre class="thingsdb16"><code class="response">"echo": {
    "argmap": ["message"],
    "defaults": {"load": true},
    "doc": "Echo message"
}</code></pre>
            <p class="copyright1">Every module exposes specific methods. For <code class="inline">demo</code>, it is the <code class="inline">echo()</code> method.
                This method takes a single argument, a <code class="inline">message</code>, and echoes it back.
                The <code class="inline">load</code> attribute being set to <code class="inline">true</code> means the
                echoed message will be loaded directly into ThingsDB, making it readily accessible.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">By setting <code class="inline1">load</code> to <code class="inline1">false</code> (the default),
                        you can unlock a special response format called "mpdata". This is ideal for modules that
                        fetch data from external sources where you do not need to store it in ThingsDB. Instead,
                        the data gets delivered directly to the client, avoiding unnecessary unpacking and repackaging
                        steps. This significantly reduces processing overhead, making your application more efficient.</p>
                </div>
            </div>
            <p class="copyright1">Let's test the <code class="inline">echo()</code> method:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">demo.echo("Hello Module!");</code>
<code class="response">[
    "Hello Module!"
]</code></pre>
            <p class="copyright1">As you see, the result is a list containing the echoed message. This is because calling a module
                method ultimately returns a future, similar to our previous future examples. However, in this case,
                the future holds the actual result (the echoed message) instead of being empty.</p>
            <p class="copyright1">We can use the familiar <code class="inline">then()</code> method to capture and manipulate the echoed message:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">demo.echo("Hello Module!").then(|result| result.upper());</code>
<code class="response">"HELLO MODULE!"</code></pre>
            <p class="copyright1">Here, <code class="inline">then()</code> grabs the echoed message (<code class="inline">"Hello Module!"</code>),
                converts it to uppercase, and returns the result.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">All exposed methods accept a <em class="thingsdb15">fixed amount</em> of arguments, specified in
                        the <code class="inline1">argmap</code> property. Any arguments exceeding this limit will not be
                        passed to the module's task itself. Instead, they will be parsed to the
                        subsequent <code class="inline1">then()</code> or <code class="inline1">else()</code> callback methods
                        you might use for handling results or errors.</p>
                </div>
            </div>
        </section>
        <section>
            <h4 id="chapter-13-2-2" class="title2">13.2.2 Sending NTFYs with the HTTP(S) Request Module</h4>
            <p class="copyright1">This section demonstrates another powerful module: the HTTP(S) request module. It allows you to seamlessly
                interact with other web services and APIs.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1"><strong class="thingsdb17">Install the "ntfy" app:</strong> Download the app on your phone
                        (<a href="https://ntfy.sh/" class="thingsdb14">https://ntfy.sh/</a>) and subscribe to
                        the <code class="inline1">"ThingsDB_Book"</code> topic (or create your own).</p>
                </div>
            </div>
            <p class="copyright1">Install the <code class="inline">requests</code> module using this code:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">new_module("requests", "github.com/thingsdb/module-go-requests");</code>
<code class="response">null</code></pre>
            <p class="copyright1">Verify the installation:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">module_info("requests").load().status;</code>
<code class="response">"running"</code></pre>
            <p class="copyright1">The <code class="inline">requests</code> module boasts a powerful <code class="inline">post_json()</code> method.
                Watch how it sends a message to your NTFY app:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">requests.post("https://ntfy.sh/", json_dump({
    topic: "ThingsDB_Book",
    message: "This book is fantastic!"
})).then(|| "OK").else(|err| err.msg());</code>
<code class="response">"OK"</code></pre>
            <p class="copyright1">Check your NTFY app &ndash; you should see the <code class="inline">"This book is fantastic!"</code> message.</p>
            <p class="copyright1">Just like <code class="inline">then()</code>, <code class="inline">else()</code> is available for all
                futures and plays a crucial role in error handling. It defines what happens when a request or task
                encounters an error.</p>
            <p class="copyright1">While <code class="inline">else()</code> is not needed for simple futures that always resolve successfully,
                it becomes essential when dealing with external sources like NTFY. These external systems can potentially
                fail due to network issues, server errors, or other unforeseen circumstances.
                If both <code class="inline">else()</code> and <code class="inline">then()</code> are defined, only one
                will be called based on the outcome (success or error).</p>
        </section>
        <section>
            <h4 id="chapter-13-2-3" class="title2">13.2.3 Talking to Yourself: Connecting ThingsDB Scopes</h4>
            <p class="copyright1">While the modules we have seen so far work out-of-the-box, others require configuration for specific tasks.
                Let's explore the <code class="inline">thingsdb</code> module, which allows communication across
                different ThingsDB scopes.</p>
            <p class="copyright1">You might think, <em class="thingsdb15">"We're already in ThingsDB, why connect to it again?"</em>. This module unlocks the
                ability to communicate between different scopes within the same ThingsDB node or even connect to
                separate ThingsDB clusters. Imagine you have data stored in a different scope that you need in your
                current scope, or you want to trigger actions across multiple clusters. This module makes it possible!</p>
            <p class="copyright1">As always, installation comes first:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">new_module("thingsdb", "github.com/thingsdb/module-go-thingsdb");</code>
<code class="response">null</code></pre>
            <p class="copyright1">ThingsDB requires proper authentication. To grant the module access, let's create a dedicated user.
                We can leverage the same <code class="inline">new_todo_user()</code> procedure we established
                in <a href="#chapter-6-4" class="thingsdb14">Chapter 6.4</a>:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">wse(); new_todo_user("module", RUN);</code>
<code class="response">"1w1WtiUZqSpCEX+B3p/Dtq"</code></pre>
            <p class="copyright1">With the token in hand, we'll configure the module using <code class="inline">set_module_conf()</code>.</p>
            <p class="copyright1">Here's how:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">set_module_conf("thingsdb", {
    token: "1w1WtiUZqSpCEX+B3p/Dtq",  </code><code class="comment">// Replace with your token</code><code class="user">
    host: "localhost",
});</code>
<code class="response">null</code></pre>
            <p class="copyright1">The function <code class="inline">set_module_conf()</code> operates asynchronously, meaning it initiates
                the configuration process in the background and returns <code class="inline">nil</code> immediately.</p>
            <p class="copyright1">To confirm successful configuration, always use <code class="inline">module_info()</code>:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">module_info("thingsdb");</code>
<code class="response">{
    "conf": {
        "host": "localhost",
        "token": "1w1WtiUZqSpCEX+B3p/Dtq"
    },
    "status": "running",
    </code><code class="comment">â¦  // &ndash; other information</code><code class="response">
}</code></pre>
            <p class="copyright1">Look for a status of <code class="inline">"running"</code> and correct configuration in
                the <code class="inline">conf</code> section.</p>
            <p class="copyright1">Troubleshooting:</p>
            <ul class="thingsdb18">
                <li class="editor"><strong class="thingsdb17">Error Messages:</strong> If the <code class="inline">status</code> shows an error, carefully examine the message for guidance.</li>
                <li class="editor"><strong class="thingsdb17">Detailed Logging:</strong> Set the log level to <code class="inline">DEBUG</code> for more information in the node console <em class="thingsdb15">(see <a href="#chapter-15-4" class="thingsdb14">Chapter 15.4</a> on how to enable debug logging)</em>.</li>
                <li class="editor"><strong class="thingsdb17">Node specific:</strong> For deeper troubleshooting, utilize <code class="inline">module_info()</code> within a node scope. This unlocks the number of active <code class="inline">tasks</code> and <code class="inline">restarts</code>. Active tasks reveal current workload on that node, potentially indicating bottlenecks. Restarts provide insight into module stability, highlighting frequent restarts as potential red flags.</li>
            </ul>
            <p class="copyright1">Now that the ThingsDB module is configured, let's put its cross-scope communication power to the test!</p>
            <p class="copyright1">We'll use the <code class="inline">search_todos()</code> procedure to find to-do's, even though we're currently in the <code class="inline">/thingsdb</code> scope:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">thingsdb.run("//todos", "search_todos", ["book"]).then(|res| res);</code>
<code class="response">[
    {
        "body": "Read a book",
        "done": true,
        "id": 2,
        "severity": "Medium",
        "user": {"name": "Alice"}
    }
]</code></pre>
            <p class="copyright1">As you can see, we successfully retrieved a to-do containing <code class="inline">"book"</code> from the <code class="inline">//todos</code> scope! This demonstrates the magic of cross-scope communication enabled by the ThingsDB module.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-13-3" class="title1">13.3 Managing Your Modules: Access, Updates, and More</h3>
        <section>
            <h4 id="chapter-13-3-1" class="title2">13.3.1 Controlling Module Access</h4>
            <p class="copyright1">By default, all installed modules are accessible by any scope. This is indicated
                by a <code class="inline">nil</code> value in the <code class="inline">scope</code> property
                of the module information.</p>
            <p class="copyright1">To limit a module's accessibility to a specific scope, use the <code class="inline">set_module_scope()</code> function.
                Remember, each module can only have one assigned scope at a time, making it either globally accessible or
                scoped to a single entity.</p>
        </section>
        <section>
            <h4 id="chapter-13-3-2" class="title2">13.3.2 Multiple Configurations, Multiple Installations</h4>
            <p class="copyright1">If you need the same module with different configurations, or with access restrictions to different scopes,
                consider installing it multiple times with different names. This allows you to tailor each instance to
                its specific needs.</p>
            <p class="copyright1">For example: Imagine connecting to different ThingsDB clusters. Install the <code class="inline">thingsdb</code> module twice with
                unique names, each configured to access a different cluster.</p>
        </section>
        <section>
            <h4 id="chapter-13-3-3" class="title2">13.3.3 Keeping Your Modules Up-to-Date</h4>
            <p class="copyright1">Modules are constantly evolving, so you might need to update them to benefit from new features and
                bug fixes. The <code class="inline">refresh_module()</code> function helps you out here. It stops the
                module, checks for available updates, performs the update if necessary, and restarts the module.</p>
            <p class="copyright1">For granular control over module source updates, leverage the <code class="inline">deploy_module()</code> function.
                While sharing similarities with <code class="inline">refresh_module()</code>, it offers the crucial
                capability to specify a new source for the module. This empowers you to, for instance, "pin" the module to a
                specific version, ensuring a stable and predictable environment. This is particularly valuable when working
                with dependencies or critical modules where consistent behavior is paramount.</p>
        </section>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-36">
<section>
    <h3 id="quiz-chapter-13" class="title1">13.4 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Can you simplify the following code while preserving its functionality and using a future?</p>
            <p class="quizcode"><code class="inline">future(nil, 6, 7).then(|_, a, b| a * b);</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Can you answer this tricky question: Is it possible to directly return <em class="thingsdb15">two futures</em> in a single query result in ThingsDB?</p></li>
        <li class="thingsdb13"><p class="copyright1">You encounter an exposed method within a module, and its <code class="inline">load</code> property has a default value of <code class="inline">true</code>. What does this imply?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">The module automatically loads into memory upon usage.</li>
                <li class="thingsdb13">The method's response will be deserialized.</li>
                <li class="thingsdb13">The property indicates the method is ready for use.</li>
                <li class="thingsdb13">The property has no effect on the method's behavior.</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">You are working with a ThingsDB module named <code class="inline">foo</code>. Its exposed method <code class="inline">bar()</code> has an intriguing <code class="inline">argmap</code> property set to <code class="inline">["*"]</code>. Consider the following code snippet:</p>
            <p class="quizcode"><code class="inline">foo.bar(nil, 42).then(|A, B| nil).else(|C, D| nil);</code></p>
            <p class="copyright1">Choose the most accurate statement about this call to the <code class="inline">bar()</code> method:</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Both <code class="inline">A</code> and <code class="inline">D</code> will be nil regardless of success or failure.</li>
                <li class="thingsdb13">On success, <code class="inline">A</code> will be <code class="inline">nil</code> and <code class="inline">B</code> will contain the method's response.</li>
                <li class="thingsdb13">On success, <code class="inline">B</code> will be <code class="inline">42</code> and on failure, <code class="inline">C</code> will be <code class="inline">42</code>.</li>
                <li class="thingsdb13">On success, <code class="inline">A</code> will contain the response and on failure, <code class="inline">C</code> will hold the error.</li>
            </ol>
            <p class="copyright1"><strong class="thingsdb17">Important:</strong> The <code class="inline">"*"</code> in an <code class="inline">argmap</code> signifies a single, unnamed argument that can hold either <code class="inline">nil</code> or a thing</p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Uh oh! A module in your ThingsDB application isn't behaving as expected. What steps can you take to diagnose the issue and get it back on track?</p>
            <p class="copyright1">Choose the most effective troubleshooting approach from the following:</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Restart the node and hope for the best.</li>
                <li class="thingsdb13">Reinstall the module without checking anything else.</li>
                <li class="thingsdb13">Use the <code class="inline">module_info()</code> function to gather information and check the node console logs.</li>
                <li class="thingsdb13">Ignore the issue and hope it fixes itself eventually.</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Scenario: You have a module pinned to version <code class="inline">v0.2.1</code> using the <code class="inline">@</code> notation. Now, a newer version (<code class="inline">v0.3.0</code>) with exciting features is available. How can you seamlessly update the module to tap into these enhancements?</p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-0">
<section>
    <h4 id="answers-chapter-13" class="title2">13.4.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">ThingsDB offers a clever feature to create futures without an actual task. This allows you to directly combine argument unpacking with future creation, eliminating the need for an empty placeholder. Here is the code:</p>
            <p class="quizcode"><code class="inline">future(|a, b| a * b, [6, 7]);</code></p>
            <p class="copyright1">This code accomplishes the identical multiplication as the original, but leverages a more concise and efficient syntax.</p>
        </li>
        <li class="thingsdb13"><p class="copyright1">While futures offer flexibility, directly returning two futures in a single response is not possible. Remember, a future can only be assigned to a variable. Assigning it to a list, for example, would simply store <code class="inline">nil</code> instead of the actual future.</p>
            <p class="copyright1">But wait! There is a workaround! While returning two direct futures is not possible, you can achieve similar behavior by chaining futures using the <code class="inline">then()</code> method. The first future's result can be passed to the second future, effectively creating a chained execution. One more workaround is to parse them as arguments to an empty future:</p>
            <p class="quizcode"><code class="inline">future(nil, future(|| 2+2), future(|| 3*3));  // response: [nil, 4, 9]</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Answer "b" is correct. When set to <code class="inline">true</code>, it instructs ThingsDB to automatically
            deserialize the response from the method call, making it readily accessible for further processing or
            manipulation. However, if you set the <code class="inline">load</code> property to <code class="inline">false</code>
            (the default), the method returns the response as "mpdata". This option is particularly useful when you do not need
            to use the data within your ThingsDB application or when you plan to send it directly to a client.
            In these cases, deserializing and then serializing it again would be unnecessary and potentially slow down your
            application.</p></li>
        <li class="thingsdb13"><p class="copyright1">Answer "d" is the correct answer. The <code class="inline">argmap</code> property set to <code class="inline">["*"]</code>
            signifies that the <code class="inline">bar()</code> method can accept a single
            argument (<code class="inline">nil</code> or a thing). In this case, you are providing nil as the argument.
            Additional arguments (like the <code class="inline">42</code> in the code snippet) won't be processed by the
            module itself. Instead, they'll be passed directly to the <code class="inline">then()</code> or <code class="inline">else()</code>
            callbacks making <code class="inline">B</code> or <code class="inline">D</code> equal to <code class="inline">42</code>
            depending on success or failure. This allows you to parse data to your callback logic.</p></li>
        <li class="thingsdb13"><p class="copyright1">Option "c" offers the most effective path to diagnosis. Use <code class="inline">module_info()</code> to
            get its <code class="inline">config</code> and <code class="inline">status</code>, plus check the node
            console logs for clues. These steps unlock insights into the issue, paving the way for a fix.
            Remember, understanding the root cause is key!</p></li>
        <li class="thingsdb13"><p class="copyright1">When seeking precise control over module updates, leverage the <code class="inline">deploy_module()</code>
            function. This tool empowers you to define the new source for the update, replacing any pinned version
            tags with the desired reference (e.g., <code class="inline">@v0.3.0</code> instead
            of <code class="inline">@v0.2.1</code>). Remember to prioritize testing updates in a non-production
            environment before deploying them to ensure compatibility and smooth operation.
            While <code class="inline">refresh_module()</code> can also update modules, it respects pinned versions.</p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-246">
<section type="chapter" role="doc-chapter" aria-labelledby="ch14_h" id="thingsdb_link-318">
    <h2 id="chapter-14" class="thingsdb7">Chapter 14 - Safeguarding Your Data: Backup, Restore, Export and Import</h2>
    <p class="copyright1">Now that you have explored the power of ThingsDB, it is crucial to consider data protection. While ThingsDB
        is designed for minimal downtime by scaling across multiple nodes, accidents or unforeseen events can still
        occur, potentially leading to data loss. Here's where backups come in!</p>
    <p class="copyright1">The good news is, ThingsDB offers scheduled backups without impacting ongoing operations. Unlike some solutions
        that lock access during backup creation, ThingsDB seamlessly handles this on <em class="thingsdb15">multi-node</em> setups.</p>
    <p class="copyright1">Later in this chapter we will also look at single collection exports and how to import them when required.
        This is also useful for development as it allows you to quickly load another collection on your local
        development machine without disrupting other collections you might be working on.</p>
    <section>
        <h3 id="chapter-14-1" class="title1">14.1 Node Scopes for Backups</h3>
        <p class="copyright1">So far, we have used the <code class="inline">/thingsdb</code> scope for managing user accounts and
            collections, and collection scopes for interacting with data. Now, for backups, we need a new scope:
            node scopes.</p>
        <p class="copyright1">Unlike the previous scopes, backups are node-specific. While each node eventually stores the same data,
            you tell ThingsDB which node should create a backup.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1"><strong class="thingsdb17">Production-Ready Backup Strategy</strong></p>
                <p class="author1">For reliable data protection, consider using at least two different nodes for backups. This ensures backups continue even if one node fails. Creating backups on all nodes is generally not required.</p>
            </div>
        </div>
        <p class="copyright1">Before scheduling a backup, we need to identify the node responsible for creating it.</p>
        <p class="copyright1">Access the node scope by typing <code class="inline">/node</code> (<code class="inline">@n</code> or <code class="inline">/n</code> for short) in the prompt:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">@ /node</code>
<code class="prompt">(/node)&gt;</code></pre>
        <p class="copyright1">When you do not specify a node ID in the scope, ThingsDB automatically uses the node you are currently
            connected to. To check which node this is, use the <code class="inline">node_info()</code> function
            and extract the <code class="inline">node_id</code> property using the following command:</p>
<pre class="thingsdb16"><code class="prompt">(/node)&gt;</code> <code class="user">node_info().load().node_id;</code>
<code class="response">0</code></pre>
        <p class="copyright1">The output <code class="inline">0</code> signifies you are currently connected to the node with ID 0.</p>
        <p class="copyright1">The <code class="inline">nodes_info()</code> function displays all nodes within your ThingsDB setup,
            providing valuable information like their IDs, names, and statuses:</p>
<pre class="thingsdb16"><code class="prompt">(/node)&gt;</code> <code class="user">nodes_info();</code>
<code class="response">[
    {
        "committed_change_id": 1,
        "node_id": 0,
        "node_name": "node0",
        "port": 9220,
        "status": "READY",
        "stored_change_id": 1,
        "stream": null,
        "syntax_version": "v1",
        "zone": 0
    }
]</code></pre>
        <p class="copyright1">In this set-up, we only have one node with ID 0, explaining the current connection.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">Wonder why <code class="inline1">node_info()</code> offers more detailed information
                    compared to <code class="inline1">nodes_info()</code>? Both commands are executed
                    on a specific node, meaning you receive information based on that node's knowledge
                    about itself and other nodes.</p>
            </div>
        </div>
        <p class="copyright1">However, if you have a multi-node setup, specifying the node ID is crucial for targeted operations.
            To force a query on a specific node, simply include its ID within the scope like this:</p>
<pre class="thingsdb16"><code class="prompt">(/node)&gt;</code> <code class="user">@ /node/0</code>
<code class="prompt">(/node/0)&gt;</code></pre>
        <p class="copyright1">Now that you have selected the right scope, let's create your first ThingsDB backup!</p>
    </section>
    <section>
        <h3 id="chapter-14-2" class="title1">14.2 Your First Backup</h3>
        <p class="copyright1">To create a backup, use the <code class="inline">new_backup()</code> function. It requires at
            least one argument: the target filename. Backup filenames must end
            with <code class="inline">".tar.gz"</code>. This ensures consistency and helps you understand
            the format of the saved data.</p>
        <p class="copyright1">ThingsDB offers handy template variables you can embed in your filename. These variables get
            automatically filled when the backup is created, making it easier to organize and identify
            your backups.</p>
        <div class="table">
            <h2 id="thingsdb_link-319" class="thingsdb7"></h2>
            <p class="title3">Table 14.2 - Summarizing backup template variable</p>
            <table class="thingsdb20">
                <tr class="thingsdb21"><th class="thingsdb22">Variable</th><th class="thingsdb22">Description</th><th class="thingsdb22">Example</th></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">{DATE}</code></td><td class="thingsdb23">Current date (YYYYMMDD format)</td><td class="thingsdb23"><code class="inline">20240221</code></td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">{TIME}</code></td><td class="thingsdb23">Current time (HHMMSS format)</td><td class="thingsdb23"><code class="inline">092713</code></td></tr>
                <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">{CHANGE_ID}</code></td><td class="thingsdb23">Last committed change ID</td><td class="thingsdb23"><code class="inline">123456</code></td></tr>
            </table>
        </div>
        <p class="copyright1">Here's a code snippet that creates a backup named <code class="inline">"/tmp/ti-backup-{DATE}-{TIME}.tar.gz"</code>.</p>
        <p class="copyright1"><strong class="thingsdb17">Note:</strong> If you are using <a href="#installation-docker" class="thingsdb14">Docker Compose</a> as described in this book,
            remember to adjust <code class="inline">/tmp</code> to <code class="inline">/dump</code>
            (which is volume-mounted to your local disk).</p>
<pre class="thingsdb16"><code class="prompt">(/node/0)&gt;</code> <code class="user">new_backup("/tmp/ti-backup-{DATE}-{TIME}.tar.gz");</code>
<code class="response">0</code></pre>
        <p class="copyright1">The return value (<code class="inline">0</code> in this case) is a unique backup ID assigned within that specific node.</p>
        <p class="copyright1">Now that you have the backup ID, let's check its status using the <code class="inline">backup_info()</code> function:</p>
<pre class="thingsdb16"><code class="prompt">(/node/0)&gt;</code> <code class="user">backup_info(0);</code>  <code class="comment">// Use the backup ID (0 in our example)</code>
<code class="response">{
    "created_at": 1708507632,
    "file_template": "/tmp/ti-backup-{DATE}-{TIME}.tar.gz",
    "files": [
        "/tmp/ti-backup-20240221-092713.tar.gz"
    ],
    "id": 0,
    "result_code": 0,
    "result_message": "success - 2024-02-21 09:27:13Z"
}</code></pre>
        <p class="copyright1">In this example, the <code class="inline">result_code</code> is <code class="inline">0</code>, indicating a
            successful backup. Additionally, the <code class="inline">result_message</code> confirms this
            with <code class="inline">"success - 2024-02-21 09:27:13Z"</code>. In case of issues, the result message
            offers further information or troubleshooting guidance.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1"><strong class="thingsdb17">Production-Ready Backup Strategy</strong></p>
                <p class="author1">During backup creation, the node enters a temporary mode called <code class="inline1">AWAY_MODE</code>.
                    This mode ensures data consistency by temporarily suspending regular queries while the backup process
                    takes place. However, queries specifically directed to that node using the node scope are still
                    accepted and handled normally.</p>
                <p class="author1">For multi-node setups, this temporary unavailability goes unnoticed by clients as queries are
                    automatically forwarded to other available nodes. ThingsDB ensures only one node
                    enters <code class="inline1">AWAY_MODE</code> at a time, guaranteeing uninterrupted service while
                    maintaining data integrity.</p>
            </div>
        </div>
    </section>
    <section>
        <h3 id="chapter-14-3" class="title1">14.3 Restoring Your Data</h3>
        <p class="copyright1">Having created a backup, let's discuss restoring it. For full backups like the one we made earlier,
            a comprehensive restore is the only option. To ensure a smooth restoration process, ThingsDB performs
            some essential pre-checks:</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1"><strong class="thingsdb17">Production-Ready Backup Strategy</strong></p>
                <p class="author1">Instead of directly restoring onto your primary ThingsDB, consider a safe testing approach using
                    separate storage paths. Set temporary environment variables for <code class="inline1">THINGSDB_STORAGE_PATH</code>
                    and <code class="inline1">THINGSDB_MODULES_PATH</code> pointing to dedicated directories.
                    This allows you to run ThingsDB using this alternate location leaving your primary data intact.</p>
            </div>
        </div>
        <p class="copyright1"><strong class="thingsdb17">User Permissions:</strong></p>
        <ul class="thingsdb18">
            <li class="editor">The user initiating the restore must possess <code class="inline">FULL</code> privileges on the <code class="inline">/thingsdb</code> scope.</li>
        </ul>
        <p class="copyright1"><strong class="thingsdb17">Data Presence:</strong></p>
        <ul class="thingsdb18">
            <li class="editor">No existing collections: Verify this using <code class="inline">collections_info()</code> and, if necessary, remove them with <code class="inline">del_collection()</code>. <em class="thingsdb15">(Note: empty collections may exist and are ignored)</em></li>
            <li class="editor">No existing modules: Use <code class="inline">modules_info()</code> to check and <code class="inline">del_module()</code> to remove any modules if needed.</li>
            <li class="editor">No tasks: Check for tasks in the <code class="inline">/thingsdb</code> scope using the <code class="inline">tasks()</code> function and remove them if necessary. </li>
        </ul>
        <p class="copyright1"><strong class="thingsdb17">Node Status:</strong></p>
        <ul class="thingsdb18">
            <li class="editor">All nodes must be online and ready: If not, either remove the problematic node or wait for it to be ready. Use <code class="inline">nodes_info()</code> to monitor node status.</li>
            <li class="editor">Multi-node setups: All committed changes must be stored on all nodes. <code class="inline">nodes_info()</code> displays both <code class="inline">committed_change_id</code> and <code class="inline">stored_change_id</code> for each node. This check is not required for single-node setups.</li>
        </ul>
        <p class="copyright1">Initiate the restore process using the <code class="inline">restore()</code> function within
            the <code class="inline">/thingsdb</code> scope. This function requires the filename of the backup you
            want to restore. Additionally, you can provide an optional thing argument containing extra restore options
            for further customization.</p>
        <p class="copyright1">Here's an example using restore options:</p>
<pre class="thingsdb16"><code class="prompt">(/t)&gt;</code> <code class="user">restore("/tmp/ti-backup-20240221-092713.tar.gz", {
    take_access: true,
    restore_tasks: true,
});</code>
<code class="response">0</code></pre>
        <p class="copyright1">In the provided example, the two key restore options are:</p>
        <ul class="thingsdb18">
            <li class="editor"><p class="copyright1"><code class="inline">take_access: true</code></p>
                <p class="quizcode">This grants full access to all restored scopes only to the user performing the restore. If you keep this option as the default <code class="inline">false</code>, access will be restored based on the original user permissions associated with each scope.</p>
            </li>
            <li class="editor"><p class="copyright1"><code class="inline">restore_tasks: true</code></p>
                <p class="quizcode">This includes scheduled tasks in the restoration process. However, keep in mind that tasks might automatically trigger based on their schedules once restored. This could be undesirable if you need time to adjust the environment after the restore. The default <code class="inline">false</code> setting prevents task execution.</p>
            </li>
        </ul>
        <p class="copyright1">After completing the restore, even with <code class="inline">take_access: true</code>, re-authenticate by signing out and signing in again due to potential user ID changes.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">While most modules function after a ThingsDB restore, some may need a nudge. Check their status with
                    <code class="inline1">modules_info()</code>. If any are not working properly,
                    use <code class="inline1">refresh_module()</code> to reload their configuration and state.
                    Alternatively, restarting the node(s) will also refresh all modules.</p>
            </div>
        </div>
        <section>
            <h4 id="chapter-14-3-1" class="title2">14.3.1 Restoring Data from a Multi-Node Setup</h4>
            <p class="copyright1">When restoring data from a backup created in a multi-node ThingsDB setup, you might encounter
                unintended behavior on single-node environments like your development machine. During the restore
                process, ThingsDB attempts to contact other nodes based on the information stored in the backup,
                which can be disruptive in this context.</p>
            <p class="copyright1">To prevent this unnecessary search for non-existent nodes, simply restart your ThingsDB instance
                after the restore is complete using the <code class="inline">--forget-nodes</code> command-line
                argument. This instructs ThingsDB to disregard any stored node information and operate as a
                single-node setup, aligning with your development environment.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-14-4" class="title1">14.4 Automating Your Backups</h3>
        <p class="copyright1">ThingsDB empowers you to schedule automatic backups, ensuring regular data protection without manual
            intervention. Let's explore how to set up scheduled backups:</p>
        <p class="copyright1">The <code class="inline">new_backup()</code> function offers three additional arguments for scheduling:</p>
        <ul class="thingsdb18">
            <li class="editor"><p class="copyright1"><code class="inline">start_ts</code></p>
                <p class="quizcode">Define the <strong class="thingsdb17">start date and time</strong> for the initial backup. If omitted, the backup starts immediately.</p>
            </li>
            <li class="editor"><p class="copyright1"><code class="inline">repeat</code></p>
                <p class="quizcode">Set the <strong class="thingsdb17">repetition interval</strong> in seconds. For daily backups, use <code class="inline">24 * 3600</code>. Leaving this blank creates a one-time backup.</p>
            </li>
            <li class="editor"><p class="copyright1"><code class="inline">max_files</code></p>
                <p class="quizcode">Determine the <strong class="thingsdb17">maximum number of backup files</strong> to retain. When this limit is reached, the oldest backup is automatically removed. The default is <code class="inline">7</code>.</p>
            </li>
        </ul>
        <p class="copyright1">Let's schedule a daily backup at 22 PM Kyiv time, keeping up to 14 backup files:</p>
<pre class="thingsdb16"><code class="prompt">(/t)&gt;</code> <code class="user">@ /node/0</code>
<code class="prompt">(/node/0)&gt;</code> <code class="user">new_backup(
    "/tmp/daily-{DATE}-{TIME}.tar.gz",
    datetime().to("Europe/Kyiv").replace({hour: 22, minute: 0, second: 0}),
    24*3600,</code>  <code class="comment">// Repeat every 24 hours</code><code class="user">
    14,</code>  <code class="comment">// Keep 14 backup files</code><code class="user">
);</code>
<code class="response">1</code></pre>
        <p class="copyright1">This starts a backup immediately as we start with a time in the past,
            the next one 24 hours later relative to the given start time.</p>
        <p class="copyright1">Use <code class="inline">backup_info()</code> and the backup ID (<code class="inline">1</code>)
            to confirm the schedule:</p>
<pre class="thingsdb16"><code class="prompt">(/node/0)&gt;</code> <code class="user">backup_info(1);</code>
<code class="response">{
    "created_at": 1708624740,
    "file_template": "/tmp/daily-{DATE}-{TIME}.tar.gz",
    "files": [],
    "id": 1,
    "max_files": 14,
    "next_run": "2024-02-22 20:00:00Z",
    "repeat": 86400
}</code></pre>
        <p class="copyright1">This shows details of your backup schedule, including the next run at 22:00 PM Kyiv time
            (<code class="inline">2024-02-22 20:00:00Z</code>), repeat interval, and maximum file count.</p>
        <section>
            <h4 id="chapter-14-4-1" class="title2">14.4.1 Ensuring Backup Health</h4>
            <p class="copyright1">ThingsDB offers a convenient function called <code class="inline">backups_ok()</code> to quickly
                check the overall health of your backup system. It returns a simple <code class="inline">true</code>
                or <code class="inline">false</code> value, making it easy to monitor if all backups are
                running as planned.</p>
            <ul class="thingsdb18">
                <li class="editor"><code class="inline">true</code>: All scheduled backups are successful or have not yet started.</li>
                <li class="editor"><code class="inline">false</code>: At least one backup has failed.</li>
            </ul>
<pre class="thingsdb16"><code class="prompt">(/node/0)&gt;</code> <code class="user">backups_ok();</code>
<code class="response">true</code></pre>
            <p class="copyright1">This response indicates that all your scheduled backups are currently successful or
                have not started yet.</p>
        </section>
        <section>
            <h4 id="chapter-14-4-2" class="title2">14.4.2 Google Cloud Storage</h4>
            <p class="copyright1">Looking to run ThingsDB on Google Cloud Platform (GCP)? We've got you covered! ThingsDB offers
                specialized Docker images for GCP, enabling you to write backups directly to a storage bucket.</p>
            <p class="copyright1">While we do not delve into the complete workflow here, we want you to be aware of this powerful option.
                More cloud platforms might be supported in future releases, so stay tuned to the documentation for updates.</p>
            <p class="copyright1">For GCP users, the ThingsDB GitHub repository provides a detailed guide for setting up backups on the GKE platform:</p>
            <ul class="thingsdb18"><li class="editor">GitHub Link: <a href="https://github.com/thingsdb/ThingsDB/tree/main/gke#readme" class="thingsdb14">https://github.com/thingsdb/ThingsDB/tree/main/gke#readme</a></li></ul>
            <p class="copyright1">What you will find:</p>
            <ul class="thingsdb18">
                <li class="editor">Step-by-step instructions for configuring ThingsDB on GKE with Google Cloud Storage integration.</li>
                <li class="editor">Guidance on utilizing the <code class="inline">new_backup()</code> function to write backups to your storage bucket.</li>
                <li class="editor">Essential considerations for managing and monitoring your backups.</li>
            </ul>
        </section>
    </section>
    <section>
        <h3 id="chapter-14-5" class="title1">14.5 Exporting and Importing Collections</h3>
        <p class="copyright1">While backups are crucial for disaster recovery, sometimes you need to work with specific collections or
            data subsets. ThingsDB's <code class="inline">export()</code> function provides flexibility for
            these scenarios.</p>
        <p class="copyright1"><strong class="thingsdb17">Collection Schemas</strong></p>
        <p class="copyright1">Run <code class="inline">export()</code> without arguments to retrieve the collection schema
            definition in a readable format. This includes enumerators, types, and procedures, but not the actual data.</p>
        <p class="copyright1"><strong class="thingsdb17">Exporting Everything</strong></p>
        <p class="copyright1">Call <code class="inline">export()</code> with a "thing" argument containing a <code class="inline">dump</code>
            property set to <code class="inline">true</code>. This exports the entire collection, including data and
            tasks (if any), in MessagePack format. You can then use the <code class="inline">import()</code> function
            to restore this data.</p>
        <p class="copyright1">ThingsDB Prompt simplifies the export/import process by letting you directly invoke <code class="inline">export()</code> and <code class="inline">import()</code> functions
            from the command line, eliminating the need for manual file handling.</p>
        <p class="copyright1">Use <code class="inline">export</code> as an argument to write an export to a file. The default
            for <code class="inline">things-prompt</code> is to export everything:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">things-prompt -u admin -p pass -s //todos export /tmp/dump.mp</code></pre>
        <p class="copyright1">Use <code class="inline">import</code> as an argument to import the exported data into a new collection:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">things-prompt -u admin -p pass -s //dev import /tmp/dump.mp</code></pre>
        <p class="copyright1">This creates a new collection <em class="thingsdb15">"dev"</em> with data identical to the original <em class="thingsdb15">"todos"</em> collection.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1"><strong class="thingsdb17">Production-Ready Backup Strategy</strong></p>
                <p class="author1">Tasks are not automatically imported during collection imports to prevent unintended immediate
                    execution. If your exported collection contains tasks and you want them imported, use
                    the <code class="inline1">--tasks</code> flag with the <code class="inline1">import</code> command.</p>
            </div>
        </div>
        <section>
            <h4 id="chapter-14-5-1" class="title2">14.5.1 Exporting Collection Schemas</h4>
            <p class="copyright1">You can also export just the collection's definition (enumerators, types, procedures) for future
                reference or sharing. This exported schema is in a readable ThingsDB code format.</p>
            <p class="copyright1">Include the <code class="inline">--structure-only</code> flag with the <code class="inline">export</code> command:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">things-prompt \
    -u admin -p pass -s //todos export /tmp/dump.ti --structure-only</code></pre>
            <p class="copyright1">This creates a pain text file <code class="inline">/tmp/dump.ti</code> containing the collection's code,
                including enum definitions like:</p>
<pre class="thingsdb16"><code class="prompt">// Enums
set_enum('Severity', {
        Medium: 1,
        Low: 0,
        High: 2,
        str: |this| `{this.name()} ({this.value()})`,
});
// â¦ more lines</code></pre>
            <p class="copyright1">As before, use <code class="inline">import</code> to import the exported schema into a (new) collection.</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">things-prompt -u admin -p pass -s //schema import /tmp/dump.ti</code></pre>
            <p class="copyright1">This creates a new collection "schema" with the same enumerators, types and procedures as the original,
                but without any data.</p>
            <div class="note">
                <img class="note1" src="images/idea.png" alt="Note" />
                <div class="content">
                    <p class="author1">Importing full collections with data can only be done into new or empty collections. This prevents
                        accidental data overwrites.</p>
                    <p class="author1">However, plain text imports (like created by a <code class="inline1">--structure-only</code> export)
                        treat the imported code as a regular ThingsDB query and can apply it to any existing collection.
                        This means it directly executes the provided code within that collection, potentially modifying
                        data or creating new entities.</p>
                </div>
            </div>
        </section>
    </section>
    <section>
        <h3 id="chapter-14-6" class="title1">14.6 Choosing Your Tool: Backups vs. Exports</h3>
        <p class="copyright1">In conclusion, exports and backups are both valuable tools, but serve distinct purposes:</p>
        <ul class="thingsdb18">
            <li class="editor"><strong class="thingsdb17">Exports:</strong> Ideal for development environments. They provide an easy way to extract specific collections or their structures for testing, sharing data subsets, or migrating between instances.</li>
            <li class="editor"><strong class="thingsdb17">Backups:</strong> Essential for disaster recovery and protecting production data. They create complete copies at specific points in time, ensuring you can recover from unexpected events without impacting your ThingsDB operations. Backups are non-intrusive and run seamlessly in the background, safeguarding your data without disrupting your workflow.</li>
        </ul>
        <p class="copyright1">Good luck with the quiz, and see you in the next chapter on adding nodes to your ThingsDB set-up!</p>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-270">
<section>
    <h3 id="quiz-chapter-14" class="title1">14.7 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Which approach is more suitable for safeguarding your ThingsDB data?: backups or exports?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Backups</li>
                <li class="thingsdb13">Exports</li>
                <li class="thingsdb13">Both, depending on the situation</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">For disaster recovery, what is the recommended scope for creating a backup using the <code class="inline">new_backup()</code> function?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">A collection scope, like: <code class="inline">//stuff</code> or <code class="inline">//todos</code></li>
                <li class="thingsdb13">The client connection node scope: <code class="inline">/n</code></li>
                <li class="thingsdb13">ThingsDB scope: <code class="inline">/thingsdb</code></li>
                <li class="thingsdb13">A specific node scope like: <code class="inline">/n/0</code> or <code class="inline">/n/1</code></li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Disaster strikes! You accidentally forget your password and lose access to your ThingsDB instance.
            Thankfully, you have a recent backup. What is the best way to regain access to your data?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Restore the backup without any additional options and hope for the best.</li>
                <li class="thingsdb13">Restore the backup using <code class="inline">restore()</code> and manually grant yourself access to each individual scope.</li>
                <li class="thingsdb13">Restore the backup using <code class="inline">restore()</code> with the <code class="inline">take_access: true</code> property, regaining access to all restored scopes automatically.</li>
                <li class="thingsdb13">There is no way to recover access without knowing the password.</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">How can you verify that your ThingsDB backups are functioning as intended?</p></li>
        <li class="thingsdb13"><p class="copyright1">Consider the behavior of tasks during imports and restores: By default, they are not included. Why do you think this happens, and what are the potential implications?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">To prevent unintended execution and potential data loss.</li>
                <li class="thingsdb13">To reduce the file size of the import or restore.</li>
                <li class="thingsdb13">To allow users to selectively restore or import specific tasks.</li>
                <li class="thingsdb13">Because tasks are not considered part of the core data structure.</li>
            </ol>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-252">
<section>
    <h4 id="answers-chapter-14" class="title2">14.7.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Answer "a" is correct. Backups are your data's safety net. They create complete copies at specific points in time, ensuring you can recover from disasters like hardware failures or accidental deletion. These backups run silently in the background on designated nodes and can be scheduled for automatic execution, safeguarding your data without disrupting your ThingsDB operations.</p>
            <p class="copyright1">Exports on the other hand allow you to extract specific collections or structures for development purposes. This makes them ideal for creating testing environments, sharing data subsets, or migrating data between instances.</p>
        </li>
        <li class="thingsdb13"><p class="copyright1">The correct answer is "d". While both <code class="inline">/n</code> and <code class="inline">/n/0</code> are technically valid scopes for creating a backup, using an explicit node scope like <code class="inline">/n/0</code> is recommended as it explicitly specifies the node on which the backup will be scheduled, eliminating ambiguity and potential confusion.</p></li>
        <li class="thingsdb13"><p class="copyright1">The correct answer is "c". Restore the backup using <code class="inline">restore()</code> with the <code class="inline">take_access: true</code> property. This efficiently restores your data and automatically grants you access to all restored scopes, ensuring a smooth recovery process.</p>
            <p class="copyright1"><em class="thingsdb15">(Once the restore is completed, always <strong class="thingsdb17">re-authenticate</strong> due to possible user ID changes!!)</em></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">The <code class="inline">backups_ok()</code> function provides a convenient boolean answer on backup success,
            but it does not give you the "why" behind failures. For that, you need the <code class="inline">backups_info()</code> function,
            which goes beyond a simple <code class="inline">true</code> / <code class="inline">false</code> by providing a result message, often pinpointing the exact issue or offering clues for troubleshooting.</p></li>
        <li class="thingsdb13"><p class="copyright1">Including tasks in imports or restores can lead to unexpected behavior and potential data manipulation if not carefully considered. If, for example, a task is scheduled for a specific date in the past, restoring it might trigger immediate execution, potentially causing issues with outdated data or unintended consequences. Therefore, answer "a" is correct.</p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-16">
<section type="chapter" role="doc-chapter" aria-labelledby="ch15_h" id="thingsdb_link-320">
    <h2 id="chapter-15" class="thingsdb7">Chapter 15 - Multiple Nodes and Debugging</h2>
    <p class="copyright1">Ready to unleash the full potential of your ThingsDB setup? This chapter dives into two essential topics:</p>
    <p class="copyright1">First, we'll guide you through the process of integrating additional nodes. Next, we'll equip you with
        valuable troubleshooting tools, from identifying bottlenecks to analyzing data flow, ensuring your
        ThingsDB runs smoothly and efficiently.</p>
    <p class="copyright1">Not interested in exploring multiple nodes for development? Feel free to skip the next sections and
        continue at <a href="#chapter-15-3" class="thingsdb14">15.3 - Node Counters</a>.</p>
    <section>
        <h3 id="chapter-15-1" class="title1">15.1 Scaling Up: Adding Nodes</h3>
        <p class="copyright1">In this section, we shall guide you through two options for adding nodes:</p>
        <ul class="thingsdb18">
            <li class="editor"><a href="#chapter-15-1-1" class="thingsdb14">ThingsDB from Source</a>: We'll provide step-by-step instructions for starting a new node in this scenario.</li>
            <li class="editor"><a href="#chapter-15-1-2" class="thingsdb14">Using Docker Compose</a>: If you followed the Docker installation instructions, we'll explain how to add another node using Docker Compose.</li>
        </ul>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1"><strong class="thingsdb17">Real-world deployments:</strong> While this section focuses on testing with multiple nodes
                    on a single machine for development purposes, remember that in production environments, you would
                    typically run each node on a separate machine or leverage a container orchestration platform like
                    Kubernetes.</p>
            </div>
        </div>
        <section>
            <h4 id="chapter-15-1-1" class="title2">15.1.1 ThingsDB from Source</h4>
            <p class="copyright1">Ready to test multiple ThingsDB nodes on a single machine? Let's explore how to achieve this when you
                have built ThingsDB from source.</p>
            <p class="copyright1">Each node requires unique TCP ports and data storage paths. You can configure them through environment
                variables or a configuration file.</p>
            <p class="copyright1"><a href="#thingsdb_link-20" class="thingsdb14">Table 15.1.1</a> summarizes the essential variables for setting up multiple nodes. For a full list of configuration options, refer to the documentation: <a href="https://docs.thingsdb.io/v1/getting-started/configuration/" class="thingsdb14">https://docs.thingsdb.io/v1/getting-started/configuration/</a></p>
            <div class="table">
                <h2 id="thingsdb_link-20" class="thingsdb7"></h2>
                <p class="title3">Table 15.1.1 - Relevant environment variables for multiple nodes</p>
                <table class="thingsdb20">
                    <tr class="thingsdb21"><th class="thingsdb22">Variable</th><th class="thingsdb22">Description</th></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">THINGSDB_LISTEN_CLIENT_PORT</code></td><td class="thingsdb23">Listen to this TCP port for client socket connections.</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">THINGSDB_LISTEN_NODE_PORT</code></td><td class="thingsdb23">Listen to this TCP port for node connections.</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">THINGSDB_HTTP_API_PORT</code></td><td class="thingsdb23">(Optional) Listen to this TCP port for HTTP API requests.</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">THINGSDB_HTTP_STATUS_PORT</code></td><td class="thingsdb23">(Optional) Listen to this TCP port for HTTP status requests.</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">THINGSDB_WS_PORT</code></td><td class="thingsdb23">(Optional) Listen to this TCP port for WebSocket requests.</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">THINGSDB_MODULES_PATH</code></td><td class="thingsdb23">Path where ThingsDB modules are stored.</td></tr>
                    <tr class="thingsdb21"><td class="thingsdb23"><code class="inline">THINGSDB_STORAGE_PATH</code></td><td class="thingsdb23">Location to store ThingsDB data.</td></tr>
                </table>
            </div>
            <p class="copyright1">Create a separate directory: (we use "node1" and consider the first one as "node0")</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">mkdir ~/node1</code></pre>
            <p class="copyright1">Start the node with unique port numbers and data paths:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">THINGSDB_LISTEN_CLIENT_PORT=9201 \
  THINGSDB_LISTEN_NODE_PORT=9221 \
  THINGSDB_HTTP_API_PORT=9211 \
  THINGSDB_HTTP_STATUS_PORT=8081 \
  THINGSDB_WS_PORT=9271 \
  THINGSDB_MODULES_PATH=~/node1/modules \
  THINGSDB_STORAGE_PATH=~/node1/data \
  thingsdb --secret pass</code>
<code class="response">â¦
Waiting for an invite from a node to join ThingsDB...

You can use the following query to add this node:

    new_node('pass', 'mylaptop', 9221);</code></pre>
            <p class="copyright1">With the node waiting for an invite, skip the next section and jump to <a href="#chapter-15-2" class="thingsdb14">15.2 - Invite the New Node</a>.</p>
        </section>
        <section>
            <h4 id="chapter-15-1-2" class="title2">15.1.2 Using Docker Compose</h4>
            <p class="copyright1">In your <code class="inline">docker-compose.yml</code> file, find the "services" section and uncomment (or add) the following configuration for a second node:</p>
<pre class="thingsdb16"><code class="prompt">services:</code>
<code class="user">  node1:
  &lt;&lt; : *ti
  hostname: node1
  container_name: node1
  command: "--secret pass"
  ports:
    - 8081:8080
  volumes:
    - ./node1/data:/data/
    - ./node1/modules:/modules/
    - ./node1/dump:/dump/</code></pre>
            <p class="copyright1">Navigate to the directory containing your <code class="inline">docker-compose.yml</code> file and run:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">docker compose up -d</code>
<code class="response">[+] Running 2/2
 â Container node1  Started
 â Container node0  Running</code></pre>
            <p class="copyright1">Verify the new node is running by checking the container logs:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">docker logs node1</code>
<code class="response">â¦
Waiting for an invite from a node to join ThingsDB...

You can use the following query to add this node:

    new_node('pass', 'node1', 9220);</code></pre>
        </section>
    </section>
    <section>
        <h3 id="chapter-15-2" class="title1">15.2 Invite the New Node</h3>
        <p class="copyright1">Now that your new node is waiting for an invitation (as mentioned in the previous section),
            it is time to officially welcome it to your ThingsDB cluster.</p>
        <p class="copyright1">ThingsDB conveniently provides the invitation command directly in the logs. It typically looks like this:</p>
<pre class="thingsdb16"><code class="response">new_node('pass', 'node1', 9220);</code></pre>
        <p class="copyright1">The <code class="inline">new_node()</code> function takes three arguments:</p>
        <ol class="thingsdb12">
            <li class="thingsdb13"><strong class="thingsdb17">Secret Password:</strong> This is the one-time password you used when starting the node (e.g., <code class="inline">--secret pass</code>). It ensures only authorized nodes can join.</li>
            <li class="thingsdb13"><strong class="thingsdb17">Hostname or IP Address:</strong> Identify the new node by its hostname (e.g., <code class="inline">node1</code>) or IP address if your DNS isn't working perfectly.</li>
            <li class="thingsdb13"><strong class="thingsdb17">Node Port:</strong> This is the port number the new node listens on for communication with other nodes (e.g., <code class="inline">9220</code>) (do not confuse it with the client port).</li>
        </ol>
        <p class="copyright1">Switch to the <code class="inline">/thingsdb</code> scope in your client and paste
            the <code class="inline">new_node(..)</code> command as shown in the logs output.</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">new_node('pass', 'node1', 9220);</code>  <code class="comment">// Replace the arguments if needed</code>
<code class="response">1</code></pre>
        <p class="copyright1">The command will return the ID of the new node.</p>
        <p class="copyright1">Allow approximately 20 seconds for the nodes to synchronize. This time may vary depending on your system load.
            During this process, the first node might be temporarily unavailable as it handles the joining process.</p>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">Only when adding a <strong class="thingsdb17">second node</strong> to your ThingsDB cluster, be aware of a temporary
                    period of unavailability. This is because the existing node needs to perform synchronization to
                    integrate the new node. This process typically takes around 20 seconds and might cause ThingsDB
                    to seem unresponsive during this time.</p>
                <p class="author1">Adding <strong class="thingsdb17">additional nodes</strong> does not experience this unavailability. With more nodes
                    available, the synchronization process is distributed, ensuring continuous operation and request
                    handling.</p>
            </div>
        </div>
        <p class="copyright1">Once the wait is over, switch to a <code class="inline">/node</code> scope and run the <code class="inline">nodes_info()</code>
            function to see information about all nodes.</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">@n</code>
<code class="prompt">(@n)&gt;</code> <code class="user">nodes_info();</code>
<code class="response">â¦</code></pre>
        <p class="copyright1">You should see two nodes with status <code class="inline">"READY"</code>. If one of the nodes is currently
            in <code class="inline">"AWAY"</code> mode, it means ThingsDB has chosen it for a specific task, temporarily
            taking it out of the general cluster operations. This does not indicate an issue, and the node will
            return to <code class="inline">"READY"</code> once its task is completed.</p>
        <p class="copyright1">To scale your ThingsDB cluster, simply repeat the steps outlined in
            sections <a href="#chapter-15-1" class="thingsdb14">15.1</a> and <a href="#chapter-15-2" class="thingsdb14">15.2</a> for each new node.
            Remember to use unique data paths and ports to avoid conflicts.</p>
    </section>
    <section>
        <h3 id="chapter-15-3" class="title1">15.3 Node Counters</h3>
        <p class="copyright1">ThingsDB tracks various counters to provide insights into a node's well-being. These counters start at zero
            on node startup and can be manually reset with the <code class="inline">reset_counters()</code> function.</p>
        <p class="copyright1">Start exploring counters by navigating to a node scope.</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">@ /node/0</code>
<code class="prompt">(/node/0)&gt;</code></pre>
        <p class="copyright1">Run the <code class="inline">counters()</code> function:</p>
<pre class="thingsdb16"><code class="prompt">(/node/0)&gt;</code> <code class="user">counters();</code>
<code class="response">{
    "average_change_duration": 0.0013940499503816795,
    "average_query_duration": 0.0003048990412233053,
    "changes_committed": 5262,
    "changes_failed": 0,
    "changes_killed": 0,
    "changes_skipped": 0,
    "changes_unaligned": 1,
    "changes_with_gap": 0,
    "garbage_collected": 1,
    "largest_result_size": 400999,
    "longest_change_duration": 0.002760923,
    "longest_query_duration": 0.010911413,
    "queries_from_cache": 235,
    "queries_success": 355260,
    "queries_with_error": 1499,
    "quorum_lost": 1,
    "started_at": 1709132982,
    "tasks_success": 0,
    "tasks_with_error": 0,
    "wasted_cache": 4
}</code></pre>
        <p class="copyright1">While it may seem like a lot of information, let's break down the key metrics:</p>
        <ul class="thingsdb18">
            <li class="editor"><strong class="thingsdb17">Performance:</strong>
                <ul class="nested">
                    <li class="editor"><code class="inline">average_change_duration</code>, <code class="inline">average_query_duration</code>: Indicate average processing times for changes and queries (in seconds).</li>
                    <li class="editor"><code class="inline">queries_success</code>: Number of successful queries handled since the last reset.</li>
                </ul>
            </li>
            <li class="editor"><strong class="thingsdb17">Health Indicators:</strong>
                <ul class="nested">
                    <li class="editor"><code class="inline">changes_failed</code>, <code class="inline">changes_killed</code>, <code class="inline">changes_skipped</code>, <code class="inline">changes_with_gap</code>: Must remain at zero as they indicate potential data corruption.</li>
                    <li class="editor"><code class="inline">changes_unaligned</code>, <code class="inline">quorum_lost</code>: Monitor these values. While slight increases are possible, significant growth suggests node collisions during change ID claiming.</li>
                </ul>
            </li>
            <li class="editor"><strong class="thingsdb17">Resource Management:</strong>
                <ul class="nested">
                    <li class="editor"><code class="inline">garbage_collected</code>: Number of items cleaned up by garbage collection.</li>
                    <li class="editor"><code class="inline">queries_from_cache</code>, <code class="inline">wasted_cache</code>: Indicate cache utilization and potential optimization opportunities.</li>
                </ul>
            </li>
        </ul>
        <p class="copyright1">Remember:</p>
        <ul class="thingsdb18">
            <li class="editor"><code class="inline">started_at</code>: Reflects the last counter reset time or node startup time if no reset occurred.</li>
            <li class="editor">Queries and tasks with errors (<code class="inline">queries_with_error</code>, <code class="inline">tasks_with_error</code>)
                are not inherently problematic. Some intentional actions might trigger them (e.g. <code class="inline">lookup_error</code> when
                something is not found etc.).</li>
            <li class="editor">By default, caching applies to queries exceeding 160 characters (adjustable via the environment
                variable <code class="inline">THINGSDB_THRESHOLD_QUERY_CACHE</code>). Queries stay cached
                for 15 minutes (adjustable via <code class="inline">THINGSDB_CACHE_EXPIRATION_TIME</code>).</li>
        </ul>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">In rare cases, data corruption might be indicated by non-zero values in one or more of the
                    critical counters (<code class="inline1">changes_failed</code>, <code class="inline1">changes_killed</code>,
                    <code class="inline1">changes_skipped</code> or <code class="inline1">changes_with_gap</code>).
                    While this is unlikely to occur in typical operation, it is essential to know how to recover
                    from such situations.</p>
                <p class="author1">ThingsDB provides the <code class="inline1">--rebuild</code> command-line argument as a last
                    resort option for recovering a single node. When used, this command will erase the node's
                    local data entirely, ensuring a clean slate and then triggers a full synchronization with
                    the remaining healthy nodes in the cluster, rebuilding its local data based on the latest
                    state from its peers.</p>
            </div>
        </div>
        <p class="copyright1">Analyzing node counters offers valuable insights into your ThingsDB cluster's health and performance.
            Use this information to identify potential issues, optimize resource usage, and ensure your ThingsDB
            setup runs smoothly.</p>
    </section>
    <section>
        <h3 id="chapter-15-4" class="title1">15.4 Diving Deeper with Node Information</h3>
        <p class="copyright1">ThingsDB offers granular control over various aspects of node behavior through configuration options.
            Let's explore how to access and manage these settings.</p>
        <p class="copyright1">Similar to the query cache in the previous section, some options can be adjusted using environment variables.
            It is crucial to <strong class="thingsdb17">maintain consistency</strong> across all nodes. For example,
            if <code class="inline">THINGSDB_RESULT_SIZE_LIMIT</code> differs between nodes, the response size for
            queries might vary depending on the responding node.</p>
        <p class="copyright1">The <code class="inline">node_info()</code> function, introduced in the previous chapter, comes in handy
            for reviewing configuration parameters and ensuring they match across your nodes. It also displays
            the ThingsDB version and its dependent library versions. Aim for consistency in these versions,
            except during controlled upgrades (performed one node at a time).</p>
        <p class="copyright1"><code class="inline">node_info()</code> also exposes the current log level for a node. You can set the
            initial level using the command-line argument <code class="inline">--log-level {debug,info,warning,error,critical}</code> or
            adjust it dynamically. Let's check the current level:</p>
<pre class="thingsdb16"><code class="prompt">(/node/0)&gt;</code> <code class="user">node_info().load().log_level;</code>
<code class="response">"WARNING"</code></pre>
            <p class="copyright1">A default setting should display <code class="inline">"WARNING"</code>.</p>
            <p class="copyright1">Need more detailed insights into your node's activities? ThingsDB allows you to dynamically adjust the log level using the <code class="inline">set_log_level()</code> function.</p>
<pre class="thingsdb16"><code class="prompt">(/node/0)&gt;</code> <code class="user">set_log_level(DEBUG);</code>  <code class="comment">// DEBUG, INFO, WARNING, ERROR, CRITICAL</code>
<code class="response">null</code></pre>
        <div class="note">
            <img class="note1" src="images/idea.png" alt="Note" />
            <div class="content">
                <p class="author1">Command-line arguments for log levels use lowercase (<code class="inline1">debug</code>,
                    <code class="inline1">info</code>, <code class="inline1">warning</code>, <code class="inline1">error</code>,
                    <code class="inline1">critical</code>),
                    while ThingsDB internally defines them in uppercase (<code class="inline1">DEBUG</code>,
                    <code class="inline1">INFO</code>, <code class="inline1">WARNING</code>, <code class="inline1">ERROR</code>,
                    <code class="inline1">CRITICAL</code>).</p>
            </div>
        </div>
        <p class="copyright1">Check the terminal where the node with ID 0 is running (or use "<code class="inline">docker logs node0</code>"" if using Docker Compose).</p>
        <p class="copyright1">Example output:</p>
<pre class="thingsdb16"><code class="prompt">â¦
[D 2024-02-23 21:18:56] not going in away mode (no reason for going into away mode)
[D 2024-02-23 21:18:59] not going in away mode (no reason for going into away mode)</code></pre>
        <p class="copyright1">The <code class="inline">D</code> at the beginning of each line indicates a <code class="inline">DEBUG</code> log message.</p>
        <p class="copyright1">Remember:</p>
        <ul class="thingsdb18">
            <li class="editor">Log levels (<code class="inline">DEBUG</code> and <code class="inline">INFO</code>) provide extensive details but can overwhelm your logs. Use them for troubleshooting or specific insights.</li>
            <li class="editor">Levels (<code class="inline">WARNING</code>, <code class="inline">ERROR</code>, <code class="inline">CRITICAL</code>) offer concise information about potential issues.</li>
            <li class="editor">Choose the log level that best suits your current needs and monitoring goals. Stick with <code class="inline">WARNING</code> for normal operation.</li>
        </ul>
    </section>
    <section>
        <h3 id="chapter-15-5" class="title1">15.5 New Version, Upgrade</h3>
        <p class="copyright1">New ThingsDB versions bring exciting enhancements! Luckily, they're backwards compatible, meaning you can still access
            data from the very first release (v0.7.5).</p>
        <p class="copyright1"><strong class="thingsdb17">Upgrading one at a time:</strong></p>
        <p class="copyright1">For a smooth upgrade, follow a rolling update approach: update one node at a time while ensuring
            full synchronization before moving on to the next. This prevents downtime during the process.</p>
        <p class="copyright1"><strong class="thingsdb17">Monitoring node readiness:</strong></p>
        <p class="copyright1">To easily determine when a node is ready for upgrade, enable HTTP status ports for each node. You can check the current status with:</p>
<pre class="thingsdb16"><code class="prompt">(/node/0)&gt;</code> <code class="user">node_info().load().http_status_port;</code>
<code class="response">8080</code></pre>
        <p class="copyright1">This shows the port number (e.g., <code class="inline">8080</code>) or <code class="inline">"disabled"</code> if not configured.</p>
        <p class="copyright1">To enable it, set the <code class="inline">THINGSDB_HTTP_STATUS_PORT</code> environment
            variable to your desired port (e.g., <code class="inline">8080</code>) and restart the node.</p>
        <section>
            <h4 id="chapter-15-5-1" class="title2">15.5.1 Understanding the HTTP Status Port</h4>
            <p class="copyright1">The enabled port offers three URLs:</p>
            <ul class="thingsdb18">
                <li class="editor"><code class="inline">/ready</code>
                    <p class="quizcode">Responds with <code class="inline">"200 OK"</code> if the node is in <code class="inline">READY</code>, <code class="inline">AWAY</code>, or <code class="inline">AWAY_SOON</code> status, indicating it is ready for the next upgrade. Any other status (e.g., <code class="inline">SYNCHRONIZING</code>) triggers a 503 Service Unavailable response.</p>
                </li>
                <li class="editor"><code class="inline">/status</code>
                    <p class="quizcode">Shows the current node status.</p>
                </li>
                <li class="editor"><code class="inline">/health</code>
                    <p class="quizcode">Always responds with <code class="inline">"200 OK"</code>, regardless of the node's state, indicating the node is responding.</p>
                </li>
            </ul>
        </section>
        <section>
            <h4 id="chapter-15-5-2" class="title2">15.5.2 Using the /ready URL</h4>
            <p class="copyright1">This URL plays a critical role in the cluster coordination process during node startup. It acts as a synchronization checkpoint, ensuring a node is fully operational before subsequent nodes initiate their own restarts.</p>
            <p class="copyright1">Use the <code class="inline">curl</code> command (available on Windows, Mac, and most Linux systems)
                to check the <code class="inline">/ready</code> status from the command line:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">curl http://localhost:8080/ready</code>
<code class="response">OK</code></pre>
            <p class="copyright1">A successful response of <code class="inline">OK</code> confirms that the node has completed its
                synchronization process and is now fully operational. This ensures a stable starting point for
                other nodes and allows them to proceed with their own restart or initialization safely.</p>
        </section>
        <section>
            <h4 id="chapter-15-5-3" class="title2">15.5.3 Liveness and Readiness</h4>
            <p class="copyright1">In the realm of dynamic environments like Kubernetes, where containerized applications are subject
                to frequent restarts and scaling operations, maintaining application health and availability becomes
                a top priority. ThingsDB, with its powerful HTTP status port, and Kubernetes' built-in liveness
                and readiness probes, form a combination to streamline upgrades and guarantee application
                responsiveness throughout the process.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-15-6" class="title1">15.6 Data Related Debugging</h3>
        <p class="copyright1">While this chapter primarily explores node-related functionalities, ThingsDB also offers valuable
            tools for data debugging.</p>
        <section>
            <h4 id="chapter-15-6-1" class="title2">15.6.1 Checking References</h4>
            <p class="copyright1">In ThingsDB, everything is treated as an object. The <code class="inline">refs()</code> function
                helps you determine the number of references an object has within the database. This information
                can be crucial for understanding how data is stored and manipulated.</p>
            <p class="copyright1">For example, check the references for <code class="inline">nil</code>:</p>
<pre class="thingsdb16"><code class="prompt">(/t)&gt;</code> <code class="user">refs(nil);</code>
<code class="response">23</code></pre>
            <p class="copyright1">While 23 references for <code class="inline">nil</code> might seem unexpected, this reflects
                internal system references and the nature of immutable objects. Unlike mutable data,
                immutable objects like <code class="inline">nil</code>, <code class="inline">true</code>,
                <code class="inline">false</code>, strings, and numbers can be shared across scopes without
                creating copies, potentially contributing to the reference count.</p>
            <p class="copyright1">This example demonstrates how <code class="inline">refs()</code> can help verify list copying behavior:</p>
<pre class="thingsdb16"><code class="prompt">(/t)&gt;</code> <code class="user">A = []; B = A; refs(A);</code>
<code class="response">3</code></pre>
            <p class="copyright1">Here, we see three references:</p>
            <ul class="thingsdb18">
                <li class="editor">One for the original list <code class="inline">A</code>.</li>
                <li class="editor">One for the reference held by variable <code class="inline">B</code>.</li>
                <li class="editor">One temporary reference introduced by the <code class="inline">refs()</code> function.</li>
            </ul>
            <p class="copyright1">When interpreting <code class="inline">refs()</code> results, remember to account for the additional
                reference introduced by the function itself.</p>
<pre class="thingsdb16"><code class="prompt">(/t)&gt;</code> <code class="user">A = []; B = [A]; refs(A);</code>
<code class="response">2</code></pre>
            <p class="copyright1">This output (2 references) confirms that adding a list to another list creates a copy.
                The original list <code class="inline">A</code> only has two references:</p>
            <ul class="thingsdb18">
                <li class="editor">One for itself, <code class="inline">A</code>.</li>
                <li class="editor">One from the <code class="inline">refs()</code> function call.</li>
            </ul>
            <p class="copyright1">The list within <code class="inline">B</code> is a separate copy and does not hold a reference to
                the original <code class="inline">A</code>.</p>
        </section>
        <section>
            <h4 id="chapter-15-6-2" class="title2">15.6.2 Finding Things</h4>
            <p class="copyright1">The <code class="inline">search()</code> method, available on all <em class="thingsdb15">"thing"</em> instances,
                offers a valuable tool for debugging purposes. It enables you to search for a specific <em class="thingsdb15">"thing"</em>
                within their properties.</p>
            <p class="copyright1">The <code class="inline">search()</code> method accepts two arguments:</p>
            <ol class="thingsdb12">
                <li class="thingsdb13">The "thing" you are searching for.</li>
                <li class="thingsdb13">An optional thing with configuration settings:
                    <ul class="thingsdb18">
                        <li class="thingsdb13"><code class="inline">deep</code>: Controls the maximum depth of the search (defaults to 1).</li>
                        <li class="thingsdb13"><code class="inline">limit</code>: Restricts the number of returned results (defaults to 1).</li>
                    </ul>
                </li>
            </ol>
            <p class="copyright1">Imagine you have a <code class="inline">Todo</code> object with ID 2 in the <code class="inline">//todos</code> scope but
                are unsure of its location within the collection. Here's how to use <code class="inline">search()</code> to
                locate it:</p>
<pre class="thingsdb16"><code class="prompt">(/t)&gt;</code> <code class="user">@ //todos</code>
<code class="prompt">(//todos)&gt;</code> <code class="user">.search(Todo(2), {deep: 3, limit: 1});</code>
<code class="response">[
    {
        "key": "todos",
        "key_type": "set",
        "parent": {"#": 10},
        "parent_type": "User"
    }
]</code></pre>
            <p class="copyright1">This output indicates that the first occurrence of the <code class="inline">Todo</code> with ID 2 is
                found within the <code class="inline">todos</code> property of a <code class="inline">User</code> object
                with ID 10.</p>
            <p class="copyright1">While <code class="inline">search()</code> is valuable for debugging, its potential performance
                impact makes it unsuitable for most production queries. Exercise caution when increasing the
                deep argument, as higher values can significantly slow down the search process.</p>
        </section>
        <section>
            <h4 id="chapter-15-6-3" class="title2">15.6.3 Profiling Code Performance</h4>
            <p class="copyright1">Optimize your ThingsDB queries and identify potential bottlenecks with
                the <code class="inline">timeit()</code> function. This handy tool measures the
                execution time of code blocks, providing valuable insights for performance tuning.</p>
            <p class="copyright1">To use it, simply enclose the code you want to evaluate within the <code class="inline">timeit()</code>
                function. Once executed, <code class="inline">timeit()</code> returns a new object containing
                two key properties:</p>
            <ul class="thingsdb18">
                <li class="editor"><code class="inline">data</code>: This property stores the result of the executed code itself.</li>
                <li class="editor"><code class="inline">time</code>: This property records the execution time in seconds, providing valuable insights into the performance of your code.</li>
            </ul>
            <p class="copyright1">Let's explore how to use <code class="inline">timeit()</code> to compare the performance of two
                approaches for calculating the sum of a large list.</p>
            <p class="copyright1">Using <code class="inline">reduce()</code>:</p>
<pre class="thingsdb16"><code class="prompt">(/t)&gt;</code> <code class="user">r = range(50000); timeit({
    r.reduce(|t, x| t += x, 0);
});</code>
<code class="response">{
    "data": 1249975000,
    "time": 0.009375523
}</code></pre>
            <p class="copyright1">Using the built-in <code class="inline">sum()</code>:</p>
<pre class="thingsdb16"><code class="prompt">(/t)&gt;</code> <code class="user">r = range(50000); timeit({
    r.sum();
});</code>
<code class="response">{
    "data": 1249975000,
    "time": 0.000410818
}</code></pre>
            <p class="copyright1">The results clearly demonstrate that the native <code class="inline">sum()</code> method is
                significantly faster than the <code class="inline">reduce()</code> approach in this case.
                The function <code class="inline">timeit()</code> empowers you to make decisions about query
                optimization, enhancing the overall performance of your ThingsDB applications.</p>
        </section>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-244">
<section>
    <h3 id="quiz-chapter-15" class="title1">15.7 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">When adding a new node to a ThingsDB cluster, under what circumstances and for what reason might you need to wait before proceeding with further actions?</p></li>
        <li class="thingsdb13"><p class="copyright1">Which command-line argument is only required once when starting a new node to enable it to join an existing ThingsDB cluster?</p></li>
        <li class="thingsdb13"><p class="copyright1">In a multi-node ThingsDB setup, which of the following practices are considered essential for ensuring optimal performance and stability?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Use the same ThingsDB version across all nodes.</li>
                <li class="thingsdb13">Ensure consistent library versions across all nodes.</li>
                <li class="thingsdb13">Maintain identical configuration settings for options that control query behavior (e.g., <code class="inline">THINGSDB_RESULT_SIZE_LIMIT</code>).</li>
                <li class="thingsdb13">Regularly monitor counter metrics using the <code class="inline">counters()</code> method on each node to assess cluster health.</li>
                <li class="thingsdb13">All of the above.</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Which methods allow you to modify the log level of a ThingsDB node, enabling you to control the verbosity of its output?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">--log-level</code> command-line argument.</li>
                <li class="thingsdb13"><code class="inline">set_log_level()</code> function within the node scope.</li>
                <li class="thingsdb13">Both of the above methods.</li>
                <li class="thingsdb13">Controlling the log level is not possible.</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">You're planning to implement liveness and readiness probes for ThingsDB nodes, but
            the <code class="inline">node_info().load().http_status_port;</code> command
            returns <code class="inline">"disabled"</code>, signaling a crucial feature is not yet active.
            What specific steps must be taken to successfully enable the HTTP status port for these nodes,
            allowing for effective health checks?</p></li>
        <li class="thingsdb13"><p class="copyright1">Predict the reference count and explain the reasoning behind your answer for the following code snippet:</p>
            <p class="quizcode"><code class="inline">t = {};</code></p>
            <p class="quizcode"><code class="inline">refs(t);  // ???</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Consider a multi-node setup. You set a property <code class="inline">.x</code> in one query and then immediately try to read its value in a subsequent query. However, you do not get the expected result. Why might this occur?</p></li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-264">
<section>
    <h4 id="answers-chapter-15" class="title2">15.7.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Waiting, for about 20 seconds, depending on the size and performance, is only essential for the second node as it synchronizes from the first. Subsequent nodes can leverage any existing node, allowing the cluster to remain responsive to queries during the process.</p></li>
        <li class="thingsdb13"><p class="copyright1">Joining a new ThingsDB node to an existing cluster requires the <code class="inline">--secret &lt;SECRET&gt;</code> argument only once during initial node startup. This secret tells the node to wait for an invite and serves as a security measure as it prevents unauthorized nodes from joining by requiring the same secret within the <code class="inline">new_node()</code> function.</p></li>
        <li class="thingsdb13"><p class="copyright1">The answer is "e", all of the above. By adhering to these best practices, you can create a robust and reliable multi-node ThingsDB environment that delivers consistent performance and efficient data management.</p></li>
        <li class="thingsdb13"><p class="copyright1">Answer "c". ThingsDB provides two methods to modify the log level. The <code class="inline">--log-level</code> command-line argument sets the initial log level when starting the node and the <code class="inline">set_log_level()</code> function in the node scope dynamically adjusts the log level during runtime.</p></li>
        <li class="thingsdb13"><p class="copyright1">To enable the HTTP status port in ThingsDB, set the <code class="inline">THINGSDB_HTTP_STATUS_PORT</code>
            environment variable and restart the node. (e.g. <code class="inline">THINGSDB_HTTP_STATUS_PORT=8080</code>).
            While less common, ThingsDB also allows you to configure the HTTP status port within a configuration file.
            Refer to the official documentation for more information: <a href="https://docs.thingsdb.io/v1/getting-started/configuration/" class="thingsdb14">https://docs.thingsdb.io/v1/getting-started/configuration/</a></p></li>
        <li class="thingsdb13"><p class="copyright1">The reference count is 2. Both <code class="inline">t</code> and the <code class="inline">refs()</code> function hold a reference, leading to a total of 2.</p></li>
        <li class="thingsdb13"><p class="copyright1">Your second query might hit a node that has not yet received the update to property <code class="inline">.x</code>, leading to the unexpected result.</p>
            <p class="copyright1">There are two main solutions to address this:</p>
            <ul class="thingsdb18">
                <li class="thingsdb13">Combine read and write in a single query: This ensures both operations happen on the same node, guaranteeing you read the latest value of <code class="inline">.x</code>.</li>
                <li class="thingsdb13">Enforce write ordering with <code class="inline">wse()</code>: If combining read and write is not an option, you can use the <code class="inline">wse()</code> function. This enforces a <em class="thingsdb15">change</em>, effectively forcing subsequent queries to wait for the change to propagate before responding. This guarantees eventual consistency but can introduce a slight performance overhead.</li>
            </ul>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-38">
<section type="chapter" role="doc-chapter" aria-labelledby="ch16_h" id="thingsdb_link-321">
    <h2 id="chapter-16" class="thingsdb7">Chapter 16: Unleashing the Power of the HTTP API</h2>
    <p class="copyright1">In this final chapter, we delve into the realm of ThingsDB's HTTP API, a valuable tool that empowers you to interact with your data beyond the ThingsDB client.</p>
    <div class="note">
        <img class="note1" src="images/idea.png" alt="Note" />
        <div class="content">
            <p class="author1">This chapter assumes you have already created the "todos" collection. If you have not, or need a fresh copy,
                <a href="#appendix-i" class="thingsdb14">Appendix I - Chapter Data Import</a> provides instructions on importing the collection data.</p>
        </div>
    </div>
    <p class="copyright1"><strong class="thingsdb17">Why a HTTP API?</strong></p>
    <p class="copyright1">The HTTP API offers several compelling advantages:</p>
    <ul class="thingsdb18">
        <li class="editor"><strong class="thingsdb17">Convenience:</strong> It provides a simple and familiar interface for interacting with ThingsDB, especially when the client is unavailable for your programming language.</li>
        <li class="editor"><strong class="thingsdb17">Flexibility:</strong> It facilitates seamless integration with various tools and services, such as webhooks, external applications, and custom scripts, extending the reach of your data manipulation capabilities.</li>
    </ul>
    <section>
        <h3 id="chapter-16-1" class="title1">16.1 Enabling the API</h3>
        <p class="copyright1">By default, the HTTP API is disabled for security reasons. To activate it, you need to configure the API port using the <code class="inline">THINGSDB_HTTP_API_PORT</code> environment variable:</p>
        <ul class="thingsdb18">
            <li class="editor"><strong class="thingsdb17">Docker Compose:</strong> If you are using Docker Compose, this variable is already included in the provided <code class="inline">docker-compose.yml</code> file.</li>
            <li class="editor"><strong class="thingsdb17">Manual Startup:</strong> For manual node startup, set the environment variable before launching the node process.</li>
        </ul>
        <p class="copyright1">Once configured, you can verify if the API is enabled and determine its listening port using the following command within the node scope:</p>
<pre class="thingsdb16"><code class="prompt">(/node/0)&gt;</code> <code class="user">node_info().load().http_api_port;</code>
<code class="response">9210</code></pre>
        <p class="copyright1">Remember, the API needs to be enabled individually on each node. You can either check each
            node or target the specific node you intend to interact with.</p>
        <p class="copyright1">With the API up and running, the next sections will equip you with the knowledge to harness
            its full potential. We'll explore various API endpoints, authentication mechanisms,
            and practical use cases, empowering you to unlock new possibilities for managing and
            interacting with your ThingsDB data.</p>
    </section>
    <section>
        <h3 id="chapter-16-2" class="title1">16.2 Exploring Your First API Call</h3>
        <p class="copyright1">Authorization is crucial for safeguarding your ThingsDB data. This section delves into basic
            authentication using a username and password.</p>
        <p class="copyright1">Let's leverage curl to execute our first API call, utilizing the default credentials <code class="inline">admin</code> and <code class="inline">pass</code>:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">curl --location --request POST 'http://localhost:9210//todos' \
--header 'Content-Type: application/json' \
--user admin:pass \
--data-raw '{
    "type": "query",
    "code": "a * b;",
    "vars": {"a": 6, "b": 7}
}'</code>
<code class="response">42</code></pre>
        <p class="copyright1">Breaking down the steps:</p>
        <ol class="thingsdb12">
            <li class="thingsdb13"><strong class="thingsdb17">Endpoint:</strong> <code class="inline">http://localhost:9210//todos</code>
                <p class="quizcode">This specifies the target endpoint for our API call. The //todos part is the scope. You can also use the full scope name /collection/todos in case you do not like the two slashes.</p>
            </li>
            <li class="thingsdb13"><strong class="thingsdb17">Method:</strong> <code class="inline">POST</code>
                <p class="quizcode">This indicates that we are sending data to the server.</p>
            </li>
            <li class="thingsdb13"><strong class="thingsdb17">Content-Type:</strong> <code class="inline">application/json</code>
                <p class="quizcode">This informs the server that we are sending JSON data.</p>
            </li>
            <li class="thingsdb13"><strong class="thingsdb17">Authentication:</strong> <code class="inline">--user admin:pass</code>
                <p class="quizcode">This provides the username and password for basic authentication.</p>
            </li>
            <li class="thingsdb13"><strong class="thingsdb17">Data:</strong> <code class="inline">--data-raw</code>
                <p class="quizcode">This specifies the raw JSON data containing the query information.</p>
            </li>
            <li class="thingsdb13"><strong class="thingsdb17">JSON data:</strong>
                <p class="quizcode">The request body containing the query details:</p>
                <ol class="thingsdb24">
                    <li class="thingsdb13"><code class="inline">"type": "query"</code>: Specifies the request type as a query.</li>
                    <li class="thingsdb13"><code class="inline">"code": "a * b;"</code>: Defines the query code to be executed.</li>
                    <li class="thingsdb13"><code class="inline">"vars": {"a": 6, "b": 7}</code>: Provides variables used within the query code.</li>
                </ol>
            </li>
        </ol>
        <section>
            <h4 id="chapter-16-2-1" class="title2">16.2.1 Securing Admin Credentials</h4>
            <p class="copyright1">The previous example highlights the crucial importance of implementing secure
                authentication practices in production environments. Here are two recommended approaches:</p>
            <p class="copyright1"><strong class="thingsdb17">Change default credentials</strong></p>
            <p class="copyright1">Replace the default username and password for the administrator account with strong,
                unique credentials. This prevents unauthorized access using well-known default values.</p>
            <p class="copyright1"><strong class="thingsdb17">Token-based authentication</strong></p>
            <p class="copyright1">Create a token for the admin account and remove its password entirely:</p>
<pre class="thingsdb16"><code class="prompt">(/t)&gt;</code> <code class="user">token = new_token("admin");
set_password("admin", nil);</code>  <code class="comment">// Remove the password</code>
<code class="user">token;</code>  <code class="comment">// Return the new token</code>
<code class="response">"7vXo2vgtnyaWsQ1LKw9CkI"</code></pre>
            <p class="copyright1">Carefully safeguard the generated token. <strong class="thingsdb17">Losing the token means losing access to the admin account</strong>, as there is no password to fall back on.</p>
        </section>
        <section>
            <h4 id="chapter-16-2-2" class="title2">16.2.2 Token Authentication</h4>
            <p class="copyright1">Before we continue exploring API calls, let's create a new user account and grant it some
                basic permissions for exploration. While we could utilize the API itself for this process,
                we'll demonstrate using the <code class="inline">things-prompt</code>:</p>
<pre class="thingsdb16"><code class="prompt">(/t)&gt;</code> <code class="comment">// Use the /thingsdb scope</code>
<code class="comment">// Create the user "web"</code>
<code class="user">user = new_user("web");</code>

<code class="comment">// Grant access to the specified scopes</code>
<code class="user">grant("/node", user, QUERY);</code>
<code class="user">grant("/thingsdb", user, QUERY);</code>
<code class="user">grant("//todos", user, QUERY | RUN);</code>

<code class="comment">// Generate a new token for user "web"</code>
<code class="user">new_token(user);</code>
<code class="response">"qOeH6Mny1jLgc6WRGujk5x"</code></pre>
            <p class="copyright1">With the generated token, we can now perform queries through the API:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">curl --location --request POST 'http://localhost:9210/node/0' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer qOeH6Mny1jLgc6WRGujk5x' \
--data-raw '{
    "type": "query",
    "code": "node_info().load().version;"
}'</code>
<code class="response">"1.6.0"</code></pre>
            <p class="copyright1">As you can see, the response <code class="inline">"1.6.0"</code> confirms the successful
                execution of the query through the API using the generated token and specified user
                permissions. Notice the scope (<code class="inline">/node/0</code>) specified in the URL,
                effectively targeting the node with ID 0. We also replaced
                the <code class="inline">--user</code> argument which we previously used for username and
                password authentication, with an <code class="inline">Authorization</code> header containing
                the <code class="inline">Bearer</code> prefix and the generated token.</p>
        </section>
    </section>
    <section>
        <h3 id="chapter-16-3" class="title1">16.3 Running Procedures with the API</h3>
        <p class="copyright1">The ThingsDB API extends beyond queries and allows you to execute procedures as well.</p>
        <p class="copyright1">Invoking procedures:</p>
        <ol class="thingsdb12">
            <li class="thingsdb13">In the JSON data body, ensure the <code class="inline">"type"</code> field is set to <code class="inline">"run"</code> to indicate procedure execution.</li>
            <li class="thingsdb13">Include a <code class="inline">"name"</code> field within the data body, specifying the name of the procedure you wish to call. This name corresponds to the procedure defined within the scope provided in the URL.</li>
            <li class="thingsdb13">If the procedure requires arguments, include an <code class="inline">"args"</code> field. This field can be formatted in two ways:
                <ul class="thingsdb18">
                    <li class="thingsdb13">Positional arguments (array): Represent arguments as an array, with each element corresponding to the expected argument order in the procedure definition.</li>
                    <li class="thingsdb13">Key-value pairs (object): Employ an object to explicitly define arguments by their respective names. Each key-value pair associates a name with its corresponding argument value.</li>
                </ul>
            </li>
        </ol>
        <p class="copyright1">Let's revisit the previously created <code class="inline">search_todos</code> procedure within the <code class="inline">//todos</code> scope. Here's how to execute it with positional arguments using <code class="inline">curl</code>:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">curl --location --request POST 'http://localhost:9210//todos' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer qOeH6Mny1jLgc6WRGujk5x' \
--data-raw '{
    "type": "run",
    "name": "search_todos",
    "args": ["book"]
}'</code>
<code class="response">[{"id":2,"body":"Read a book","user":{"name":"Alice"},"severity":"Medium","done":true}]</code></pre>
        <p class="copyright1">Here's an alternative way to call the same procedure using key-value arguments:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">curl --location --request POST 'http://localhost:9210//todos' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer qOeH6Mny1jLgc6WRGujk5x' \
--data-raw '{
    "type": "run",
    "name": "search_todos",
    "args": {"needle": "teeth"}
}'</code>
<code class="response">[{"id":3,"body":"Brush your teeth","user":{"name":"Alice"},"severity":"Medium","done":false}]</code></pre>
        <p class="copyright1">By understanding these concepts, you can effectively invoke procedures through the ThingsDB API to execute various functionalities within your applications.</p>
    </section>
    <section>
        <h3 id="chapter-16-4" class="title1">16.4 MessagePack vs JSON for the API</h3>
        <p class="copyright1">While JSON is the most common data format used with the ThingsDB API, it has limitations
            when handling binary data. Attempting to send binary data directly within a JSON request
            will result in an error, as demonstrated in the following example:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">curl --location --request POST 'http://localhost:9210/thingsdb' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer qOeH6Mny1jLgc6WRGujk5x' \
--data-raw '{
    "type": "query",
    "code": "bytes(\"Not supported by JSON\");"
}'</code>
<code class="response">type `bytes` is not JSON serializable (-61)</code></pre>
        <p class="copyright1">One approach to solve this issue involves <strong class="thingsdb17">base64 encoding</strong> the binary
            data before including it in a JSON request. However, this adds an extra step of encoding and decoding, potentially impacting performance and code readability. The following example demonstrates this approach using the <code class="inline">base64_encode()</code> function:</p>
<pre class="thingsdb16"><code class="prompt">$</code> <code class="user">curl --location --request POST 'http://localhost:9210/thingsdb' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer qOeH6Mny1jLgc6WRGujk5x' \
--data-raw '{
    "type": "query",
    "code": "base64_encode(bytes(\"Conversion works!\"));"
}'</code>
<code class="response">"Q29udmVyc2lvbiB3b3JrcyE="</code></pre>
        <p class="copyright1">ThingsDB offers <strong class="thingsdb17">MessagePack</strong> as a more efficient alternative. It is
            specifically designed for binary data exchange and provides a more compact and efficient
            way to transmit information compared to JSON.</p>
        <p class="copyright1">While directly utilizing MessagePack with <code class="inline">curl</code> might involve additional tools, here's a
            simple Python example showcasing its usage:</p>
<pre class="thingsdb16"><code class="prompt">import requests
import msgpack</code>

<code class="comment"># Prepare data in MessagePack format</code>
<code class="prompt">data = msgpack.packb({
    "type": "query",
    "code": "bytes('Works without conversion!');"
})</code>
<code class="comment"># Send request with appropriate headers</code>
<code class="prompt">response = requests.post('http://localhost:9210//todos', data, headers={
    "Content-Type": "application/msgpack",
    "Authorization": "Bearer qOeH6Mny1jLgc6WRGujk5x"
})</code>
<code class="comment"># Unpack response and print the result</code>
<code class="prompt">result = msgpack.unpackb(response.content)
print(result)</code>  <code class="comment"># Prints: b'Works without conversion!'</code></pre>
        <p class="copyright1">For most situations, JSON remains the preferred choice due to its widespread adoption
            and ease of use. However, for performance-critical scenarios with substantial binary
            data exchange, consider MessagePack. Being ThingsDB's internal format, data is already
            optimized for MessagePack, minimizing the need for conversions compared to using JSON.</p>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-265">
<section>
    <h3 id="quiz-chapter-16" class="title1">16.5 Quiz - Challenge Your Understanding</h3>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Which of the following security practices are NOT recommended for securing a ThingsDB production environment?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Rename the admin user and change the password.</li>
                <li class="thingsdb13">Remove the admin password and switch to token authentication.</li>
                <li class="thingsdb13">Use dedicated accounts with limited privileges for specific tasks.</li>
                <li class="thingsdb13">Leave the default admin account credentials unchanged.</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">ThingsDB is working on my computer but I cannot connect to the HTTP API. The error
            message states <em class="thingsdb15">"Failed to connect to localhost port 9210"</em>. Which of the following
            is most likely the reason?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">The account does not have the appropriate access rights.</li>
                <li class="thingsdb13">The API request is invalid.</li>
                <li class="thingsdb13">The API is not enabled on port 9210.</li>
                <li class="thingsdb13">Connecting to the API on localhost is not possible.</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">Which of the following URLs are valid to perform a query in the "foo" collection?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13"><code class="inline">http://thingsdb/foo</code></li>
                <li class="thingsdb13"><code class="inline">http://thingsdb/collection/foo</code></li>
                <li class="thingsdb13"><code class="inline">http://thingsdb//foo</code></li>
                <li class="thingsdb13"><code class="inline">http://thingsdb/foo/collection</code></li>
                <li class="thingsdb13">The collection must be provided with the body, not the URL.</li>
            </ol>
        </li>
        <li class="thingsdb13"><p class="copyright1">The procedure <code class="inline">get_score</code> exists in the <code class="inline">//game</code> scope and accepts a <code class="inline">user_id</code> as argument. Fix the
            following API request to retrieve the score for a user with ID 123:</p>
            <p class="quizcode"><code class="inline">GET http://thingsdb//game</code></p>
            <p class="quizcode"><code class="inline">{</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;"type": "procedure",</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;"name": "get_score",</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;"args": [{"user_id": 123}]</code></p>
            <p class="quizcode"><code class="inline">}</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Which of the following Media Types are supported by the ThingsDB HTTP API for data exchange?</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">application/json</li>
                <li class="thingsdb13">application/xml</li>
                <li class="thingsdb13">text/csv</li>
                <li class="thingsdb13">application/msgpack</li>
            </ol>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-248">
<section>
    <h4 id="answers-chapter-16" class="title2">16.5.1 Quiz - Answers</h4>
    <ol class="thingsdb12">
        <li class="thingsdb13"><p class="copyright1">Option "d", "leave the default admin account credentials unchanged" is the least secure practice among the choices. Using the default credentials increases the risk of unauthorized access, as they are widely known and easily guessable.</p></li>
        <li class="thingsdb13"><p class="copyright1">Answer "c". The most likely reason is that the API is not enabled on port 9210.</p>
            <p class="copyright1">Use the <code class="inline">node_info().load().http_api_port;</code> query in the node scope to confirm the currently configured port for the HTTP API.</p>
            <p class="copyright1">If the API is disabled or the desired port is not 9210, start ThingsDB with the environment
            variable <code class="inline">THINGSDB_HTTP_API_PORT=9210</code>. This will enable the API on port 9210.</p></li>
        <li class="thingsdb13"><p class="copyright1">Both "b" (<code class="inline">../collection/foo</code>) and "c" (<code class="inline">..//foo</code>) are valid options, as ThingsDB allows shortening the 'collection' term in the URL.</p></li>
        <li class="thingsdb13"><p class="copyright1">Fix the request:</p>
            <ol class="thingsdb19">
                <li class="thingsdb13">Change method to <code class="inline">POST</code>.</li>
                <li class="thingsdb13">Set type to <code class="inline">"run"</code> (indicating a procedure call).</li>
                <li class="thingsdb13">Use either:
                    <ol class="thingsdb25">
                        <li class="thingsdb13">Positional args (e.g., <code class="inline">[123]</code>).</li>
                        <li class="thingsdb13">Keywords (e.g., <code class="inline">{"user_id": 123}</code>).</li>
                    </ol>
                </li>
            </ol>
            <p class="copyright1">Here's the corrected request:</p>
            <p class="quizcode"><code class="inline">POST http://thingsdb//game</code></p>
            <p class="quizcode"><code class="inline">{</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;"type": "run",</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;"name": "get_score",</code></p>
            <p class="quizcode"><code class="inline">&nbsp;&nbsp;"args": {"user_id": 123}&nbsp;&nbsp;&nbsp;&nbsp;// or [123]</code></p>
            <p class="quizcode"><code class="inline">}</code></p>
        </li>
        <li class="thingsdb13"><p class="copyright1">Both "a" and "d". The supported Media Types for the HTTP API are:</p>
            <ul class="thingsdb18">
                <li class="thingsdb13">application/json</li>
                <li class="thingsdb13">application/msgpack</li>
            </ul>
            <p class="copyright1">Both JSON and MessagePack are efficient formats for transmitting data over the API.
                While JSON is the most commonly used option due to its widespread adoption, MessagePack offers advantages in terms of compactness and efficiency, especially when dealing with binary data.</p>
        </li>
    </ol>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-240">
		<section type="closing-note" role="doc-closing-note" id="thingsdb_link-322">
			<h2 id="closing-note" class="thingsdb7">Closing Note</h2>
			<p class="copyright1">This exploration of <em class="thingsdb15">"Data as Code"</em> has brought you on a journey through the heart of ThingsDB.
				You've learned how this innovative platform allows you to seamlessly combine data and code, empowering
				you to craft powerful, flexible, secure and scalable applications.</p>
			<p class="copyright1">As you venture beyond this book, remember that ThingsDB is an actively evolving platform. Stay connected
				with ThingsDB's community and evolving features! Explore the official documentation, engage in discussions
				on the forum (<a href="https://github.com/orgs/thingsdb/discussions" class="thingsdb14">https://github.com/orgs/thingsdb/discussions</a>),
				and discover the latest best practices to keep your ThingsDB knowledge sharp.</p>
			<p class="copyright1">We are confident that you, armed with the knowledge from this book and the power of ThingsDB,
				will embark on a journey of data-driven innovation, shaping the future of information management and
				application development.</p>
		</section>
	</div>


<div class="thingsdb3" id="thingsdb_link-256">
<section type="appendix" role="doc-appendix" aria-labelledby="ap01_h" id="thingsdb_link-323">
    <h2 id="appendix-i" class="thingsdb7">Appendix I - Chapter Data Import</h2>
    <p class="copyright1">This appendix helps you jump into Chapters 7-13 of this book, which build on a
        to-do application using the "todos" collection. Whether you want to start a specific
        chapter or just explore the application with pre-populated data, follow these steps:</p>
    <p class="copyright1">Switch to the <code class="inline">/thingsdb</code> Scope (using <code class="inline">@t</code>)
        and install the <code class="inline">"requests"</code> module <em class="thingsdb15">(if not already done)</em>:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">new_module("requests", "github.com/thingsdb/module-go-requests");</code>
<code class="response">null</code></pre>
    <p class="copyright1">Create a new collection (replace <code class="inline">"todos"</code> if you prefer another name):</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">new_collection("todos");</code>
<code class="response">"todos"</code></pre>
    <p class="copyright1">Switch to the newly created collection scope:</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="user">@ //todos</code>
<code class="prompt">(//todos)&gt;</code></pre>
    <p class="copyright1">Choose your starting chapter (<code class="inline">7</code>, <code class="inline">8</code>,
        <code class="inline">9</code>, <code class="inline">10</code>, <code class="inline">11</code>,
        <code class="inline">12</code>, or <code class="inline">13</code>):</p>
<pre class="thingsdb16"><code class="prompt">(@t)&gt;</code> <code class="comment">// Replace chapter9 with desired chapter number (7-13):</code>
<code class="user">requests.get("https://docs.thingsdb.io/v1/book/chapter9.mp").then(|res| {
    data = res.load().body;
    import(data);
});</code>
<code class="response">null</code></pre>
    <p class="copyright1"><strong class="thingsdb17">Ready to Go!</strong></p>
    <p class="copyright1">With these steps, you've imported the chapter data and can start exploring the "todos" application from your chosen point.</p>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-9">
<section type="appendix" role="doc-appendix" aria-labelledby="ap02_h" id="thingsdb_link-324">
    <h2 id="appendix-ii" class="thingsdb7">Appendix II - Useful Links for ThingsDB</h2>
    <section>
        <h3 id="general-information" class="title1">General information</h3>
        <ul class="thingsdb18">
            <li class="editor"><p class="quizcode">ThingsDB Website</p><p class="quizcode"><a href="https://thingsdb.io" class="thingsdb14">https://thingsdb.io</a></p></li>
            <li class="editor"><p class="quizcode">ThingsDB Source Code</p><p class="quizcode"><a href="https://github.com/thingsdb" class="thingsdb14">https://github.com/thingsdb</a></p></li>
            <li class="editor"><p class="quizcode">ThingsDB Documentation</p><p class="quizcode"><a href="https://docs.thingsdb.io" class="thingsdb14">https://docs.thingsdb.io</a></p></li>
            <li class="editor"><p class="quizcode">ThingsDB Discussion Forum</p><p class="quizcode"><a href="https://github.com/orgs/thingsdb/discussions" class="thingsdb14">https://github.com/orgs/thingsdb/discussions</a></p></li>
        </ul>
    </section>
    <section>
        <h3 id="applications" class="title1">Applications</h3>
        <ul class="thingsdb18">
            <li class="editor"><p class="quizcode">ThingsGUI Application</p><p class="quizcode"><a href="https://github.com/thingsdb/ThingsGUI" class="thingsdb14">https://github.com/thingsdb/ThingsGUI</a></p></li>
            <li class="editor"><p class="quizcode">ThingsPrompt Toolkit</p><p class="quizcode"><a href="https://github.com/thingsdb/ThingsPrompt" class="thingsdb14">https://github.com/thingsdb/ThingsPrompt</a></p></li>
        </ul>
    </section>
    <section>
        <h3 id="connectors" class="title1">Connectors</h3>
        <ul class="thingsdb18">
            <li class="editor"><p class="quizcode">Python Connector</p><p class="quizcode"><a href="https://github.com/thingsdb/python-thingsdb" class="thingsdb14">https://github.com/thingsdb/python-thingsdb</a></p></li>
            <li class="editor"><p class="quizcode">Go Connector</p><p class="quizcode"><a href="https://github.com/thingsdb/go-thingsdb" class="thingsdb14">https://github.com/thingsdb/go-thingsdb</a></p></li>
            <li class="editor"><p class="quizcode">C# Connector</p><p class="quizcode"><a href="https://github.com/thingsdb/ThingsDB-CSharp" class="thingsdb14">https://github.com/thingsdb/ThingsDB-CSharp</a></p></li>
            <li class="editor"><p class="quizcode">PHP Connector</p><p class="quizcode"><a href="https://github.com/stefanak-michal/thingsdb-php" class="thingsdb14">https://github.com/stefanak-michal/thingsdb-php</a></p></li>
            <li class="editor"><p class="quizcode">JavaScript/Node.js Connector</p><p class="quizcode"><a href="https://github.com/stefanak-michal/thingsdb.js" class="thingsdb14">https://github.com/stefanak-michal/thingsdb.js</a></p></li>
            <li class="editor"><p class="quizcode">List of all connectors</p><p class="quizcode"><a href="https://docs.thingsdb.io/v1/connect/" class="thingsdb14">https://docs.thingsdb.io/v1/connect/</a></p></li>
        </ul>
    </section>
    <section>
        <h3 id="modules" class="title1">Modules</h3>
        <ul class="thingsdb18">
            <li class="editor"><p class="quizcode">Demo module</p><p class="quizcode"><a href="https://github.com/thingsdb/module-go-demo" class="thingsdb14">https://github.com/thingsdb/module-go-demo</a></p></li>
            <li class="editor"><p class="quizcode">Requests module</p><p class="quizcode"><a href="https://github.com/thingsdb/module-go-requests" class="thingsdb14">https://github.com/thingsdb/module-go-requests</a></p></li>
            <li class="editor"><p class="quizcode">ThingsDB module</p><p class="quizcode"><a href="https://github.com/thingsdb/module-go-thingsdb" class="thingsdb14">https://github.com/thingsdb/module-go-thingsdb</a></p></li>
            <li class="editor"><p class="quizcode">List of other modules maintained by the ThingsDB team</p><p class="quizcode"><a href="https://docs.thingsdb.io/v1/modules/supported-modules/" class="thingsdb14">https://docs.thingsdb.io/v1/modules/supported-modules/</a></p></li>
        </ul>
    </section>
    <section>
        <h3 id="deployment" class="title1">Deployment</h3>
        <ul class="thingsdb18">
            <li class="editor"><p class="quizcode">Google Cloud Platform Deployment (Kubernetes, GKE)</p><p class="quizcode"><a href="https://github.com/thingsdb/ThingsDB/tree/main/gke#readme" class="thingsdb14">https://github.com/thingsdb/ThingsDB/tree/main/gke#readme</a></p></li>
        </ul>
    </section>
    <section>
        <h3 id="downloads" class="title1">Downloads</h3>
        <ul class="thingsdb18">
            <li class="editor"><p class="quizcode">Docker Compose file</p><p class="quizcode"><a href="https://docs.thingsdb.io/v1/book/docker-compose.yml" class="thingsdb14">https://docs.thingsdb.io/v1/book/docker-compose.yml</a></p></li>
            <li class="editor"><p class="quizcode">Python Template file</p><p class="quizcode"><a href="https://docs.thingsdb.io/v1/book/template.py" class="thingsdb14">https://docs.thingsdb.io/v1/book/template.py</a></p></li>
            <li class="editor"><p class="quizcode">Python Dashboard file</p><p class="quizcode"><a href="https://docs.thingsdb.io/v1/book/dashboard.py" class="thingsdb14">https://docs.thingsdb.io/v1/book/dashboard.py</a></p></li>
        </ul>
    </section>
</section>
</div>


<div class="thingsdb3" id="thingsdb_link-238">
		<section type="author" role="doc-author" id="thingsdb_link-325">
			<h2 id="about-the-author" class="thingsdb7">About the Author</h2>
			<p class="copyright1">Jeroen van der Heijden has been passionate about programming since his early years,
                and has been actively contributing to the open-source world since 2012. He is the
                designer behind ThingsDB. His expertise extends beyond ThingsDB, as he is also the
                maintainer of other projects like SiriDB (a high-performance time-series database)
                and the "leri" language parsing libraries.</p>
			<p class="copyright1">Currently, Jeroen's expertise drives innovation at Cesbit, where he leads the development
                of InfraSonar (<a href="https://infrasonar.com" class="thingsdb14">www.infrasonar.com</a>), a infrastructure
                monitoring solution that relies heavily on both ThingsDB and SiriDB.</p>
			<p class="copyright1">Beyond ThingsDB, he enjoys coding in C/C++, Python and other languages. When he's not
                coding, he spends time with his family or seeks thrills on the open road or trails
                with his race or mountain bike.</p>
		</section>
	</div>

</div>
</body></html>